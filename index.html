<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Daynight RP ‚Äî PDA / CAD (Completo Largo)</title>
  <meta name="description" content="PDA/CAD completo ‚Äî BOLO, Multas, Alertas, Entornos, notificaciones estilo FiveM ‚Äî preparado para Firebase.">

  <!-- ========================= ESTILOS (NEON ACCENT - DETALLADO) ========================= -->
  <style>
    :root{
      --bg-1:#030618; --bg-2:#071428;
      --panel: rgba(255,255,255,0.028);
      --glass: rgba(255,255,255,0.02);
      --border: rgba(255,255,255,0.05);
      --muted: #9fb3bd;
      --text: #E9F9FF;
      --accent-violet: #7C3AED;
      --accent-cyan: #06B6E4;
      --success: #30D39A;
      --danger: #FF6B6B;
      --radius: 12px;
      --shadow: 0 18px 46px rgba(2,6,10,0.6);
      --fast: 160ms; --med:260ms;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:
      radial-gradient(900px 380px at 12% 8%, rgba(124,58,237,0.06), transparent 20%),
      linear-gradient(180deg,var(--bg-1),var(--bg-2) 60%); color:var(--text); -webkit-font-smoothing:antialiased;}
    body{padding:18px;}

    /* Background decorative layers */
    .bg{position:fixed;inset:0;z-index:0;pointer-events:none}
    .nebula{position:absolute;width:60vmax;height:60vmax;left:-8vmin;top:-6vmin;background:
      radial-gradient(circle at 30% 30%, rgba(124,58,237,0.22), transparent 30%),
      radial-gradient(circle at 70% 70%, rgba(6,182,164,0.12), transparent 25%);filter: blur(46px) saturate(120%);opacity:0.95;transform:translateZ(0)}
    .nebula.r{right:-8vmin;left:auto;top:6vmin;background:
      radial-gradient(circle at 70% 20%, rgba(255,80,120,0.18), transparent 30%),
      radial-gradient(circle at 30% 80%, rgba(110,231,183,0.10), transparent 25%);animation-direction:reverse}

    /* Layout base */
    .wrap{max-width:1200px;margin:0 auto;position:relative;z-index:5}
    header{display:flex;justify-content:space-between;align-items:center;gap:12px;padding:10px 0}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent-cyan),var(--accent-violet));display:grid;place-items:center;color:#02141a;font-weight:900}
    h1{margin:0;font-size:18px}
    .subtitle{font-size:13px;color:var(--muted)}

    .top-right{display:flex;align-items:center;gap:8px}
    .pill{background:var(--glass);padding:8px 12px;border-radius:999px;color:var(--muted);font-weight:700}
    .btn{background:linear-gradient(90deg,var(--accent-violet),var(--accent-cyan));border:none;color:#02141a;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:800;box-shadow:var(--shadow)}
    .btn-ghost{background:transparent;border:1px solid var(--border);color:var(--muted);padding:7px 10px;border-radius:10px;cursor:pointer}
    .btn-sm{padding:6px 8px;font-size:13px;border-radius:9px}

    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-top:12px}
    @media(max-width:980px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:640px){.grid{grid-template-columns:1fr}}

    /* Panels */
    .panel{background:var(--panel);border-radius:var(--radius);padding:14px;border:1px solid var(--border);box-shadow:var(--shadow);display:flex;flex-direction:column;gap:10px;min-height:120px;transition:transform var(--med) ease,box-shadow var(--fast)}
    .panel:hover{transform:translateY(-6px);box-shadow:0 30px 80px rgba(0,0,0,0.6);border-color: rgba(124,58,237,0.12)}
    .panel .title{font-weight:900;color:var(--accent-violet)}
    .panel .sub{color:var(--muted);font-size:13px}

    .list{display:flex;flex-direction:column;gap:8px;overflow:auto}
    .item{display:flex;justify-content:space-between;align-items:center;padding:10px;background:rgba(255,255,255,0.02);border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
    .item-left{max-width:72%}
    .item-title{font-weight:800}
    .item-meta{font-size:13px;color:var(--muted)}

    .panel-actions{display:flex;gap:8px;justify-content:flex-end}

    /* Expanded area */
    #expandedRoot .expanded{margin-top:12px;border-radius:12px;padding:16px;background:linear-gradient(180deg, rgba(255,255,255,0.016), rgba(0,0,0,0.03));border:1px solid rgba(255,255,255,0.03);box-shadow:0 30px 44px rgba(0,0,0,0.55);animation:panelIn .28s cubic-bezier(.2,.9,.2,.99) both}
    @keyframes panelIn{from{opacity:0;transform:translateY(12px) scale(.995)}to{opacity:1;transform:none}}
    @keyframes panelOut{from{opacity:1}to{opacity:0;transform:translateY(8px)}}

    /* Toasts */
    #toasts{position:fixed;right:18px;top:72px;z-index:99999;display:flex;flex-direction:column;gap:10px;width:360px;pointer-events:none}
    .toast{pointer-events:auto;display:flex;gap:12px;align-items:flex-start;padding:12px;border-radius:10px;background:linear-gradient(90deg,var(--accent-cyan),var(--accent-violet));color:#02141a;font-weight:800;box-shadow:0 12px 38px rgba(2,6,10,0.6);animation:toastIn .22s}
    @keyframes toastIn{from{opacity:0;transform:translateY(-8px) scale(.98)}to{opacity:1;transform:none}}
    .toast .t-body{font-weight:700;color:rgba(2,20,26,0.92)}.toast .t-close{margin-left:auto;background:transparent;border:none;color:rgba(2,20,26,0.85);font-weight:900;cursor:pointer}

    /* Modal */
    .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.5);z-index:99999}
    .modal{background:var(--panel);border-radius:12px;padding:16px;min-width:320px;max-width:920px;box-shadow:0 14px 40px rgba(2,6,10,0.6)}
    input,textarea,select{background:transparent;border:1px solid var(--border);color:var(--text);padding:8px;border-radius:8px;width:100%}

    .muted{color:var(--muted)}.hidden{display:none}
    .pulse{animation:pulse .9s}@keyframes pulse{0%{box-shadow:0 0 0 rgba(124,58,237,0.12)}70%{box-shadow:0 0 30px rgba(124,58,237,0.04)}100%{box-shadow:none}}
    footer{margin-top:18px;color:var(--muted);text-align:center;font-size:13px}
  </style>

  <!-- ========================= FIREBASE PLACEHOLDER =========================
       Nota: por seguridad NO incluyo keys reales.
       Cuando copies este archivo, pega tus credenciales en el objeto firebaseConfig
       reemplazando las cadenas "TU_..." con tus valores reales.
  ========================= -->
  <script>
    // Firebase SDK scripts (opcional, si vas a usar modular imports, a√±ade los m√≥dulos en tu build)
    // Si usas la CDN (compat), incluye estos <script> en <head> antes de init:
    // <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    // <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    // <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    //
    // O, si usas m√≥dulos en tu bundler, importa getAuth, getFirestore, etc. en tu build.

    // Placeholder configuration object: üîß pega tus credenciales AQU√ç
    const firebaseConfig = {
      apiKey: "TU_API_KEY_AQUI",
      authDomain: "TU_AUTH_DOMAIN_AQUI",
      projectId: "TU_PROJECT_ID_AQUI",
      storageBucket: "TU_STORAGE_BUCKET_AQUI",
      messagingSenderId: "TU_MESSAGING_SENDER_ID_AQUI",
      appId: "TU_APP_ID_AQUI"
      // measurementId: "TU_MEASUREMENT_ID"  // opcional
    };

    // Inicializaci√≥n segura:
    // Si ya inicializas Firebase en otro archivo, deja esta secci√≥n comentada.
    function initFirebaseIfNeeded(){
      try{
        if(typeof firebase !== 'undefined' && firebase.apps && firebase.apps.length === 0){
          // compat mode
          firebase.initializeApp(firebaseConfig);
          console.info('Firebase inicializado (compat)');
        } else if(typeof firebase === 'undefined'){
          // si no usas compat CDN, esperamos que el proyecto inicialice Firebase desde otro sitio
          console.info('Firebase no detectado globalmente. Si usas modular, inicializa en tu bundler con firebaseConfig.');
        } else {
          console.info('Firebase ya inicializado');
        }
      }catch(e){
        console.warn('initFirebaseIfNeeded:', e);
      }
    }
    // No ejecutamos aqu√≠ initFirebaseIfNeeded() autom√°ticamente para no duplicar si ya existe.
    // Llama a initFirebaseIfNeeded(); desde tu script si quieres que este archivo lo haga.
  </script>

</head>
<body>
  <div class="bg" aria-hidden="true">
    <div class="nebula"></div>
    <div class="nebula r"></div>
  </div>

  <div class="wrap" role="main">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true">PDA</div>
        <div>
          <h1>Daynight RP ‚Äî PDA / CAD</h1>
          <div class="subtitle">BOLO ¬∑ Multas ¬∑ Alertas ¬∑ Entornos ¬∑ Historial</div>
        </div>
      </div>

      <div class="top-right">
        <div id="userDisplay" class="pill">No conectado</div>
        <div id="dutyStatus" class="pill">Servicio: <span id="onDutyCount">0</span></div>
        <button id="refreshAll" class="btn-ghost">Refrescar todo</button>
        <button id="exportBtn" class="btn">Exportar</button>
        <button id="btnLogin" class="btn-ghost">Entrar</button>
      </div>
    </header>

    <section class="grid" id="panelsRoot" aria-label="Paneles principales">
      <!-- BLOQUE 2 reemplaza / rellena este espacio -->
    </section>

    <div id="expandedRoot" aria-live="polite"></div>

    <footer>Daynight RP ‚Ä¢ PDA / CAD ‚Ä¢ Est√©tica Neon Accent</footer>
  </div>

  <!-- LOGIN modal (sin registro) -->
  <div id="loginModal" class="overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <h3>Acceso ‚Äî Daynight RP</h3>
      <div class="muted small">Inicia sesi√≥n o usa Invitado para modo local.</div>
      <div style="margin-top:12px">
        <label class="muted small">Usuario (email o nick)</label>
        <input id="loginUser" placeholder="usuario@example.com">
        <label class="muted small" style="margin-top:8px">Contrase√±a</label>
        <input id="loginPass" type="password" placeholder="contrase√±a">
        <div style="display:flex;gap:8px;margin-top:12px">
          <button id="loginBtnModal" class="btn">Entrar</button>
          <button id="guestBtnModal" class="btn-ghost">Invitado</button>
          <button id="closeLoginModal" class="btn-ghost" style="margin-left:auto">Cerrar</button>
        </div>
        <div id="loginError" class="muted small" style="margin-top:8px;color:#ff9b9b;display:none"></div>
      </div>
    </div>
  </div>

  <div id="toasts" aria-live="polite" aria-atomic="true"></div>

  <!-- Fin BLOQUE 1 / 4 -->
  <!-- ========================= BLOQUE 2 / 4: MARKUP DETALLADO DE PANELES ========================= -->

      <!-- ========================= PANEL: BOLOs / BUSCADOS ========================= -->
      <div class="panel" id="panel-bolos">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="title">üöì BOLOs / Buscados</div>
            <div class="sub">Gestiona BOLOs: crear, ver, borrar.</div>
          </div>
          <div class="panel-actions">
            <button class="btn-ghost btn-sm" data-refresh="bolos">‚ü≥</button>
            <button class="btn btn-sm" data-open="bolos">Abrir</button>
          </div>
        </div>
        <div class="list" id="bolosPreview"><div class="muted">Cargando BOLOs...</div></div>
      </div>

      <!-- ========================= PANEL: MULTAS ========================= -->
      <div class="panel" id="panel-multas">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="title">üí∞ Multas y Sanciones</div>
            <div class="sub">Registro de infracciones y pagos.</div>
          </div>
          <div class="panel-actions">
            <button class="btn-ghost btn-sm" data-refresh="multas">‚ü≥</button>
            <button class="btn btn-sm" data-open="multas">Abrir</button>
          </div>
        </div>
        <div class="list" id="multasPreview"><div class="muted">Cargando multas...</div></div>
      </div>

      <!-- ========================= PANEL: ALERTAS ========================= -->
      <div class="panel" id="panel-alertas">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="title">üö® Alertas y Llamadas</div>
            <div class="sub">Env√≠a y administra alertas a la central.</div>
          </div>
          <div class="panel-actions">
            <button class="btn-ghost btn-sm" data-refresh="alertas">‚ü≥</button>
            <button class="btn btn-sm" data-open="alertas">Abrir</button>
          </div>
        </div>
        <div class="list" id="alertasPreview"><div class="muted">Cargando alertas...</div></div>
      </div>

      <!-- ========================= PANEL: ENTORNOS (AUTOM√ÅTICO) ========================= -->
      <div class="panel" id="panel-entornos">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="title">üóíÔ∏è Entornos Policiales</div>
            <div class="sub">Eventos generados por agentes/ciudadanos (notifs autom√°ticas).</div>
          </div>
          <div class="panel-actions">
            <button class="btn-ghost btn-sm" data-refresh="entornos">‚ü≥</button>
            <button class="btn btn-sm" data-open="entornos">Abrir</button>
          </div>
        </div>
        <div class="list" id="entornosPreview"><div class="muted">Cargando entornos...</div></div>
      </div>

      <!-- ========================= PANEL: VEH√çCULOS ========================= -->
      <div class="panel" id="panel-vehiculos">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="title">üöó Veh√≠culos Registrados</div>
            <div class="sub">Consulta por matr√≠cula, propietario y estado.</div>
          </div>
          <div class="panel-actions">
            <button class="btn-ghost btn-sm" data-refresh="vehiculos">‚ü≥</button>
            <button class="btn btn-sm" data-open="vehiculos">Abrir</button>
          </div>
        </div>
        <div class="list" id="vehiculosPreview"><div class="muted">Cargando veh√≠culos...</div></div>
      </div>

      <!-- ========================= PANEL: ARMAMENTO ========================= -->
      <div class="panel" id="panel-armas">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="title">üî´ Armamento y Equipamiento</div>
            <div class="sub">Control de armas, n√∫mero de serie y asignaciones.</div>
          </div>
          <div class="panel-actions">
            <button class="btn-ghost btn-sm" data-refresh="armas">‚ü≥</button>
            <button class="btn btn-sm" data-open="armas">Abrir</button>
          </div>
        </div>
        <div class="list" id="armasPreview"><div class="muted">Cargando armamento...</div></div>
      </div>

      <!-- ========================= PANEL: OFICIALES ========================= -->
      <div class="panel" id="panel-oficiales">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="title">üëÆ‚Äç‚ôÇÔ∏è Personal en Servicio</div>
            <div class="sub">Estado del personal y turnos.</div>
          </div>
          <div class="panel-actions">
            <button class="btn-ghost btn-sm" data-refresh="oficiales">‚ü≥</button>
            <button class="btn btn-sm" data-open="oficiales">Abrir</button>
          </div>
        </div>
        <div class="list" id="oficialesPreview"><div class="muted">Cargando oficiales...</div></div>
      </div>

      <!-- ========================= PANEL: INFORMES ========================= -->
      <div class="panel" id="panel-informes">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="title">üìÇ Informes y Casos</div>
            <div class="sub">Crear, asignar y seguir investigaciones.</div>
          </div>
          <div class="panel-actions">
            <button class="btn-ghost btn-sm" data-refresh="informes">‚ü≥</button>
            <button class="btn btn-sm" data-open="informes">Abrir</button>
          </div>
        </div>
        <div class="list" id="informesPreview"><div class="muted">Cargando informes...</div></div>
      </div>

      <!-- ========================= PANEL: HISTORIAL ========================= -->
      <div class="panel" id="panel-historial">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="title">üïì Historial de Notificaciones</div>
            <div class="sub">Registro de notificaciones y acciones.</div>
          </div>
          <div class="panel-actions">
            <button class="btn-ghost btn-sm" data-refresh="historial">‚ü≥</button>
            <button class="btn btn-sm" data-open="historial">Abrir</button>
          </div>
        </div>
        <div class="list" id="historialPreview"><div class="muted">Cargando historial...</div></div>
      </div>

  <!-- ========================= FIN BLOQUE 2 / 4 ========================= -->
  <!-- ========================= BLOQUE 3 / 4: L√ìGICA JS PRINCIPAL ========================= -->
  <script>
  // Utilidades b√°sicas
  const $ = s => document.querySelector(s);
  const $$ = s => document.querySelectorAll(s);

  // Estado global (cache local)
  const STATE = {
    bolos: [], multas: [], alertas: [], entornos: [],
    vehiculos: [], armas: [], oficiales: [], informes: [], historial: []
  };

  // ======= SISTEMA DE NOTIFICACIONES TIPO FIVEM =======
  function pushNotif(msg, type = "info") {
    const toasts = $("#toasts");
    const toast = document.createElement("div");
    toast.className = "toast";
    toast.innerHTML = `
      <div class="t-body">${msg}</div>
      <button class="t-close" aria-label="Cerrar">√ó</button>
    `;
    toasts.appendChild(toast);
    toast.querySelector(".t-close").onclick = () => toast.remove();
    setTimeout(() => toast.remove(), 5500);
  }

  // ======= RENDERIZADO DE PANELES =======
  function renderPanel(id, list) {
    const cont = $(`#${id}Preview`);
    if (!cont) return;
    cont.innerHTML = "";
    if (!list || list.length === 0) {
      cont.innerHTML = `<div class="muted small">Sin registros.</div>`;
      return;
    }
    list.forEach(item => {
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div class="item-left">
          <div class="item-title">${item.nombre || item.titulo || item.autor || item.tipo || "Registro"}</div>
          <div class="item-meta">${item.motivo || item.descripcion || item.detalle || item.fecha || ""}</div>
        </div>
        <div style="display:flex;gap:4px;">
          <button class="btn-ghost btn-sm" onclick="editItem('${id}', '${item.id || ""}')">‚úé</button>
          <button class="btn-ghost btn-sm" onclick="deleteItem('${id}', '${item.id || ""}')">üóëÔ∏è</button>
        </div>
      `;
      cont.appendChild(div);
    });
  }

  // ======= CRUD LOCAL =======
  function addItem(type) {
    const title = prompt("T√≠tulo o nombre:");
    if (!title) return;
    const desc = prompt("Descripci√≥n o motivo:");
    const newItem = {
      id: Math.random().toString(36).substring(2, 9),
      titulo: title, descripcion: desc, fecha: new Date().toLocaleString()
    };
    STATE[type].unshift(newItem);
    renderPanel(type, STATE[type]);
    pushNotif(`Nuevo registro a√±adido en ${type.toUpperCase()}`);
    saveToFirestore(type, newItem);
  }

  function editItem(type, id) {
    const list = STATE[type];
    const item = list.find(x => x.id === id);
    if (!item) return alert("Registro no encontrado.");
    const nuevoTitulo = prompt("Editar t√≠tulo:", item.titulo || item.nombre);
    const nuevoDesc = prompt("Editar descripci√≥n:", item.descripcion || item.motivo);
    if (nuevoTitulo) item.titulo = nuevoTitulo;
    if (nuevoDesc) item.descripcion = nuevoDesc;
    renderPanel(type, STATE[type]);
    pushNotif(`Registro actualizado (${type})`);
    updateFirestore(type, id, item);
  }

  function deleteItem(type, id) {
    if (!confirm("¬øEliminar registro?")) return;
    STATE[type] = STATE[type].filter(x => x.id !== id);
    renderPanel(type, STATE[type]);
    pushNotif(`Registro eliminado (${type})`);
    deleteFromFirestore(type, id);
  }

  // ======= FIRESTORE INTEGRACI√ìN (si Firebase inicializado) =======
  function getDb() {
    try {
      if (firebase && firebase.firestore) return firebase.firestore();
    } catch(e){ console.warn("Firestore no detectado."); }
    return null;
  }

  async function saveToFirestore(col, data) {
    const db = getDb();
    if (!db) return;
    try {
      await db.collection(col).add(data);
    } catch (err) { console.error(err); }
  }

  async function updateFirestore(col, id, data) {
    const db = getDb();
    if (!db || !id) return;
    try {
      const snap = await db.collection(col).where("id", "==", id).get();
      snap.forEach(doc => doc.ref.update(data));
    } catch (err) { console.error(err); }
  }

  async function deleteFromFirestore(col, id) {
    const db = getDb();
    if (!db || !id) return;
    try {
      const snap = await db.collection(col).where("id", "==", id).get();
      snap.forEach(doc => doc.ref.delete());
    } catch (err) { console.error(err); }
  }

  async function loadFirestore(col) {
    const db = getDb();
    if (!db) return [];
    try {
      const snap = await db.collection(col).get();
      return snap.docs.map(d => ({ id: d.id, ...d.data() }));
    } catch (err) { console.error(err); return []; }
  }

  // ======= REFRESCAR TODO =======
  async function refreshAll() {
    const keys = Object.keys(STATE);
    for (const k of keys) {
      const data = await loadFirestore(k);
      STATE[k] = data.length ? data : STATE[k];
      renderPanel(k, STATE[k]);
    }
    pushNotif("Todos los paneles actualizados");
  }

  // ======= LOGIN =======
  const loginModal = $("#loginModal");
  const userDisplay = $("#userDisplay");

  $("#btnLogin").onclick = () => loginModal.style.display = "flex";
  $("#closeLoginModal").onclick = () => loginModal.style.display = "none";

  $("#guestBtnModal").onclick = () => {
    loginModal.style.display = "none";
    userDisplay.textContent = "Invitado";
    pushNotif("Entraste como invitado");
  };

  $("#loginBtnModal").onclick = async () => {
    const user = $("#loginUser").value.trim();
    const pass = $("#loginPass").value.trim();
    if (!user || !pass) {
      $("#loginError").textContent = "Introduce usuario y contrase√±a.";
      $("#loginError").style.display = "block";
      return;
    }
    $("#loginError").style.display = "none";
    loginModal.style.display = "none";
    userDisplay.textContent = user;
    pushNotif(`Bienvenido ${user}`);
  };

  // ======= EXPORTAR =======
  $("#exportBtn").onclick = () => {
    const blob = new Blob([JSON.stringify(STATE, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = "pda_export.json";
    a.click();
    pushNotif("Datos exportados (JSON)");
  };

  // ======= REFRESH BOTONES =======
  $$("[data-refresh]").forEach(btn => {
    btn.onclick = e => {
      const key = e.target.dataset.refresh;
      renderPanel(key, STATE[key]);
      btn.classList.add("pulse");
      setTimeout(() => btn.classList.remove("pulse"), 700);
      pushNotif(`Panel ${key.toUpperCase()} actualizado`);
    };
  });

  // ======= OPEN PANEL DETALLADO =======
  $$("[data-open]").forEach(btn => {
    btn.onclick = e => {
      const key = e.target.dataset.open;
      openPanel(key);
    };
  });

  // ======= FUNCI√ìN OPEN PANEL =======
  function openPanel(key) {
    const root = $("#expandedRoot");
    root.innerHTML = "";
    const div = document.createElement("div");
    div.className = "expanded";
    div.innerHTML = `
      <h3>${key.toUpperCase()}</h3>
      <p class="muted small">Registros activos:</p>
      <div id="${key}Expanded" class="list"></div>
      <div style="margin-top:12px;display:flex;gap:8px;">
        <button class="btn" onclick="addItem('${key}')">A√±adir</button>
        <button class="btn-ghost" onclick="refreshAll()">Refrescar todo</button>
        <button class="btn-ghost" onclick="closePanel()">Cerrar</button>
      </div>
    `;
    root.appendChild(div);
    renderPanel(key, STATE[key]);
    window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
  }

  function closePanel() {
    const root = $("#expandedRoot");
    root.innerHTML = "";
  }

  // ======= DATOS DEMO =======
  STATE.bolos = [
    { id:"1", nombre:"John Doe", motivo:"Robo a mano armada", fecha:"2025-10-23" },
    { id:"2", nombre:"Sof√≠a R.", motivo:"Conducci√≥n temeraria", fecha:"2025-10-22" }
  ];
  STATE.multas = [
    { id:"3", infractor:"Carlos P.", motivo:"Exceso de velocidad", cantidad:500 },
    { id:"4", infractor:"Laura T.", motivo:"Estacionamiento indebido", cantidad:250 }
  ];
  STATE.alertas = [
    { id:"5", tipo:"Llamada 911", detalle:"Pelea en Strawberry Ave" },
    { id:"6", tipo:"Refuerzo", detalle:"Unidad 42 solicita apoyo en Vespucci" }
  ];
  STATE.entornos = [
    { id:"7", autor:"Ofc. P√©rez", descripcion:"Veh√≠culo abandonado Grove Street" },
    { id:"8", autor:"Sgt. L√≥pez", descripcion:"Sujeto armado cerca de Legion" }
  ];

  window.addEventListener("DOMContentLoaded", () => {
    refreshAll();
    setTimeout(() => {
      pushNotif("Conexi√≥n establecida con central.");
      pushNotif("Nuevos entornos disponibles.");
    }, 1500);
  });
  </script>
  <!-- ========================= FIN BLOQUE 3 / 4 ========================= -->
  <!-- ========================= BLOQUE 4 / 4: ANIMACIONES, AUTO-ENTORNOS Y CIERRE ========================= -->
  <script>
  (function(){
    // Animaciones/peque√±os toques UX
    function bounceElement(el){
      if(!el) return;
      el.animate([
        { transform: 'translateY(0)' },
        { transform: 'translateY(-6px)' },
        { transform: 'translateY(0)' }
      ], { duration: 420, easing: 'cubic-bezier(.2,.9,.2,.99)' });
    }

    // Animaci√≥n para paneles al entrar (stagger)
    function animatePanelsIn(){
      const panels = document.querySelectorAll('#panelsRoot .panel');
      panels.forEach((p, i) => {
        p.style.opacity = '0';
        p.style.transform = 'translateY(10px)';
        setTimeout(() => {
          p.style.transition = 'opacity 360ms ease, transform 360ms cubic-bezier(.2,.9,.2,.99)';
          p.style.opacity = '1';
          p.style.transform = 'translateY(0)';
        }, i * 70);
      });
    }

    // Small helper to show a quick centered toast (used for big events)
    function bigToast(text){
      const id = Date.now().toString(36);
      const node = document.createElement('div'); node.className='toast'; node.dataset.id = id;
      node.style.width = '420px'; node.style.fontSize = '15px';
      node.innerHTML = `<div style="font-weight:900">üîî ${text}</div><button class="t-close">√ó</button>`;
      document.getElementById('toasts').prepend(node);
      node.querySelector('.t-close').onclick = ()=> node.remove();
      setTimeout(()=> node.remove(), 7000);
    }

    // Auto-entornos simulator: crea eventos nuevo cada X segundos si Firestore no est√° activo
    let autoEntornosInterval = null;
    function startAutoEntornos(){
      // only run if no Firestore
      let dbPresent = false;
      try{ dbPresent = !!(firebase && firebase.firestore); }catch(e){ dbPresent = false; }
      if(dbPresent) return; // don't simulate if real DB exists

      if(autoEntornosInterval) clearInterval(autoEntornosInterval);
      autoEntornosInterval = setInterval(()=>{
        const now = new Date();
        const id = 'sim-'+now.getTime().toString(36).slice(-6);
        const titles = [
          'Veh√≠culo sospechoso reportado',
          'Disputa p√∫blica ‚Äî posible agresi√≥n',
          'Objetos abandonados en v√≠a p√∫blica',
          'Robo en proceso',
          'Robo con arma',
          'Choque m√∫ltiple'
        ];
        const msgs = [
          'Localizado por c√°mara en Vinewood.',
          'Varias llamadas 911 ‚Äî refuerzos solicitados.',
          'Sin ocupantes visibles, revisado por patrulla.',
          'Unidad 12 informa situaci√≥n cr√≠tica.',
          'Posible fuga del sospechoso en veh√≠culo oscuro.',
          'Requiere ambulancia y bomberos.'
        ];
        const idx = Math.floor(Math.random()*titles.length);
        const item = {
          id,
          title: titles[idx],
          msg: msgs[idx],
          createdAt: new Date().toISOString(),
          autor: 'Sistema autom√°tico'
        };
        // push locally
        STATE.entornos.unshift(item);
        // re-render preview + if expanded open, update expanded
        try{
          const entPreview = document.getElementById('entornosPreview');
          if(entPreview) { /* re-render quick */ entPreview.prepend(createItemNode(item)); }
        }catch(e){}
        // notify
        notifyAuto(item);
      }, 24000); // every 24s (configurable)
    }

    // small helper to create DOM node for preview insertion used by simulator
    function createItemNode(item){
      const d = document.createElement('div'); d.className='item';
      d.innerHTML = `<div class="item-left"><div class="item-title">${escapeHtml(item.title||item.autor||'Evento')}</div><div class="item-meta">${escapeHtml(item.msg||'')}</div></div>`;
      return d;
    }

    // notify wrapper used by simulator and general code
    function notifyAuto(item){
      // uses notify defined in BLOQUE 3 if present, else fallback to pushNotif
      if(typeof notify === 'function') notify('warn', item.title||'Evento', item.msg||'', 7000);
      else if(typeof pushNotif === 'function') pushNotif((item.title||'Evento') + ' ‚Äî ' + (item.msg||''), 'warn');
      else bigToast((item.title||'Evento') + ' ‚Äî ' + (item.msg||''));
    }

    // graceful shutdown for simulator (if user navigates away)
    window.addEventListener('beforeunload', ()=> { if(autoEntornosInterval) clearInterval(autoEntornosInterval); });

    // Init small things after DOM ready
    document.addEventListener('DOMContentLoaded', ()=>{
      // animate panels
      animatePanelsIn();

      // wire add buttons in expanded panel (they call addItem in BLOQUE 3)
      // (already wired by inline onclicks in BLOQUE 3)

      // start simulator if no DB
      startAutoEntornos();

      // small notification on load
      bigToast('PDA cargada ‚Äî listo para operar');

      // quick pulse on refreshAll
      const raf = document.getElementById('refreshAll');
      if(raf){ raf.addEventListener('click', ()=> bounceElement(raf)); }
    });

    // expose some helpers for console debugging
    window.PDA_DEBUG = {
      startAutoEntornos, stopAutoEntornos: ()=> { if(autoEntornosInterval) clearInterval(autoEntornosInterval); autoEntornosInterval = null; },
      createItemNode
    };

    // Fallback definitions if some functions from earlier blocks missing (defensive)
    if(typeof notify === 'undefined'){
      window.notify = function(type, title, text, ttl){ if(typeof pushNotif === 'function') pushNotif(`${title} ‚Äî ${text}`, ttl); else bigToast(title + ' ‚Ä¢ ' + text); };
    }
    if(typeof escapeHtml === 'undefined'){
      window.escapeHtml = function(s){ if(s===undefined||s===null) return ''; return String(s).replace(/[&<>"']/g, m=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'})[m]); };
    }
    if(typeof createModal === 'undefined'){
      window.createModal = function(innerHtml){
        const back = document.createElement('div'); back.className='overlay'; back.style.display='flex';
        const box = document.createElement('div'); box.className='modal'; box.innerHTML = innerHtml;
        back.appendChild(box); document.body.appendChild(back);
        back.addEventListener('click', function(e){ if(e.target === back) back.remove(); });
        return back;
      };
    }
    if(typeof makeBtn === 'undefined'){
      window.makeBtn = function(label, cb){ const b = document.createElement('button'); b.className='btn-ghost btn-sm'; b.textContent = label; b.addEventListener('click', cb); return b; };
    }

  })();
  </script>

</body>
</html>
