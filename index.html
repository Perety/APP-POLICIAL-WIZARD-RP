<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Wizard RP ‚Äî PDA Policial (Online)</title>
<style>
  :root{
    --bg:#071018; --card:#0e2633; --muted:#98a8b0; --accent:#f7b731; --accent-2:#7c3aed;
    --glass: rgba(255,255,255,0.03); --radius:14px;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:
    radial-gradient(900px 350px at 10% 10%, rgba(124,58,237,0.04), transparent),
    linear-gradient(180deg, #03121a 0%, var(--bg) 60%); color:#e7eef6}
  .wrap{max-width:1100px;margin:18px auto;padding:18px;display:grid;grid-template-rows:auto 1fr;gap:14px}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .brand{display:flex;gap:12px;align-items:center}
  .logo-img{width:56px;height:56px;border-radius:12px;overflow:hidden;display:flex;align-items:center;justify-content:center;background:#071729}
  .logo-img img{width:100%;height:100%;object-fit:cover}
  h1{margin:0;font-size:18px}
  .subtitle{color:var(--muted);font-size:13px}
  .top-right{display:flex;gap:8px;align-items:center}
  .pill{background:rgba(255,255,255,0.03);padding:8px 10px;border-radius:999px;font-weight:700}
  .small{font-size:12px;color:var(--muted)}
  .btn{background:var(--accent);color:#041018;padding:8px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:800}
  .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);padding:7px 10px;border-radius:10px;cursor:pointer}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:var(--radius);padding:18px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 10px 30px rgba(2,6,10,0.6);cursor:pointer;overflow:hidden;position:relative;transition:transform .28s, box-shadow .28s;display:flex;flex-direction:column;gap:12px;min-height:120px;}
  .card:hover{transform:translateY(-8px);box-shadow:0 18px 40px rgba(2,6,10,0.75)}
  .card .title{font-weight:900;font-size:16px}
  .card .desc{color:var(--muted);font-size:13px}
  .icon{width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,rgba(255,255,255,0.03),rgba(255,255,255,0.01));display:flex;align-items:center;justify-content:center;font-weight:900;font-size:20px;transition:transform .35s}
  .card:hover .icon{transform:rotate(8deg) scale(1.06)}
  .expanded{margin-top:14px;border-radius:var(--radius);padding:18px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03)}
  .form-row{display:flex;gap:8px}
  input, textarea, select{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
  textarea{min-height:100px;resize:vertical}
  .list{display:flex;flex-direction:column;gap:10px}
  .item{padding:10px;border-radius:10px;background:var(--glass);display:flex;justify-content:space-between;align-items:center}
  .muted{color:var(--muted)}
  .danger{background:linear-gradient(90deg,#ff8a80,#ff5252);color:#041018;padding:6px 8px;border-radius:8px}
  footer{margin-top:18px;text-align:center;color:var(--muted);font-size:13px}
  .overlay{position:fixed;inset:0;background:linear-gradient(rgba(2,6,10,0.6),rgba(2,6,10,0.8));display:flex;align-items:center;justify-content:center;z-index:9999}
  .modal{width:720px;max-width:94%;background:linear-gradient(180deg,#071729,#061421);padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
  .link-like{color:var(--accent);cursor:pointer;text-decoration:underline}
  .grid-2{display:grid;grid-template-columns:1fr 320px;gap:12px}
  .role-chip{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.02);margin-right:6px;margin-bottom:6px}
  .hidden{display:none}
  @media (max-width:980px){ .grid{grid-template-columns:repeat(2,1fr)} .grid-2{grid-template-columns:1fr} }
  @media (max-width:640px){ .grid{grid-template-columns:1fr} .form-row{flex-direction:column} .modal{width:94%} }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo-img"><img id="logoImg" src="https://cdn.discordapp.com/attachments/1421898595271180360/1422217488145453219/LOGO_WIZARD_FONDO.png.png" alt="Wizard"></div>
        <div>
          <h1>Wizard RP ‚Äî PDA / CAD</h1>
          <div class="subtitle">Simulador online ‚Äî sincronizado con Firestore</div>
        </div>
      </div>

      <div class="top-right">
        <div class="pill small" id="userDisplay">No conectado</div>
        <div class="pill small" id="dutyStatus">En servicio: 0</div>
        <button id="btnExport" class="btn">Exportar</button>
        <button id="btnLogin" class="btn-ghost">Iniciar</button>
      </div>
    </header>

    <section class="grid" id="cardsRoot">
      <!-- JS insert -->
    </section>

    <div id="expandedRoot"></div>

    <footer>Hecho para Wizard RP ‚Ä¢ Datos en Firestore ‚Ä¢ Sustituye firebaseConfig por los tuyos</footer>
  </div>

  <!-- LOGIN modal (tu flow original) -->
  <div id="loginModal" class="overlay hidden">
    <div class="modal">
      <h3>Entrar / Registrarse</h3>
      <div class="muted small">Usa tu cuenta o crea una. Los datos se guardan en la nube (Firestore).</div>

      <div style="margin-top:12px">
        <label class="muted small">Usuario</label>
        <input id="loginUser" placeholder="usuario (ej: perety04)"/>
        <label class="muted small" style="margin-top:8px">Contrase√±a</label>
        <input id="loginPass" type="password" placeholder="contrase√±a"/>
        <div style="display:flex;gap:8px;margin-top:12px">
          <button id="loginBtn" class="btn">Entrar</button>
          <button id="guestBtn" class="btn-ghost">Invitado</button>
          <div style="margin-left:auto" class="small muted">¬øSin cuenta? <span id="showReg" class="link-like">Crear</span></div>
        </div>
        <div id="loginError" class="muted small" style="margin-top:8px;color:#ff9b9b;display:none"></div>
      </div>

      <div id="registerBlock" class="hidden" style="margin-top:12px;border-top:1px dashed rgba(255,255,255,0.03);padding-top:12px">
        <h4 style="margin:0 0 8px 0">Crear cuenta</h4>
        <label class="muted small">Nombre visible</label>
        <input id="regName" placeholder="Ej: Ofc. P√©rez"/>
        <label class="muted small">Usuario</label>
        <input id="regUser" placeholder="usuario (ej: perety04)"/>
        <label class="muted small">Contrase√±a</label>
        <input id="regPass" type="password" placeholder="contrase√±a"/>
        <div style="display:flex;gap:8px;margin-top:8px">
          <select id="regRole">
            <option value="officer">Officer</option>
            <option value="sergeant">Sergeant</option>
            <option value="dispatcher">Dispatcher</option>
            <option value="admin">Admin</option>
          </select>
          <button id="regCreate" class="btn">Crear</button>
          <button id="regCancel" class="btn-ghost">Cancelar</button>
        </div>
        <div id="regMsg" class="muted small" style="margin-top:8px"></div>
      </div>
    </div>
  </div>

<script type="module">
/* ================= FIREBASE SETUP =================
   Replace the firebaseConfig object below with your project's config (Firebase Console > Project settings > Your apps)
   Note: We use Firestore (no Firebase Auth). The UI enforces "only logged-in users can write".
   If you later enable Firebase Auth, update security rules to require auth.
================================================== */

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import {
  getFirestore, collection, doc, getDoc, getDocs, addDoc, setDoc, updateDoc, deleteDoc,
  onSnapshot, query, where, orderBy
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "TU_API_KEY",
  authDomain: "TU_PROJECT_ID.firebaseapp.com",
  projectId: "TU_PROJECT_ID",
  storageBucket: "TU_PROJECT_ID.appspot.com",
  messagingSenderId: "TU_MSG_SENDER",
  appId: "TU_APP_ID"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* =================== App state =================== */
let STATE = {
  currentUser: null, // {id, username, display, role, badge}
  expanded: null
};

/* ============== Helper: Firestore wrappers ============== */
// Collections used: users, roles, reports, pda, calls, fines, wanted, logs, onDuty
const COL = name => collection(db, name);

async function fsAdd(colName, obj){
  // ensure only logged in can write in UI
  if(!STATE.currentUser){ alert('Inicia sesi√≥n para realizar esta acci√≥n'); throw 'not-auth'; }
  obj._created = Date.now();
  return await addDoc(COL(colName), obj);
}
async function fsSet(docRef, obj){
  if(!STATE.currentUser){ alert('Inicia sesi√≥n'); throw 'not-auth'; }
  return await setDoc(docRef, obj);
}
async function fsUpdate(docRef, partial){
  if(!STATE.currentUser){ alert('Inicia sesi√≥n'); throw 'not-auth'; }
  return await updateDoc(docRef, partial);
}
async function fsDelete(docRef){
  if(!STATE.currentUser){ alert('Inicia sesi√≥n'); throw 'not-auth'; }
  return await deleteDoc(docRef);
}

/* =============== UI refs =============== */
const cardsRoot = document.getElementById('cardsRoot');
const expandedRoot = document.getElementById('expandedRoot');
const userDisplay = document.getElementById('userDisplay');
const dutyStatus = document.getElementById('dutyStatus');
const loginModal = document.getElementById('loginModal');
const btnLogin = document.getElementById('btnLogin');
const btnExport = document.getElementById('btnExport');

/* =============== Seed if empty (first-time friendly) =============== */
async function seedIfNeeded(){
  // Check users collection quickly; if empty, seed default
  const snap = await getDocs(COL('users'));
  if(snap.empty){
    // seed default users and roles
    await addDoc(COL('roles'), { key:'officer', name:'Officer', permissions:['create_reports','create_pda','create_call'] });
    await addDoc(COL('roles'), { key:'sergeant', name:'Sergeant', permissions:['create_reports','create_pda','create_call','delete_reports'] });
    await addDoc(COL('roles'), { key:'dispatcher', name:'Dispatcher', permissions:['create_call','assign_call'] });
    await addDoc(COL('roles'), { key:'admin', name:'Admin', permissions:['all'] });

    await addDoc(COL('users'), { username:'admin', display:'Admin', badge:'ADM-001', password:'admin123', role:'admin', _created:Date.now() });
    await addDoc(COL('users'), { username:'dispatcher', display:'Dispatch', badge:'DISP', password:'dispatch', role:'dispatcher', _created:Date.now() });
    await addDoc(COL('users'), { username:'perety04', display:'Perety 04', badge:'PD-314', password:'peretypass', role:'officer', _created:Date.now() });

    // sample collections
    await addDoc(COL('reports'), { title:'Robo en tienda', description:'Robo con arma blanca. Sospechoso huy√≥.', author:'Admin', _created:Date.now() });
    await addDoc(COL('pda'), { title:'Juan P√©rez', text:'Nombre: Juan P√©rez\nAlias: rata\nDelitos: robo', author:'Admin', _created:Date.now() });
    await addDoc(COL('wanted'), { name:'Mario Rata', description:'Robo coches', bounty:500, _created:Date.now() });
    await addDoc(COL('calls'), { caller:'Civ. X', message:'Disparo', status:'pending', assigned_to:null, _created:Date.now() });
    await addDoc(COL('fines'), { offender:'Veh LSF-021', amount:200, reason:'Exceso velocidad', author:'Admin', _created:Date.now() });
    await addDoc(COL('logs'), { msg:'Seed inicial creada', t:Date.now() });
    console.log('Seed done');
  }
}

/* =============== Utility UI helpers =============== */
function uid(short='id'){ return short+'_'+Math.random().toString(36).slice(2,9); }
function formatDate(ts){ try{ return new Date(ts).toLocaleString(); }catch(e){ return ''; } }
function pushLog(msg){
  // push to logs collection (only if logged in)
  const payload = { msg: msg, t: Date.now(), actor: STATE.currentUser ? STATE.currentUser.username : 'Invitado' };
  // If not logged, still allow adding logs? We'll require logged in
  if(!STATE.currentUser) return;
  addDoc(COL('logs'), payload).catch(()=>{ /* ignore */ });
}

/* =============== Render main cards =============== */
const CARDS = [
  {id:'pda', title:'PDA / Fichas', desc:'Buscar y crear fichas PDA', icon:'üîç'},
  {id:'calls', title:'Dispatch / Llamadas', desc:'Crear/Asignar llamadas 911', icon:'üìû'},
  {id:'reports', title:'Informes', desc:'Crear informes oficiales', icon:'üìë'},
  {id:'wanted', title:'BOLO / Wanted', desc:'Fichas de buscados', icon:'üö®'},
  {id:'fines', title:'Multas', desc:'Generar sanciones', icon:'üí∏'},
  {id:'service', title:'Servicio', desc:'Ponerse en servicio / Fuera', icon:'üü¢'},
  {id:'admin', title:'Administraci√≥n', desc:'Usuarios y roles (admin)', icon:'‚öôÔ∏è'},
  {id:'logs', title:'Auditor√≠a', desc:'Historial de acciones', icon:'üìú'},
  {id:'tools', title:'Herramientas', desc:'Exportar / Importar datos', icon:'üß∞'}
];

function renderCards(){
  cardsRoot.innerHTML = '';
  CARDS.forEach(c=>{
    const el = document.createElement('div'); el.className='card'; el.dataset.id = c.id;
    el.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
      <div><div class="title">${c.title}</div><div class="desc">${c.desc}</div></div>
      <div class="icon">${c.icon}</div>
    </div>
    <div class="cta" style="display:flex;justify-content:space-between;align-items:center">
      <div class="muted tiny">Acci√≥n r√°pida</div>
      <div><button class="btn-ghost" data-open="${c.id}">Abrir</button></div>
    </div>`;
    el.onclick = ()=> openCard(c.id);
    el.querySelector('button[data-open]').onclick = (e)=>{ e.stopPropagation(); openCard(c.id); };
    cardsRoot.appendChild(el);
  });
}

/* =============== Open card => render expanded content =============== */
function openCard(id){
  STATE.expanded = id;
  expandedRoot.innerHTML = '';
  const panel = document.createElement('div'); panel.className='expanded';
  if(id==='pda') renderPDA(panel);
  else if(id==='calls') renderCalls(panel);
  else if(id==='reports') renderReports(panel);
  else if(id==='wanted') renderWanted(panel);
  else if(id==='fines') renderFines(panel);
  else if(id==='service') renderService(panel);
  else if(id==='admin') renderAdmin(panel);
  else if(id==='logs') renderLogs(panel);
  else if(id==='tools') renderTools(panel);
  expandedRoot.appendChild(panel);
  window.scrollTo({ top: panel.offsetTop-20, behavior:'smooth' });
}

/* ================= PDA ================= */
async function renderPDA(container){
  const templatesSnap = await getDocs(COL('templates').withConverter?.()); // just try to avoid errors if no templates collection
  container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
    <div><strong>PDA / Lookup</strong><div class="muted small">Buscar personas, placas y fichas</div></div>
    <div><button class="btn btn-small" id="closeX">Cerrar</button></div>
  </div>
  <div style="margin-top:12px;display:grid;grid-template-columns:1fr 360px;gap:12px">
    <div>
      <input id="pdaQ" placeholder="Buscar por nombre, usuario o placa..." />
      <div id="pdaRes" style="margin-top:12px"></div>
    </div>
    <div>
      <div class="muted small">Crear nueva ficha (plantilla)</div>
      <textarea id="pdaTpl" placeholder="Plantilla...">Nombre: {{name}}\nAlias: {{alias}}\nNotas: {{notes}}</textarea>
      <div style="display:flex;gap:8px;margin-top:8px"><button id="createPDA" class="btn">Crear ficha</button><button id="clearPDA" class="btn-ghost">Limpiar</button></div>
    </div>
  </div>`;
  container.querySelector('#closeX').onclick = ()=> closeExpanded();
  container.querySelector('#pdaQ').oninput = ()=> searchPDA(document.getElementById('pdaQ').value);
  container.querySelector('#createPDA').onclick = createPDA;
  loadPDAResults();

  // realtime listener
  onSnapshot(COL('pda'), snap => loadPDAResults());
}
function loadPDAResults(){
  const res = document.getElementById('pdaRes');
  if(!res) return;
  getDocs(COL('pda')).then(snap=>{
    const arr = []; snap.forEach(d=> arr.push({id:d.id, ...d.data()}));
    if(!arr.length){ res.innerHTML = '<div class="muted small">Sin fichas</div>'; return; }
    res.innerHTML = arr.map(p=>`<div class="item"><div style="flex:1"><b>${p.title||'Ficha'}</b><div class="muted small">${(p.text||'').slice(0,140)}</div></div>
      <div><button class="btn-ghost" data-id="${p.id}" data-act="view">Ver</button> <button class="btn-ghost" data-id="${p.id}" data-act="del">Borrar</button></div></div>`).join('');
    // attach
    res.querySelectorAll('button[data-act="view"]').forEach(b=> b.onclick = (e)=>{ const id=b.dataset.id; viewPDA(id); });
    res.querySelectorAll('button[data-act="del"]').forEach(b=> b.onclick = async (e)=>{ if(!confirm('Borrar ficha?')) return; if(!STATE.currentUser){ alert('Inicia sesi√≥n'); return; } await deleteDoc(doc(db,'pda',b.dataset.id)); pushLog(`Ficha PDA ${b.dataset.id} borrada`); loadPDAResults(); });
  });
}
async function searchPDA(q){
  q=(q||'').toLowerCase().trim();
  const res = document.getElementById('pdaRes');
  if(!res) return;
  const snap = await getDocs(COL('pda'));
  const arr = []; snap.forEach(d=>{ const data=d.data(); if((data.text||'').toLowerCase().includes(q) || (data.title||'').toLowerCase().includes(q)) arr.push({id:d.id,...data}); });
  if(!arr.length){ res.innerHTML = '<div class="muted small">No hay resultados</div>'; return; }
  res.innerHTML = arr.map(p=>`<div class="item"><div style="flex:1"><b>${p.title||'Ficha'}</b><div class="muted small">${(p.text||'').slice(0,140)}</div></div>
    <div><button class="btn-ghost" data-id="${p.id}" data-act="view">Ver</button> <button class="btn-ghost" data-id="${p.id}" data-act="del">Borrar</button></div></div>`).join('');
  res.querySelectorAll('button[data-act="view"]').forEach(b=> b.onclick = ()=> viewPDA(b.dataset.id));
  res.querySelectorAll('button[data-act="del"]').forEach(b=> b.onclick = async ()=>{ if(!confirm('Borrar ficha?')) return; if(!STATE.currentUser){ alert('Inicia sesi√≥n'); return; } await deleteDoc(doc(db,'pda',b.dataset.id)); pushLog(`Ficha PDA ${b.dataset.id} borrada`); loadPDAResults(); });
}
async function createPDA(){
  if(!STATE.currentUser){ alert('Inicia sesi√≥n'); return; }
  const txt = document.getElementById('pdaTpl').value.trim();
  if(!txt) return alert('Plantilla vac√≠a');
  const title = (txt.split('\n')[0]||'Ficha').replace('Nombre:','').trim();
  await addDoc(COL('pda'), { title, text:txt, author: STATE.currentUser.display, created_at:Date.now() });
  pushLog(`Ficha PDA creada: ${title}`);
  document.getElementById('pdaTpl').value='';
  loadPDAResults();
}
async function viewPDA(id){
  const d = await getDoc(doc(db,'pda',id));
  if(!d.exists()) return alert('No encontrado');
  const p = d.data();
  alert(`Ficha: ${p.title}\n\n${p.text}\n\nAutor: ${p.author}\nCreada: ${formatDate(p.created_at)}`);
}

/* ================= Calls / Dispatch ================= */
async function renderCalls(container){
  container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
    <div><strong>Dispatch / Llamadas</strong><div class="muted small">Crear llamadas y asignar unidades</div></div>
    <div><button class="btn btn-small" id="closeC">Cerrar</button></div>
  </div>
  <div style="margin-top:12px;display:flex;gap:8px">
    <input id="callFrom" placeholder="Remitente (opcional)"/>
    <input id="callMsg" placeholder="Mensaje"/>
    <select id="assignTo"><option value="">Asignar a...</option></select>
    <button id="callCreate" class="btn">Crear llamada</button>
  </div>
  <div style="margin-top:12px"><strong>Llamadas</strong><div id="callsList" class="list" style="margin-top:8px"></div></div>`;
  container.querySelector('#closeC').onclick = ()=> closeExpanded();
  container.querySelector('#callCreate').onclick = createCall;
  // update assignTo with users in service
  onSnapshot(COL('onDuty'), snap=> loadAssignOptions());
  onSnapshot(COL('calls'), snap=> loadCalls());
  loadAssignOptions();
  loadCalls();
}
async function loadAssignOptions(){
  const sel = document.getElementById('assignTo');
  if(!sel) return;
  sel.innerHTML = '<option value="">Sin asignar</option>';
  // onDuty is stored as documents where id==userid with {active:true, name}
  const s = await getDocs(COL('onDuty'));
  s.forEach(d=>{
    const data = d.data();
    if(data.active) sel.innerHTML += `<option value="${d.id}">${data.display||d.id}</option>`;
  });
}
async function createCall(){
  if(!STATE.currentUser){ alert('Inicia sesi√≥n para crear llamadas'); return; }
  const caller = document.getElementById('callFrom').value.trim() || 'Anonimo';
  const message = document.getElementById('callMsg').value.trim();
  const assign = document.getElementById('assignTo').value || null;
  if(!message) return alert('Introduce un mensaje');
  await addDoc(COL('calls'), { caller, message, status:'pending', assigned_to: assign, created_at:Date.now(), author: STATE.currentUser.display });
  pushLog(`Llamada creada por ${caller}`);
  document.getElementById('callMsg').value=''; document.getElementById('callFrom').value='';
}
async function loadCalls(){
  const list = document.getElementById('callsList'); if(!list) return;
  const snap = await getDocs(COL('calls'));
  const arr=[]; snap.forEach(d=> arr.push({id:d.id,...d.data()}));
  if(!arr.length){ list.innerHTML = '<div class="muted small">No hay llamadas</div>'; return; }
  list.innerHTML = '';
  arr.sort((a,b)=> b.created_at - a.created_at);
  arr.forEach(c=>{
    const el = document.createElement('div'); el.className='item';
    el.innerHTML = `<div style="flex:1"><div style="font-weight:700">${c.caller}</div><div class="muted small">${c.message}</div></div>
      <div style="text-align:right"><div class="muted tiny">${formatDate(c.created_at)}</div><div style="margin-top:8px" class="muted tiny">Asig: ${c.assigned_to || '‚Äî'}</div></div>`;
    const btns = document.createElement('div'); btns.style.marginLeft='12px';
    // If dispatcher/admin allow assigning to any on-duty user
    if(STATE.currentUser && (STATE.currentUser.role==='dispatcher' || STATE.currentUser.role==='admin')){
      const assignBtn = document.createElement('button'); assignBtn.className='btn-ghost'; assignBtn.textContent='Asignar';
      assignBtn.onclick = ()=> openAssignDialog(c.id);
      btns.appendChild(assignBtn);
    }
    if(STATE.currentUser && (STATE.currentUser.role==='admin' || (c.assigned_to && STATE.currentUser.id===c.assigned_to))){
      const del = document.createElement('button'); del.className='btn'; del.style.marginLeft='6px'; del.textContent='Borrar';
      del.onclick = async ()=>{ if(confirm('Borrar llamada?')){ await deleteDoc(doc(db,'calls',c.id)); pushLog(`Llamada ${c.id} borrada`); loadCalls(); } };
      btns.appendChild(del);
    }
    el.appendChild(btns);
    list.appendChild(el);
  });
}
function openAssignDialog(callId){
  // simple prompt listing on-duty users
  getDocs(COL('onDuty')).then(snap=>{
    const options = []; snap.forEach(d=>{ const data=d.data(); if(data.active) options.push({id:d.id, display:data.display||d.id}); });
    if(!options.length) return alert('No hay unidades en servicio');
    const names = options.map(o=>`${o.id}: ${o.display}`).join('\n');
    const pick = prompt('Elige ID de unidad en servicio:\n'+names);
    if(!pick) return;
    updateDoc(doc(db,'calls',callId), { assigned_to: pick, status:'assigned' }).then(()=>{ pushLog(`Llamada ${callId} asignada a ${pick}`); });
  });
}

/* ================= Reports (informes) - full panel ================= */
async function renderReports(container){
  container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
    <div><strong>Informes</strong><div class="muted small">Crear y consultar informes</div></div>
    <div><button class="btn btn-small" id="closeR">Cerrar</button></div>
  </div>
  <div style="margin-top:12px;display:grid;grid-template-columns:1fr 360px;gap:12px">
    <div>
      <div class="muted small">Buscar</div>
      <input id="repQ" placeholder="Buscar por t√≠tulo..." />
      <div id="reportsList" class="list" style="margin-top:8px"></div>
    </div>
    <div>
      <div class="muted small">Plantilla (editable)</div>
      <textarea id="tplReport">T√≠tulo: {{title}}\nHechos: {{facts}}\nAcciones: {{actions}}\nOficial: {{author}}</textarea>
      <input id="repTitle" placeholder="T√≠tulo" style="margin-top:8px"/>
      <input id="repAuthor" placeholder="Autor (auto)" />
      <textarea id="repDesc" placeholder="Descripci√≥n..." style="margin-top:8px"></textarea>
      <div style="display:flex;gap:8px;margin-top:8px"><button id="saveRep" class="btn">Guardar informe</button><button id="clearRep" class="btn-ghost">Limpiar</button></div>
    </div>
  </div>`;
  container.querySelector('#closeR').onclick = ()=> closeExpanded();
  document.getElementById('repAuthor').value = STATE.currentUser ? STATE.currentUser.display : 'Invitado';
  document.getElementById('saveRep').onclick = saveReport;
  document.getElementById('clearRep').onclick = ()=>{ document.getElementById('repTitle').value=''; document.getElementById('repDesc').value=''; };
  document.getElementById('repQ').oninput = ()=> loadReports(document.getElementById('repQ').value);
  onSnapshot(COL('reports'), snap=> loadReports(document.getElementById('repQ').value));
  loadReports('');
}
async function saveReport(){
  if(!STATE.currentUser){ alert('Inicia sesi√≥n para crear informes'); return; }
  const title = document.getElementById('repTitle').value.trim();
  const desc = document.getElementById('repDesc').value.trim();
  if(!title || !desc){ alert('T√≠tulo y descripci√≥n obligatorios'); return; }
  await addDoc(COL('reports'), { title, description: desc, author: STATE.currentUser.display, created_at:Date.now() });
  // optionally save template
  pushLog(`Informe creado: ${title}`);
  document.getElementById('repTitle').value=''; document.getElementById('repDesc').value='';
}
async function loadReports(q){
  const list = document.getElementById('reportsList'); if(!list) return;
  const snap = await getDocs(COL('reports'));
  const arr=[]; snap.forEach(d=> arr.push({id:d.id, ...d.data()}));
  const filtered = (q||'').trim() ? arr.filter(r=> (r.title||'').toLowerCase().includes(q.toLowerCase())) : arr;
  if(!filtered.length){ list.innerHTML='<div class="muted small">No hay informes</div>'; return; }
  list.innerHTML='';
  filtered.sort((a,b)=> b.created_at - a.created_at);
  filtered.forEach(r=>{
    const it = document.createElement('div'); it.className='item';
    it.innerHTML = `<div style="flex:1"><div style="font-weight:700">${r.title}</div><div class="muted small">${(r.description||'').slice(0,160)}</div></div>
      <div style="text-align:right"><div class="muted tiny">${formatDate(r.created_at)}</div><div style="margin-top:6px" class="muted tiny">${r.author||''}</div></div>`;
    const btns = document.createElement('div'); btns.style.marginLeft='12px';
    const view = document.createElement('button'); view.className='btn-ghost'; view.textContent='Ver';
    view.onclick = ()=> alert(`Informe ‚Äî ${r.title}\n\n${r.description}\n\nAutor: ${r.author}\nFecha: ${formatDate(r.created_at)}`);
    btns.appendChild(view);
    if(STATE.currentUser && (STATE.currentUser.role==='admin' || STATE.currentUser.role==='sergeant')){
      const del = document.createElement('button'); del.className='btn'; del.style.marginLeft='6px'; del.textContent='Borrar'; del.onclick = async ()=>{ if(confirm('Borrar informe?')){ await deleteDoc(doc(db,'reports',r.id)); pushLog(`Informe ${r.id} borrado`); } };
      btns.appendChild(del);
    }
    it.appendChild(btns);
    list.appendChild(it);
  });
}

/* ================= Wanted / BOLO ================= */
async function renderWanted(container){
  container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
    <div><strong>BOLO / Wanted</strong><div class="muted small">Crear y gestionar fichas buscadas</div></div>
    <div><button class="btn btn-small" id="closeW">Cerrar</button></div>
  </div>
  <div style="margin-top:12px" class="form-row">
    <input id="wName" placeholder="Nombre / Alias"/>
    <input id="wBounty" placeholder="Recompensa"/>
  </div>
  <div style="margin-top:8px"><textarea id="wDesc" placeholder="Descripci√≥n"></textarea></div>
  <div style="margin-top:8px;display:flex;gap:8px"><button id="saveW" class="btn">Crear ficha</button></div>
  <div style="margin-top:12px"><strong>Fichas</strong><div id="wantedList" class="list" style="margin-top:8px"></div></div>`;
  container.querySelector('#closeW').onclick = ()=> closeExpanded();
  container.querySelector('#saveW').onclick = createWanted;
  onSnapshot(COL('wanted'), snap=> loadWanted());
  loadWanted();
}
async function createWanted(){ if(!STATE.currentUser){ alert('Inicia sesi√≥n'); return; }
  const name=document.getElementById('wName').value.trim(); const desc=document.getElementById('wDesc').value.trim(); const bounty=parseInt(document.getElementById('wBounty').value||'0',10);
  if(!name){ alert('Nombre requerido'); return; }
  await addDoc(COL('wanted'), { name, description:desc, bounty, created_at:Date.now(), author:STATE.currentUser.display });
  pushLog(`Wanted creado: ${name}`); document.getElementById('wName').value=''; document.getElementById('wDesc').value=''; document.getElementById('wBounty').value=''; 
}
async function loadWanted(){ const list=document.getElementById('wantedList'); if(!list) return; const snap=await getDocs(COL('wanted')); const arr=[]; snap.forEach(d=>arr.push({id:d.id,...d.data()})); if(!arr.length){ list.innerHTML='<div class="muted small">No hay fichas</div>'; return; } list.innerHTML=''; arr.sort((a,b)=> b.created_at - a.created_at); arr.forEach(w=>{ const it=document.createElement('div'); it.className='item'; it.innerHTML = `<div style="flex:1"><b>${w.name}</b><div class="muted small">${w.description}</div></div><div class="pill">${w.bounty||0}‚Ç¨</div>`; const btns=document.createElement('div'); btns.style.marginLeft='12px'; const view=document.createElement('button'); view.className='btn-ghost'; view.textContent='Ver'; view.onclick=()=> alert(`Wanted ‚Äî ${w.name}\n\n${w.description}\nRecompensa: ${w.bounty}‚Ç¨`); btns.appendChild(view); if(STATE.currentUser && (STATE.currentUser.role==='sergeant' || STATE.currentUser.role==='admin')){ const del=document.createElement('button'); del.className='btn'; del.style.marginLeft='6px'; del.textContent='Borrar'; del.onclick=async()=>{ if(confirm('Borrar ficha?')){ await deleteDoc(doc(db,'wanted',w.id)); pushLog(`Wanted ${w.id} borrado`); } }; btns.appendChild(del); } it.appendChild(btns); list.appendChild(it); }); }

/* ================= Fines ================= */
async function renderFines(container){
  container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
    <div><strong>Multas</strong><div class="muted small">Genera sanciones y multas</div></div>
    <div><button class="btn btn-small" id="closeF">Cerrar</button></div>
  </div>
  <div style="margin-top:12px" class="form-row"><input id="fineOff" placeholder="Infractor (nombre/veh√≠culo)"/><input id="fineAmt" placeholder="Importe"/></div>
  <div style="margin-top:8px"><textarea id="fineReason" placeholder="Motivo..."></textarea></div>
  <div style="margin-top:8px;display:flex;gap:8px"><button id="saveFine" class="btn">Emitir multa</button></div>
  <div style="margin-top:12px"><strong>Multas</strong><div id="finesList" class="list" style="margin-top:8px"></div></div>`;
  container.querySelector('#closeF').onclick = ()=> closeExpanded();
  document.getElementById('saveFine').onclick = saveFine;
  onSnapshot(COL('fines'), snap=> loadFines());
  loadFines();
}
async function saveFine(){ if(!STATE.currentUser){ alert('Inicia sesi√≥n'); return; }
  const off=document.getElementById('fineOff').value.trim(); const amt=parseInt(document.getElementById('fineAmt').value||'0',10); const reason=document.getElementById('fineReason').value.trim();
  if(!off || !amt){ alert('Infractor e importe requeridos'); return; }
  await addDoc(COL('fines'), { offender:off, amount:amt, reason, author:STATE.currentUser.display, created_at:Date.now() });
  pushLog(`Multa creada: ${off} ${amt}‚Ç¨`);
}

/* ================= Service (on duty) ================= */
async function renderService(container){
  container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
    <div><strong>Servicio</strong><div class="muted small">Ponte en servicio o sal</div></div>
    <div><button class="btn btn-small" id="closeS">Cerrar</button></div>
  </div>
  <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
    <div class="muted small">Estado actual:</div><div id="serviceBox" class="pill">Desconocido</div>
    <div style="margin-left:auto"><button id="toggleDuty" class="btn">Cambiar estado</button></div>
  </div>
  <div style="margin-top:12px"><strong>Polic√≠as en servicio</strong><div id="dutyList" class="list" style="margin-top:8px"></div></div>`;
  container.querySelector('#closeS').onclick = ()=> closeExpanded();
  const box = container.querySelector('#serviceBox');
  const on = getDocs(COL('onDuty')).then(snap=>{
    const map = {};
  });
  // set UI initial
  const uId = STATE.currentUser ? STATE.currentUser.id : null;
  const serviceBox = container.querySelector('#serviceBox');
  // toggle duty
  container.querySelector('#toggleDuty').onclick = async ()=>{
    if(!STATE.currentUser){ alert('Inicia sesi√≥n'); return; }
    const docRef = doc(db,'onDuty', STATE.currentUser.id);
    // fetch doc
    const existing = await getDoc(docRef);
    if(existing.exists()){
      const cur = existing.data();
      await setDoc(docRef, { active: !cur.active, display: STATE.currentUser.display, updated_at: Date.now() });
    } else {
      await setDoc(docRef, { active: true, display: STATE.currentUser.display, updated_at: Date.now() });
    }
    pushLog(`${STATE.currentUser.display} cambi√≥ estado de servicio`);
    loadDutyList();
  };
  onSnapshot(COL('onDuty'), snap=> loadDutyList());
  loadDutyList();
}
async function loadDutyList(){
  const list = document.getElementById('dutyList'); if(!list) return;
  const snap = await getDocs(COL('onDuty'));
  const active = [];
  snap.forEach(d=>{ const data = d.data(); if(data.active) active.push({id:d.id, display:data.display}); });
  list.innerHTML = active.map(a=>`<div class="item">${a.display}</div>`).join('') || '<div class="muted small">Nadie en servicio</div>';
  dutyStatus.textContent = `En servicio: ${active.length}`;
}

/* ================= Admin panel ================= */
async function renderAdmin(container){
  // only visible to admin or comisario
  if(!STATE.currentUser || !(STATE.currentUser.role==='admin' || STATE.currentUser.role==='comisario')){
    container.innerHTML = `<div><strong>Administraci√≥n</strong><div class="muted small">Acceso restringido (solo admin/comisario)</div></div>`;
    return;
  }
  container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
    <div><strong>Administraci√≥n</strong><div class="muted small">Gestiona roles, permisos y usuarios</div></div>
    <div><button class="btn btn-small" id="closeA">Cerrar</button></div>
  </div>
  <div style="margin-top:12px;display:flex;gap:12px">
    <div style="flex:1">
      <h4>Usuarios</h4>
      <div id="usersAdminList" class="list"></div>
    </div>
    <div style="width:360px">
      <h4>Crear usuario</h4>
      <input id="adm_newUser" placeholder="username"><input id="adm_newDisplay" placeholder="display"><input id="adm_newPass" placeholder="password">
      <select id="adm_newRole"></select>
      <div style="display:flex;gap:8px;margin-top:8px"><button id="adm_createUser" class="btn">Crear</button><button id="adm_refresh" class="btn-ghost">Refrescar</button></div>
      <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.03)">
      <h4>Roles</h4>
      <div style="display:flex;gap:8px"><input id="adm_newRoleName" placeholder="nuevo rol"><button id="adm_createRole" class="btn">Crear rol</button></div>
      <div id="rolesAdminList" style="margin-top:12px"></div>
    </div>
  </div>`;
  container.querySelector('#closeA').onclick = ()=> closeExpanded();
  document.getElementById('adm_createUser').onclick = adminCreateUser;
  document.getElementById('adm_refresh').onclick = ()=> renderAdmin(container);
  document.getElementById('adm_createRole').onclick = adminCreateRole;
  loadRolesForSelect();
  loadUsersAdmin();
  onSnapshot(COL('users'), snap=> loadUsersAdmin());
  onSnapshot(COL('roles'), snap=> loadRolesAdmin());
}
async function loadRolesForSelect(){
  const sel = document.getElementById('adm_newRole');
  if(!sel) return;
  const snap = await getDocs(COL('roles'));
  sel.innerHTML = snap.docs.map(d=>`<option value="${d.data().key||d.id}">${d.data().name||d.data().key||d.id}</option>`).join('');
}
async function loadUsersAdmin(){
  const ul = document.getElementById('usersAdminList'); if(!ul) return;
  const snap = await getDocs(COL('users'));
  if(!snap.size){ ul.innerHTML = '<div class="muted small">No hay usuarios</div>'; return; }
  ul.innerHTML = '';
  snap.forEach(d=>{
    const u = d.data(); const uid = d.id;
    const div = document.createElement('div'); div.className='item';
    div.innerHTML = `<div><b>${u.display||u.username} (${u.username})</b><div class="muted small">Rol: <span class="role-chip">${u.role||''}</span> ‚Ä¢ Badge: ${u.badge||'‚Äî'}</div></div>
      <div style="text-align:right">
        <select data-uid="${uid}" class="adm_role_sel"></select>
        <div style="margin-top:6px"><button class="btn-ghost btn-small" data-uid="${uid}" data-act="del">Borrar</button> <button class="btn btn-small" data-uid="${uid}" data-act="imp">Impersonar</button></div>
      </div>`;
    ul.appendChild(div);
  });
  // fill role selects
  ul.querySelectorAll('.adm_role_sel').forEach(async sel=>{
    const uid = sel.dataset.uid;
    const rolesSnap = await getDocs(COL('roles'));
    sel.innerHTML = rolesSnap.docs.map(r=>`<option value="${r.data().key||r.id}">${r.data().name||r.data().key||r.id}</option>`).join('');
    // set value to user's current role
    const usersSnap = await getDocs(COL('users'));
    usersSnap.forEach(uDoc=>{
      if(uDoc.id===sel.dataset.uid){
        sel.value = uDoc.data().role || '';
      }
    });
    sel.onchange = async (e)=> changeUserRole(uid, e.target.value);
  });
  // attach delete/impersonate
  ul.querySelectorAll('button[data-act="del"]').forEach(b=> b.onclick = async ()=>{
    const uid = b.dataset.uid;
    if(!confirm('Borrar usuario?')) return;
    // prevent deleting seed admin? not necessary
    await deleteDoc(doc(db,'users',uid));
    pushLog(`Usuario borrado: ${uid}`);
  });
  ul.querySelectorAll('button[data-act="imp"]').forEach(b=> b.onclick = async ()=>{
    const uid = b.dataset.uid;
    const ud = await getDoc(doc(db,'users',uid));
    if(!ud.exists()) return alert('Usuario no existe');
    const u = ud.data(); // impersonate locally
    STATE.currentUser = { id: uid, ...u };
    localStorage.setItem('pda_currentUser', JSON.stringify(STATE.currentUser));
    updateHeader();
    pushLog(`Impersonaci√≥n: ${u.username}`);
    alert('Ahora eres: '+u.display);
  });
}
async function changeUserRole(uid,newRole){
  if(!STATE.currentUser || STATE.currentUser.role!=='admin'){ alert('Solo admin puede cambiar roles'); return; }
  await updateDoc(doc(db,'users',uid), { role: newRole });
  pushLog(`Rol cambiado: ${uid} -> ${newRole}`);
}
async function adminCreateUser(){
  if(!STATE.currentUser || STATE.currentUser.role!=='admin'){ alert('Solo admin puede crear usuarios'); return; }
  const username=document.getElementById('adm_newUser').value.trim(); const display=document.getElementById('adm_newDisplay').value.trim()||username; const pass=document.getElementById('adm_newPass').value.trim()||'1234'; const role=document.getElementById('adm_newRole').value;
  if(!username) return alert('username requerido');
  await addDoc(COL('users'), { username, display, badge:'', password:pass, role });
  pushLog(`Usuario admin creado: ${username}`);
}
async function adminCreateRole(){
  if(!STATE.currentUser || STATE.currentUser.role!=='admin'){ alert('Solo admin puede crear roles'); return; }
  const name=document.getElementById('adm_newRoleName').value.trim(); if(!name) return alert('Nombre rol requerido');
  // store with key = name normalized
  const key = name.toLowerCase().replace(/\s+/g,'_');
  await addDoc(COL('roles'), { key, name, color:'#999999', permissions:[] });
  pushLog(`Rol creado: ${key}`);
}
async function loadRolesAdmin(){
  const out = document.getElementById('rolesAdminList'); if(!out) return;
  const snap = await getDocs(COL('roles'));
  out.innerHTML = '';
  snap.forEach(d=>{
    const r = d.data(); const key = r.key||d.id;
    const div = document.createElement('div'); div.className='item';
    div.innerHTML = `<div style="flex:1"><b>${key}</b><div class="muted small">Permisos: ${(r.permissions||[]).join(', ') || 'Sin permisos'}</div></div>
      <div style="text-align:right"><button class="btn-ghost" data-role="${d.id}" data-act="edit">Editar</button> <button class="btn" data-role="${d.id}" data-act="del">Borrar</button></div>`;
    out.appendChild(div);
  });
  // attach edit/del
  out.querySelectorAll('button[data-act="edit"]').forEach(b=> b.onclick = ()=> openRoleEditor(b.dataset.role));
  out.querySelectorAll('button[data-act="del"]').forEach(b=> b.onclick = async ()=>{
    const roleDoc = b.dataset.role;
    if(!confirm('Borrar rol? (Los usuarios con este rol quedar√°n sin rol)')) return;
    await deleteDoc(doc(db,'roles',roleDoc));
    // strip role from users who had it
    const usersSnap = await getDocs(COL('users'));
    usersSnap.forEach(async uDoc=>{ if(uDoc.data().role=== (await getDoc(doc(db,'roles',roleDoc))).data()?.key || roleDoc){ await updateDoc(doc(db,'users',uDoc.id), { role: '' }).catch(()=>{}); }});
    pushLog(`Rol borrado: ${roleDoc}`);
  });
}
function openRoleEditor(roleDocId){
  // fetch role data
  getDoc(doc(db,'roles',roleDocId)).then(rdoc=>{
    if(!rdoc.exists()) return alert('Rol no encontrado');
    const r = rdoc.data();
    const modal = document.createElement('div'); modal.className='overlay';
    modal.innerHTML = `<div class="modal"><h3>Editar rol: ${r.key||roleDocId}</h3><div class="muted small">Marca los permisos</div><div id="permChecks" style="margin-top:12px"></div><div style="display:flex;gap:8px;margin-top:12px"><button id="saveRole" class="btn">Guardar</button><button id="cancelRole" class="btn-ghost">Cancelar</button></div></div>`;
    document.body.appendChild(modal);
    const perms = ['create_reports','delete_reports','create_pda','create_call','assign_call','create_bolo','manage_wanted','create_fine','export','all'];
    const box = modal.querySelector('#permChecks');
    box.innerHTML = perms.map(p=>`<div style="margin-bottom:6px"><label><input type="checkbox" data-perm="${p}" ${ (r.permissions||[]).includes(p) ? 'checked' : '' }/> ${p}</label></div>`).join('');
    modal.querySelector('#cancelRole').onclick = ()=> modal.remove();
    modal.querySelector('#saveRole').onclick = async ()=>{
      const checked = Array.from(box.querySelectorAll('input[type=checkbox]:checked')).map(i=>i.dataset.perm);
      await updateDoc(doc(db,'roles',roleDocId), { permissions: checked });
      pushLog(`Rol editado: ${r.key||roleDocId}`);
      modal.remove();
    };
  });
}

/* ================= Logs / Tools ================= */
function renderLogs(container){
  if(!container){ expandedRoot.innerHTML=''; const panel=document.createElement('div'); panel.className='expanded'; renderLogs(panel); expandedRoot.appendChild(panel); return; }
  container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>Auditor√≠a</strong><div class="muted small">√öltimas acciones</div></div><div><button class="btn btn-small" id="closeL">Cerrar</button></div></div>
    <div style="margin-top:12px" id="logsList" class="list"></div>`;
  container.querySelector('#closeL').onclick = ()=> closeExpanded();
  // only show logs if admin or comisario
  if(!STATE.currentUser || !(STATE.currentUser.role==='admin' || STATE.currentUser.role==='comisario')){
    container.querySelector('#logsList').innerHTML = '<div class="muted small">Acceso restringido</div>'; return;
  }
  onSnapshot(COL('logs'), snap=>{
    const list = container.querySelector('#logsList'); list.innerHTML = '';
    const arr = []; snap.forEach(d=> arr.push({id:d.id, ...d.data()}));
    arr.sort((a,b)=> b.t - a.t);
    arr.slice(0,200).forEach(l=>{
      const it = document.createElement('div'); it.className='item';
      it.innerHTML = `<div><div style="font-weight:700">${l.msg}</div><div class="muted small">${l.actor||''} ‚Ä¢ ${formatDate(l.t)}</div></div>`;
      list.appendChild(it);
    });
  });
}
function renderTools(container){
  container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>Herramientas</strong><div class="muted small">Exportar / Importar</div></div><div><button class="btn btn-small" id="closeT">Cerrar</button></div></div>
    <div style="margin-top:12px;display:flex;gap:8px"><button id="doExport" class="btn">Exportar JSON</button><button id="doImport" class="btn-ghost">Importar JSON</button><button id="doClear" class="btn-ghost">Borrar todo</button></div>
    <input id="importFile" type="file" accept=".json" style="display:none" />`;
  container.querySelector('#closeT').onclick = ()=> closeExpanded();
  container.querySelector('#doExport').onclick = exportAll;
  container.querySelector('#doImport').onclick = ()=> document.getElementById('importFile').click();
  container.querySelector('#doClear').onclick = async ()=>{ if(!confirm('Borrar todos los datos de Firestore (colecciones usadas)?')) return; alert('Esta operaci√≥n debe realizarse manualmente en Firebase Console o con scripts.'); };
  document.getElementById('importFile').onchange = importFile;
}
async function exportAll(){
  if(!STATE.currentUser){ alert('Inicia sesi√≥n'); return; }
  // read all main collections and offer download
  const collections = ['users','roles','templates','reports','wanted','calls','pda','fines','logs','onDuty'];
  const out = {};
  for(const c of collections){
    const snap = await getDocs(COL(c));
    out[c] = []; snap.forEach(d=> out[c].push({ id: d.id, ...d.data() }));
  }
  const blob = new Blob([JSON.stringify(out,null,2)], { type:'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = `pda_export_${Date.now()}.json`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  pushLog('Exportado datos');
}
function importFile(e){
  const f = e.target.files[0]; if(!f) return;
  const reader = new FileReader();
  reader.onload = async (ev)=>{
    try{
      const data = JSON.parse(ev.target.result);
      if(!confirm('Importar reemplazar√°/a√±adir√° datos en Firestore. Continuar?')) return;
      // Note: import is naive ‚Äî duplicates possible. Use carefully.
      for(const colName in data){
        const arr = data[colName];
        for(const item of arr){
          const copy = { ...item }; delete copy.id;
          await addDoc(COL(colName), copy);
        }
      }
      alert('Importaci√≥n terminada');
      pushLog('Datos importados');
    }catch(err){ alert('JSON inv√°lido'); }
  };
  reader.readAsText(f);
}

/* ============== Login / Register (your modal preserved) ============== */
document.getElementById('btnLogin').onclick = ()=> openLoginModal();
document.getElementById('btnExport').onclick = ()=> exportAll();

function openLoginModal(){ loginModal.classList.remove('hidden'); document.getElementById('loginUser').focus(); }
function closeLoginModal(){ loginModal.classList.add('hidden'); document.getElementById('loginPass').value=''; document.getElementById('loginUser').value=''; document.getElementById('loginError').style.display='none'; }

document.getElementById('guestBtn').onclick = ()=> { STATE.currentUser = null; localStorage.removeItem('pda_currentUser'); updateHeader(); closeLoginModal(); pushLog('Entr√≥ como invitado'); };
document.getElementById('showReg').onclick = ()=> { const b = document.getElementById('registerBlock'); b.classList.toggle('hidden'); };
document.getElementById('regCancel').onclick = ()=> { document.getElementById('registerBlock').classList.add('hidden'); };

document.getElementById('loginBtn').onclick = async ()=>{
  const u = document.getElementById('loginUser').value.trim(); const p = document.getElementById('loginPass').value.trim();
  if(!u || !p) { document.getElementById('loginError').style.display='block'; document.getElementById('loginError').textContent='Usuario y contrase√±a requeridos'; return; }
  // find user in Firestore
  const snap = await getDocs(query(COL('users'), where('username','==',u)));
  let found = null;
  snap.forEach(d=> { found = { id: d.id, ...d.data() }; });
  if(found && found.password === p){
    STATE.currentUser = { id: found.id, username: found.username, display: found.display, role: found.role, badge: found.badge || '' };
    localStorage.setItem('pda_currentUser', JSON.stringify(STATE.currentUser));
    updateHeader(); closeLoginModal(); pushLog(`Sesi√≥n iniciada: ${found.username}`); alert('Sesi√≥n iniciada: ' + found.display);
  } else {
    document.getElementById('loginError').style.display='block'; document.getElementById('loginError').textContent='Usuario o contrase√±a incorrectos';
  }
};

document.getElementById('regCreate').onclick = async ()=>{
  const username = document.getElementById('regUser').value.trim();
  const display = document.getElementById('regName').value.trim() || username;
  const pass = document.getElementById('regPass').value.trim() || '1234';
  const role = document.getElementById('regRole').value;
  if(!username){ document.getElementById('regMsg').textContent='Usuario requerido'; return; }
  const exists = await getDocs(query(COL('users'), where('username','==',username)));
  if(!exists.empty){ document.getElementById('regMsg').textContent='Usuario ya existe'; return; }
  await addDoc(COL('users'), { username, display, badge:'', password:pass, role, _created: Date.now() });
  document.getElementById('regMsg').textContent='Cuenta creada. Inicia sesi√≥n.';
  pushLog(`Cuenta creada: ${username}`);
  document.getElementById('regUser').value=''; document.getElementById('regName').value=''; document.getElementById('regPass').value='';
};

/* ============== Header / helpers ============== */
function closeExpanded(){ STATE.expanded=null; expandedRoot.innerHTML=''; window.scrollTo({top:0,behavior:'smooth'}); }
function updateHeader(){
  // try to restore from localStorage
  if(!STATE.currentUser){
    const raw = localStorage.getItem('pda_currentUser');
    if(raw) STATE.currentUser = JSON.parse(raw);
  }
  if(STATE.currentUser){ userDisplay.textContent = `${STATE.currentUser.display} (${STATE.currentUser.role})`; btnLogin.textContent='Cerrar sesi√≥n'; }
  else { userDisplay.textContent = 'No conectado'; btnLogin.textContent='Iniciar'; }
  // duty count
  getDocs(COL('onDuty')).then(snap => {
    let active = 0; snap.forEach(d=> { if(d.data().active) active++; });
    dutyStatus.textContent = `En servicio: ${active}`;
  });
}
btnLogin.addEventListener('click', ()=>{
  if(STATE.currentUser){ if(confirm('Cerrar sesi√≥n?')){ STATE.currentUser=null; localStorage.removeItem('pda_currentUser'); updateHeader(); pushLog('Sesi√≥n cerrada'); } } else openLoginModal();
});

/* ============== Init ============== */
(async function initUI(){
  await seedIfNeeded();
  renderCards();
  STATE.currentUser = JSON.parse(localStorage.getItem('pda_currentUser')||'null');
  updateHeader();
  // Realtime listeners for cards that are open might be attached when opened
})();
</script>
</body>
</html>
