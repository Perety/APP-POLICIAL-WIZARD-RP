<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Daynight RP ‚Äî PDA / CAD (Firestore only)</title>
<style>
  :root{
    --bg:#071018; --muted:#98a8b0; --accent:#844ffc; --accent2:#6ee7b7;
    --card:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    --glass: rgba(255,255,255,0.03);
    --radius:12px;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;color:#e7eef6;-webkit-font-smoothing:antialiased;background:
      radial-gradient(900px 350px at 10% 10%, rgba(132,79,252,0.04), transparent),
      linear-gradient(180deg, #03121a 0%, var(--bg) 60%);
    position:relative; overflow-x:hidden;
  }

  /* Animated decorative background (police lights) */
  .bg-animated { position:fixed; inset:0; z-index:0; pointer-events:none; }
  .stripe { position:absolute; top:-40%; bottom:-40%; width:42%; transform:skewX(-12deg); filter: blur(40px); opacity:0.12; animation: slide 6s linear infinite; }
  .stripe.left { left:-35%; background: linear-gradient(90deg, rgba(132,79,252,0.9), rgba(132,79,252,0.06)); animation-delay:0s; }
  .stripe.right { right:-35%; background: linear-gradient(90deg, rgba(255,10,10,0.9), rgba(255,10,10,0.06)); animation-direction:reverse; animation-delay:1s; }
  .pulse { position:absolute; bottom:8%; left:50%; transform:translateX(-50%); width:22vmin; height:22vmin; border-radius:50%; background: radial-gradient(circle at 30% 30%, rgba(132,79,252,0.5), transparent 30%), radial-gradient(circle at 70% 70%, rgba(110,231,183,0.28), transparent 25%); filter: blur(30px); animation: pulse 4s ease-in-out infinite; opacity:0.5; }
  @keyframes slide { 0%{ transform:translateX(-40%) skewX(-12deg) } 50%{ transform:translateX(40%) skewX(-12deg) } 100%{ transform:translateX(-40%) skewX(-12deg) } }
  @keyframes pulse { 0%{ transform:translateX(-50%) scale(.92) } 50%{ transform:translateX(-50%) scale(1.08) } 100%{ transform:translateX(-50%) scale(.92) }

  .wrap{max-width:1100px;margin:18px auto;padding:18px;display:grid;grid-template-rows:auto 1fr;gap:14px; position:relative; z-index:1}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent2),var(--accent));display:flex;align-items:center;justify-content:center;font-weight:900;color:#041018; overflow:hidden}
  .logo img{width:100%;height:100%;object-fit:cover;border-radius:10px}
  h1{margin:0;font-size:18px}
  .subtitle{color:var(--muted);font-size:13px}
  .top-right{display:flex;gap:8px;align-items:center}
  .pill{background:rgba(255,255,255,0.03);padding:8px 10px;border-radius:999px;font-weight:700}
  .small{font-size:12px;color:var(--muted)}
  .btn{background:var(--accent);color:#fff;padding:8px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:800}
  .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);padding:7px 10px;border-radius:10px;cursor:pointer}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
  .card{background:var(--card);border-radius:var(--radius);padding:18px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 10px 30px rgba(2,6,10,0.6);cursor:pointer;overflow:hidden;position:relative;display:flex;flex-direction:column;gap:12px;min-height:120px;transition:transform .22s,box-shadow .22s}
  .card:hover{transform:translateY(-6px);box-shadow:0 18px 40px rgba(2,6,10,0.75)}
  .title{font-weight:900;font-size:16px}
  .desc{color:var(--muted);font-size:13px}
  .icon{width:56px;height:56px;border-radius:10px;background:rgba(255,255,255,0.02);display:flex;align-items:center;justify-content:center;font-size:22px}
  .expanded{margin-top:14px;border-radius:var(--radius);padding:18px;background:var(--card);border:1px solid rgba(255,255,255,0.03)}
  .form-row{display:flex;gap:8px}
  input,textarea,select,button{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
  textarea{min-height:110px;resize:vertical}
  .list{display:flex;flex-direction:column;gap:10px}
  .item{padding:10px;border-radius:10px;background:var(--glass);display:flex;justify-content:space-between;align-items:center}
  .muted{color:var(--muted)}
  .tiny{font-size:12px}
  footer{margin-top:18px;text-align:center;color:var(--muted);font-size:13px}
  .overlay{position:fixed;inset:0;background:linear-gradient(rgba(2,6,10,0.6),rgba(2,6,10,0.8));display:flex;align-items:center;justify-content:center;z-index:9999}
  .modal{width:720px;max-width:94%;background:linear-gradient(180deg,#071729,#061421);padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
  .admin-mode-pill{background:linear-gradient(90deg,#ffef00,#ff6b00);color:#041018;padding:6px 10px;border-radius:999px;font-weight:800;cursor:pointer}
  .notif-pill{background:linear-gradient(90deg,#6ee7b7,#844ffc); color:#041018; padding:6px 10px;border-radius:999px; font-weight:800; cursor:pointer; margin-right:4px}
  .radio-messages{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005)); padding:12px; border-radius:10px; max-height:380px; overflow:auto}
  .radio-msg{display:flex;gap:10px;align-items:flex-start}
  .radio-avatar{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:linear-gradient(90deg,var(--accent),var(--accent2));color:#041018;font-weight:800}
  .radio-bubble{padding:10px;border-radius:10px;background:rgba(0,0,0,0.34)}
  .radio-bubble.me{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#041018}
  @media (max-width:980px){ .grid{grid-template-columns:repeat(2,1fr)} .expanded{padding:12px} }
  @media (max-width:640px){ .grid{grid-template-columns:1fr} .form-row{flex-direction:column} .modal{width:94%} }
</style>
</head>
<body>
  <div class="bg-animated" aria-hidden="true">
    <div class="stripe left"></div>
    <div class="stripe right"></div>
    <div class="pulse"></div>
  </div>

  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo"><img id="brandLogo" src="https://cdn.discordapp.com/attachments/1421898595271180360/1425878366116122654/LOGO_WIZARD_FONDO.png.png" alt="Logo"></div>
        <div>
          <h1>Daynight RP ‚Äî PDA / CAD</h1>
          <div class="subtitle">Sin LocalStorage ‚Äî Firestore como √∫nica fuente</div>
        </div>
      </div>

      <div class="top-right">
        <div class="pill small" id="userDisplay">No conectado</div>
        <div class="pill small" id="dutyStatus">En servicio: 0</div>
        <div id="notifWrap" style="display:inline-flex;align-items:center">
          <div id="notifPill" class="notif-pill" style="display:none">Alertas 0</div>
        </div>
        <button id="btnExport" class="btn">Exportar</button>
        <button id="btnLogin" class="btn-ghost">Entrar</button>
        <div id="adminModeWrap" style="display:none">
          <span id="adminModePill" class="admin-mode-pill">Admin: OFF</span>
        </div>
      </div>
    </header>

    <section class="grid" id="cardsRoot"></section>

    <div id="expandedRoot"></div>

    <footer>Hecho para Daynight RP ‚Ä¢ Firestore</footer>
  </div>

  <!-- Login/Register modal -->
  <div id="loginModal" class="overlay" style="display:none">
    <div class="modal">
      <h3>Entrar / Registrar (Firestore)</h3>
      <div class="muted small">Las cuentas y datos est√°n guardados exclusivamente en Firestore.</div>

      <div style="margin-top:12px">
        <label class="muted small">Usuario</label>
        <input id="loginUser" placeholder="usuario"/>
        <label class="muted small" style="margin-top:8px">Contrase√±a</label>
        <input id="loginPass" type="password" placeholder="contrase√±a"/>
        <div style="display:flex;gap:8px;margin-top:12px">
          <button id="loginBtnModal" class="btn">Entrar</button>
          <button id="guestBtn" class="btn-ghost">Invitado (sin sesi√≥n)</button>
          <div style="margin-left:auto" class="small muted">¬øSin cuenta? <span id="showReg" class="link-like" style="cursor:pointer">Crear</span></div>
        </div>
        <div id="loginError" class="muted small" style="margin-top:8px;color:#ff9b9b;display:none"></div>
      </div>

      <div id="registerBlock" style="display:none;margin-top:12px;border-top:1px dashed rgba(255,255,255,0.03);padding-top:12px">
        <h4 style="margin:0 0 8px 0">Crear cuenta</h4>
        <label class="muted small">Nombre visible</label>
        <input id="regName" placeholder="Ej: Ofc. P√©rez"/>
        <label class="muted small">Usuario</label>
        <input id="regUser" placeholder="usuario"/>
        <label class="muted small">Contrase√±a</label>
        <input id="regPass" type="password" placeholder="contrase√±a"/>
        <div style="display:flex;gap:8px;margin-top:8px">
          <select id="regRole">
            <option value="officer">Officer</option>
            <option value="sergeant">Sergeant</option>
            <option value="dispatcher">Dispatcher</option>
            <option value="admin">Admin</option>
          </select>
          <button id="regCreate" class="btn">Crear</button>
          <button id="regCancel" class="btn-ghost">Cancelar</button>
        </div>
        <div id="regMsg" class="muted small" style="margin-top:8px"></div>
      </div>
    </div>
  </div>

  <script type="module">
  // Firestore-only PDA/CAD single-file app
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import {
    getFirestore, collection, getDocs, addDoc, setDoc, doc, deleteDoc, updateDoc,
    onSnapshot, query, where, orderBy, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

  // --- Firebase config (kept from your project) ---
  const firebaseConfig = {
    apiKey: "AIzaSyCskczYgGtlPPBEIZiE5PuY7s_cfE_3Chg",
    authDomain: "wizard-rp.firebaseapp.com",
    projectId: "wizard-rp",
    storageBucket: "wizard-rp.firebasestorage.app",
    messagingSenderId: "479456044047",
    appId: "1:479456044047:web:65c52e2430bcb6ca586f7a",
    measurementId: "G-KX5Y56CG0R"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // App state (memory only)
  const STATE = {
    currentUser: null,   // { id: docId, username, display, role, ... }
    adminMode: false,
    unsub: {}            // hold unsubscribe fns for onSnapshot
  };

  // DOM refs
  const cardsRoot = document.getElementById('cardsRoot');
  const expandedRoot = document.getElementById('expandedRoot');
  const userDisplay = document.getElementById('userDisplay');
  const dutyStatus = document.getElementById('dutyStatus');
  const btnLogin = document.getElementById('btnLogin');
  const btnExport = document.getElementById('btnExport');
  const adminModeWrap = document.getElementById('adminModeWrap');
  const adminModePill = document.getElementById('adminModePill');
  const notifPill = document.getElementById('notifPill');
  const loginModal = document.getElementById('loginModal');

  const COL = (name) => collection(db, name);

  // Helper: seed initial data in Firestore if collections empty (for demo)
  async function seedIfEmpty(){
    try{
      const usersSnap = await getDocs(COL('users'));
      if(usersSnap.empty){
        await addDoc(COL('users'), { username:'admin', display:'Admin', password:'admin123', role:'admin', badge:'ADM-001', onDuty:false });
        await addDoc(COL('users'), { username:'dispatcher', display:'Dispatch', password:'dispatch', role:'dispatcher', badge:'DISP', onDuty:false });
        await addDoc(COL('users'), { username:'perety04', display:'Perety 04', password:'peretypass', role:'officer', badge:'PD-314', onDuty:false });
      }
      const rolesSnap = await getDocs(COL('roles'));
      if(rolesSnap.empty){
        await setDoc(doc(db,'roles','officer'), { name:'Officer', color:'#7c3aed', permissions:['create_reports','create_pda','create_call'] });
        await setDoc(doc(db,'roles','sergeant'), { name:'Sergeant', color:'#3b82f6', permissions:['create_reports','create_pda','create_call','delete_reports'] });
        await setDoc(doc(db,'roles','dispatcher'), { name:'Dispatcher', color:'#f97316', permissions:['create_call','assign_call'] });
        await setDoc(doc(db,'roles','admin'), { name:'Admin', color:'#10b981', permissions:['all'] });
      }
      const channelsSnap = await getDocs(COL('radio_channels'));
      if(channelsSnap.empty){
        await addDoc(COL('radio_channels'), { id:'general', name:'General', created_at: Date.now() });
        await addDoc(COL('radio_channels'), { id:'police', name:'Police', created_at: Date.now() });
        await addDoc(COL('radio_channels'), { id:'medical', name:'Medical', created_at: Date.now() });
      }
      const reportsSnap = await getDocs(COL('reports'));
      if(reportsSnap.empty){
        await addDoc(COL('reports'), { title:'Robo en tienda', description:'Robo con arma blanca. Sospechoso huy√≥.', author:'Admin', created_at: Date.now() - 3600*1000 });
      }
      // initial logs
      const logsSnap = await getDocs(COL('logs'));
      if(logsSnap.empty){
        await addDoc(COL('logs'), { t: Date.now(), msg:'Seed inicial en Firestore' });
      }
    }catch(err){
      // If Firestore rules prevent writes, we still continue (app will work if data exists)
      console.warn('Seed failed or limited by rules:', err);
    }
  }

  // Permission checker: reads roles collection and checks permission.
  // 'all' in permissions means superuser; destructive perms require adminMode.
  async function hasPerm(perm){
    if(!STATE.currentUser) return perm === 'create_call' ? true : false;
    try{
      const rdoc = await getDocs(query(COL('roles'), where('__name__','==', STATE.currentUser.role)));
      let role = null;
      rdoc.forEach(d=> role = d.data());
      if(!role) return false;
      if(Array.isArray(role.permissions) && role.permissions.includes('all')){
        // Restrict destructive actions behind adminMode
        const sensitive = ['delete_reports','delete_alerts','manage_users','manage_roles','delete_all_alerts','impersonate','view_logs','all'];
        if(sensitive.includes(perm)) return STATE.adminMode === true;
        return true;
      }
      return role.permissions && role.permissions.includes(perm);
    }catch(err){
      console.warn('hasPerm error', err);
      return false;
    }
  }

  // UI: cards list (admin/logs hidden to non-admins)
  const CARDS = [
    {id:'pda', title:'PDA / Fichas', desc:'Buscar y crear fichas', icon:'üöì'},
    {id:'calls', title:'Dispatch / Llamadas', desc:'Crear/Asignar llamadas', icon:'üìû'},
    {id:'reports', title:'Informes', desc:'Crear / Editar informes', icon:'üìë'},
    {id:'wanted', title:'BOLO / Wanted', desc:'Fichas buscados', icon:'üö®'},
    {id:'fines', title:'Multas', desc:'Generar sanciones', icon:'üí∏'},
    {id:'service', title:'Servicio', desc:'Entrar / Salir de servicio', icon:'üü¢'},
    {id:'alerts', title:'Alertas', desc:'Crear y gestionar alertas', icon:'‚ö†Ô∏è'},
    {id:'radio', title:'Radios', desc:'Chat por canales', icon:'üì°'},
    {id:'admin', title:'Administraci√≥n', desc:'Roles y usuarios (avanzado)', icon:'‚öôÔ∏è'},
    {id:'logs', title:'Auditor√≠a', desc:'Historial de acciones', icon:'üìú'}
  ];

  function renderCards(){
    cardsRoot.innerHTML = '';
    const isAdmin = STATE.currentUser && STATE.currentUser.role === 'admin';
    CARDS.forEach(c=>{
      if((c.id === 'admin' || c.id === 'logs') && !isAdmin) return;
      const el = document.createElement('div'); el.className='card';
      el.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
        <div><div class="title">${c.title}</div><div class="desc">${c.desc}</div></div>
        <div class="icon">${c.icon}</div>
      </div>
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="muted tiny">Acci√≥n r√°pida</div>
        <div><button class="btn-ghost" data-open="${c.id}">Abrir</button></div>
      </div>`;
      el.querySelector('button[data-open]').onclick = (e)=>{ e.stopPropagation(); openCard(c.id); };
      el.onclick = ()=> openCard(c.id);
      cardsRoot.appendChild(el);
    });
  }

  // Admin Mode UI
  function updateAdminUI(){
    const isAdmin = STATE.currentUser && STATE.currentUser.role === 'admin';
    adminModeWrap.style.display = isAdmin ? 'inline-block' : 'none';
    adminModePill.textContent = `Admin: ${STATE.adminMode ? 'ON' : 'OFF'}`;
  }
  adminModePill.addEventListener('click', async ()=>{
    if(!STATE.currentUser || STATE.currentUser.role !== 'admin'){ alert('Solo admin puede activar Admin Mode'); return; }
    if(STATE.adminMode){
      if(confirm('Desactivar Admin Mode?')){ STATE.adminMode = false; updateAdminUI(); renderCards(); }
      return;
    }
    const pass = prompt('Reingresa la contrase√±a del admin para activar Admin Mode:');
    if(!pass) return;
    try{
      const q = query(COL('users'), where('username','==', STATE.currentUser.username), where('password','==', pass));
      const snap = await getDocs(q);
      if(snap.empty){ alert('Contrase√±a incorrecta'); return; }
      STATE.adminMode = true; updateAdminUI(); renderCards(); await pushLog(`Admin Mode activado por ${STATE.currentUser.username}`);
    }catch(e){ console.error(e); alert('Error validando contrase√±a'); }
  });

  // Open panels
  function openCard(id){
    if(id === 'admin' && (!STATE.currentUser || STATE.currentUser.role !== 'admin')){ alert('Acceso denegado: necesitas rol admin'); return; }
    if(id === 'logs' && (!STATE.currentUser || STATE.currentUser.role !== 'admin' || !STATE.adminMode)){ alert('Acceso denegado: logs requieren Admin Mode'); return; }
    expandedRoot.innerHTML = '';
    const panel = document.createElement('div'); panel.className='expanded';
    expandedRoot.appendChild(panel);
    switch(id){
      case 'pda': renderPDA(panel); break;
      case 'calls': renderCalls(panel); break;
      case 'reports': renderReports(panel); break;
      case 'wanted': renderWanted(panel); break;
      case 'fines': renderFines(panel); break;
      case 'service': renderService(panel); break;
      case 'alerts': renderAlerts(panel); break;
      case 'radio': renderRadio(panel); break;
      case 'admin': renderAdmin(panel); break;
      case 'logs': renderLogs(panel); break;
    }
    window.scrollTo({ top: panel.offsetTop-20, behavior:'smooth' });
  }

  /* -------------------- PDA -------------------- */
  async function renderPDA(container){
    container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>PDA / Fichas</strong><div class="muted small">Buscar y crear fichas (Firestore)</div></div>
      <div><button class="btn btn-small" id="closeP">Cerrar</button></div>
    </div>
    <div style="margin-top:12px" class="grid-2">
      <div>
        <div class="muted small">Buscar</div>
        <input id="pdaQ" placeholder="Buscar por texto..." />
        <div id="pdaResults" style="margin-top:12px"></div>
      </div>
      <div>
        <div class="muted small">Crear nueva ficha</div>
        <textarea id="pdaTxt"></textarea>
        <div style="display:flex;gap:8px;margin-top:8px"><button id="createPDA" class="btn">Crear ficha</button></div>
      </div>
    </div>`;
    container.querySelector('#closeP').onclick = ()=> expandedRoot.innerHTML = '';
    container.querySelector('#createPDA').onclick = async ()=>{
      if(!await hasPerm('create_pda')){ alert('No tienes permiso para crear fichas'); return; }
      const text = document.getElementById('pdaTxt').value.trim();
      if(!text) { alert('Rellena el texto'); return; }
      try{ await addDoc(COL('pda'), { text, created_at: Date.now(), author: STATE.currentUser ? STATE.currentUser.username : 'Invitado' }); await pushLog('Ficha PDA creada'); document.getElementById('pdaTxt').value=''; }catch(e){ console.error(e); alert('Error creando ficha'); }
    };
    document.getElementById('pdaQ').addEventListener('input', ()=> loadPDAs(document.getElementById('pdaQ').value));
    if(STATE.unsub.pda) STATE.unsub.pda();
    STATE.unsub.pda = onSnapshot(COL('pda'), ()=> loadPDAs(document.getElementById('pdaQ')?.value || ''));
    loadPDAs('');
  }
  async function loadPDAs(q=''){
    const res = document.getElementById('pdaResults'); if(!res) return;
    const snap = await getDocs(COL('pda'));
    const arr = []; snap.forEach(s=> arr.push({ id:s.id, ...s.data() }));
    const out = arr.filter(p => (q||'').trim()==='' ? true : ((p.text||'').toLowerCase().includes(q.toLowerCase())));
    res.innerHTML = out.map(p=>`<div class="item"><div style="flex:1"><b>${(p.text||'').slice(0,40)}</b><div class="muted small">${(p.text||'').slice(0,160)}</div></div>
      <div><button class="btn-ghost" data-id="${p.id}" data-act="view">Ver</button> <button class="btn-ghost" data-id="${p.id}" data-act="del">Borrar</button></div></div>`).join('') || '<div class="muted small">Sin fichas</div>';
    res.querySelectorAll('button[data-act]').forEach(b=>{
      b.onclick = async ()=>{
        const id = b.dataset.id;
        if(b.dataset.act==='view'){
          const docSnap = await fetchDoc('pda', id);
          alert('Ficha PDA:\n\n' + (docSnap?.text || 'No encontrada') + '\n\nAutor: ' + (docSnap?.author||'‚Äî'));
        } else if(b.dataset.act==='del'){
          if(!confirm('Borrar ficha?')) return;
          // require delete permission (sensitive)
          if(!await hasPerm('delete_reports')){ alert('Admin Mode o permisos requeridos para borrar'); return; }
          try{ await deleteDoc(doc(db,'pda',id)); await pushLog(`Ficha PDA ${id} borrada`); }catch(e){ console.error(e); alert('Error borrando'); }
        }
      };
    });
  }

  // helper: fetch single doc by id (query by __name__)
  async function fetchDoc(collectionName, id){
    try{
      const snap = await getDocs(query(COL(collectionName), where('__name__','==', id)));
      let data = null;
      snap.forEach(s => data = s.data());
      return data;
    }catch(e){ console.warn('fetchDoc', e); return null; }
  }

  /* -------------------- Calls -------------------- */
  async function renderCalls(container){
    container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>Dispatch / Llamadas</strong><div class="muted small">Crear llamadas y asignar unidades</div></div>
      <div><button class="btn btn-small" id="closeC">Cerrar</button></div>
    </div>
    <div style="margin-top:12px;display:flex;gap:8px">
      <input id="callFrom" placeholder="Remitente (opcional)"/>
      <input id="callMsg" placeholder="Mensaje"/>
      <button id="callCreate" class="btn">Crear llamada</button>
    </div>
    <div style="margin-top:12px"><strong>Llamadas</strong><div id="callsList" class="list" style="margin-top:8px"></div></div>`;
    container.querySelector('#closeC').onclick = ()=> expandedRoot.innerHTML = '';
    container.querySelector('#callCreate').onclick = async ()=>{
      const caller = document.getElementById('callFrom').value.trim() || 'Anonimo';
      const message = document.getElementById('callMsg').value.trim();
      if(!message){ alert('Introduce un mensaje'); return; }
      try{ await addDoc(COL('calls'), { caller, message, status:'pending', assigned_to:null, created_at: Date.now() }); await pushLog('Llamada creada'); document.getElementById('callMsg').value=''; }catch(e){ console.error(e); alert('Error creando llamada'); }
    };
    if(STATE.unsub.calls) STATE.unsub.calls();
    STATE.unsub.calls = onSnapshot(COL('calls'), ()=> loadCalls());
    loadCalls();
  }
  async function loadCalls(){
    const list = document.getElementById('callsList'); if(!list) return;
    const snap = await getDocs(COL('calls'));
    const arr = []; snap.forEach(s=> arr.push({ id:s.id, ...s.data() }));
    if(!arr.length){ list.innerHTML = '<div class="muted small">No hay llamadas</div>'; return; }
    list.innerHTML = '';
    const usersSnap = await getDocs(COL('users')); const users = []; usersSnap.forEach(u=> users.push({ id:u.id, ...u.data() }));
    for(const c of arr){
      const assignee = c.assigned_to ? (users.find(u=>u.id===c.assigned_to)?.display || '‚Äî') : '‚Äî';
      const el = document.createElement('div'); el.className='item';
      el.innerHTML = `<div style="flex:1"><b>${c.caller}</b><div class="muted small">${c.message}</div></div>
        <div style="text-align:right"><div class="muted tiny">${new Date(c.created_at||0).toLocaleString()}</div><div class="muted tiny">Asig: ${assignee}</div></div>`;
      const btns = document.createElement('div'); btns.style.marginLeft='12px';
      if(await hasPerm('assign_call') && STATE.currentUser){
        const assign = document.createElement('button'); assign.className='btn-ghost'; assign.textContent='Asignar a m√≠';
        assign.onclick = async ()=> { try{ await updateDoc(doc(db,'calls',c.id), { status:'assigned', assigned_to: STATE.currentUser.id }); await pushLog(`Llamada ${c.id} asignada a ${STATE.currentUser.username}`); }catch(e){ console.error(e); } };
        btns.appendChild(assign);
      }
      if(STATE.currentUser && (STATE.currentUser.role==='admin' || (c.assigned_to && STATE.currentUser.id===c.assigned_to))){
        const del = document.createElement('button'); del.className='btn'; del.style.marginLeft='6px'; del.textContent='Borrar';
        del.onclick = async ()=> { if(confirm('Borrar llamada?')){ try{ await deleteDoc(doc(db,'calls',c.id)); await pushLog(`Llamada ${c.id} borrada`); }catch(e){console.error(e);} } };
        btns.appendChild(del);
      }
      el.appendChild(btns);
      list.appendChild(el);
    }
  }

  /* -------------------- Reports -------------------- */
  async function renderReports(container){
    container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>Informes</strong><div class="muted small">Crear y consultar informes</div></div>
      <div><button class="btn btn-small" id="closeR">Cerrar</button></div>
    </div>
    <div style="margin-top:12px">
      <div class="muted small">Plantilla (editable)</div>
      <textarea id="tplReport" style="min-height:80px"></textarea>
    </div>
    <div style="margin-top:8px" class="form-row">
      <input id="repTitle" placeholder="T√≠tulo" />
      <input id="repAuthor" placeholder="Autor (auto)" />
    </div>
    <div style="margin-top:8px"><textarea id="repDesc" placeholder="Descripci√≥n..."></textarea></div>
    <div style="margin-top:8px;display:flex;gap:8px"><button id="saveRep" class="btn">Guardar informe</button><button id="clearRep" class="btn-ghost">Limpiar</button></div>
    <div style="margin-top:12px"><strong>√öltimos informes</strong><div id="reportsList" class="list" style="margin-top:8px"></div></div>`;
    container.querySelector('#closeR').onclick = ()=> expandedRoot.innerHTML = '';
    document.getElementById('repAuthor').value = STATE.currentUser ? STATE.currentUser.display : 'Invitado';
    document.getElementById('saveRep').onclick = async ()=>{
      if(!await hasPerm('create_reports')){ alert('No tienes permiso para crear informes'); return; }
      const title = document.getElementById('repTitle').value.trim();
      const desc = document.getElementById('repDesc').value.trim();
      if(!title || !desc){ alert('T√≠tulo y descripci√≥n obligatorios'); return; }
      try{ await addDoc(COL('reports'), { title, description: desc, author: STATE.currentUser ? STATE.currentUser.display : 'Invitado', created_at: Date.now() }); await pushLog(`Informe creado: ${title}`); loadReports(); }catch(e){ console.error(e); alert('Error guardando informe'); }
    };
    if(STATE.unsub.reports) STATE.unsub.reports();
    STATE.unsub.reports = onSnapshot(COL('reports'), ()=> loadReports());
    loadReports();
  }
  async function loadReports(){
    const list = document.getElementById('reportsList'); if(!list) return;
    const snap = await getDocs(query(COL('reports'), orderBy('created_at','desc')));
    const arr = []; snap.forEach(s => arr.push({ id:s.id, ...s.data() }));
    if(!arr.length){ list.innerHTML = '<div class="muted small">No hay informes</div>'; return; }
    list.innerHTML = '';
    for(const r of arr){
      const it = document.createElement('div'); it.className='item';
      it.innerHTML = `<div style="flex:1"><div style="font-weight:700">${r.title}</div><div class="muted small">${(r.description||'').slice(0,160)}</div></div>
        <div style="text-align:right"><div class="muted tiny">${new Date(r.created_at||0).toLocaleString()}</div><div class="muted tiny">${r.author||''}</div></div>`;
      const btns = document.createElement('div'); btns.style.marginLeft='12px';
      const view = document.createElement('button'); view.className='btn-ghost'; view.textContent='Ver';
      view.onclick = ()=> alert(`Informe ‚Äî ${r.title}\n\n${r.description}\n\nAutor: ${r.author}\nFecha: ${new Date(r.created_at||0).toLocaleString()}`);
      btns.appendChild(view);
      if(STATE.currentUser && (STATE.currentUser.role==='admin' || STATE.currentUser.role==='sergeant')){
        const del = document.createElement('button'); del.className='btn'; del.style.marginLeft='6px'; del.textContent='Borrar';
        del.onclick = async ()=> {
          if(!await hasPerm('delete_reports')){ alert('Admin Mode requerido para borrar'); return; }
          if(!confirm('Borrar informe?')) return;
          try{ await deleteDoc(doc(db,'reports',r.id)); await pushLog(`Informe ${r.id} borrado`); }catch(e){ console.error(e); alert('Error borrando'); }
        };
        btns.appendChild(del);
      }
      it.appendChild(btns); list.appendChild(it);
    }
  }

  /* -------------------- Alerts & Notifications -------------------- */
  async function renderAlerts(container){
    container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>Alertas</strong><div class="muted small">Crear alertas de la ciudad</div></div>
      <div><button class="btn btn-small" id="closeA">Cerrar</button></div>
    </div>
    <div style="margin-top:12px" class="form-row">
      <select id="alertLevel"><option value="verde">Verde</option><option value="amarilla">Amarilla</option><option value="roja">Roja</option></select>
      <input id="alertTitle" placeholder="T√≠tulo"/>
    </div>
    <div style="margin-top:8px"><textarea id="alertMsg" placeholder="Mensaje..."></textarea></div>
    <div style="margin-top:8px;display:flex;gap:8px"><button id="createAlertBtn" class="btn">Crear alerta</button><button id="refreshAlerts" class="btn-ghost">Refrescar</button></div>
    <div style="margin-top:12px"><strong>Alertas actuales</strong><div id="alertsList" class="list" style="margin-top:8px"></div></div>
    <div id="alertsFooter" style="margin-top:8px;text-align:right"></div>`;
    container.querySelector('#closeA').onclick = ()=> expandedRoot.innerHTML = '';
    container.querySelector('#createAlertBtn').onclick = createAlert;
    container.querySelector('#refreshAlerts').onclick = loadAlerts;
    if(STATE.unsub.alerts) STATE.unsub.alerts();
    STATE.unsub.alerts = onSnapshot(COL('alerts'), ()=> { loadAlerts(); updateNotifCount(); });
    loadAlerts(); updateNotifCount();
  }
  async function createAlert(){
    if(!STATE.currentUser){ alert('Inicia sesi√≥n para crear alertas'); return; }
    const lvl = document.getElementById('alertLevel').value;
    const title = document.getElementById('alertTitle').value.trim();
    const msg = document.getElementById('alertMsg').value.trim();
    if(!title || !msg){ alert('T√≠tulo y mensaje obligatorios'); return; }
    try{
      await addDoc(COL('alerts'), { title, message: msg, level: lvl, author: STATE.currentUser.username, created_at: Date.now() });
      await pushLog(`Alerta creada: ${title}`);
      document.getElementById('alertTitle').value=''; document.getElementById('alertMsg').value='';
      loadAlerts(); updateNotifCount();
    }catch(e){ console.error(e); alert('Error creando alerta'); }
  }
  async function loadAlerts(){
    const list = document.getElementById('alertsList'); if(!list) return;
    const snap = await getDocs(query(COL('alerts'), orderBy('created_at','desc')));
    const arr = []; snap.forEach(s=> arr.push({ id:s.id, ...s.data() }));
    if(!arr.length){ list.innerHTML = '<div class="muted small">No hay alertas</div>'; return; }
    list.innerHTML = '';
    for(const a of arr){
      const it = document.createElement('div'); it.className='item';
      it.innerHTML = `<div style="flex:1"><div style="font-weight:700">${a.title} <span class="muted tiny">[${a.level||'‚Äî'}]</span></div><div class="muted small">${(a.message||'').slice(0,200)}</div></div>
        <div style="text-align:right"><div class="muted tiny">${a.created_at? new Date(a.created_at).toLocaleString() : ''}</div></div>`;
      const btns = document.createElement('div'); btns.style.marginLeft='12px';
      if(STATE.currentUser && (STATE.currentUser.role==='admin' && STATE.adminMode || a.author === (STATE.currentUser && STATE.currentUser.username))){
        const del = document.createElement('button'); del.className='btn-danger-small'; del.style.marginLeft='6px'; del.textContent='Borrar';
        del.onclick = async ()=>{ if(confirm('Borrar alerta?')){ try{ await deleteDoc(doc(db,'alerts',a.id)); await pushLog(`Alerta ${a.id} borrada`); loadAlerts(); updateNotifCount(); }catch(e){console.error(e);} } };
        btns.appendChild(del);
      }
      it.appendChild(btns); list.appendChild(it);
    }
  }
  async function updateNotifCount(){
    try{
      const snap = await getDocs(COL('alerts'));
      const count = snap.size;
      if(count>0){ notifPill.style.display='inline-block'; notifPill.textContent=`Alertas ${count}`; notifPill.onclick = ()=> openCard('alerts'); } else notifPill.style.display='none';
    }catch(e){ console.warn('updateNotifCount', e); }
  }

  /* -------------------- Administration -------------------- */
  async function renderAdmin(container){
    container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>Administraci√≥n</strong><div class="muted small">Gestiona roles y usuarios</div></div>
      <div><button class="btn btn-small" id="closeA">Cerrar</button></div>
    </div>
    <div style="margin-top:12px" id="adminNotice"></div>
    <div style="margin-top:12px;display:flex;gap:12px">
      <div style="flex:1">
        <h4>Usuarios</h4>
        <div id="usersAdminList" class="list"></div>
      </div>
      <div style="width:360px">
        <h4>Crear usuario</h4>
        <input id="adm_newUser" placeholder="username"><input id="adm_newDisplay" placeholder="display"><input id="adm_newPass" placeholder="password">
        <select id="adm_newRole"></select>
        <div style="display:flex;gap:8px;margin-top:8px"><button id="adm_createUser" class="btn">Crear</button><button id="adm_refresh" class="btn-ghost">Refrescar</button></div>
        <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.03)">
        <h4>Roles</h4>
        <div style="display:flex;gap:8px"><input id="adm_newRoleName" placeholder="nuevo rol"><button id="adm_createRole" class="btn">Crear rol</button></div>
        <div id="rolesAdminList" style="margin-top:12px"></div>
      </div>
    </div>`;
    container.querySelector('#closeA').onclick = ()=> expandedRoot.innerHTML = '';

    if(!STATE.currentUser || STATE.currentUser.role !== 'admin'){
      container.querySelector('#adminNotice').innerHTML = `<div class="item"><div style="flex:1"><b>Acceso denegado</b><div class="muted small">Necesitas ser admin para gestionar cuentas.</div></div></div>`;
      return;
    }

    // Admin Mode notice / controls
    const notice = container.querySelector('#adminNotice');
    if(!STATE.adminMode){
      notice.innerHTML = `<div class="item"><div style="flex:1"><b>Admin Mode OFF</b><div class="muted small">Activa Admin Mode para operaciones sensibles (crear/borrar/impersonar/editar permisos)</div></div>
        <div style="display:flex;flex-direction:column;gap:6px"><button id="enableAdminMode" class="btn">Activar Admin Mode</button></div></div>`;
      notice.querySelector('#enableAdminMode').onclick = async ()=>{
        const pass = prompt('Reingresa la contrase√±a del admin:');
        if(!pass) return;
        const snap = await getDocs(query(COL('users'), where('username','==', STATE.currentUser.username), where('password','==', pass)));
        if(snap.empty){ alert('Contrase√±a incorrecta'); return; }
        STATE.adminMode = true; updateAdminUI(); renderAdmin(container); await pushLog(`Admin Mode activado por ${STATE.currentUser.username}`); 
      };
    } else {
      notice.innerHTML = `<div class="item"><div style="flex:1"><b>Admin Mode ON</b><div class="muted small">Puedes realizar acciones administrativas.</div></div>
        <div><button id="disableAdminMode" class="btn-danger-small">Desactivar</button></div></div>`;
      notice.querySelector('#disableAdminMode').onclick = ()=> { if(confirm('Desactivar Admin Mode?')){ STATE.adminMode=false; updateAdminUI(); renderAdmin(container); } };
    }

    // populate roles select
    const rolesSnap = await getDocs(COL('roles'));
    const roleSelect = container.querySelector('#adm_newRole');
    roleSelect.innerHTML = '';
    rolesSnap.forEach(r => roleSelect.appendChild(Object.assign(document.createElement('option'), { value: r.id, textContent: r.id })));

    // handlers
    container.querySelector('#adm_createUser').onclick = async ()=>{
      if(!STATE.adminMode){ alert('Activa Admin Mode para crear usuarios'); return; }
      const username = container.querySelector('#adm_newUser').value.trim(); if(!username) return alert('username requerido');
      const display = container.querySelector('#adm_newDisplay').value.trim() || username;
      const pass = container.querySelector('#adm_newPass').value.trim() || '1234';
      const role = container.querySelector('#adm_newRole').value;
      try{ await addDoc(COL('users'), { username, display, password: pass, role, badge:'', onDuty:false }); await pushLog(`Usuario creado: ${username}`); renderAdmin(container); }catch(e){ console.error(e); alert('Error creando usuario'); }
    };
    container.querySelector('#adm_refresh').onclick = ()=> renderAdmin(container);
    container.querySelector('#adm_createRole').onclick = async ()=>{
      if(!STATE.adminMode){ alert('Activa Admin Mode para crear roles'); return; }
      const name = container.querySelector('#adm_newRoleName').value.trim(); if(!name) return alert('Nombre rol requerido');
      try{ await setDoc(doc(db,'roles',name), { name, color:'#999999', permissions:[] }); await pushLog(`Rol creado: ${name}`); renderAdmin(container); }catch(e){ console.error(e); alert('Error creando rol'); }
    };

    // lists
    await loadUsersAdmin(container);
    await loadRolesAdmin(container);
  }

  async function loadUsersAdmin(container){
    const list = container.querySelector('#usersAdminList'); list.innerHTML = '<div class="muted small">Cargando...</div>';
    const snap = await getDocs(COL('users'));
    const users = []; snap.forEach(s => users.push({ id:s.id, ...s.data() }));
    list.innerHTML = '';
    for(const u of users){
      const div = document.createElement('div'); div.className='item';
      const canPerform = STATE.adminMode && STATE.currentUser && STATE.currentUser.role==='admin';
      div.innerHTML = `<div><b>${u.display} (${u.username})</b><div class="muted small">Rol: <span class="muted small">${u.role||'‚Äî'}</span> ‚Ä¢ Badge: ${u.badge||'‚Äî'}</div></div>
        <div style="text-align:right">
          <select data-uid="${u.id}" ${canPerform ? '' : 'disabled'} class="adm-role-sel"></select>
          <div style="margin-top:6px"><button data-uid="${u.id}" class="btn-ghost btn-small" ${canPerform ? '' : 'disabled'} data-act="del">Borrar</button> <button data-uid="${u.id}" class="btn btn-small" ${canPerform ? '' : 'disabled'} data-act="imp">Impersonar</button></div>
        </div>`;
      list.appendChild(div);
    }
    // fill role options then attach events
    const rolesSnap = await getDocs(COL('roles'));
    const roleKeys = []; rolesSnap.forEach(r => roleKeys.push(r.id));
    list.querySelectorAll('.adm-role-sel').forEach(sel=>{
      sel.innerHTML = roleKeys.map(k=> `<option value="${k}">${k}</option>` ).join('');
      (async ()=>{
        const uid = sel.dataset.uid;
        const userSnap = await getDocs(query(COL('users'), where('__name__','==', uid)));
        let userObj = null; userSnap.forEach(s=> userObj = s.data());
        if(userObj) sel.value = userObj.role || '';
      })();
      sel.onchange = async (e)=>{
        if(!STATE.adminMode){ alert('Activa Admin Mode para cambiar roles'); return; }
        const newRole = e.target.value; const uid = e.target.dataset.uid;
        try{ await updateDoc(doc(db,'users',uid), { role: newRole }); await pushLog(`Rol cambiado: ${uid} -> ${newRole}`); loadUsersAdmin(container); }catch(e){ console.error(e); alert('Error cambiando rol'); }
      };
    });
    list.querySelectorAll('button[data-act="del"]').forEach(b=>{
      b.onclick = async ()=>{
        if(!STATE.adminMode){ alert('Activa Admin Mode para borrar usuarios'); return; }
        const uid = b.dataset.uid;
        if(!confirm('Borrar usuario?')) return;
        try{
          const s = await getDocs(query(COL('users'), where('__name__','==', uid)));
          let userObj = null; s.forEach(d=> userObj = d.data());
          if(userObj && userObj.username === 'admin'){ alert('No puedes borrar admin seed'); return; }
          await deleteDoc(doc(db,'users',uid));
          await pushLog(`Usuario borrado: ${uid}`);
          loadUsersAdmin(container);
        }catch(e){ console.error(e); alert('Error borrando usuario'); }
      };
    });
    list.querySelectorAll('button[data-act="imp"]').forEach(b=>{
      b.onclick = async ()=>{
        if(!STATE.adminMode){ alert('Activa Admin Mode para impersonar'); return; }
        const uid = b.dataset.uid;
        try{
          const s = await getDocs(query(COL('users'), where('__name__','==', uid)));
          let userObj = null; s.forEach(d=> userObj = { id:d.id, ...d.data() });
          if(!userObj) return alert('Usuario no encontrado');
          STATE.currentUser = userObj;
          updateHeader();
          await pushLog(`Impersonaci√≥n: ${userObj.username}`);
          renderCards();
          alert('Ahora impersonas a: ' + userObj.display);
        }catch(e){ console.error(e); alert('Error impersonando'); }
      };
    });
  }

  async function loadRolesAdmin(container){
    const out = container.querySelector('#rolesAdminList'); out.innerHTML = '';
    const snap = await getDocs(COL('roles'));
    snap.forEach(s => {
      const r = s.data();
      const div = document.createElement('div'); div.className='item';
      div.innerHTML = `<div style="flex:1"><b>${s.id}</b><div class="muted small">Permisos: ${(r.permissions||[]).join(', ') || 'Sin permisos'}</div></div>
        <div style="text-align:right"><button data-role="${s.id}" class="btn-ghost" data-act="edit">Editar</button> <button data-role="${s.id}" class="btn" data-act="del">Borrar</button></div>`;
      out.appendChild(div);
    });
    out.querySelectorAll('button[data-act="edit"]').forEach(b=>{
      b.onclick = async ()=>{
        if(!STATE.adminMode){ alert('Activa Admin Mode para editar roles'); return; }
        const roleKey = b.dataset.role;
        const modal = document.createElement('div'); modal.className='overlay';
        modal.innerHTML = `<div class="modal"><h3>Editar rol: ${roleKey}</h3><div class="muted small">Permisos (separados por comas)</div>
          <textarea id="permArea" style="width:100%;height:100px;margin-top:8px"></textarea>
          <div style="display:flex;gap:8px;margin-top:12px"><button id="saveRole" class="btn">Guardar</button><button id="cancelRole" class="btn-ghost">Cancelar</button></div></div>`;
        document.body.appendChild(modal);
        const rSnap = await getDocs(query(COL('roles'), where('__name__','==', roleKey)));
        let roleObj = null; rSnap.forEach(d=> roleObj = d.data());
        document.getElementById('permArea').value = (roleObj && roleObj.permissions) ? roleObj.permissions.join(',') : '';
        document.getElementById('cancelRole').onclick = ()=> modal.remove();
        document.getElementById('saveRole').onclick = async ()=>{
          const perms = document.getElementById('permArea').value.split(',').map(x=>x.trim()).filter(Boolean);
          await setDoc(doc(db,'roles',roleKey), { name: roleKey, color: roleObj?.color || '#999999', permissions: perms });
          await pushLog(`Rol editado: ${roleKey}`);
          modal.remove(); loadRolesAdmin(container); loadUsersAdmin(container);
        };
      };
    });
    out.querySelectorAll('button[data-act="del"]').forEach(b=>{
      b.onclick = async ()=>{
        if(!STATE.adminMode){ alert('Activa Admin Mode para borrar roles'); return; }
        const roleKey = b.dataset.role;
        if(!confirm('Borrar rol? Los usuarios con este rol quedar√°n con rol vac√≠o')) return;
        try{
          await deleteDoc(doc(db,'roles',roleKey));
          const usersSnap = await getDocs(COL('users'));
          usersSnap.forEach(async u=>{ const d = u.data(); if(d.role === roleKey) await updateDoc(doc(db,'users',u.id), { role: '' }); });
          await pushLog(`Rol borrado: ${roleKey}`);
          loadRolesAdmin(container); loadUsersAdmin(container);
        }catch(e){ console.error(e); alert('Error borrando rol'); }
      };
    });
  }

  /* -------------------- Logs -------------------- */
  async function renderLogs(container){
    container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>Auditor√≠a</strong><div class="muted small">√öltimas acciones</div></div>
      <div><button class="btn btn-small" id="closeL">Cerrar</button></div>
    </div>
    <div style="margin-top:12px" id="logsList" class="list"></div>`;
    container.querySelector('#closeL').onclick = ()=> expandedRoot.innerHTML = '';
    const list = container.querySelector('#logsList');
    if(STATE.unsub.logs) STATE.unsub.logs();
    STATE.unsub.logs = onSnapshot(query(COL('logs'), orderBy('t','desc')), snap=>{
      list.innerHTML = '';
      snap.forEach(s=> {
        const d = s.data();
        const it = document.createElement('div'); it.className='item';
        it.innerHTML = `<div><div style="font-weight:700">${d.msg}</div><div class="muted small">${new Date(d.t).toLocaleString()}</div></div>`;
        list.appendChild(it);
      });
    });
  }

  /* -------------------- Radio (Firestore real-time) -------------------- */
  async function renderRadio(container){
    container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>Radios</strong><div class="muted small">Chat por canales (Firestore en tiempo real)</div></div>
      <div><button class="btn btn-small" id="closeRadio">Cerrar</button></div>
    </div>
    <div style="margin-top:12px;display:flex;gap:12px">
      <div style="flex:1">
        <div style="display:flex;gap:8px;align-items:center">
          <select id="radioChannelSelect" class="muted small"></select>
          <div style="margin-left:auto;display:flex;gap:8px"><input id="radioNewChannel" placeholder="Nuevo canal (ej: police-1)" style="min-width:160px"/><button id="radioCreateChannel" class="btn-ghost">Crear</button><button id="radioRefresh" class="btn-ghost">Refrescar</button></div>
        </div>
        <div id="radioMessages" class="radio-messages" style="margin-top:12px"></div>
        <div style="display:flex;gap:8px;margin-top:8px"><input id="radioMsgInput" placeholder="Escribe mensaje..." /><button id="radioSend" class="btn">Enviar</button></div>
      </div>
      <div style="width:300px">
        <h4 style="margin:0 0 8px 0">Canales</h4>
        <input id="radioSearchChannels" placeholder="Buscar canales..." style="width:100%;padding:8px;border-radius:8px"/>
        <div id="radioChannelsList" class="list" style="margin-top:8px"></div>
      </div>
    </div>`;
    container.querySelector('#closeRadio').onclick = ()=> expandedRoot.innerHTML = '';
    container.querySelector('#radioCreateChannel').onclick = async ()=>{
      const val = container.querySelector('#radioNewChannel').value.trim(); if(!val) return;
      try{ await addDoc(COL('radio_channels'), { id: val, name: val, created_at: Date.now() }); await pushLog(`Canal radio creado: ${val}`); loadRadioChannels(); container.querySelector('#radioNewChannel').value=''; }catch(e){ console.error(e); alert('Error creando canal'); }
    };
    container.querySelector('#radioRefresh').onclick = loadRadioChannels;
    container.querySelector('#radioSend').onclick = sendRadioMessage;
    container.querySelector('#radioMsgInput').addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendRadioMessage(); }});
    container.querySelector('#radioSearchChannels').addEventListener('input', (e)=>{
      const q = (e.target.value||'').toLowerCase();
      document.querySelectorAll('#radioChannelsList .item').forEach(it=>{ it.style.display = (it.dataset.name||'').toLowerCase().includes(q) ? '' : 'none'; });
    });
    if(STATE.unsub.radio_channels) STATE.unsub.radio_channels();
    STATE.unsub.radio_channels = onSnapshot(COL('radio_channels'), snap => renderChannelList(snap.docs.map(d=>({ id:d.id, ...d.data() }))));
    loadRadioChannels();
  }
  async function loadRadioChannels(){
    const list = document.getElementById('radioChannelsList'); const select = document.getElementById('radioChannelSelect');
    if(!list || !select) return;
    const snap = await getDocs(COL('radio_channels'));
    const arr = []; snap.forEach(s=> arr.push({ id:s.id, ...s.data() }));
    renderChannelList(arr);
  }
  function renderChannelList(arr){
    const list = document.getElementById('radioChannelsList'); const select = document.getElementById('radioChannelSelect');
    if(!list || !select) return;
    list.innerHTML = ''; select.innerHTML = '';
    arr.forEach(ch=>{
      const id = ch.id || ch.name;
      const name = ch.name || id;
      const it = document.createElement('div'); it.className='item'; it.dataset.name = name;
      it.innerHTML = `<div style="flex:1"><b>${name}</b><div class="muted small">${id}</div></div><div><button class="btn-ghost" data-id="${id}">Unirse</button></div>`;
      it.querySelector('button').onclick = ()=> switchRadioChannel(id);
      list.appendChild(it);
      const opt = document.createElement('option'); opt.value = id; opt.textContent = name; select.appendChild(opt);
    });
  }
  async function switchRadioChannel(channelId){
    if(!channelId) return;
    const select = document.getElementById('radioChannelSelect'); if(select) select.value = channelId;
    const messagesEl = document.getElementById('radioMessages'); if(!messagesEl) return;
    messagesEl.innerHTML = '<div class="muted small">Cargando mensajes...</div>';
    if(STATE.unsub.radio_messages) STATE.unsub.radio_messages();
    // subscribe to messages and filter client-side (simple approach)
    STATE.unsub.radio_messages = onSnapshot(COL('radio_messages'), snap=>{
      const msgs = [];
      snap.forEach(s => { const d = s.data(); if((d.channel||'') === channelId) msgs.push({ id:s.id, ...d }); });
      msgs.sort((a,b)=> (a.created_at||0) - (b.created_at||0));
      renderRadioMessages(msgs);
    });
    // set selected channel on state
    STATE.selectedChannel = channelId;
  }
  function renderRadioMessages(msgs){
    const messagesEl = document.getElementById('radioMessages'); if(!messagesEl) return;
    messagesEl.innerHTML = '';
    if(!msgs.length){ messagesEl.innerHTML = '<div class="muted small">Sin mensajes</div>'; return; }
    msgs.forEach(m=>{
      const me = STATE.currentUser && (STATE.currentUser.display === m.author || STATE.currentUser.username === m.author_username);
      const it = document.createElement('div'); it.className = 'radio-msg ' + (me ? 'me' : '');
      const avatar = document.createElement('div'); avatar.className='radio-avatar'; avatar.textContent = (m.author||'G').split(' ').map(s=>s[0]||'').slice(0,2).join('').toUpperCase();
      const bubble = document.createElement('div'); bubble.className='radio-bubble ' + (me ? 'me' : '');
      bubble.innerHTML = `<div style="font-weight:700">${m.author||'Anon'}</div><div>${escapeHtml(m.text||'')}</div><div class="radio-meta">${new Date(m.created_at||0).toLocaleString()}</div>`;
      it.appendChild(avatar); it.appendChild(bubble); messagesEl.appendChild(it);
    });
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }
  async function sendRadioMessage(){
    const input = document.getElementById('radioMsgInput'); const text = (input.value||'').trim();
    if(!text) return;
    const channel = STATE.selectedChannel || document.getElementById('radioChannelSelect').value;
    if(!channel) return alert('Selecciona un canal');
    try{
      await addDoc(COL('radio_messages'), { channel, text, author: STATE.currentUser ? STATE.currentUser.display : 'Invitado', author_username: STATE.currentUser ? STATE.currentUser.username : 'guest', created_at: Date.now() });
      await pushLog(`Mensaje radio (${channel})`);
      input.value = '';
    }catch(e){ console.error(e); alert('Error enviando mensaje'); }
  }

  /* -------------------- Service / duty -------------------- */
  async function renderService(container){
    container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>Servicio</strong><div class="muted small">Ponte en servicio o sal</div></div>
      <div><button class="btn btn-small" id="closeS">Cerrar</button></div>
    </div>
    <div style="margin-top:12px;display:flex;gap:8px;align-items:center"><div class="muted small">Tu estado:</div><div id="serviceBox" class="pill">Desconocido</div><div style="margin-left:auto"><button id="toggleDuty" class="btn">Cambiar estado</button></div></div>
    <div style="margin-top:12px"><strong>Polic√≠as en servicio</strong><div id="dutyList" class="list" style="margin-top:8px"></div></div>`;
    container.querySelector('#closeS').onclick = ()=> expandedRoot.innerHTML = '';
    const box = container.querySelector('#serviceBox');
    const u = STATE.currentUser;
    if(!u){ box.textContent = 'Inicia sesi√≥n'; container.querySelector('#toggleDuty').onclick = ()=> alert('Inicia sesi√≥n'); return; }
    // read current user's onDuty field
    const userSnap = await getDocs(query(COL('users'), where('__name__','==', u.id)));
    let userObj = null; userSnap.forEach(s=> userObj = s.data());
    const on = userObj?.onDuty || false; box.textContent = on ? 'En servicio' : 'Fuera de servicio';
    container.querySelector('#toggleDuty').onclick = async ()=>{
      try{
        await updateDoc(doc(db,'users',u.id), { onDuty: !on });
        await pushLog(`${u.username} ${!on ? 'entr√≥' : 'sali√≥'} de servicio`);
        renderService(container);
        updateHeader();
      }catch(e){ console.error(e); alert('Error cambiando estado'); }
    };
    loadDutyList();
  }
  async function loadDutyList(){
    const list = document.getElementById('dutyList'); if(!list) return;
    const snap = await getDocs(COL('users'));
    const active = [];
    snap.forEach(s=>{ const d = s.data(); if(d.onDuty) active.push(d.display || d.username); });
    list.innerHTML = active.map(a=> `<div class="item">${a}</div>`).join('') || '<div class="muted small">Nadie en servicio</div>';
    updateHeader();
  }

  /* -------------------- Utilities & Auth -------------------- */
  function escapeHtml(s){ return (s+'').replace(/[&<>"']/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  // Login modal handlers (Firestore-only)
  document.getElementById('btnLogin').onclick = ()=> openLoginModal();
  function openLoginModal(){ loginModal.style.display='flex'; document.getElementById('loginUser').focus(); }
  function closeLoginModal(){ loginModal.style.display='none'; document.getElementById('loginPass').value=''; document.getElementById('loginUser').value=''; document.getElementById('loginError').style.display='none'; }

  document.getElementById('guestBtn').onclick = ()=> { STATE.currentUser = null; STATE.adminMode = false; updateHeader(); closeLoginModal(); };
  document.getElementById('showReg').onclick = ()=> { const b = document.getElementById('registerBlock'); b.style.display = b.style.display==='none' ? 'block' : 'none'; };
  document.getElementById('regCancel').onclick = ()=> { document.getElementById('registerBlock').style.display='none'; };

  document.getElementById('loginBtnModal').onclick = async ()=>{
    const u = document.getElementById('loginUser').value.trim(); const p = document.getElementById('loginPass').value.trim();
    if(!u || !p){ document.getElementById('loginError').style.display='block'; document.getElementById('loginError').textContent='Usuario y contrase√±a requeridos'; return; }
    try{
      const snap = await getDocs(query(COL('users'), where('username','==', u), where('password','==', p)));
      if(snap.empty){ document.getElementById('loginError').style.display='block'; document.getElementById('loginError').textContent='Usuario o contrase√±a incorrectos'; return; }
      let found = null; snap.forEach(s=> found = { id:s.id, ...s.data() });
      STATE.currentUser = found;
      STATE.adminMode = false; // reset admin mode on login
      updateHeader();
      closeLoginModal();
      await pushLog(`Sesi√≥n iniciada: ${found.username}`);
      renderCards();
    }catch(e){ console.error(e); document.getElementById('loginError').style.display='block'; document.getElementById('loginError').textContent='Error en login (ver consola)'; }
  };

  document.getElementById('regCreate').onclick = async ()=>{
    const username = document.getElementById('regUser').value.trim();
    const display = document.getElementById('regName').value.trim() || username;
    const pass = document.getElementById('regPass').value.trim() || '1234';
    const role = document.getElementById('regRole').value || 'officer';
    if(!username){ document.getElementById('regMsg').textContent='Usuario requerido'; return; }
    try{
      const exists = await getDocs(query(COL('users'), where('username','==', username)));
      if(!exists.empty){ document.getElementById('regMsg').textContent='Usuario ya existe'; return; }
      await addDoc(COL('users'), { username, display, password: pass, role, badge:'', onDuty:false });
      document.getElementById('regMsg').textContent='Cuenta creada. Inicia sesi√≥n.';
      await pushLog(`Cuenta creada: ${username}`);
      document.getElementById('regUser').value=''; document.getElementById('regName').value=''; document.getElementById('regPass').value='';
    }catch(e){ console.error(e); document.getElementById('regMsg').textContent='Error creando cuenta'; }
  };

  // Header update
  function updateHeader(){
    userDisplay.textContent = STATE.currentUser ? `${STATE.currentUser.display} (${STATE.currentUser.role})` : 'No conectado';
    dutyStatus.textContent = 'En servicio: ‚Äî';
    if(STATE.currentUser){
      // fetch count of users on duty
      getDocs(COL('users')).then(snap=>{
        let cnt = 0; snap.forEach(s=> { const d = s.data(); if(d.onDuty) cnt++; });
        dutyStatus.textContent = `En servicio: ${cnt}`;
      });
    } else dutyStatus.textContent = 'En servicio: 0';
    updateAdminUI();
    updateNotifCount();
  }

  // Export: pull many collections and download JSON
  document.getElementById('btnExport').onclick = async ()=>{
    try{
      const collections = ['users','roles','reports','wanted','calls','pda','fines','alerts','radio_channels','radio_messages','logs'];
      const data = {};
      for(const c of collections){
        const snap = await getDocs(COL(c));
        data[c] = [];
        snap.forEach(s=> data[c].push({ id: s.id, ...s.data() }));
      }
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'firestore_export_'+Date.now()+'.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }catch(e){ console.error(e); alert('Error exportando (ver consola)'); }
  };

  /* -------------------- Init -------------------- */
  (async ()=>{
    await seedIfEmpty();
    renderCards();
    updateHeader();
    // Subscribe to alerts count in background
    if(STATE.unsub.alertsCount) STATE.unsub.alertsCount();
    STATE.unsub.alertsCount = onSnapshot(COL('alerts'), ()=> updateNotifCount());
    // ensure cards reflect initial auth state
  })();

  // Expose for debugging
  window.__APP = { db, STATE, openCard };

  </script>
</body>
</html>
