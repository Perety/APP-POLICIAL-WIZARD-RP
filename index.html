<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sistema Policial Global ‚Äî PDA / CAD</title>
<style>
  :root{
    --bg-1:#06121a; --bg-2:#071729;
    --muted:#9fb3bd; --text:#e6f0f6;
    --accent:#7c3aed; --accent-2:#06b6a4;
    --danger:#ff6b6b;
    --glass: rgba(255,255,255,0.03);
    --card-grad: linear-gradient(180deg, rgba(255,255,255,0.014), rgba(255,255,255,0.006));
    --radius:12px;
    --shadow: 0 14px 40px rgba(2,6,10,0.6);
    font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:
    radial-gradient(800px 300px at 12% 8%, rgba(124,58,237,0.06), transparent),
    linear-gradient(180deg,var(--bg-2) 0%, var(--bg-1) 60%); color:var(--text); -webkit-font-smoothing:antialiased;}
  
  .bg { position:fixed; inset:0; z-index:0; pointer-events:none; overflow:hidden; }
  .nebula { position:absolute; width:60vmax; height:60vmax; left:-10vmin; top:-8vmin; background:
    radial-gradient(circle at 30% 30%, rgba(124,58,237,0.24), transparent 30%),
    radial-gradient(circle at 70% 70%, rgba(6,182,164,0.12), transparent 25%);
    filter: blur(56px) saturate(120%); animation: float 12s ease-in-out infinite; }
  .nebula.r { right:-10vmin; left:auto; top:6vmin; background:
    radial-gradient(circle at 70% 20%, rgba(255,80,120,0.20), transparent 30%),
    radial-gradient(circle at 30% 80%, rgba(110,231,183,0.12), transparent 25%);
    animation-duration:10s; animation-direction:reverse; }
  @keyframes float { 0%,100%{ transform:translateY(-8px) } 50%{ transform:translateY(8px) } }

  .wrap{max-width:1150px;margin:22px auto;padding:20px;position:relative;z-index:2}
  header{display:flex;align-items:center;justify-content:space-between;gap:18px;margin-bottom:20px}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:60px;height:60px;border-radius:12px;background:linear-gradient(135deg,var(--accent-2),var(--accent));display:flex;align-items:center;justify-content:center;font-weight:900;color:#031018;font-size:28px}
  h1{margin:0;font-size:18px}
  .subtitle{color:var(--muted);font-size:13px}

  .top-right{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .pill{background:var(--glass);padding:8px 12px;border-radius:999px;font-weight:700;color:var(--muted);font-size:13px}
  .btn{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#031018;padding:8px 16px;border-radius:10px;border:none;cursor:pointer;font-weight:800;transition:all .2s}
  .btn:hover{transform:translateY(-2px);opacity:0.9}
  .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);padding:7px 12px;border-radius:10px;cursor:pointer;transition:all .2s}
  .btn-ghost:hover{border-color:var(--accent);color:var(--text)}

  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-top:20px}
  @media (max-width:980px){ .grid{grid-template-columns:repeat(2,1fr)} }
  @media (max-width:640px){ .grid{grid-template-columns:1fr} }

  .card{
    background:var(--card-grad); border-radius:var(--radius); padding:20px; border:1px solid rgba(255,255,255,0.04);
    box-shadow:var(--shadow); min-height:140px; transition:all .18s; cursor:pointer; position:relative;
  }
  .card:hover{transform:translateY(-8px); box-shadow:0 30px 60px rgba(0,0,0,0.7); border-color:rgba(140,80,240,0.12)}
  .card .icon{font-size:42px;margin-bottom:12px}
  .card .title{font-weight:900;font-size:18px;margin-bottom:4px}
  .card .desc{color:var(--muted);font-size:13px}

  .expanded { margin-top:20px; border-radius:12px; padding:24px; background:linear-gradient(180deg, rgba(255,255,255,0.012), rgba(255,255,255,0.006)); border:1px solid rgba(255,255,255,0.04); box-shadow:0 16px 44px rgba(0,0,0,0.55); }

  .list{display:flex;flex-direction:column;gap:10px;max-height:500px;overflow-y:auto}
  .item{padding:14px;border-radius:10px;background:rgba(255,255,255,0.012);border:1px solid rgba(255,255,255,0.03);transition:all .2s}
  .item:hover{background:rgba(255,255,255,0.02);border-color:rgba(140,80,240,0.08)}

  input, textarea, select { background: rgba(0,0,0,0.18); border:1px solid rgba(255,255,255,0.03); padding:10px 12px; border-radius:8px; color:var(--text); font:inherit; transition:all .2s; width:100% }
  input:focus, textarea:focus, select:focus { outline:none; border-color:var(--accent); box-shadow:0 0 0 3px rgba(124,58,237,0.1) }
  textarea{min-height:100px; resize:vertical}

  .overlay{position:fixed;inset:0;background:rgba(2,6,10,0.85);backdrop-filter:blur(8px);display:none;align-items:center;justify-content:center;z-index:9999}
  .overlay.show{display:flex}
  .modal{width:500px;max-width:95%;background:linear-gradient(180deg,#071729,#061421);padding:28px;border-radius:12px;border:1px solid rgba(255,255,255,0.05);box-shadow:0 20px 60px rgba(0,0,0,0.8)}
  .modal h3{margin:0 0 12px 0;font-size:22px}

  .muted{color:var(--muted)}
  .small{font-size:13px}
  .mt-2{margin-top:8px}
  .mt-3{margin-top:12px}
  .gap-2{gap:8px}
  .flex{display:flex}
  .items-center{align-items:center}
  .justify-between{justify-content:space-between}
</style>
</head>
<body>
  <div class="bg">
    <div class="nebula"></div>
    <div class="nebula r"></div>
  </div>

  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">üõ°Ô∏è</div>
        <div>
          <h1>Sistema Policial Global ‚Äî PDA / CAD</h1>
          <div class="subtitle">üåç Sincronizaci√≥n mundial en tiempo real</div>
        </div>
      </div>

      <div class="top-right">
        <div id="userDisplay" class="pill">No conectado</div>
        <button id="btnLogin" class="btn-ghost">Entrar</button>
        <button id="btnLogout" class="btn-ghost" style="display:none">Salir</button>
        <div id="adminIndicator" style="display:none" class="pill">üëë Admin</div>
      </div>
    </header>

    <div class="grid" id="cardsGrid"></div>
    <div id="expandedArea"></div>
  </div>

  <!-- Login Modal -->
  <div id="loginModal" class="overlay">
    <div class="modal">
      <h3>Iniciar Sesi√≥n</h3>
      <div class="muted small mt-2">Acceso seguro al sistema policial</div>
      
      <div style="margin-top:20px">
        <input id="loginUser" placeholder="Usuario" style="margin-bottom:12px"/>
        <input id="loginPass" type="password" placeholder="Contrase√±a" style="margin-bottom:12px"/>
        <div class="flex gap-2">
          <button id="btnDoLogin" class="btn" style="flex:1">Entrar</button>
          <button id="btnCancelLogin" class="btn-ghost">Cancelar</button>
        </div>
        <div id="loginError" class="muted small mt-2" style="color:var(--danger);display:none"></div>
      </div>

      <div style="margin-top:24px;padding-top:16px;border-top:1px solid rgba(255,255,255,0.05)">
        <div class="muted small">Usuario por defecto:</div>
        <div class="mt-2"><strong>admin</strong> / <strong>admin123</strong></div>
        <div class="muted small mt-2">Los administradores pueden crear nuevos usuarios desde el panel de administraci√≥n</div>
      </div>
    </div>
  </div>

  <script>
    // ========== STATE ==========
    const STATE = {
      currentUser: null,
      data: {
        usuarios: [],
        ciudadanos: [],
        multas: [],
        arrestos: [],
        vehiculos: [],
        denuncias: [],
        investigaciones: []
      }
    };

    // ========== HELPERS ==========
    const $ = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => r.querySelectorAll(s);
    const html = s => s.replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));

    async function loadData(key) {
      try {
        const result = await window.storage.get(key, true);
        return result ? JSON.parse(result.value) : [];
      } catch (e) {
        return [];
      }
    }

    async function saveData(key, data) {
      try {
        await window.storage.set(key, JSON.stringify(data), true);
        showNotif('‚úì Datos guardados y sincronizados', 'success');
        await loadAllData();
      } catch (e) {
        showNotif('‚úó Error al guardar', 'error');
      }
    }

    async function loadAllData() {
      STATE.data.usuarios = await loadData('usuarios');
      STATE.data.ciudadanos = await loadData('ciudadanos');
      STATE.data.multas = await loadData('multas');
      STATE.data.arrestos = await loadData('arrestos');
      STATE.data.vehiculos = await loadData('vehiculos');
      STATE.data.denuncias = await loadData('denuncias');
      STATE.data.investigaciones = await loadData('investigaciones');
    }

    function showNotif(msg, type='info') {
      const n = document.createElement('div');
      n.style.cssText = `position:fixed;top:80px;right:20px;z-index:10000;padding:14px 24px;border-radius:10px;
        background:${type==='success'?'linear-gradient(90deg,#10b981,#059669)':'linear-gradient(90deg,#ef4444,#dc2626)'};
        color:white;font-weight:700;box-shadow:0 10px 40px rgba(0,0,0,0.6);animation:slideIn .3s ease`;
      n.textContent = msg;
      document.body.appendChild(n);
      setTimeout(() => n.remove(), 3000);
    }

    // ========== INIT ADMIN ==========
    async function initAdmin() {
      const users = await loadData('usuarios');
      if (users.length === 0) {
        await saveData('usuarios', [{
          id: 1,
          username: 'admin',
          password: 'admin123',
          nombre: 'Administrador del Sistema',
          rol: 'admin',
          placa: 'ADMIN-001',
          onDuty: false,
          fechaCreacion: new Date().toISOString()
        }]);
      }
    }

    // ========== CARDS ==========
    const CARDS = [
      { id:'ciudadanos', title:'Ciudadanos', desc:'Base de datos', icon:'üë§' },
      { id:'buscar', title:'B√∫squeda', desc:'Consultar registros', icon:'üîç' },
      { id:'multas', title:'Multas', desc:'Infracciones', icon:'üìã' },
      { id:'arrestos', title:'Arrestos', desc:'Detenciones', icon:'‚õìÔ∏è' },
      { id:'vehiculos', title:'Veh√≠culos', desc:'Registro vehicular', icon:'üöó' },
      { id:'denuncias', title:'Denuncias', desc:'Reportes ciudadanos', icon:'üìù' },
      { id:'investigaciones', title:'Investigaciones', desc:'Casos activos', icon:'üî¨' },
      { id:'estadisticas', title:'Estad√≠sticas', desc:'M√©tricas del sistema', icon:'üìä' },
      { id:'codigos', title:'C√≥digos', desc:'Se√±ales policiales', icon:'üö®' },
      { id:'admin', title:'Administraci√≥n', desc:'Gesti√≥n de usuarios', icon:'‚öôÔ∏è', adminOnly:true }
    ];

    function renderCards() {
      const grid = $('#cardsGrid');
      grid.innerHTML = '';
      
      CARDS.forEach(card => {
        if (card.adminOnly && (!STATE.currentUser || STATE.currentUser.rol !== 'admin')) return;
        
        const el = document.createElement('div');
        el.className = 'card';
        el.innerHTML = `
          <div class="icon">${card.icon}</div>
          <div class="title">${card.title}</div>
          <div class="desc">${card.desc}</div>
        `;
        el.onclick = () => openPanel(card.id);
        grid.appendChild(el);
      });
    }

    // ========== PANELS ==========
    function openPanel(id) {
      const area = $('#expandedArea');
      area.innerHTML = '';
      
      const panel = document.createElement('div');
      panel.className = 'expanded';
      area.appendChild(panel);
      
      switch(id) {
        case 'ciudadanos': renderCiudadanos(panel); break;
        case 'buscar': renderBuscar(panel); break;
        case 'multas': renderMultas(panel); break;
        case 'arrestos': renderArrestos(panel); break;
        case 'vehiculos': renderVehiculos(panel); break;
        case 'denuncias': renderDenuncias(panel); break;
        case 'investigaciones': renderInvestigaciones(panel); break;
        case 'estadisticas': renderEstadisticas(panel); break;
        case 'codigos': renderCodigos(panel); break;
        case 'admin': renderAdmin(panel); break;
      }
      
      panel.scrollIntoView({ behavior:'smooth' });
    }

    function renderCiudadanos(p) {
      p.innerHTML = `
        <div class="flex justify-between items-center" style="margin-bottom:20px">
          <div><strong style="font-size:20px">üë§ Ciudadanos</strong><div class="muted small">Base de datos</div></div>
          <button class="btn-ghost" onclick="$('#expandedArea').innerHTML=''">Cerrar</button>
        </div>
        <div style="display:grid;grid-template-columns:2fr 1fr;gap:20px">
          <div>
            <input id="searchCiudadano" placeholder="Buscar..." style="margin-bottom:12px"/>
            <div id="listCiudadanos" class="list"></div>
          </div>
          <div>
            <strong>Nuevo Ciudadano</strong>
            <div style="margin-top:12px;display:flex;flex-direction:column;gap:10px">
              <input id="cNombre" placeholder="Nombre *"/>
              <input id="cDNI" placeholder="DNI *"/>
              <input id="cFecha" type="date"/>
              <input id="cDireccion" placeholder="Direcci√≥n"/>
              <input id="cTelefono" placeholder="Tel√©fono"/>
              <button class="btn" onclick="crearCiudadano()">Registrar</button>
            </div>
          </div>
        </div>
      `;
      loadCiudadanos();
      $('#searchCiudadano').oninput = loadCiudadanos;
    }

    function loadCiudadanos() {
      const list = $('#listCiudadanos');
      const q = ($('#searchCiudadano')?.value || '').toLowerCase();
      const items = STATE.data.ciudadanos.filter(c => 
        c.nombre?.toLowerCase().includes(q) || c.dni?.toLowerCase().includes(q)
      );
      
      list.innerHTML = items.length ? items.map(c => `
        <div class="item">
          <div><strong>${html(c.nombre)}</strong><div class="muted small">DNI: ${html(c.dni)} ${c.telefono?'‚Ä¢ '+html(c.telefono):''}</div></div>
        </div>
      `).join('') : '<div class="muted small">No hay ciudadanos</div>';
    }

    async function crearCiudadano() {
      const nombre = $('#cNombre').value.trim();
      const dni = $('#cDNI').value.trim();
      if (!nombre || !dni) return showNotif('Complete los campos requeridos', 'error');
      
      STATE.data.ciudadanos.push({
        id: Date.now(),
        nombre, dni,
        fechaNacimiento: $('#cFecha').value,
        direccion: $('#cDireccion').value,
        telefono: $('#cTelefono').value,
        oficialRegistro: STATE.currentUser?.nombre || 'Sistema',
        fechaRegistro: new Date().toISOString()
      });
      
      await saveData('ciudadanos', STATE.data.ciudadanos);
      $('#cNombre').value = $('#cDNI').value = $('#cFecha').value = $('#cDireccion').value = $('#cTelefono').value = '';
      loadCiudadanos();
    }

    function renderBuscar(p) {
      p.innerHTML = `
        <div class="flex justify-between items-center" style="margin-bottom:20px">
          <div><strong style="font-size:20px">üîç B√∫squeda Global</strong></div>
          <button class="btn-ghost" onclick="$('#expandedArea').innerHTML=''">Cerrar</button>
        </div>
        <input id="globalSearch" placeholder="Buscar en todos los registros..." style="font-size:16px;padding:14px;margin-bottom:16px"/>
        <div id="searchResults"></div>
      `;
      
      $('#globalSearch').oninput = () => {
        const q = $('#globalSearch').value.toLowerCase();
        const res = $('#searchResults');
        if (q.length < 2) { res.innerHTML = '<div class="muted small">Escriba al menos 2 caracteres</div>'; return; }
        
        const c = STATE.data.ciudadanos.filter(x => x.nombre?.toLowerCase().includes(q) || x.dni?.toLowerCase().includes(q));
        const m = STATE.data.multas.filter(x => x.nombre?.toLowerCase().includes(q) || x.dni?.toLowerCase().includes(q));
        const a = STATE.data.arrestos.filter(x => x.nombre?.toLowerCase().includes(q) || x.dni?.toLowerCase().includes(q));
        const v = STATE.data.vehiculos.filter(x => x.matricula?.toLowerCase().includes(q) || x.propietarioNombre?.toLowerCase().includes(q));
        
        let html = '';
        if (c.length) html += `<h4>üë§ Ciudadanos (${c.length})</h4><div class="list">${c.slice(0,5).map(x=>`<div class="item"><strong>${x.nombre}</strong><div class="muted small">DNI: ${x.dni}</div></div>`).join('')}</div>`;
        if (m.length) html += `<h4 style="margin-top:16px">üìã Multas (${m.length})</h4><div class="list">${m.slice(0,5).map(x=>`<div class="item"><strong>${x.nombre}</strong><div class="muted small">${x.tipo} - $${x.importe}</div></div>`).join('')}</div>`;
        if (a.length) html += `<h4 style="margin-top:16px">‚õìÔ∏è Arrestos (${a.length})</h4><div class="list">${a.slice(0,5).map(x=>`<div class="item"><strong>${x.nombre}</strong><div class="muted small">${x.cargo}</div></div>`).join('')}</div>`;
        if (v.length) html += `<h4 style="margin-top:16px">üöó Veh√≠culos (${v.length})</h4><div class="list">${v.slice(0,5).map(x=>`<div class="item"><strong>${x.matricula}</strong><div class="muted small">${x.marca} ${x.modelo}</div></div>`).join('')}</div>`;
        
        res.innerHTML = html || '<div class="muted small">Sin resultados</div>';
      };
    }

    function renderMultas(p) {
      p.innerHTML = `
        <div class="flex justify-between items-center" style="margin-bottom:20px">
          <div><strong style="font-size:20px">üìã Multas</strong></div>
          <button class="btn-ghost" onclick="$('#expandedArea').innerHTML=''">Cerrar</button>
        </div>
        <div style="display:grid;grid-template-columns:2fr 1fr;gap:20px">
          <div id="listMultas" class="list"></div>
          <div>
            <strong>Nueva Multa</strong>
            <div style="margin-top:12px;display:flex;flex-direction:column;gap:10px">
              <input id="mDNI" placeholder="DNI *"/>
              <input id="mNombre" placeholder="Nombre *"/>
              <select id="mTipo">
                <option>Exceso de velocidad</option>
                <option>Estacionamiento indebido</option>
                <option>Conducci√≥n temeraria</option>
                <option>Conducir bajo efectos</option>
                <option>Documentaci√≥n irregular</option>
              </select>
              <input id="mImporte" type="number" placeholder="Importe *"/>
              <textarea id="mDesc" placeholder="Descripci√≥n..."></textarea>
              <button class="btn" onclick="crearMulta()">Registrar</button>
            </div>
          </div>
        </div>
      `;
      loadMultas();
    }

    function loadMultas() {
      const list = $('#listMultas');
      list.innerHTML = STATE.data.multas.length ? STATE.data.multas.map(m => `
        <div class="item">
          <div><strong>${html(m.nombre)}</strong><div class="muted small">${html(m.tipo)} - $${m.importe}</div></div>
          <div class="muted small">${new Date(m.fecha).toLocaleDateString()}</div>
        </div>
      `).join('') : '<div class="muted small">No hay multas</div>';
    }

    async function crearMulta() {
      const dni = $('#mDNI').value.trim();
      const nombre = $('#mNombre').value.trim();
      const tipo = $('#mTipo').value;
      const importe = $('#mImporte').value;
      if (!dni || !nombre || !tipo || !importe) return showNotif('Complete los campos', 'error');
      
      STATE.data.multas.push({
        id: Date.now(),
        dni, nombre, tipo, importe,
        descripcion: $('#mDesc').value,
        oficialRegistro: STATE.currentUser?.nombre || 'Sistema',
        fecha: new Date().toISOString()
      });
      
      await saveData('multas', STATE.data.multas);
      $('#mDNI').value = $('#mNombre').value = $('#mImporte').value = $('#mDesc').value = '';
      loadMultas();
    }

    function renderArrestos(p) {
      p.innerHTML = `
        <div class="flex justify-between items-center" style="margin-bottom:20px">
          <div><strong style="font-size:20px">‚õìÔ∏è Arrestos</strong></div>
          <button class="btn-ghost" onclick="$('#expandedArea').innerHTML=''">Cerrar</button>
        </div>
        <div style="display:grid;grid-template-columns:2fr 1fr;gap:20px">
          <div id="listArrestos" class="list"></div>
          <div>
            <strong>Nuevo Arresto</strong>
            <div style="margin-top:12px;display:flex;flex-direction:column;gap:10px">
              <input id="aDNI" placeholder="DNI *"/>
              <input id="aNombre" placeholder="Nombre *"/>
              <select id="aCargo">
                <option>Robo</option>
                <option>Asalto</option>
                <option>Homicidio</option>
                <option>Narcotr√°fico</option>
                <option>Secuestro</option>
                <option>Fraude</option>
                <option>Agresi√≥n</option>
              </select>
              <input id="aTiempo" type="number" placeholder="Meses de condena"/>
              <textarea id="aDetalles" placeholder="Detalles..."></textarea>
              <button class="btn" onclick="crearArresto()">Registrar</button>
            </div>
          </div>
        </div>
      `;
      loadArrestos();
    }

    function loadArrestos() {
      const list = $('#listArrestos');
      list.innerHTML = STATE.data.arrestos.length ? STATE.data.arrestos.map(a => `
        <div class="item">
          <div><strong>${html(a.nombre)}</strong><div class="muted small">${html(a.cargo)} - ${a.tiempo} meses</div></div>
          <div class="muted small">${new Date(a.fecha).toLocaleDateString()}</div>
        </div>
      `).join('') : '<div class="muted small">No hay arrestos</div>';
    }

    async function crearArresto() {
      const dni = $('#aDNI').value.trim();
      const nombre = $('#aNombre').value.trim();
      const cargo = $('#aCargo').value;
      const tiempo = $('#aTiempo').value;
      if (!dni || !nombre || !cargo) return showNotif('Complete los campos', 'error');
      
      STATE.data.arrestos.push({
        id: Date.now(),
        dni, nombre, cargo, tiempo,
        detalles: $('#aDetalles').value,
        oficialRegistro: STATE.currentUser?.nombre || 'Sistema',
        fecha: new Date().toISOString()
      });
      
      await saveData('arrestos', STATE.data.arrestos);
      $('#aDNI').value = $('#aNombre').value = $('#aTiempo').value = $('#aDetalles').value = '';
      loadArrestos();
    }

    function renderVehiculos(p) {
      p.innerHTML = `
        <div class="flex justify-between items-center" style="margin-bottom:20px">
          <div><strong style="font-size:20px">üöó Veh√≠culos</strong></div>
          <button class="btn-ghost" onclick="$('#expandedArea').innerHTML=''">Cerrar</button>
        </div>
        <div style="display:grid;grid-template-columns:2fr 1fr;gap:20px">
          <div id="listVehiculos" class="list"></div>
          <div>
            <strong>Nuevo Veh√≠culo</strong>
            <div style="margin-top:12px;display:flex;flex-direction:column;gap:10px">
              <input id="vMatricula" placeholder="Matr√≠cula *"/>
              <input id="vMarca" placeholder="Marca *"/>
              <input id="vModelo" placeholder="Modelo"/>
              <input id="vColor" placeholder="Color"/>
              <input id="vPropietarioDNI" placeholder="DNI Propietario"/>
              <input id="vPropietarioNombre" placeholder="Nombre Propietario"/>
              <button class="btn" onclick="crearVehiculo()">Registrar</button>
            </div>
          </div>
        </div>
      `;
      loadVehiculos();
    }

    function loadVehiculos() {
      const list = $('#listVehiculos');
      list.innerHTML = STATE.data.vehiculos.length ? STATE.data.vehiculos.map(v => `
        <div class="item">
          <div><strong>${html(v.matricula)}</strong><div class="muted small">${html(v.marca)} ${html(v.modelo)} - ${html(v.color)}</div></div>
          <div class="muted small">${html(v.propietarioNombre||'')}</div>
        </div>
      `).join('') : '<div class="muted small">No hay veh√≠culos</div>';
    }

    async function crearVehiculo() {
      const matricula = $('#vMatricula').value.trim();
      const marca = $('#vMarca').value.trim();
      if (!matricula || !marca) return showNotif('Complete los campos requeridos', 'error');
      
      STATE.data.vehiculos.push({
        id: Date.now(),
        matricula, marca,
        modelo: $('#vModelo').value,
        color: $('#vColor').value,
        propietarioDNI: $('#vPropietarioDNI').value,
        propietarioNombre: $('#vPropietarioNombre').value,
        oficialRegistro: STATE.currentUser?.nombre || 'Sistema',
        fechaRegistro: new Date().toISOString()
      });
      
      await saveData('vehiculos', STATE.data.vehiculos);
      $('#vMatricula').value = $('#vMarca').value = $('#vModelo').value = $('#vColor').value = $('#vPropietarioDNI').value = $('#vPropietarioNombre').value = '';
      loadVehiculos();
    }

    function renderDenuncias(p) {
      p.innerHTML = `
        <div class="flex justify-between items-center" style="margin-bottom:20px">
          <div><strong style="font-size:20px">üìù Denuncias</strong></div>
          <button class="btn-ghost" onclick="$('#expandedArea').innerHTML=''">Cerrar</button>
        </div>
        <div style="display:grid;grid-template-columns:2fr 1fr;gap:20px">
          <div id="listDenuncias" class="list"></div>
          <div>
            <strong>Nueva Denuncia</strong>
            <div style="margin-top:12px;display:flex;flex-direction:column;gap:10px">
              <input id="dRemitente" placeholder="Remitente"/>
              <input id="dTitulo" placeholder="T√≠tulo *"/>
              <textarea id="dDescripcion" placeholder="Descripci√≥n *"></textarea>
              <input id="dUbicacion" placeholder="Ubicaci√≥n"/>
              <button class="btn" onclick="crearDenuncia()">Registrar</button>
            </div>
          </div>
        </div>
      `;
      loadDenuncias();
    }

    function loadDenuncias() {
      const list = $('#listDenuncias');
      list.innerHTML = STATE.data.denuncias.length ? STATE.data.denuncias.map(d => `
        <div class="item">
          <div><strong>${html(d.titulo)}</strong><div class="muted small">${html((d.descripcion||'').slice(0,100))}</div></div>
          <div class="muted small">${html(d.remitente||'An√≥nimo')}<br>${new Date(d.fecha).toLocaleDateString()}</div>
        </div>
      `).join('') : '<div class="muted small">No hay denuncias</div>';
    }

    async function crearDenuncia() {
      const titulo = $('#dTitulo').value.trim();
      const descripcion = $('#dDescripcion').value.trim();
      if (!titulo || !descripcion) return showNotif('Complete los campos requeridos', 'error');
      
      STATE.data.denuncias.push({
        id: Date.now(),
        titulo, descripcion,
        remitente: $('#dRemitente').value || 'An√≥nimo',
        ubicacion: $('#dUbicacion').value,
        estado: 'Abierta',
        oficialRegistro: STATE.currentUser?.nombre || 'Sistema',
        fecha: new Date().toISOString()
      });
      
      await saveData('denuncias', STATE.data.denuncias);
      $('#dRemitente').value = $('#dTitulo').value = $('#dDescripcion').value = $('#dUbicacion').value = '';
      loadDenuncias();
    }

    function renderInvestigaciones(p) {
      p.innerHTML = `
        <div class="flex justify-between items-center" style="margin-bottom:20px">
          <div><strong style="font-size:20px">üî¨ Investigaciones</strong></div>
          <button class="btn-ghost" onclick="$('#expandedArea').innerHTML=''">Cerrar</button>
        </div>
        <div style="display:grid;grid-template-columns:2fr 1fr;gap:20px">
          <div id="listInvestigaciones" class="list"></div>
          <div>
            <strong>Nueva Investigaci√≥n</strong>
            <div style="margin-top:12px;display:flex;flex-direction:column;gap:10px">
              <input id="iTitulo" placeholder="T√≠tulo *"/>
              <textarea id="iDescripcion" placeholder="Descripci√≥n *"></textarea>
              <select id="iEstado">
                <option>En Progreso</option>
                <option>Suspendida</option>
                <option>Cerrada</option>
              </select>
              <button class="btn" onclick="crearInvestigacion()">Registrar</button>
            </div>
          </div>
        </div>
      `;
      loadInvestigaciones();
    }

    function loadInvestigaciones() {
      const list = $('#listInvestigaciones');
      list.innerHTML = STATE.data.investigaciones.length ? STATE.data.investigaciones.map(i => `
        <div class="item">
          <div><strong>${html(i.titulo)}</strong><div class="muted small">${html((i.descripcion||'').slice(0,100))}</div></div>
          <div class="muted small">${html(i.estado)}<br>${new Date(i.fechaInicio).toLocaleDateString()}</div>
        </div>
      `).join('') : '<div class="muted small">No hay investigaciones</div>';
    }

    async function crearInvestigacion() {
      const titulo = $('#iTitulo').value.trim();
      const descripcion = $('#iDescripcion').value.trim();
      if (!titulo || !descripcion) return showNotif('Complete los campos requeridos', 'error');
      
      STATE.data.investigaciones.push({
        id: Date.now(),
        titulo, descripcion,
        estado: $('#iEstado').value,
        oficialRegistro: STATE.currentUser?.nombre || 'Sistema',
        fechaInicio: new Date().toISOString()
      });
      
      await saveData('investigaciones', STATE.data.investigaciones);
      $('#iTitulo').value = $('#iDescripcion').value = '';
      loadInvestigaciones();
    }

    function renderEstadisticas(p) {
      p.innerHTML = `
        <div class="flex justify-between items-center" style="margin-bottom:20px">
          <div><strong style="font-size:20px">üìä Estad√≠sticas</strong></div>
          <button class="btn-ghost" onclick="$('#expandedArea').innerHTML=''">Cerrar</button>
        </div>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px">
          <div class="item" style="text-align:center;padding:24px">
            <div style="font-size:42px;font-weight:900;color:var(--accent)">${STATE.data.ciudadanos.length}</div>
            <div class="muted small">Ciudadanos</div>
          </div>
          <div class="item" style="text-align:center;padding:24px">
            <div style="font-size:42px;font-weight:900;color:var(--accent-2)">${STATE.data.multas.length}</div>
            <div class="muted small">Multas</div>
          </div>
          <div class="item" style="text-align:center;padding:24px">
            <div style="font-size:42px;font-weight:900;color:var(--danger)">${STATE.data.arrestos.length}</div>
            <div class="muted small">Arrestos</div>
          </div>
          <div class="item" style="text-align:center;padding:24px">
            <div style="font-size:42px;font-weight:900;color:var(--accent)">${STATE.data.vehiculos.length}</div>
            <div class="muted small">Veh√≠culos</div>
          </div>
          <div class="item" style="text-align:center;padding:24px">
            <div style="font-size:42px;font-weight:900;color:var(--accent-2)">${STATE.data.denuncias.length}</div>
            <div class="muted small">Denuncias</div>
          </div>
          <div class="item" style="text-align:center;padding:24px">
            <div style="font-size:42px;font-weight:900;color:var(--accent)">${STATE.data.investigaciones.length}</div>
            <div class="muted small">Investigaciones</div>
          </div>
        </div>
        <div style="margin-top:24px">
          <strong>Actividad Reciente</strong>
          <div class="list" style="margin-top:12px">
            ${generateRecentActivity()}
          </div>
        </div>
      `;
    }

    function generateRecentActivity() {
      const all = [
        ...STATE.data.ciudadanos.map(x => ({...x, type:'üë§ Ciudadano', date:x.fechaRegistro})),
        ...STATE.data.multas.map(x => ({...x, type:'üìã Multa', date:x.fecha})),
        ...STATE.data.arrestos.map(x => ({...x, type:'‚õìÔ∏è Arresto', date:x.fecha})),
        ...STATE.data.vehiculos.map(x => ({...x, type:'üöó Veh√≠culo', date:x.fechaRegistro}))
      ].sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0,10);
      
      return all.length ? all.map(x => `
        <div class="item">
          <div><strong>${x.type}</strong><div class="muted small">${html(x.nombre||x.matricula||x.titulo||'‚Äî')}</div></div>
          <div class="muted small">${new Date(x.date).toLocaleString()}<br>${html(x.oficialRegistro||'‚Äî')}</div>
        </div>
      `).join('') : '<div class="muted small">Sin actividad</div>';
    }

    function renderCodigos(p) {
      const codigos = [
        {code:'10-4', desc:'Mensaje recibido'},
        {code:'10-6', desc:'Ocupado'},
        {code:'10-8', desc:'En servicio'},
        {code:'10-15', desc:'Detenido'},
        {code:'10-20', desc:'Ubicaci√≥n'},
        {code:'10-23', desc:'En posici√≥n'},
        {code:'10-31', desc:'Crimen en progreso'},
        {code:'10-32', desc:'Persona armada'},
        {code:'10-99', desc:'Oficial ca√≠do'},
        {code:'C√≥digo 0', desc:'Oficial en peligro - M√°xima prioridad'},
        {code:'C√≥digo 1', desc:'Situaci√≥n bajo control'},
        {code:'C√≥digo 2', desc:'Respuesta urgente'},
        {code:'C√≥digo 3', desc:'Respuesta de emergencia'},
        {code:'C√≥digo 4', desc:'No se requiere asistencia'}
      ];
      
      p.innerHTML = `
        <div class="flex justify-between items-center" style="margin-bottom:20px">
          <div><strong style="font-size:20px">üö® C√≥digos Policiales</strong></div>
          <button class="btn-ghost" onclick="$('#expandedArea').innerHTML=''">Cerrar</button>
        </div>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px">
          ${codigos.map(c => `
            <div class="item" style="text-align:center;padding:20px;cursor:pointer" onclick="showNotif('${c.code}: ${c.desc}','info')">
              <div style="font-size:24px;font-weight:900;color:var(--accent);margin-bottom:8px">${c.code}</div>
              <div class="muted small">${c.desc}</div>
            </div>
          `).join('')}
        </div>
      `;
    }

    function renderAdmin(p) {
      if (!STATE.currentUser || STATE.currentUser.rol !== 'admin') {
        p.innerHTML = '<div class="item"><strong>Acceso Denegado</strong><div class="muted small">Solo administradores pueden acceder</div></div>';
        return;
      }
      
      p.innerHTML = `
        <div class="flex justify-between items-center" style="margin-bottom:20px">
          <div><strong style="font-size:20px">‚öôÔ∏è Administraci√≥n</strong></div>
          <button class="btn-ghost" onclick="$('#expandedArea').innerHTML=''">Cerrar</button>
        </div>
        <div style="display:grid;grid-template-columns:2fr 1fr;gap:20px">
          <div>
            <strong>Usuarios del Sistema</strong>
            <div id="listUsuarios" class="list" style="margin-top:12px"></div>
          </div>
          <div>
            <strong>Crear Nuevo Usuario</strong>
            <div style="margin-top:12px;display:flex;flex-direction:column;gap:10px">
              <input id="uUsername" placeholder="Usuario *"/>
              <input id="uPassword" type="password" placeholder="Contrase√±a *"/>
              <input id="uNombre" placeholder="Nombre completo *"/>
              <input id="uPlaca" placeholder="Placa"/>
              <select id="uRol">
                <option value="oficial">Oficial</option>
                <option value="sargento">Sargento</option>
                <option value="admin">Administrador</option>
              </select>
              <button class="btn" onclick="crearUsuario()">Crear Usuario</button>
            </div>
          </div>
        </div>
      `;
      loadUsuarios();
    }

    function loadUsuarios() {
      const list = $('#listUsuarios');
      if (!list) return;
      
      list.innerHTML = STATE.data.usuarios.length ? STATE.data.usuarios.map(u => `
        <div class="item">
          <div>
            <strong>${html(u.nombre)}</strong>
            <div class="muted small">Usuario: ${html(u.username)} ‚Ä¢ Rol: ${html(u.rol)} ‚Ä¢ Placa: ${html(u.placa||'‚Äî')}</div>
          </div>
          <button class="btn-ghost" onclick="eliminarUsuario(${u.id})" ${u.username==='admin'?'disabled':''}>
            ${u.username==='admin'?'Protegido':'Eliminar'}
          </button>
        </div>
      `).join('') : '<div class="muted small">No hay usuarios</div>';
    }

    async function crearUsuario() {
      const username = $('#uUsername').value.trim();
      const password = $('#uPassword').value.trim();
      const nombre = $('#uNombre').value.trim();
      
      if (!username || !password || !nombre) return showNotif('Complete los campos requeridos', 'error');
      
      if (STATE.data.usuarios.find(u => u.username === username)) {
        return showNotif('El usuario ya existe', 'error');
      }
      
      STATE.data.usuarios.push({
        id: Date.now(),
        username, password, nombre,
        placa: $('#uPlaca').value,
        rol: $('#uRol').value,
        onDuty: false,
        fechaCreacion: new Date().toISOString()
      });
      
      await saveData('usuarios', STATE.data.usuarios);
      $('#uUsername').value = $('#uPassword').value = $('#uNombre').value = $('#uPlaca').value = '';
      loadUsuarios();
    }

    async function eliminarUsuario(id) {
      if (!confirm('¬øEst√° seguro de eliminar este usuario?')) return;
      
      STATE.data.usuarios = STATE.data.usuarios.filter(u => u.id !== id);
      await saveData('usuarios', STATE.data.usuarios);
      loadUsuarios();
    }

    // ========== AUTH ==========
    function updateUI() {
      $('#userDisplay').textContent = STATE.currentUser 
        ? `${STATE.currentUser.nombre} (${STATE.currentUser.rol})` 
        : 'No conectado';
      
      $('#btnLogin').style.display = STATE.currentUser ? 'none' : 'inline-block';
      $('#btnLogout').style.display = STATE.currentUser ? 'inline-block' : 'none';
      $('#adminIndicator').style.display = STATE.currentUser && STATE.currentUser.rol === 'admin' ? 'inline-block' : 'none';
      
      renderCards();
    }

    $('#btnLogin').onclick = () => $('#loginModal').classList.add('show');
    $('#btnCancelLogin').onclick = () => $('#loginModal').classList.remove('show');
    $('#btnLogout').onclick = () => {
      STATE.currentUser = null;
      updateUI();
      $('#expandedArea').innerHTML = '';
      showNotif('Sesi√≥n cerrada', 'info');
    };

    $('#btnDoLogin').onclick = async () => {
      const username = $('#loginUser').value.trim();
      const password = $('#loginPass').value.trim();
      
      if (!username || !password) {
        $('#loginError').textContent = 'Complete todos los campos';
        $('#loginError').style.display = 'block';
        return;
      }
      
      const user = STATE.data.usuarios.find(u => u.username === username && u.password === password);
      
      if (!user) {
        $('#loginError').textContent = 'Usuario o contrase√±a incorrectos';
        $('#loginError').style.display = 'block';
        return;
      }
      
      STATE.currentUser = user;
      updateUI();
      $('#loginModal').classList.remove('show');
      $('#loginUser').value = $('#loginPass').value = '';
      $('#loginError').style.display = 'none';
      showNotif(`Bienvenido ${user.nombre}`, 'success');
    };

    // ========== INIT ==========
    (async () => {
      await initAdmin();
      await loadAllData();
      updateUI();
    })();
  </script>
</body>
</html>
