<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Daynight RP — Sistema Policial</title>
  <style>
    :root {
      --bg-1: #0a0f1a;
      --bg-2: #0c1628;
      --muted: #a0b8c6;
      --text: #eaf4fc;
      --accent: #4f46e5;
      --accent-2: #06b6d4;
      --danger: #ef4444;
      --glass: rgba(255,255,255,0.03);
      --card-grad: linear-gradient(180deg, rgba(255,255,255,0.014), rgba(255,255,255,0.006));
      --radius: 12px;
      --shadow: 0 14px 40px rgba(2,6,10,0.6);
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    }
    html, body {
      height: 100%;
      margin: 0;
      background:
        radial-gradient(800px 300px at 12% 8%, rgba(79,70,229,0.06), transparent),
        linear-gradient(180deg,var(--bg-2) 0%, var(--bg-1) 60%);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
    }
    a { color: var(--accent) }

    .bg {
      position: fixed;
      inset: 0;
      z-index: 0;
      pointer-events: none;
      overflow: hidden;
    }
    .nebula {
      position: absolute;
      width: 60vmax;
      height: 60vmax;
      left: -10vmin;
      top: -8vmin;
      background:
        radial-gradient(circle at 30% 30%, rgba(79,70,229,0.24), transparent 30%),
        radial-gradient(circle at 70% 70%, rgba(6,182,164,0.12), transparent 25%);
      filter: blur(56px) saturate(120%);
      transform: translateZ(0);
      animation: float 12s ease-in-out infinite;
      opacity: 0.95;
    }
    .nebula.r {
      right: -10vmin;
      left: auto;
      top: 6vmin;
      background:
        radial-gradient(circle at 70% 20%, rgba(255,80,120,0.20), transparent 30%),
        radial-gradient(circle at 30% 80%, rgba(110,231,183,0.12), transparent 25%);
      animation-duration: 10s;
      animation-direction: reverse;
    }
    .gridOverlay {
      position: absolute;
      inset: 0;
      background-image:
        linear-gradient(transparent 96%, rgba(255,255,255,0.01) 96%),
        linear-gradient(90deg, transparent 96%, rgba(255,255,255,0.01) 96%);
      background-size: 320px 320px;
      opacity: 0.03;
    }
    .stripes {
      position: absolute;
      inset: 0;
      opacity: 0.12;
      filter: blur(18px) saturate(120%);
      background:
        linear-gradient(90deg, rgba(79,70,229,0.06) 0 20%, transparent 20% 50%),
        linear-gradient(90deg, rgba(255,40,80,0.05) 50% 70%, transparent 70% 100%);
      mix-blend-mode: overlay;
      animation: stripesShift 6s linear infinite;
    }
    @keyframes float {
      0% { transform: translateY(-8px) }
      50% { transform: translateY(8px) }
      100% { transform: translateY(-8px) }
    }
    @keyframes stripesShift {
      0% { background-position: 0 0, 100% 0 }
      50% { background-position: 50% 0, 50% 0 }
      100% { background-position: 0 0, 100% 0 }
    }

    .wrap {
      max-width: 1150px;
      margin: 22px auto;
      padding: 20px;
      display: grid;
      grid-template-rows: auto 1fr;
      gap: 18px;
      position: relative;
      z-index: 2;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 18px;
    }
    .brand {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    .logo {
      width: 60px;
      height: 60px;
      border-radius: 12px;
      background: linear-gradient(135deg,var(--accent-2),var(--accent));
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 900;
      color: #031018;
    }
    h1 {
      margin: 0;
      font-size: 18px;
    }
    .subtitle {
      color: var(--muted);
      font-size: 13px;
    }

    .top-right {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .pill {
      background: var(--glass);
      padding: 8px 12px;
      border-radius: 999px;
      font-weight: 700;
      color: var(--muted);
    }
    .btn {
      background: linear-gradient(90deg,var(--accent),var(--accent-2));
      color: #031018;
      padding: 8px 12px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      font-weight: 800;
      box-shadow: 0 8px 24px rgba(20,10,40,0.12);
    }
    .btn-ghost {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.04);
      color: var(--muted);
      padding: 7px 10px;
      border-radius: 10px;
      cursor: pointer;
    }
    .notif-pill {
      background: linear-gradient(90deg,var(--accent-2),var(--accent));
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 800;
      color: #031018;
      cursor: pointer;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(3,1fr);
      gap: 16px;
    }
    @media (max-width:980px){ .grid{grid-template-columns:repeat(2,1fr)} }
    @media (max-width:640px){ .grid{grid-template-columns:1fr} }

    .card {
      background: var(--card-grad);
      border-radius: var(--radius);
      padding: 18px;
      border: 1px solid rgba(255,255,255,0.04);
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-height: 120px;
      transition: transform .18s, box-shadow .18s, border-color .18s;
      position: relative;
      overflow: hidden;
    }
    .card .card-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .card .title {
      font-weight: 900;
      font-size: 16px;
    }
    .card .desc {
      color: var(--muted);
      font-size: 13px;
    }
    .card:hover {
      transform: translateY(-8px);
      box-shadow: 0 30px 60px rgba(0,0,0,0.7);
      border-color: rgba(79,70,229,0.12);
    }
    .card.active {
      outline: 2px solid rgba(79,70,229,0.18);
      transform: translateY(-6px) scale(1.01);
    }

    footer {
      margin-top  </style>
</head>
<body>
  <div class="bg" aria-hidden="true">
    <div class="nebula"></div>
    <div class="nebula r"></div>
    <div class="gridOverlay"></div>
    <div class="stripes"></div>
  </div>

  <div class="wrap" role="main">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <img src="https://cdn.discordapp.com/attachments/1421898595271180360/1425878366116122654/LOGO_WIZARD_FONDO.png.png" alt="logo" style="width:100%;height:100%;object-fit:cover;border-radius:8px">
        </div>
        <div>
          <h1>Daynight RP — Sistema Policial</h1>
          <div class="subtitle">Interfaz mejorada • Firestore sincronizado</div>
        </div>
      </div>
      <div class="top-right">
        <div id="userDisplay" class="pill">No conectado</div>
        <div id="dutyStatus" class="pill">En servicio: 0</div>
        <div id="notifWrap" style="display:inline-flex;align-items:center">
          <div id="notifPill" class="notif-pill" style="display:none">Alertas 0</div>
        </div>
        <button id="btnExport" class="btn">Exportar</button>
        <button id="btnLogin" class="btn-ghost">Entrar</button>
        <div id="adminModeWrap" style="display:none">
          <span id="adminModePill" class="admin-mode-pill">Admin: OFF</span>
        </div>
      </div>
    </header>

    <section class="grid" id="cardsRoot" aria-label="Paneles principales"></section>
    <div id="expandedRoot" aria-live="polite"></div>
    <footer>Hecho para Daynight RP • UI actualizada • Firestore-only</footer>
  </div>

  <!-- Modal de login -->
  <div id="loginModal" class="overlay" style="display:none" aria-hidden="true">
    <div class="modal fade-in" role="dialog" aria-modal="true">
      <h3>Entrar / Registrarse</h3>
      <div class="muted small">Demo con Firestore. En producción: Firebase Auth + reglas.</div>
      <div style="margin-top:12px">
        <label class="muted small" for="loginUser">Usuario</label>
        <input id="loginUser" placeholder="usuario"/>
        <label class="muted small" for="loginPass" style="margin-top:8px">Contraseña</label>
        <input id="loginPass" type="password" placeholder="contraseña"/>
        <div style="display:flex;gap:8px;margin-top:12px">
          <button id="loginBtnModal" class="btn">Entrar</button>
          <button id="guestBtn" class="btn-ghost">Invitado</button>
          <div style="margin-left:auto" class="small muted">¿Sin cuenta? <span id="showReg" style="cursor:pointer;color:var(--accent)">Crear</span></div>
        </div>
        <div id="loginError" class="muted small" style="margin-top:8px;color:var(--danger);display:none"></div>
      </div>
      <div id="registerBlock" style="display:none;margin-top:12px;border-top:1px dashed rgba(255,255,255,0.03);padding-top:12px">
        <h4 style="margin:0 0 8px 0">Crear cuenta</h4>
        <label class="muted small">Nombre visible</label>
        <input id="regName" placeholder="Ej: Ofc. Pérez"/>
        <label class="muted small">Usuario</label>
        <input id="regUser" placeholder="usuario"/>
        <label class="muted small">Contraseña</label>
        <input id="regPass" type="password" placeholder="contraseña"/>
        <div style="display:flex;gap:8px;margin-top:8px">
          <select id="regRole">
            <option value="officer">Oficial</option>
            <option value="sergeant">Sargento</option>
            <option value="dispatcher">Despachador</option>
            <option value="admin">Administrador</option>
          </select>
          <button id="regCreate" class="btn">Crear</button>
          <button id="regCancel" class="btn-ghost">Cancelar</button>
        </div>
        <div id="regMsg" class="muted small" style="margin-top:8px"></div>
      </div>
    </div>
  </div>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import {
      getFirestore, collection, getDocs, addDoc, setDoc, doc, deleteDoc, updateDoc,
      onSnapshot, query, where, orderBy
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCskczYgGtlPPBEIZiE5PuY7s_cfE_3Chg",
      authDomain: "wizard-rp.firebaseapp.com",
      projectId: "wizard-rp",
      storageBucket: "wizard-rp.firebasestorage.app",
      messagingSenderId: "479456044047",
      appId: "1:479456044047:web:65c52e2430bcb6ca586f7a",
      measurementId: "G-KX5Y56CG0R"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const COL = name => collection(db, name);

    const STATE = {
      currentUser: null,
      adminMode: false,
      selectedCard: null,
      unsub: {},
      lastAlertCount: 0
    };

    const $ = (sel, root=document) => root.querySelector(sel);
    const escapeHtml = s => (s||'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));

    async function pushLog(msg){
      try{ await addDoc(COL('logs'), { t: Date.now(), msg }); }catch(e){ console.warn('pushLog', e); }
    }

    const cardsRoot = $('#cardsRoot');
    const expandedRoot = $('#expandedRoot');
    const userDisplay = $('#userDisplay');
    const dutyStatus = $('#dutyStatus');
    const btnLogin = $('#btnLogin');
    const btnExport = $('#btnExport');
    const adminModeWrap = $('#adminModeWrap');
    const adminModePill = $('#adminModePill');
    const notifPill = $('#notifPill');

    const CARDS = [
      { id:'pda', title:'Fichas PDA', desc:'Buscar y crear fichas', icon:'👤🔒' },
      { id:'calls', title:'Llamadas', desc:'Crear y asignar llamadas', icon:'📟' },
      { id:'reports', title:'Informes', desc:'Crear y consultar informes', icon:'📝' },
      { id:'wanted', title:'Buscados / BOLO', desc:'Personas buscadas', icon:'🚔' },
      { id:'fines', title:'Multas', desc:'Generar sanciones', icon:'💰' },
      { id:'service', title:'Servicio', desc:'Entrar / Salir de servicio', icon:'🦺' },
      { id:'alerts', title:'Alertas', desc:'Crear y gestionar alertas', icon:'📢' },
      { id:'radio', title:'Radio', desc:'Chat por canales', icon:'📡' },
      { id:'admin', title:'Administración', desc:'Roles y usuarios', icon:'⚙️' },
      { id:'logs', title:'Auditoría', desc:'Historial de acciones', icon:'📜' }
    ];

    function renderCards(){
      cardsRoot.innerHTML = '';
      const isAdmin = STATE.currentUser && STATE.currentUser.role === 'admin';
      CARDS.forEach(c=>{
        if((c.id === 'admin' || c.id === 'logs') && !isAdmin) return;
        const el = document.createElement('div');
        el.className = 'card';
        el.dataset.id = c.id;
        el.innerHTML = `<div class="card-head">
          <div><div class="title">${c.title}</div><div class="desc">${c.desc}</div></div>
          <div style="display:flex;flex-direction:column;align-items:flex-end">
            <div style="font-size:26px">${c.icon}</div>
            <button class="btn-ghost open-btn" data-open="${c.id}" style="margin-top:8px">Abrir</button>
          </div>
        </div>`;
        el.addEventListener('click', (e)=> {
          if(e.target && e.target.matches('button')) return;
          openCard(c.id, el);
        });
        el.querySelector('.open-btn').addEventListener('click', (e)=> { e.stopPropagation(); openCard(c.id, el); });
        cardsRoot.appendChild(el);
      });
    }

    function setActiveCard(el){
      document.querySelectorAll('.card').forEach(c=>c.classList.remove('active'));
      if(el) el.classList.add('active');
    }

    function clearExpanded(){
      if(STATE.unsub.currentPanel && typeof STATE.unsub.currentPanel === 'function') {
        try{ STATE.unsub.currentPanel(); } catch(e){}
        STATE.unsub.currentPanel = null;
      }
      expandedRoot.innerHTML = '';
      setActiveCard(null);
    }

    async function openCard(id, cardEl=null){
      clearExpanded();
      setActiveCard(cardEl);
      const panel = document.createElement('div');
      panel.className = 'expanded';
      expandedRoot.appendChild(panel);
      switch(id){
        case 'pda': await renderPDA(panel); break;
        case 'calls': await renderCalls(panel); break;
        case 'reports': await renderReports(panel); break;
        case 'wanted': await renderWanted(panel); break;
        case 'fines': await renderFines(panel); break;
        case 'service': await renderService(panel); break;
        case 'alerts': await renderAlerts(panel); break;
        case 'radio': await renderRadio(panel); break;
        case 'admin': await renderAdmin(panel); break;
        case 'logs': await renderLogs(panel); break;
        default: panel.textContent = 'Panel no implementado'; break;
      }
      panel.scrollIntoView({ behavior:'smooth', block:'start' });
    }

    async function hasPerm(perm){
      if(!STATE.currentUser) return perm === 'create_call' ? true : false;
      try{
        const rSnap = await getDocs(query(COL('roles'), where('__name__','==', STATE.currentUser.role)));
        let role = null; rSnap.forEach(d=> role = d.data());
        if(!role) return false;
        if(Array.isArray(role.permissions) && role.permissions.includes('all')){
          const sensitive = ['delete_reports','delete_alerts','manage_users','manage_roles','delete_all_alerts','impersonate','view_logs','all'];
          if(sensitive.includes(perm)) return STATE.adminMode === true;
          return true;
        }
        return role.permissions && role.permissions.includes(perm);
      }catch(e){ console.warn('hasPerm error', e); return false; }
    }

    // Aquí irían las funciones renderPDA, renderCalls, renderReports, renderWanted, renderFines, renderAlerts, etc.
    // Ya las tienes implementadas en tu código original y en las partes anteriores.

    renderCards();
  </script>
</body>
</html>
