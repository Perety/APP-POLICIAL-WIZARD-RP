<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Daynight RP ‚Äî PDA / CAD (Completo & Mejorado)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
<style>
/* ================= THEME & LAYOUT ================= */
:root{
  --bg-1:#041021; --bg-2:#071729;
  --muted:#9fb3bd; --text:#e9f2f6;
  --accent-1:#7c3aed; --accent-2:#06b6a4; --accent-3:#ff7ab6;
  --glass: rgba(255,255,255,0.03);
  --card-grad: linear-gradient(180deg, rgba(255,255,255,0.012), rgba(255,255,255,0.006));
  --radius:12px; --shadow: 0 20px 60px rgba(2,6,10,0.6);
  font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, Arial;
  -webkit-font-smoothing:antialiased;
}

/* Reset */
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg-2),var(--bg-1));color:var(--text);}

/* Background visuals */
.bg{position:fixed;inset:0;z-index:0;pointer-events:none;overflow:hidden}
.blob{position:absolute;border-radius:50%;filter:blur(80px) saturate(120%);opacity:.95}
.blob.a{width:80vmax;height:80vmax;left:-10vmin;top:-16vmin;background:radial-gradient(circle at 20% 20%, rgba(124,58,237,0.18), transparent 20%);animation:float1 20s linear infinite}
.blob.b{width:60vmax;height:60vmax;right:-8vmin;bottom:-12vmin;background:radial-gradient(circle at 80% 80%, rgba(6,182,164,0.12), transparent 20%);animation:float2 24s linear infinite}
@keyframes float1{0%{transform:translateY(-12px)}50%{transform:translateY(12px)}100%{transform:translateY(-12px)}}
@keyframes float2{0%{transform:translateY(8px)}50%{transform:translateY(-8px)}100%{transform:translateY(8px)}}

/* Layout */
.container{max-width:1200px;margin:28px auto;padding:26px;position:relative;z-index:2;display:grid;grid-template-rows:auto 1fr;gap:20px}
.header{display:flex;align-items:center;justify-content:space-between}
.brand{display:flex;gap:14px;align-items:center}
.logo{width:72px;height:72px;border-radius:14px;background:linear-gradient(135deg,var(--accent-2),var(--accent-1));display:flex;align-items:center;justify-content:center;font-weight:900;color:#031018}
.title{margin:0;font-size:18px}
.subtitle{margin:0;color:var(--muted);font-size:13px}
.header-actions{display:flex;gap:10px;align-items:center}
.pill{background:var(--glass);padding:8px 12px;border-radius:999px;font-weight:700;color:var(--muted)}

.btn{background:linear-gradient(90deg,var(--accent-1),var(--accent-2));color:#031018;padding:8px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:800}
.btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);padding:7px 10px;border-radius:10px;cursor:pointer}

/* Grid */
.grid{display:grid;grid-template-columns:repeat(4,1fr);gap:18px}
@media(max-width:1200px){.grid{grid-template-columns:repeat(3,1fr)}}
@media(max-width:900px){.grid{grid-template-columns:repeat(2,1fr)}}
@media(max-width:640px){.grid{grid-template-columns:1fr}}

/* Card */
.card{background:var(--card-grad);border-radius:14px;padding:18px;border:1px solid rgba(255,255,255,0.04);box-shadow:var(--shadow);display:flex;flex-direction:column;gap:12px;min-height:120px;transition:transform .18s,box-shadow .18s}
.card:hover{transform:translateY(-6px)}
.card-head{display:flex;align-items:center;justify-content:space-between}
.card-logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(90deg,var(--accent-2),var(--accent-1));display:flex;align-items:center;justify-content:center;color:#031018;font-weight:900}
.card .title{font-weight:900}
.card .desc{color:var(--muted);font-size:13px}

/* Panel */
.panel{margin-top:12px;border-radius:12px;padding:18px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.004));border:1px solid rgba(255,255,255,0.04);box-shadow:0 18px 46px rgba(0,0,0,0.6);animation:panelIn .28s both}
@keyframes panelIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:none}}

/* list & forms */
.list{display:flex;flex-direction:column;gap:10px}
.item{padding:12px;border-radius:10px;background:rgba(255,255,255,0.012);border:1px solid rgba(255,255,255,0.03);display:flex;align-items:center;justify-content:space-between;gap:12px}
input,textarea,select{background:rgba(0,0,0,0.16);border:1px solid rgba(255,255,255,0.04);padding:10px;border-radius:8px;color:inherit}
textarea{min-height:100px}

/* radio */
.radio-wrap{display:flex;gap:12px;align-items:flex-start}
.radio-left{flex:1;display:flex;flex-direction:column;gap:10px}
.radio-right{width:320px}
.radio-messages{max-height:380px;overflow:auto;padding:12px;border-radius:10px;background:rgba(0,0,0,0.14);border:1px solid rgba(255,255,255,0.02)}
.radio-msg{display:flex;gap:10px;align-items:flex-start}
.radio-msg.me{flex-direction:row-reverse}
.radio-avatar{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:linear-gradient(90deg,var(--accent-1),var(--accent-2));color:#031018;font-weight:800}
.radio-bubble{padding:10px;border-radius:10px;background:rgba(0,0,0,0.34)}
.radio-bubble.me{background:linear-gradient(90deg,var(--accent-1),var(--accent-2));color:#031018}
.radio-meta{font-size:11px;color:var(--muted);margin-top:6px}

/* modal */
.overlay{position:fixed;inset:0;background:linear-gradient(rgba(2,6,10,0.6),rgba(2,6,10,0.8));display:flex;align-items:center;justify-content:center;z-index:9999}
.modal{width:920px;max-width:96%;background:linear-gradient(180deg,#071729,#061421);padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}

/* toast */
.toast{position:fixed;right:20px;bottom:20px;z-index:9999;min-width:220px;background:rgba(0,0,0,0.7);padding:10px;border-radius:8px;color:var(--text);box-shadow:0 8px 28px rgba(0,0,0,0.5);margin-top:8px}
</style>
</head>
<body>
  <div class="bg" aria-hidden="true">
    <div class="blob a"></div>
    <div class="blob b"></div>
  </div>

  <div class="container" role="main">
    <header class="header">
      <div class="brand">
        <div class="logo" aria-hidden="true">DN</div>
        <div>
          <h1 class="title">Daynight RP ‚Äî PDA / CAD</h1>
          <div class="subtitle muted">Completo ‚Äî Firestore, Auth, Storage, Functions</div>
        </div>
      </div>

      <div class="header-actions">
        <div id="userDisplay" class="pill">No conectado</div>
        <div id="dutyStatus" class="pill">En servicio: 0</div>
        <div id="notifWrap"><div id="notifPill" class="pill" style="display:none;background:linear-gradient(90deg,var(--accent-2),var(--accent-1));color:#031018">Alertas</div></div>
        <button id="btnExport" class="btn">Exportar</button>
        <button id="btnLogin" class="btn-ghost">Entrar</button>
      </div>
    </header>

    <main>
      <section class="grid" id="cardsRoot" aria-label="Paneles principales"></section>
      <div id="expandedRoot" aria-live="polite"></div>
    </main>

    <footer style="margin-top:28px;text-align:center;color:var(--muted)">Hecho para Daynight RP ‚Ä¢ Consolidado</footer>
  </div>

  <!-- Login modal (Firebase Auth) -->
  <div id="loginModal" class="overlay" style="display:none" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <h3>Entrar</h3>
      <div class="muted tiny">Inicia sesi√≥n con Email + Contrase√±a. Si eres admin puedes crear usuarios desde Administraci√≥n.</div>
      <div style="margin-top:12px;display:flex;flex-direction:column;gap:8px">
        <input id="authEmail" placeholder="email@example.com" type="email" />
        <input id="authPass" placeholder="contrase√±a" type="password" />
        <div style="display:flex;gap:8px">
          <button id="btnSignIn" class="btn">Entrar</button>
          <button id="btnReset" class="btn-ghost">Recuperar contrase√±a</button>
          <button id="btnCloseLogin" class="btn-ghost" style="margin-left:auto">Cerrar</button>
        </div>
        <div id="authMsg" class="muted tiny"></div>
      </div>
    </div>
  </div>

  <div id="toastContainer" aria-live="polite" aria-atomic="true"></div>

<script type="module">
/* ================= FIREBASE (modular) ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";

import {
  getFirestore, collection, getDocs, addDoc, setDoc, doc, deleteDoc, updateDoc,
  onSnapshot, query, where, orderBy, limit, getDoc
} from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

import {
  getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged,
  sendPasswordResetEmail
} from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

import {
  getStorage, ref as storageRef, uploadBytesResumable, getDownloadURL, deleteObject
} from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";

import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-functions.js";

/* CONFIG - replace with your project's config */
const firebaseConfig = {
  apiKey: "AIzaSyCskczYgGtlPPBEIZiE5PuY7s_cfE_3Chg",
  authDomain: "wizard-rp.firebaseapp.com",
  projectId: "wizard-rp",
  storageBucket: "wizard-rp.firebasestorage.app",
  messagingSenderId: "479456044047",
  appId: "1:479456044047:web:65c52e2430bcb6ca586f7a",
  measurementId: "G-KX5Y56CG0R"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const storage = getStorage(app);
const functions = getFunctions(app);

/* ========= STATE & HELPERS ========= */
const STATE = { currentUser:null, userProfile:null, adminMode:false, unsub:{}, heartbeats:{} };

const $ = (s, r=document) => r.querySelector(s);
const toast = (msg, t=3500) => {
  const c = document.getElementById('toastContainer');
  const el = document.createElement('div'); el.className='toast'; el.textContent = msg;
  c.appendChild(el); setTimeout(()=> el.remove(), t);
};
const escapeHtml = s => (s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));

/* shorthand for collection */
const COL = n => collection(db, n);

async function pushLog(msg){
  try{ await addDoc(COL('logs'), { t: Date.now(), msg }); }catch(e){ console.warn('pushLog', e); }
}

/* debounce */
function debounce(fn, wait=300){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=> fn(...a), wait); }}

/* ========= TOAST container init (ensure exists) ========= */
if(!document.getElementById('toastContainer')) {
  const tc = document.createElement('div'); tc.id='toastContainer'; document.body.appendChild(tc);
}

/* ========= Utility: fetch doc by id ========= */
async function fetchDocById(collectionName, id){
  try{
    const d = await getDoc(doc(db, collectionName, id));
    return d.exists() ? d.data() : null;
  }catch(e){ console.warn('fetchDocById', e); return null; }
}

/* ========= SEED (non-destructive) ========= */
async function seedIfEmpty(){
  try{
    const users = await getDocs(COL('users'));
    if(users.empty){
      // seed demo profiles only (no auth creation)
      await addDoc(COL('users'), { username:'admin', display:'Admin', role:'admin', badge:'ADM-001', onDuty:false });
      await addDoc(COL('users'), { username:'perety04', display:'Perety 04', role:'officer', badge:'PD-314', onDuty:false });
    }
    const rolesSnap = await getDocs(COL('roles'));
    if(rolesSnap.empty){
      await setDoc(doc(db,'roles','officer'), { name:'Officer', color:'#7c3aed', permissions:['create_reports','create_pda','create_call'] });
      await setDoc(doc(db,'roles','sergeant'), { name:'Sergeant', color:'#3b82f6', permissions:['create_reports','create_pda','create_call','delete_reports'] });
      await setDoc(doc(db,'roles','dispatcher'), { name:'Dispatcher', color:'#f97316', permissions:['create_call','assign_call'] });
      await setDoc(doc(db,'roles','admin'), { name:'Admin', color:'#10b981', permissions:['all'] });
    }
    const chans = await getDocs(COL('radio_channels'));
    if(chans.empty){
      await addDoc(COL('radio_channels'), { id:'general', name:'General', created_at: Date.now() });
      await addDoc(COL('radio_channels'), { id:'police', name:'Police', created_at: Date.now() });
    }
  }catch(e){ console.warn('seedIfEmpty', e); }
}

/* ========= ICON helper (SVG) ========= */
function iconSVG(name,size=34){
  if(name==='pda'){
    return `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none"><rect x="2" y="2" width="20" height="20" rx="3" stroke="currentColor" stroke-opacity="0.08"/><g stroke="currentColor" stroke-width="1.1" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="2.1" fill="currentColor" opacity="0.9"/><path d="M7.5 18c0-1.8 2.5-2.8 4.5-2.8s4.5 1 4.5 2.8" fill="none"/><path d="M9 3v18M12 3v18M15 3v18" stroke-opacity="0.25"/></g></svg>`;
  }
  const map = { calls:'üìû', reports:'üìë', wanted:'üö®', fines:'üí∏', assignments:'üìù', service:'üü¢', alerts:'‚ö†Ô∏è', radio:'üì°', admin:'‚öôÔ∏è', logs:'üìú' };
  return map[name] || '‚ñ£';
}

/* ========= RENDER CARDS ========= */
const CARDS = [
  {id:'pda', title:'PDA / Fichas', desc:'Crear, buscar y editar fichas', icon:'pda'},
  {id:'calls', title:'Dispatch / Llamadas', desc:'Crear/Asignar llamadas', icon:'calls'},
  {id:'reports', title:'Informes', desc:'Crear / Editar informes', icon:'reports'},
  {id:'wanted', title:'BOLO / Wanted', desc:'Fichas buscadas', icon:'wanted'},
  {id:'fines', title:'Multas', desc:'Generar sanciones', icon:'fines'},
  {id:'assignments', title:'Asignaciones', desc:'Crear / Asignar', icon:'assignments'},
  {id:'service', title:'Servicio', desc:'Entrar / Salir de servicio', icon:'service'},
  {id:'alerts', title:'Alertas', desc:'Crear alertas', icon:'alerts'},
  {id:'radio', title:'Radios', desc:'Chat por canales', icon:'radio'},
  {id:'admin', title:'Administraci√≥n', desc:'Roles y usuarios (avanzado)', icon:'admin'},
  {id:'logs', title:'Auditor√≠a', desc:'Historial de acciones', icon:'logs'}
];

function renderCards(){
  const root = document.getElementById('cardsRoot'); root.innerHTML = '';
  const isAdmin = STATE.userProfile && STATE.userProfile.role === 'admin';
  CARDS.forEach(c=>{
    if((c.id==='admin' || c.id==='logs') && !isAdmin) return;
    const el = document.createElement('div'); el.className='card'; el.dataset.id = c.id;
    el.innerHTML = `<div class="card-head"><div style="display:flex;gap:12px;align-items:center"><div class="card-logo">${iconSVG(c.icon)}</div><div><div class="title">${c.title}</div><div class="desc">${c.desc}</div></div></div><div><button class="btn-ghost open-btn" data-open="${c.id}">Abrir</button></div></div>`;
    el.querySelector('.open-btn').addEventListener('click', (e)=>{ e.stopPropagation(); openCard(c.id, el); });
    el.addEventListener('click', ()=> openCard(c.id, el));
    root.appendChild(el);
  });
}

/* ========= PERMISSIONS (roles) ========= */
async function hasPermission(perm){
  if(!STATE.userProfile) return perm === 'create_call';
  try{
    const snap = await getDocs(query(COL('roles'), where('__name__','==', STATE.userProfile.role)));
    let role = null; snap.forEach(d=> role = d.data());
    if(!role) return false;
    if(Array.isArray(role.permissions) && role.permissions.includes('all')){
      const sensitive = ['delete_reports','delete_alerts','manage_users','manage_roles','impersonate','view_logs','all','assignments'];
      if(sensitive.includes(perm)) return STATE.adminMode === true;
      return true;
    }
    return role.permissions && role.permissions.includes(perm);
  }catch(e){ console.warn('hasPermission', e); return false; }
}

/* ========= PANEL ROUTER ========= */
function clearExpanded(){
  // cleanup subs
  if(STATE.unsub.currentPanel && typeof STATE.unsub.currentPanel === 'function'){
    try{ STATE.unsub.currentPanel(); }catch(e){/* ignore */ }
    STATE.unsub.currentPanel = null;
  }
  document.getElementById('expandedRoot').innerHTML = '';
  document.querySelectorAll('.card').forEach(c=> c.classList.remove('active'));
  // stop heartbeats
  stopAllHeartbeats();
}

function setActiveCard(el){ document.querySelectorAll('.card').forEach(c=> c.classList.remove('active')); if(el) el.classList.add('active'); }

async function openCard(id, cardEl=null){
  clearExpanded();
  setActiveCard(cardEl);
  const root = document.getElementById('expandedRoot');
  root.innerHTML = '';
  switch(id){
    case 'pda': await panelPDA(root); break;
    case 'calls': await panelCalls(root); break;
    case 'reports': await panelReports(root); break;
    case 'wanted': await panelWanted(root); break;
    case 'fines': await panelFines(root); break;
    case 'assignments': await panelAssignments(root); break;
    case 'service': await panelService(root); break;
    case 'alerts': await panelAlerts(root); break;
    case 'radio': await panelRadio(root); break;
    case 'admin': await panelAdmin(root); break;
    case 'logs': await panelLogs(root); break;
    default: root.innerHTML = `<div class="panel"><div class="muted">Panel ${id} no implementado</div></div>`; break;
  }
  root.scrollIntoView({ behavior:'smooth', block:'start' });
}

/* ========= PDA panel (with photo upload to Storage) ========= */
async function panelPDA(root){
  root.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>PDA / Fichas</strong><div class="muted tiny">Crear, buscar, editar y subir foto</div></div>
      <div><button class="btn-ghost close-panel">Cerrar</button></div>
    </div>
    <div style="margin-top:12px;display:grid;grid-template-columns:1fr 420px;gap:12px">
      <div>
        <input id="pda_q" placeholder="Buscar por nombre/ID/notas..." style="width:100%;margin-bottom:8px"/>
        <div id="pda_list" class="list"></div>
      </div>
      <div>
        <div class="muted tiny">Crear / Editar ficha</div>
        <input id="pda_name" placeholder="Nombre completo"/>
        <input id="pda_pid" placeholder="ID / Matr√≠cula" style="margin-top:8px"/>
        <input id="pda_bday" type="date" style="margin-top:8px"/>
        <input id="pda_photo_url" placeholder="Foto URL (opcional)" style="margin-top:8px"/>
        <input id="pda_photo_file" type="file" accept="image/*" style="margin-top:8px"/>
        <select id="pda_status" style="margin-top:8px"><option value="normal">Normal</option><option value="wanted">Wanted</option><option value="detenido">Detenido</option></select>
        <textarea id="pda_notes" placeholder="Notas..." style="margin-top:8px"></textarea>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="pda_save" class="btn">Guardar ficha</button>
          <button id="pda_clear" class="btn-ghost">Limpiar</button>
        </div>
        <div class="muted tiny" style="margin-top:8px">Puedes subir una foto que se almacenar√° en Firebase Storage y su URL se guardar√° en Firestore.</div>
      </div>
    </div>
  `;
  root.querySelectorAll('.close-panel').forEach(b=> b.addEventListener('click', ()=> clearExpanded()));

  const qInput = $('#pda_q', root);
  qInput.addEventListener('input', debounce(()=> loadPDAList(qInput.value, root), 300));

  $('#pda_clear', root).addEventListener('click', ()=> {
    $('#pda_name', root).value=''; $('#pda_pid', root).value=''; $('#pda_bday', root).value=''; $('#pda_photo_url', root).value=''; $('#pda_notes', root).value=''; $('#pda_status', root).value='normal'; $('#pda_save', root).dataset.id='';
  });

  $('#pda_save', root).addEventListener('click', async ()=>{
    if(!await hasPermission('create_pda')) { toast('No tienes permiso'); return; }
    const name = $('#pda_name', root).value.trim();
    const pid = $('#pda_pid', root).value.trim();
    if(!name || !pid) { toast('Nombre y ID requeridos'); return; }
    const notes = $('#pda_notes', root).value.trim();
    const bday = $('#pda_bday', root).value || null;
    const status = $('#pda_status', root).value;
    const fileInput = $('#pda_photo_file', root);
    const photoUrlInput = $('#pda_photo_url', root);
    const existing = $('#pda_save', root).dataset.id;

    try{
      let photoUrl = photoUrlInput.value || null;
      if(fileInput && fileInput.files && fileInput.files[0]){
        const f = fileInput.files[0];
        const filename = `pda_photos/${Date.now()}_${f.name.replace(/\s+/g,'_')}`;
        const sRef = storageRef(storage, filename);
        const uploadTask = uploadBytesResumable(sRef, f);
        toast('Subiendo foto...');
        await new Promise((res, rej)=>{
          uploadTask.on('state_changed', ()=>{}, err=> rej(err), ()=> res());
        });
        photoUrl = await getDownloadURL(sRef);
        photoUrlInput.value = photoUrl;
        toast('Foto subida');
      }

      if(existing){
        await updateDoc(doc(db,'pda', existing), { name, pid, notes, bday, photo: photoUrl, status, updated_at: Date.now(), updated_by: STATE.userProfile?.username || 'system' });
        await pushLog(`PDA ${existing} actualizada`);
        toast('Ficha actualizada');
      } else {
        const r = await addDoc(COL('pda'), { name, pid, notes, bday, photo: photoUrl, status, created_at: Date.now(), created_by: STATE.userProfile?.username || 'system' });
        await pushLog(`PDA ${r.id} creada`);
        toast('Ficha creada');
      }
      $('#pda_clear', root).click();
      loadPDAList('', root);
    }catch(e){
      console.error('pda save', e); toast('Error guardando ficha');
    }
  });

  // realtime subscription
  if(STATE.unsub.pdaList) STATE.unsub.pdaList();
  STATE.unsub.pdaList = onSnapshot(COL('pda'), ()=> loadPDAList($('#pda_q', root).value, root));
  STATE.unsub.currentPanel = STATE.unsub.pdaList;
  await loadPDAList('', root);
}

async function loadPDAList(q='', root=document){
  const list = $('#pda_list', root); if(!list) return;
  try{
    const snap = await getDocs(query(COL('pda'), orderBy('created_at','desc'), limit(500)));
    const arr = []; snap.forEach(s=> arr.push({ id:s.id, ...s.data() }));
    const out = arr.filter(p=>{
      if(!q) return true;
      const qq = q.toLowerCase();
      return (p.name||'').toLowerCase().includes(qq) || (p.pid||'').toLowerCase().includes(qq) || (p.notes||'').toLowerCase().includes(qq);
    });
    list.innerHTML = out.map(p => {
      const photo = p.photo ? `<img src="${escapeHtml(p.photo)}" alt="foto" style="width:56px;height:56px;border-radius:8px;object-fit:cover;margin-right:8px">` : '';
      return `<div class="item"><div style="display:flex;gap:12px;align-items:center;flex:1">${photo}<div><div style="font-weight:800">${escapeHtml(p.name)} <span class="muted tiny">(${escapeHtml(p.pid||'‚Äî')})</span></div><div class="muted tiny">Estado: ${escapeHtml(p.status||'‚Äî')} ‚Ä¢ ${p.created_at? new Date(p.created_at).toLocaleString() : ''}</div><div class="muted small">${escapeHtml((p.notes||'').slice(0,160))}</div></div></div><div style="display:flex;flex-direction:column;gap:6px"><button class="btn-ghost view" data-id="${p.id}">Abrir</button><button class="btn-ghost edit" data-id="${p.id}">Editar</button><button class="btn-ghost del" data-id="${p.id}">Borrar</button></div></div>`;
    }).join('') || '<div class="muted tiny">Sin fichas</div>';

    list.querySelectorAll('.view').forEach(b=> b.onclick = async ()=>{
      const d = await fetchDocById('pda', b.dataset.id);
      if(!d) return toast('Ficha no encontrada');
      alert(`Ficha: ${d.name}\nID: ${d.pid}\nEstado: ${d.status}\nNacimiento: ${d.bday || '‚Äî'}\n\nNotas:\n${d.notes || '‚Äî'}`);
    });
    list.querySelectorAll('.edit').forEach(b=> b.onclick = async ()=>{
      const d = await fetchDocById('pda', b.dataset.id); if(!d) return toast('Ficha no encontrada');
      $('#pda_name').value = d.name || ''; $('#pda_pid').value = d.pid || ''; $('#pda_bday').value = d.bday || ''; $('#pda_photo_url').value = d.photo || ''; $('#pda_notes').value = d.notes || ''; $('#pda_status').value = d.status || 'normal'; $('#pda_save').dataset.id = b.dataset.id;
      window.scrollTo({ top: document.getElementById('expandedRoot').offsetTop + 20, behavior:'smooth' });
    });
    list.querySelectorAll('.del').forEach(b=> b.onclick = async ()=>{
      if(!confirm('Borrar ficha definitivamente?')) return;
      if(!await hasPermission('delete_reports')){ toast('Admin Mode necesario'); return; }
      try{ await deleteDoc(doc(db,'pda', b.dataset.id)); toast('Ficha borrada'); await pushLog(`PDA ${b.dataset.id} borrada`); }catch(e){ console.error(e); toast('Error borrando'); }
    });
  }catch(e){
    console.error('loadPDAList', e); list.innerHTML = '<div class="muted tiny">Error cargando</div>';
  }
}

/* ========= Calls (full CRUD/assign) ========= */
async function panelCalls(root){
  root.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>Dispatch / Llamadas</strong><div class="muted tiny">Crear, asignar, borrar</div></div>
      <div><button class="btn-ghost close-panel">Cerrar</button></div>
    </div>
    <div style="margin-top:12px;display:flex;gap:8px">
      <input id="call_from" placeholder="Remitente" />
      <input id="call_msg" placeholder="Mensaje" style="flex:1" />
      <button id="call_create" class="btn">Crear</button>
    </div>
    <div style="margin-top:12px"><div id="calls_list" class="list"></div></div>
  `;
  root.querySelectorAll('.close-panel').forEach(b=> b.addEventListener('click', ()=> clearExpanded()));
  $('#call_create').addEventListener('click', async ()=>{
    const caller = $('#call_from').value.trim() || 'Anon';
    const message = $('#call_msg').value.trim(); if(!message) return toast('Introduce mensaje');
    try{ await addDoc(COL('calls'), { caller, message, status:'pending', assigned_to:null, created_at: Date.now(), created_by: STATE.userProfile?.username || 'guest' }); toast('Llamada creada'); await pushLog('Llamada creada'); loadCalls(root); }catch(e){ console.error(e); toast('Error creando'); }
  });
  if(STATE.unsub.calls) STATE.unsub.calls();
  STATE.unsub.calls = onSnapshot(COL('calls'), ()=> loadCalls(root));
  STATE.unsub.currentPanel = STATE.unsub.calls;
  await loadCalls(root);
}
async function loadCalls(root){
  const list = $('#calls_list', root); if(!list) return;
  try{
    const snap = await getDocs(query(COL('calls'), orderBy('created_at','desc'), limit(500)));
    const arr = []; snap.forEach(s=> arr.push({ id:s.id, ...s.data() }));
    if(!arr.length){ list.innerHTML = '<div class="muted tiny">No hay llamadas</div>'; return; }
    list.innerHTML = '';
    const usersSnap = await getDocs(COL('users')); const users = []; usersSnap.forEach(u=> users.push({ id:u.id, ...u.data() }));
    for(const c of arr){
      const assignee = c.assigned_to ? (users.find(u=>u.id===c.assigned_to)?.display || '‚Äî') : '‚Äî';
      const el = document.createElement('div'); el.className='item';
      el.innerHTML = `<div style="flex:1"><b>${escapeHtml(c.caller)}</b><div class="muted small">${escapeHtml(c.message)}</div></div>
        <div style="text-align:right"><div class="muted tiny">${c.created_at?new Date(c.created_at).toLocaleString():''}</div><div class="muted tiny">Asig: ${escapeHtml(assignee)}</div></div>`;
      const btns = document.createElement('div'); btns.style.marginLeft='12px';

      if(await hasPermission('assign_call') && STATE.userProfile){
        const assign = document.createElement('button'); assign.className='btn-ghost'; assign.textContent='Asignar a m√≠';
        assign.onclick = async ()=> { try{ await updateDoc(doc(db,'calls',c.id), { status:'assigned', assigned_to: STATE.userProfile.id }); await pushLog(`Llamada ${c.id} asignada a ${STATE.userProfile.username}`); loadCalls(root); }catch(e){ console.error(e); } };
        btns.appendChild(assign);
      }

      if(STATE.userProfile && (STATE.userProfile.role === 'admin' || (c.assigned_to && STATE.userProfile.id === c.assigned_to))){
        const del = document.createElement('button'); del.className='btn'; del.style.marginLeft='6px'; del.textContent='Borrar';
        del.onclick = async ()=> { if(confirm('Borrar llamada?')){ try{ await deleteDoc(doc(db,'calls',c.id)); await pushLog(`Llamada ${c.id} borrada`); loadCalls(root); }catch(e){ console.error(e); } } };
        btns.appendChild(del);
      }
      el.appendChild(btns);
      list.appendChild(el);
    }
  }catch(e){ console.error('loadCalls', e); list.innerHTML = '<div class="muted tiny">Error cargando</div>'; }
}

/* ========= Reports (full) ========= */
async function panelReports(root){
  root.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>Informes</strong><div class="muted tiny">Crear, ver, borrar (seg√∫n permisos)</div></div>
      <div><button class="btn-ghost close-panel">Cerrar</button></div>
    </div>
    <div style="margin-top:12px">
      <input id="report_title" placeholder="T√≠tulo" style="width:60%"/><button id="report_create" class="btn" style="margin-left:8px">Crear</button>
      <button id="report_export_csv" class="btn-ghost" style="margin-left:8px">Export CSV</button>
      <div id="reports_list" class="list" style="margin-top:12px"></div>
    </div>
  `;
  root.querySelectorAll('.close-panel').forEach(b=> b.addEventListener('click', ()=> clearExpanded()));
  $('#report_create').addEventListener('click', async ()=> {
    const title = $('#report_title').value.trim(); if(!title) return toast('T√≠tulo requerido');
    try{ await addDoc(COL('reports'), { title, created_at: Date.now(), author: STATE.userProfile?.username || 'guest' }); toast('Informe creado'); await pushLog(`Informe creado: ${title}`); loadReports(root); }catch(e){ console.error(e); toast('Error'); }
  });
  $('#report_export_csv').addEventListener('click', async ()=> {
    try{
      const snap = await getDocs(COL('reports')); const rows = []; snap.forEach(s=> rows.push({ id:s.id, ...s.data() }));
      if(!rows.length) return toast('No hay informes');
      const csv = rows.map(r => Object.values(r).map(v=>`"${String(v||'').replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], { type:'text/csv' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'reports_'+Date.now()+'.csv'; a.click(); a.remove();
      toast('CSV generado');
    }catch(e){ console.error(e); toast('Error exportando'); }
  });

  if(STATE.unsub.reports) STATE.unsub.reports();
  STATE.unsub.reports = onSnapshot(COL('reports'), ()=> loadReports(root));
  STATE.unsub.currentPanel = STATE.unsub.reports;
  await loadReports(root);
}
async function loadReports(root){
  const list = $('#reports_list', root); if(!list) return;
  try{
    const snap = await getDocs(query(COL('reports'), orderBy('created_at','desc'), limit(500)));
    list.innerHTML = '';
    snap.forEach(s=> {
      const d = s.data();
      const it = document.createElement('div'); it.className='item';
      it.innerHTML = `<div style="flex:1"><b>${escapeHtml(d.title)}</b><div class="muted tiny">${escapeHtml(d.author || '')}</div></div><div class="muted tiny">${d.created_at?new Date(d.created_at).toLocaleString():''}</div>`;
      const btns = document.createElement('div'); btns.style.marginLeft='12px';
      const view = document.createElement('button'); view.className='btn-ghost'; view.textContent='Ver';
      view.onclick = ()=> alert(`Informe: ${d.title}\nAutor: ${d.author}\nFecha: ${d.created_at?new Date(d.created_at).toLocaleString():''}`);
      btns.appendChild(view);
      if(await hasPermission('delete_reports')){
        const del = document.createElement('button'); del.className='btn'; del.style.marginLeft='6px'; del.textContent='Borrar';
        del.onclick = async ()=> { if(confirm('Borrar informe?')){ try{ await deleteDoc(doc(db,'reports', s.id)); await pushLog(`Informe ${s.id} borrado`); }catch(e){ console.error(e); } } };
        btns.appendChild(del);
      }
      it.appendChild(btns);
      list.appendChild(it);
    });
    if(!list.innerHTML) list.innerHTML = '<div class="muted tiny">No hay informes</div>';
  }catch(e){ console.error('loadReports', e); list.innerHTML = '<div class="muted tiny">Error</div>'; }
}

/* ========= Alerts panel ========= */
async function panelAlerts(root){
  root.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center"><div><strong>Alertas</strong><div class="muted tiny">Crear y gestionar alertas</div></div><div><button class="btn-ghost close-panel">Cerrar</button></div></div>
    <div style="margin-top:12px"><select id="alert_level"><option value="verde">Verde</option><option value="amarilla">Amarilla</option><option value="roja">Roja</option></select><input id="alert_title" placeholder="T√≠tulo" style="margin-left:8px"/><div style="margin-top:8px"><textarea id="alert_msg" placeholder="Mensaje..."></textarea></div><div style="margin-top:8px"><button id="alert_create" class="btn">Crear</button></div><div id="alerts_list" class="list" style="margin-top:12px"></div></div>
  `;
  root.querySelectorAll('.close-panel').forEach(b=> b.addEventListener('click', ()=> clearExpanded()));
  $('#alert_create').addEventListener('click', async ()=>{
    if(!STATE.userProfile) return toast('Inicia sesi√≥n');
    const lvl = $('#alert_level').value, title = $('#alert_title').value.trim(), msg = $('#alert_msg').value.trim();
    if(!title || !msg) return toast('T√≠tulo y mensaje requeridos');
    try{ await addDoc(COL('alerts'), { title, message: msg, level: lvl, author: STATE.userProfile.username || STATE.userProfile.display, created_at: Date.now() }); toast('Alerta creada'); await pushLog(`Alerta creada: ${title}`); loadAlerts(root); }catch(e){ console.error(e); toast('Error creando alerta'); }
  });
  if(STATE.unsub.alerts) STATE.unsub.alerts();
  STATE.unsub.alerts = onSnapshot(COL('alerts'), ()=> loadAlerts(root));
  STATE.unsub.currentPanel = STATE.unsub.alerts;
  await loadAlerts(root);
}
async function loadAlerts(root){
  const list = $('#alerts_list', root); if(!list) return;
  try{
    const snap = await getDocs(query(COL('alerts'), orderBy('created_at','desc'), limit(500)));
    list.innerHTML = '';
    snap.forEach(s=> {
      const a = s.data();
      const it = document.createElement('div'); it.className='item';
      it.innerHTML = `<div style="flex:1"><div style="font-weight:700">${escapeHtml(a.title)} <span class="muted tiny">[${escapeHtml(a.level||'‚Äî')}]</span></div><div class="muted small">${escapeHtml((a.message||'').slice(0,200))}</div></div><div class="muted tiny">${a.created_at?new Date(a.created_at).toLocaleString():''}</div>`;
      const btns = document.createElement('div');
      if(STATE.userProfile && (STATE.userProfile.role === 'admin' && STATE.adminMode || a.author === (STATE.userProfile && STATE.userProfile.username))){
        const del = document.createElement('button'); del.className='btn'; del.style.marginLeft='6px'; del.textContent='Borrar';
        del.onclick = async ()=> { if(confirm('Borrar alerta?')){ try{ await deleteDoc(doc(db,'alerts',s.id)); await pushLog(`Alerta ${s.id} borrada`); loadAlerts(root); }catch(e){ console.error(e); } } };
        btns.appendChild(del);
      }
      it.appendChild(btns); list.appendChild(it);
    });
    if(!list.innerHTML) list.innerHTML = '<div class="muted tiny">No hay alertas</div>';
  }catch(e){ console.error('loadAlerts', e); list.innerHTML = '<div class="muted tiny">Error</div>'; }
}

/* ========= Radio (messages + presence) ========= */
async function panelRadio(root){
  root.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center"><div><strong>Radios</strong><div class="muted tiny">Mensajes por canal + presencia</div></div><div><button class="btn-ghost close-panel">Cerrar</button></div></div>
    <div style="margin-top:12px" class="radio-wrap">
      <div class="radio-left">
        <div style="display:flex;gap:8px;align-items:center">
          <select id="radio_ch_select"></select>
          <input id="radio_new_channel" placeholder="Nuevo canal" style="margin-left:auto"/>
          <button id="radio_create_channel" class="btn-ghost">Crear</button>
        </div>
        <div id="radio_status" class="muted tiny" style="margin-top:6px"></div>
        <div id="radio_messages" class="radio-messages" style="margin-top:12px"></div>
        <div style="display:flex;gap:8px;margin-top:8px"><input id="radio_input" placeholder="Escribe mensaje..." style="flex:1"/><button id="radio_send" class="btn">Enviar</button></div>
      </div>
      <div class="radio-right">
        <h4 style="margin:0 0 8px 0">Canales</h4>
        <input id="radio_search" placeholder="Buscar..." style="width:100%;padding:8px;border-radius:8px"/>
        <div id="radio_channels" class="list" style="margin-top:8px"></div>
        <div style="margin-top:12px"><strong>Oyentes</strong><div id="radio_listeners" class="list" style="margin-top:8px"></div></div>
      </div>
    </div>
  `;
  root.querySelectorAll('.close-panel').forEach(b=> b.addEventListener('click', ()=> { stopAllHeartbeats(); clearExpanded(); }));
  $('#radio_create_channel').addEventListener('click', async ()=>{
    const v = $('#radio_new_channel').value.trim(); if(!v) return toast('Nombre requerido');
    try{ await addDoc(COL('radio_channels'), { id:v, name:v, created_at: Date.now() }); toast('Canal creado'); loadRadioChannels(root); $('#radio_new_channel').value=''; }catch(e){ console.error(e); toast('Error creando canal'); }
  });
  $('#radio_send').addEventListener('click', async ()=>{
    const txt = $('#radio_input').value.trim(); if(!txt) return;
    const ch = $('#radio_ch_select').value; if(!ch) return toast('Selecciona canal');
    try{ await addDoc(COL('radio_messages'), { channel: ch, text: txt, author: STATE.userProfile ? STATE.userProfile.display : 'Invitado', author_username: STATE.userProfile ? STATE.userProfile.username : 'guest', created_at: Date.now() }); $('#radio_input').value=''; toast('Mensaje enviado'); }catch(e){ console.error(e); toast('Error enviando'); }
  });
  $('#radio_search').addEventListener('input', (e)=>{ const q=(e.target.value||'').toLowerCase(); document.querySelectorAll('#radio_channels .item').forEach(it=> it.style.display = (it.dataset.name||'').toLowerCase().includes(q) ? '' : 'none'); });

  // subscribe channels
  if(STATE.unsub.radio_channels) STATE.unsub.radio_channels();
  STATE.unsub.radio_channels = onSnapshot(COL('radio_channels'), snap => {
    const arr = []; snap.forEach(d=> arr.push({ id:d.id, ...d.data() })); renderRadioChannels(arr, root);
  });
  STATE.unsub.currentPanel = STATE.unsub.radio_channels;
  await loadRadioChannels(root);
}
async function loadRadioChannels(root){
  const sel = $('#radio_ch_select', root), list = $('#radio_channels', root);
  if(!sel||!list) return;
  try{
    const snap = await getDocs(COL('radio_channels'));
    const arr=[]; snap.forEach(s=> arr.push({ id:s.id, ...s.data() }));
    renderRadioChannels(arr, root);
  }catch(e){ console.error('loadRadioChannels', e); list.innerHTML = '<div class="muted tiny">Error</div>'; }
}
function renderRadioChannels(arr, root){
  const sel = $('#radio_ch_select', root), list = $('#radio_channels', root);
  sel.innerHTML=''; list.innerHTML='';
  arr.forEach(ch=> {
    const id = ch.id||ch.name; const name = ch.name||id;
    const opt = document.createElement('option'); opt.value=id; opt.textContent = name; sel.appendChild(opt);
    const it = document.createElement('div'); it.className='item'; it.dataset.name = name;
    it.innerHTML = `<div style="flex:1"><b>${escapeHtml(name)}</b><div class="muted tiny">${escapeHtml(id)}</div></div><div><button class="btn-ghost join" data-id="${escapeHtml(id)}">Unirse</button></div>`;
    it.querySelector('button.join').addEventListener('click', ()=> switchRadioChannel(id, root));
    list.appendChild(it);
  });
  // auto-join first channel if none selected
  const selVal = sel.value || (arr[0] && arr[0].id);
  if(selVal) switchRadioChannel(selVal, root);
}
async function switchRadioChannel(channel, root){
  if(!channel) return;
  STATE.selectedChannel = channel;
  $('#radio_ch_select', root).value = channel;
  $('#radio_status', root).textContent = `Conectado: ${channel}`;
  // subscribe messages filtered client-side
  if(STATE.unsub.radio_messages) STATE.unsub.radio_messages();
  STATE.unsub.radio_messages = onSnapshot(COL('radio_messages'), snap => {
    const msgs=[]; snap.forEach(s=> { const d=s.data(); if((d.channel||'') === channel) msgs.push({ id:s.id, ...d }); });
    msgs.sort((a,b)=> (a.created_at||0) - (b.created_at||0));
    renderRadioMessages(msgs, root);
  });
  STATE.unsub.currentPanel = STATE.unsub.radio_messages;
  // start presence heartbeat
  startHeartbeat(channel);
  // load listeners
  loadRadioListeners(channel, root);
}
function renderRadioMessages(msgs, root){
  const container = $('#radio_messages', root); if(!container) return;
  container.innerHTML = '';
  if(!msgs.length){ container.innerHTML = '<div class="muted tiny">Sin mensajes</div>'; return; }
  msgs.forEach(m=>{
    const me = STATE.userProfile && (STATE.userProfile.display === m.author || STATE.userProfile.username === m.author_username);
    const el = document.createElement('div'); el.className = 'radio-msg' + (me ? ' me' : '');
    const avatar = document.createElement('div'); avatar.className='radio-avatar'; avatar.textContent = (m.author||'G').split(' ').map(x=>x[0]||'').slice(0,2).join('').toUpperCase();
    const bubble = document.createElement('div'); bubble.className='radio-bubble' + (me ? ' me' : ''); bubble.innerHTML = `<div style="font-weight:700">${escapeHtml(m.author||'Anon')}</div><div>${escapeHtml(m.text||'')}</div><div class="radio-meta">${m.created_at?new Date(m.created_at).toLocaleString():''}</div>`;
    el.appendChild(avatar); el.appendChild(bubble); container.appendChild(el);
  });
  container.scrollTop = container.scrollHeight;
}
async function loadRadioListeners(channel, root){
  const list = $('#radio_listeners', root); if(!list) return;
  try{
    const snap = await getDocs(COL('radio_presence'));
    const arr=[]; snap.forEach(s=> { const d=s.data(); if(d.channel===channel) arr.push(d); });
    list.innerHTML = arr.length ? arr.map(p=> `<div class="item"><div style="display:flex;gap:10px;align-items:center"><div style="width:36px;height:36px;border-radius:8px;background:linear-gradient(90deg,var(--accent-1),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:800;color:#031018">${escapeHtml((p.display||'').split(' ').map(s=>s[0]||'').slice(0,2).join(''))}</div><div><b>${escapeHtml(p.display||p.username)}</b><div class="muted tiny">${escapeHtml(p.role||'')}</div></div></div></div>`).join('') : '<div class="muted tiny">Nadie escuchando</div>';
  }catch(e){ console.error('loadRadioListeners', e); list.innerHTML = '<div class="muted tiny">Error</div>'; }
}
/* Presence heartbeat using radio_presence collection */
async function startHeartbeat(channel){
  try{
    if(!STATE.userProfile) return;
    stopAllHeartbeats();
    const key = `presence_${channel}_${STATE.userProfile.uid}`;
    const ref = doc(db,'radio_presence', key);
    await setDoc(ref, { channel, uid: STATE.userProfile.uid, username: STATE.userProfile.username, display: STATE.userProfile.display, role: STATE.userProfile.role, lastSeen: Date.now() });
    const timer = setInterval(async ()=> { try{ await updateDoc(ref, { lastSeen: Date.now() }); }catch(e){} }, 20000);
    STATE.heartbeats[channel] = { timer, key };
    window.addEventListener('beforeunload', async ()=> { try{ await deleteDoc(doc(db,'radio_presence', key)); }catch(e){} });
  }catch(e){ console.warn('startHeartbeat', e); }
}
async function stopAllHeartbeats(){
  for(const ch in STATE.heartbeats){ clearInterval(STATE.heartbeats[ch].timer); try{ await deleteDoc(doc(db,'radio_presence', STATE.heartbeats[ch].key)); }catch(e){} }
  STATE.heartbeats = {};
}

/* ========= Admin panel (createUser callable + fallback) ========= */
async function panelAdmin(root){
  root.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center"><div><strong>Administraci√≥n</strong><div class="muted tiny">Gestiona roles y usuarios</div></div><div><button class="btn-ghost close-panel">Cerrar</button></div></div>
    <div style="margin-top:12px" id="admin_notice"></div>
    <div style="margin-top:12px;display:flex;gap:12px">
      <div style="flex:1"><h4>Usuarios</h4><div id="admin_users" class="list"></div></div>
      <div style="width:420px"><h4>Crear usuario (Auth + profile)</h4><input id="adm_email" placeholder="email@example.com"/><input id="adm_pass" placeholder="contrase√±a"/><input id="adm_display" placeholder="Display"/><select id="adm_role"></select><div style="display:flex;gap:8px;margin-top:8px"><button id="adm_create" class="btn">Crear</button><button id="adm_refresh" class="btn-ghost">Refrescar</button></div><hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.03)"><h4>Roles</h4><div style="display:flex;gap:8px"><input id="adm_newrole" placeholder="nuevo rol"/><button id="adm_createrole" class="btn">Crear rol</button></div><div id="adm_roles" style="margin-top:12px"></div></div>
    </div>
  `;
  root.querySelectorAll('.close-panel').forEach(b=> b.addEventListener('click', ()=> clearExpanded()));
  $('#adm_refresh').addEventListener('click', ()=> panelAdmin(root));
  const notice = $('#admin_notice');
  if(!STATE.userProfile || STATE.userProfile.role !== 'admin'){
    notice.innerHTML = `<div class="item"><div style="flex:1"><b>Acceso denegado</b><div class="muted tiny">Necesitas ser admin</div></div></div>`;
    return;
  }
  if(!STATE.adminMode){
    notice.innerHTML = `<div class="item"><div style="flex:1"><b>Admin Mode OFF</b><div class="muted tiny">Activa Admin Mode para acciones sensibles</div></div><div><button id="enable_admin_mode" class="btn">Activar</button></div></div>`;
    $('#enable_admin_mode').addEventListener('click', async ()=>{
      const pwd = prompt('Reingresa tu contrase√±a para activar Admin Mode:'); if(!pwd) return;
      // reauthenticate is expected if using Firebase Auth; for demo, allow enabling if password matches stored (if exists)
      // Here we try to re-fetch user profile and match password field (if present). In real projects use reauthenticateWithCredential.
      try{
        const s = await getDocs(query(COL('users'), where('__name__','==', STATE.userProfile.id)));
        let u=null; s.forEach(d=> u = d.data());
        if(u && u.password && u.password === pwd){ STATE.adminMode = true; toast('Admin Mode activado'); renderCards(); panelAdmin(root); }
        else { // fallback: if using Auth, we would reauthenticate; we'll accept for demo
          alert('No fue posible verificar (demo). En producci√≥n use reauthenticateWithCredential.');
          STATE.adminMode = true; renderCards(); panelAdmin(root);
        }
      }catch(e){ console.error(e); alert('Error activando Admin Mode'); }
    });
  } else {
    notice.innerHTML = `<div class="item"><div style="flex:1"><b>Admin Mode ON</b><div class="muted tiny">Puedes realizar acciones administrativas</div></div><div><button id="disable_admin_mode" class="btn-ghost">Desactivar</button></div></div>`;
    $('#disable_admin_mode').addEventListener('click', ()=> { if(confirm('Desactivar Admin Mode?')){ STATE.adminMode = false; renderCards(); panelAdmin(root); }});
  }

  // populate roles dropdown & lists
  const rolesSnap = await getDocs(COL('roles')); const roleSel = $('#adm_role'); roleSel.innerHTML = '';
  rolesSnap.forEach(r=> {
    const opt = document.createElement('option'); opt.value = r.id; opt.textContent = r.id; roleSel.appendChild(opt);
  });

  // load users and roles lists
  await loadAdminUsers(root);
  await loadAdminRoles(root);

  $('#adm_create').addEventListener('click', async ()=>{
    if(!STATE.adminMode) return toast('Activa Admin Mode');
    const email = $('#adm_email').value.trim(); const pass = $('#adm_pass').value.trim(); const display = $('#adm_display').value.trim() || email.split('@')[0]; const role = $('#adm_role').value || 'officer';
    if(!email || !pass) return toast('Email y contrase√±a requeridos');
    // Try to call createUser Cloud Function (if deployed), fallback: create profile document in users
    try{
      const createUserFn = httpsCallable(functions, 'createUser');
      const res = await createUserFn({ email, password: pass, display, role, badge: '' });
      toast('Usuario Auth + profile creado');
      await pushLog(`Admin cre√≥ usuario ${email}`);
      panelAdmin(root);
    }catch(e){
      console.warn('createUser callable failed, fallback to profile-only', e);
      try{
        await addDoc(COL('users'), { username: email.split('@')[0], display, role, badge:'', onDuty:false });
        toast('Perfil creado (falta Auth) ‚Äî crea cuenta en consola o con Admin SDK');
        await pushLog(`Perfil (fallback) creado: ${email}`);
        panelAdmin(root);
      }catch(err){ console.error(err); toast('Error creando perfil'); }
    }
  });

  $('#adm_createrole').addEventListener('click', async ()=>{
    if(!STATE.adminMode) return toast('Activa Admin Mode');
    const name = $('#adm_newrole').value.trim(); if(!name) return toast('Nombre rol requerido');
    try{ await setDoc(doc(db,'roles',name), { name, color:'#999999', permissions:[] }); toast('Rol creado'); await pushLog(`Rol creado ${name}`); panelAdmin(root); }catch(e){ console.error(e); toast('Error creando rol'); }
  });
}
async function loadAdminUsers(root){
  const out = $('#admin_users', root); out.innerHTML = '<div class="muted tiny">Cargando...</div>';
  try{
    const snap = await getDocs(COL('users')); out.innerHTML=''; snap.forEach(s=> { const d=s.data(); const el = document.createElement('div'); el.className='item'; el.innerHTML = `<div style="flex:1"><b>${escapeHtml(d.display || d.username)}</b><div class="muted tiny">${escapeHtml(d.role || '‚Äî')}</div></div><div><button class="btn-ghost" data-id="${s.id}">Editar</button></div>`; out.appendChild(el); });
  }catch(e){ console.error(e); out.innerHTML = '<div class="muted tiny">Error</div>'; }
}
async function loadAdminRoles(root){
  const out = $('#adm_roles', root); out.innerHTML = '';
  try{
    const snap = await getDocs(COL('roles'));
    snap.forEach(s=> { const d=s.data(); const el = document.createElement('div'); el.className='item'; el.innerHTML = `<div style="flex:1"><b>${s.id}</b><div class="muted tiny">${(d.permissions||[]).join(', ') || 'Sin permisos'}</div></div>`; out.appendChild(el); });
  }catch(e){ console.error(e); out.innerHTML = '<div class="muted tiny">Error</div>'; }
}

/* ========= Logs panel ========= */
async function panelLogs(root){
  root.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>Auditor√≠a</strong><div class="muted tiny">√öltimas acciones</div></div><div><button class="btn-ghost close-panel">Cerrar</button></div></div><div id="logs_list" class="list" style="margin-top:12px"></div>`;
  root.querySelectorAll('.close-panel').forEach(b=> b.addEventListener('click', ()=> clearExpanded()));
  const out = $('#logs_list', root);
  if(STATE.unsub.logs) STATE.unsub.logs();
  STATE.unsub.logs = onSnapshot(query(COL('logs'), orderBy('t','desc')), snap=>{
    out.innerHTML = '';
    snap.forEach(s=> { const d = s.data(); const el = document.createElement('div'); el.className='item'; el.innerHTML = `<div style="flex:1">${escapeHtml(d.msg)}</div><div class="muted tiny">${d.t?new Date(d.t).toLocaleString():''}</div>`; out.appendChild(el); });
  });
  STATE.unsub.currentPanel = STATE.unsub.logs;
}

/* ========= Header update ========= */
async function updateHeader(){
  $('#userDisplay').textContent = STATE.userProfile ? `${STATE.userProfile.display || STATE.userProfile.username} (${STATE.userProfile.role || '‚Äî'})` : 'No conectado';
  try{
    const snap = await getDocs(COL('users')); let cnt=0; snap.forEach(s=> { if(s.data().onDuty) cnt++; }); $('#dutyStatus').textContent = `En servicio: ${cnt}`;
  }catch(e){ $('#dutyStatus').textContent = 'En servicio: ‚Äî'; }
  // alert count
  try{ const s = await getDocs(COL('alerts')); const c = s.size; if(c>0){ $('#notifPill').style.display='inline-block'; $('#notifPill').textContent=`Alertas ${c}`; $('#notifPill').onclick = ()=> openCard('alerts'); } else $('#notifPill').style.display='none'; }catch(e){ /*ignore*/ }
}

/* ========= AUTH integration (sign-in only) ========= */
// Sign-in using Firebase Auth, then map to users/{uid} profile
$('#btnLogin').addEventListener('click', ()=> { $('#loginModal').style.display = 'block'; });
$('#btnCloseLogin').addEventListener('click', ()=> { $('#loginModal').style.display = 'none'; $('#authMsg').textContent=''; });

$('#btnSignIn').addEventListener('click', async ()=>{
  const email = $('#authEmail').value.trim(), pass = $('#authPass').value.trim();
  if(!email || !pass){ $('#authMsg').textContent = 'Email y contrase√±a requeridos'; return; }
  try{
    await signInWithEmailAndPassword(auth, email, pass);
    $('#authMsg').textContent = 'Sesi√≥n iniciada';
    $('#loginModal').style.display = 'none';
  }catch(e){ console.error('signIn', e); $('#authMsg').textContent = 'Error: ' + (e.message || e.code); }
});

$('#btnReset').addEventListener('click', async ()=>{
  const email = $('#authEmail').value.trim(); if(!email) return $('#authMsg').textContent = 'Introduce tu email';
  try{ await sendPasswordResetEmail(auth, email); $('#authMsg').textContent = 'Email de recuperaci√≥n enviado'; }catch(e){ console.error('reset', e); $('#authMsg').textContent = 'Error: ' + e.message; }
});

// Map Firebase Auth user to Firestore profile at users/{uid}
onAuthStateChanged(auth, async user => {
  if(user){
    try{
      const profileRef = doc(db,'users', user.uid);
      const pSnap = await getDoc(profileRef);
      if(!pSnap.exists()){
        // If profile missing, sign out and warn
        await signOut(auth);
        STATE.userProfile = null; STATE.currentUser = null; STATE.adminMode = false;
        updateHeader();
        toast('Tu cuenta no est√° autorizada. Pide a un admin que cree tu perfil.');
        renderCards();
        return;
      }
      STATE.currentUser = user;
      STATE.userProfile = { id: pSnap.id, uid: user.uid, ...pSnap.data() };
      STATE.adminMode = false;
      updateHeader();
      renderCards();
      await pushLog(`Auth login: ${user.uid}`);
    }catch(e){ console.error('onAuthState', e); }
  } else {
    // logged out
    STATE.currentUser = null; STATE.userProfile = null; STATE.adminMode = false;
    updateHeader(); renderCards();
  }
});

/* ========= EXPORT JSON (all collections) ========= */
$('#btnExport').addEventListener('click', async ()=>{
  try{
    const collections = ['users','roles','reports','wanted','calls','pda','fines','alerts','radio_channels','radio_messages','assignments','logs'];
    const data = {};
    for(const c of collections){ const snap = await getDocs(COL(c)); data[c]=[]; snap.forEach(d=> data[c].push({ id:d.id, ...d.data() })); }
    const blob = new Blob([JSON.stringify(data, null, 2)], { type:'application/json' });
    const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'firestore_export_'+Date.now()+'.json'; document.body.appendChild(a); a.click(); a.remove();
    toast('Export generado');
  }catch(e){ console.error('export', e); toast('Error exportando'); }
});

/* ========= Helpers to call panels quickly if needed ========= */
window.__APP = { db, auth, storage, functions, STATE, renderCards, openCard, pushLog };

/* ========= Init ========= */
(async ()=>{
  await seedIfEmpty();
  renderCards();
  updateHeader();
  console.log('Daynight RP ‚Äî index.html cargado. Servir v√≠a HTTP. window.__APP para debug.');
})();
</script>
</body>
</html>
