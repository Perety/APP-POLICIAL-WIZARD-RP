<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Daynight RP ‚Äî PDA / CAD</title>
<style>
  :root{
    --bg:#071018; --muted:#98a8b0; --accent:#844ffc; --accent2:#6ee7b7;
    --card:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    --glass: rgba(255,255,255,0.03);
    --radius:12px;
    --danger:#ff6b6b;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    color:#e7eef6; -webkit-font-smoothing:antialiased;
    position:relative; overflow-x:hidden;
    background:
      radial-gradient(900px 350px at 10% 10%, rgba(132,79,252,0.04), transparent),
      linear-gradient(180deg, #03121a 0%, var(--bg) 60%);
  }

  /* Animated decorative background */
  .bg-animated {
    position:fixed; inset:0; z-index:0; pointer-events:none;
    background:
      linear-gradient(120deg, rgba(132,79,252,0.02), rgba(6,17,25,0.02) 30%, rgba(110,231,183,0.01));
    overflow:hidden;
  }
  .bg-animated .stripe {
    position:absolute; top:-40%; bottom:-40%; width:30%;
    transform:rotate(-12deg);
    filter:blur(40px) saturate(120%);
    animation: stripeMove 6s ease-in-out infinite;
    opacity:0.14;
  }
  .bg-animated .stripe.r { right:-25%; background:linear-gradient(90deg, rgba(2,6,255,0.95), rgba(2,6,255,0.08)); animation-direction:reverse; animation-duration:5.2s; }
  .bg-animated .stripe.b { left:-25%; background:linear-gradient(90deg, rgba(255,10,10,0.95), rgba(255,10,10,0.06)); animation-duration:5.6s; opacity:0.12; }
  @keyframes stripeMove {
    0%{ transform:translateX(-60%) rotate(-12deg); }
    50%{ transform:translateX(60%) rotate(-12deg); }
    100%{ transform:translateX(-60%) rotate(-12deg); }
  }
  .bg-dots { position:absolute; inset:0; background-image: radial-gradient(rgba(255,255,255,0.02) 1px, transparent 1px); background-size: 80px 80px; opacity:0.06; transform: translateZ(0); }

  /* UI */
  .wrap{max-width:1100px;margin:18px auto;padding:18px;display:grid;grid-template-rows:auto 1fr;gap:14px; position:relative; z-index:1}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent2),var(--accent));display:flex;align-items:center;justify-content:center;font-weight:900;color:#041018; overflow:hidden; box-shadow: 0 6px 22px rgba(132,79,252,0.12); border:1px solid rgba(255,255,255,0.03) }
  .logo img{width:100%;height:100%;object-fit:cover;border-radius:10px}
  h1{margin:0;font-size:18px}
  .subtitle{color:var(--muted);font-size:13px}
  .top-right{display:flex;gap:8px;align-items:center}
  .pill{background:rgba(255,255,255,0.03);padding:8px 10px;border-radius:999px;font-weight:700}
  .small{font-size:12px;color:var(--muted)}
  .btn{background:var(--accent);color:#fff;padding:8px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:800}
  .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);padding:7px 10px;border-radius:10px;cursor:pointer}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));backdrop-filter: blur(6px);border-radius:14px;padding:18px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 10px 30px rgba(2,6,10,0.55);cursor:pointer;overflow:hidden;position:relative;display:flex;flex-direction:column;gap:12px;min-height:120px;transition:transform .22s,box-shadow .22s,border-color .22s}
  .card:hover{transform:translateY(-6px);box-shadow:0 22px 48px rgba(2,6,10,0.8); border-color: rgba(132,79,252,0.12)}
  .title{font-weight:900;font-size:16px}
  .desc{color:var(--muted);font-size:13px}
  .icon{width:56px;height:56px;border-radius:10px;background:rgba(255,255,255,0.02);display:flex;align-items:center;justify-content:center;font-size:22px}
  .expanded{margin-top:14px;border-radius:12px;padding:18px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03);backdrop-filter: blur(8px)}
  .form-row{display:flex;gap:8px}
  input,textarea,select,button{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:rgba(0,0,0,0.18);color:inherit}
  textarea{min-height:110px;resize:vertical}
  .list{display:flex;flex-direction:column;gap:10px}
  .item{padding:10px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));display:flex;justify-content:space-between;align-items:center}
  .muted{color:var(--muted)}
  .danger{background:linear-gradient(90deg,#ff8a80,#ff5252);color:#041018;padding:6px 8px;border-radius:8px}
  .ok{background:linear-gradient(90deg,#48c774,#34d399);color:#041018;padding:6px 8px;border-radius:8px}
  .tiny{font-size:12px}
  footer{margin-top:18px;text-align:center;color:var(--muted);font-size:13px}
  .overlay{position:fixed;inset:0;background:linear-gradient(rgba(2,6,10,0.6),rgba(2,6,10,0.8));display:flex;align-items:center;justify-content:center;z-index:9999}
  .modal{width:720px;max-width:94%;background:linear-gradient(180deg,#071729,#061421);padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
  .link-like{color:var(--accent);cursor:pointer;text-decoration:underline}
  .grid-2{display:grid;grid-template-columns:1fr 320px;gap:12px}
  .role-chip{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.02);margin-right:6px;margin-bottom:6px}
  .btn-danger-small{background:rgba(255,60,60,0.14);color:#ff6b6b;border:1px solid rgba(255,60,60,0.18);padding:6px 10px;border-radius:8px;cursor:pointer}
  .admin-mode-pill{background:linear-gradient(90deg,#ffef00,#ff6b00);color:#041018;padding:6px 10px;border-radius:999px;font-weight:800;cursor:pointer}
  @media (max-width:980px){ .grid{grid-template-columns:repeat(2,1fr)} .grid-2{grid-template-columns:1fr} }
  @media (max-width:640px){ .grid{grid-template-columns:1fr} .form-row{flex-direction:column} .modal{width:94%} }

  /* Radio styles */
  .radio-wrap { display:flex; gap:12px; align-items:flex-start; }
  .radio-left { flex:1; display:flex; flex-direction:column; gap:8px; }
  .radio-right { width:300px; }
  .radio-topbar { display:flex; gap:8px; align-items:center; }
  .radio-channel-badge { padding:6px 10px; border-radius:999px; background:rgba(255,255,255,0.03); font-weight:700; color:var(--muted); display:inline-flex; align-items:center; gap:8px; }
  .radio-messages { background: linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01)); padding:12px; border-radius:10px; max-height:380px; overflow:auto; display:flex; flex-direction:column; gap:8px; }
  .radio-msg { display:flex; gap:10px; align-items:flex-start; max-width:85%; }
  .radio-msg.me { margin-left:auto; flex-direction:row-reverse; }
  .radio-avatar { width:36px; height:36px; border-radius:10px; display:flex; align-items:center; justify-content:center; font-weight:800; background:linear-gradient(90deg, rgba(132,79,252,0.12), rgba(110,231,183,0.08)); color:#fff; font-size:14px; flex-shrink:0; }
  .radio-bubble { padding:10px 12px; border-radius:10px; background:rgba(0,0,0,0.34); color:inherit; box-shadow: 0 6px 18px rgba(0,0,0,0.35); }
  .radio-bubble.me { background: linear-gradient(90deg,var(--accent),var(--accent2)); color:#041018; }
  .radio-meta { font-size:11px; color:var(--muted); margin-top:4px; }
  .radio-channel-list .item { display:flex; align-items:center; justify-content:space-between; gap:8px; }
  .radio-actions { display:flex; gap:8px; align-items:center; }
  .radio-search { width:100%; padding:8px; border-radius:8px; border:1px solid rgba(255,255,255,0.03); background:rgba(0,0,0,0.12) }
</style>
</head>
<body>
  <div class="bg-animated" aria-hidden="true">
    <div class="stripe r" style="height:180%;"></div>
    <div class="stripe b" style="height:160%;"></div>
    <div class="bg-dots"></div>
  </div>

  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo"><img id="brandLogo" src="https://cdn.discordapp.com/attachments/1421898595271180360/1425878366116122654/LOGO_WIZARD_FONDO.png.png?ex=68e93036&is=68e7deb6&hm=db97d6e7afebb0948f23e7e7e19d8159c52456483ba28a970face42f7f4455ec&" alt="Logo"></div>
        <div>
          <h1>Daynight RP ‚Äî PDA / CAD</h1>
          <div class="subtitle">Simulador ‚Äî comparte `index.html` o publ√≠calo</div>
        </div>
      </div>

      <div class="top-right">
        <div class="pill small" id="userDisplay">No conectado</div>
        <div class="pill small" id="dutyStatus">En servicio: 0</div>
        <button id="btnExport" class="btn">Exportar</button>
        <button id="btnLogin" class="btn-ghost">Iniciar</button>
        <div id="adminModeWrap" style="display:none">
          <span id="adminModePill" class="admin-mode-pill" title="Activar modo administrador">Admin: OFF</span>
        </div>
      </div>
    </header>

    <section class="grid" id="cardsRoot"></section>

    <div id="expandedRoot"></div>

    <footer>Hecho para Daynight RP ‚Ä¢ Datos en Firestore ‚Ä¢ Copia este index.html</footer>
  </div>

  <!-- LOGIN / REGISTER modal -->
  <div id="loginModal" class="overlay" style="display:none">
    <div class="modal">
      <h3>Entrar / Registrarse</h3>
      <div class="muted small">Usa tu cuenta o crea una. Los datos se guardan localmente y tambi√©n se sincronizan con Firestore si est√°s conectado.</div>

      <div style="margin-top:12px">
        <label class="muted small">Usuario</label>
        <input id="loginUser" placeholder="usuario (ej: perety04)"/>
        <label class="muted small" style="margin-top:8px">Contrase√±a</label>
        <input id="loginPass" type="password" placeholder="contrase√±a"/>
        <div style="display:flex;gap:8px;margin-top:12px">
          <button id="loginBtn" class="btn">Entrar</button>
          <button id="guestBtn" class="btn-ghost">Invitado</button>
          <div style="margin-left:auto" class="small muted">¬øSin cuenta? <span id="showReg" class="link-like">Crear</span></div>
        </div>
        <div id="loginError" class="muted small" style="margin-top:8px;color:#ff9b9b;display:none"></div>
      </div>

      <div id="registerBlock" style="display:none;margin-top:12px;border-top:1px dashed rgba(255,255,255,0.03);padding-top:12px">
        <h4 style="margin:0 0 8px 0">Crear cuenta</h4>
        <label class="muted small">Nombre visible</label>
        <input id="regName" placeholder="Ej: Ofc. P√©rez"/>
        <label class="muted small">Usuario</label>
        <input id="regUser" placeholder="usuario (ej: perety04)"/>
        <label class="muted small">Contrase√±a</label>
        <input id="regPass" type="password" placeholder="contrase√±a"/>
        <div style="display:flex;gap:8px;margin-top:8px">
          <select id="regRole">
            <option value="officer">Officer</option>
            <option value="sergeant">Sergeant</option>
            <option value="dispatcher">Dispatcher</option>
            <option value="admin">Admin</option>
          </select>
          <button id="regCreate" class="btn">Crear</button>
          <button id="regCancel" class="btn-ghost">Cancelar</button>
        </div>
        <div id="regMsg" class="muted small" style="margin-top:8px"></div>
      </div>
    </div>
  </div>

  <!-- Carga Firebase (modular v9) e inicializaci√≥n -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getFirestore, collection, getDocs, deleteDoc, doc, addDoc, setDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCskczYgGtlPPBEIZiE5PuY7s_cfE_3Chg",
      authDomain: "wizard-rp.firebaseapp.com",
      projectId: "wizard-rp",
      storageBucket: "wizard-rp.firebasestorage.app",
      messagingSenderId: "479456044047",
      appId: "1:479456044047:web:65c52e2430bcb6ca586f7a",
      measurementId: "G-KX5Y56CG0R"
    };

    const firebaseApp = initializeApp(firebaseConfig);
    const db = getFirestore(firebaseApp);

    window.__FIRESTORE_DB = db;
    window.__FIRESTORE_READY = true;
    window.__FIRESTORE_helpers = { collection, getDocs, deleteDoc, doc, addDoc, setDoc, onSnapshot, query, orderBy };
  </script>

  <!-- C√≥digo principal -->
  <script>
  const PREFIX = 'pda_v5_';
  function lsGet(k, fallback){ try{ const v = localStorage.getItem(PREFIX+k); return v ? JSON.parse(v) : fallback; } catch(e){ return fallback; } }
  function lsSet(k,v){ try{ localStorage.setItem(PREFIX+k, JSON.stringify(v)); }catch(e){} }
  function lsRm(k){ try{ localStorage.removeItem(PREFIX+k); }catch(e){} }
  function uid(pref='id'){ return pref + '_' + Math.random().toString(36).slice(2,9); }
  function now(){ return Date.now(); }
  function modalAlert(title,msg){ alert(title + "\n\n" + msg); }

  function seedIfNeeded(){
    if(!lsGet('inited', false)){
      const users = [
        {id:uid('u'), username:'admin', display:'Admin', badge:'ADM-001', password:'admin123', role:'admin'},
        {id:uid('u'), username:'dispatcher', display:'Dispatch', badge:'DISP', password:'dispatch', role:'dispatcher'},
        {id:uid('u'), username:'perety04', display:'Perety 04', badge:'PD-314', password:'peretypass', role:'officer'}
      ];
      const templates = {
        report: "T√≠tulo: {{title}}\\nHechos: {{facts}}\\nAcciones: {{actions}}\\nOficial: {{author}}",
        pda: "Nombre: {{name}}\\nAlias: {{alias}}\\nNotas: {{notes}}",
      };
      const reports = [{id:uid('rep'), title:'Robo en tienda', description:'Robo con arma blanco. Sospechoso huy√≥.', author:'Admin', created_at:now()-3600*1000}];
      const wanted = [{id:uid('w'), name:'Mario Rata', description:'Robo coches', bounty:500, created_at:now()-20000}];
      const calls = [{id:uid('c'), caller:'Civ. X', message:'Disparo', status:'pending', assigned_to:null, created_at:now()-5000}];
      const pda = [{id:uid('p'), text:'Nombre: Juan P√©rez\\nAlias: rata\\nDelitos: robo', created_at:now()-2000}];
      const fines = [{id:uid('f'), offender:'Veh LSF-021', amount:200, reason:'Exceso velocidad', author:'Admin', created_at:now()-8000}];
      const roles = {
        officer: {name:'Officer', color:'#7c3aed', permissions:['create_reports','create_pda','create_call']},
        sergeant: {name:'Sergeant', color:'#3b82f6', permissions:['create_reports','create_pda','create_call','delete_reports']},
        dispatcher: {name:'Dispatcher', color:'#f97316', permissions:['create_call','assign_call']},
        admin: {name:'Admin', color:'#10b981', permissions:['all']}
      };
      const radioChannels = [{id:'general', name:'General'},{id:'police', name:'Police'},{id:'medical', name:'Medical'}];

      lsSet('users', users);
      lsSet('templates', templates);
      lsSet('reports', reports);
      lsSet('wanted', wanted);
      lsSet('calls', calls);
      lsSet('pda', pda);
      lsSet('fines', fines);
      lsSet('roles', roles);
      lsSet('logs', [{id:uid('log'), t:now(), msg:'Seed inicial creada'}]);
      lsSet('onDuty', {});
      lsSet('radio_channels', radioChannels);
      lsSet('inited', true);
    }
  }

  const STATE = {
    currentUser: lsGet('currentUser', null),
    expanded: null,
    adminMode: false,
    radio: { selectedChannel: null, unsubMessages: null, unsubChannels: null }
  };

  const cardsRoot = document.getElementById('cardsRoot');
  const expandedRoot = document.getElementById('expandedRoot');
  const userDisplay = document.getElementById('userDisplay');
  const dutyStatus = document.getElementById('dutyStatus');
  const loginModal = document.getElementById('loginModal');
  const btnLogin = document.getElementById('btnLogin');
  const btnExport = document.getElementById('btnExport');
  const adminModeWrap = document.getElementById('adminModeWrap');
  const adminModePill = document.getElementById('adminModePill');

  function hasPerm(perm){
    if(!STATE.currentUser) return perm === 'create_call' ? true : false;
    const roles = lsGet('roles', {});
    const roleKey = STATE.currentUser.role;
    const role = roles[roleKey];
    if(!role) return false;
    if(role.permissions && role.permissions.includes('all')){
      return STATE.adminMode === true;
    }
    return role.permissions && role.permissions.includes(perm);
  }

  const CARDS = [
    {id:'pda', title:'PDA / Fichas', desc:'Buscar y crear fichas PDA', icon:'üöì'},
    {id:'calls', title:'Dispatch / Llamadas', desc:'Crear/Asignar llamadas', icon:'üìû'},
    {id:'reports', title:'Informes', desc:'Crear / Editar informes', icon:'üìë'},
    {id:'wanted', title:'BOLO / Wanted', desc:'Fichas buscados', icon:'üö®'},
    {id:'fines', title:'Multas', desc:'Generar sanciones', icon:'üí∏'},
    {id:'service', title:'Servicio', desc:'Entrar / Salir de servicio', icon:'üü¢'},
    {id:'alerts', title:'Alertas (Verde/Amarilla/Roja)', desc:'Crear y gestionar alertas', icon:'‚ö†Ô∏è'},
    {id:'radio', title:'Radios', desc:'Chat por canales (radio escrita)', icon:'üì°'},
    {id:'admin', title:'Administraci√≥n', desc:'Roles y usuarios (avanzado)', icon:'‚öôÔ∏è'},
    {id:'logs', title:'Auditor√≠a', desc:'Historial de acciones', icon:'üìú'}
  ];

  function renderCards(){
    cardsRoot.innerHTML = '';
    const cur = STATE.currentUser;
    const isAdmin = cur && cur.role === 'admin';
    CARDS.forEach(c=>{
      if((c.id === 'admin' || c.id === 'logs') && !isAdmin) return;
      const el = document.createElement('div'); el.className='card'; el.dataset.id=c.id;
      el.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
        <div><div class="title">${c.title}</div><div class="desc">${c.desc}</div></div>
        <div class="icon">${c.icon}</div>
      </div>
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="muted tiny">Acci√≥n r√°pida</div>
        <div><button class="btn-ghost" data-open="${c.id}" style="border-color: rgba(132,79,252,0.12); color: #844ffc;">Abrir</button></div>
      </div>`;
      el.onclick = ()=>openCard(c.id);
      el.querySelector('button[data-open]').onclick = (e)=>{ e.stopPropagation(); openCard(c.id); };
      cardsRoot.appendChild(el);
    });
  }

  /* Admin Mode UI + logic */
  function updateAdminUI(){
    const cur = STATE.currentUser;
    const isAdmin = cur && cur.role === 'admin';
    adminModeWrap.style.display = isAdmin ? 'inline-block' : 'none';
    adminModePill.textContent = `Admin: ${STATE.adminMode ? 'ON' : 'OFF'}`;
    adminModePill.style.opacity = STATE.adminMode ? '1' : '0.7';
  }
  function promptEnableAdminMode(){
    if(!STATE.currentUser || STATE.currentUser.role !== 'admin'){ modalAlert('Error','Solo admin puede activar modo admin'); return false; }
    const pass = prompt('Reingresa la contrase√±a de admin para activar modo administrador:');
    if(!pass) return false;
    const users = lsGet('users', []);
    const found = users.find(u=>u.username === STATE.currentUser.username);
    if(!found || found.password !== pass){ modalAlert('Error','Contrase√±a incorrecta'); return false; }
    STATE.adminMode = true;
    updateAdminUI();
    pushLogLocal(`Admin mode activado por ${STATE.currentUser.username}`);
    renderCards();
    return true;
  }
  adminModePill.addEventListener('click', async ()=>{
    if(STATE.adminMode){
      if(confirm('Desactivar Admin Mode?')){ STATE.adminMode = false; updateAdminUI(); pushLogLocal(`Admin mode desactivado por ${STATE.currentUser?STATE.currentUser.username:'?'}`); renderCards(); }
      return;
    }
    promptEnableAdminMode();
  });

  /*
    Admin Mode behavior:
    - Admin Mode is an extra protection. Admin users can open the Admin panel while Admin Mode is OFF,
      but destructive operations (create/delete roles & users, impersonate, delete-all) require Admin Mode ON.
    - This avoids situations where clicking a button "no hace nada" ‚Äî instead, the panel explains the requirement
      and offers a button to enable Admin Mode (re-auth).
  */

  function openCard(id){
    // we allow admin panel open even if adminMode is OFF but only to admins
    if(id === 'admin' && (!STATE.currentUser || STATE.currentUser.role !== 'admin')){ modalAlert('Acceso denegado','Acceso a Administraci√≥n: necesitas ser admin.'); return; }
    if(id === 'logs' && (!STATE.currentUser || STATE.currentUser.role !== 'admin' || !STATE.adminMode)){ modalAlert('Acceso denegado','Solo admin con Admin Mode puede ver la auditor√≠a. Activa Admin Mode para ver los logs.'); return; }
    STATE.expanded = id;
    expandedRoot.innerHTML = '';
    const panel = document.createElement('div'); panel.className='expanded';
    if(id==='pda') renderPDA(panel);
    else if(id==='calls') renderCalls(panel);
    else if(id==='reports') renderReports(panel);
    else if(id==='wanted') renderWanted(panel);
    else if(id==='fines') renderFines(panel);
    else if(id==='service') renderService(panel);
    else if(id==='alerts') renderAlerts(panel);
    else if(id==='admin') renderAdmin(panel);
    else if(id==='logs') renderLogs(panel);
    else if(id==='radio') renderRadio(panel);
    expandedRoot.appendChild(panel);
    window.scrollTo({ top: panel.offsetTop-20, behavior:'smooth' });
  }

  /* ========== PDA (unchanged) ========== */
  function renderPDA(container){
    const templates = lsGet('templates', {});
    container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>PDA / Fichas</strong><div class="muted small">Buscar y crear fichas</div></div>
      <div><button class="btn btn-small" id="closeP">Cerrar</button></div>
    </div>
    <div style="margin-top:12px" class="grid-2">
      <div>
        <div class="muted small">Buscar</div>
        <input id="pdaQ" placeholder="Buscar por nombre, alias o texto..." />
        <div id="pdaResults" style="margin-top:12px"></div>
      </div>
      <div>
        <div class="muted small">Crear nueva ficha (plantilla editable)</div>
        <textarea id="pdaTpl">${templates.pda||''}</textarea>
        <div style="display:flex;gap:8px;margin-top:8px"><button id="createPDA" class="btn">Crear ficha</button><button id="clearPDA" class="btn-ghost">Limpiar</button></div>
      </div>
    </div>`;
    container.querySelector('#closeP').onclick = ()=> closeExpanded();
    container.querySelector('#pdaQ').oninput = ()=> searchPDA(document.getElementById('pdaQ').value);
    container.querySelector('#createPDA').onclick = createPDA;
    loadPDAResults();
  }
  function loadPDAResults(){
    const arr = lsGet('pda', []);
    const res = document.getElementById('pdaResults');
    if(!res) return;
    res.innerHTML = arr.map(p=>`<div class="item"><div style="flex:1"><b>${(p.title||'Ficha')}</b><div class="muted small">${(p.text||'').slice(0,140)}</div></div>
      <div><button class="btn-ghost" onclick="(function(){const ev = new Event('viewPDACustom'); ev.detail='${p.id}'; window.dispatchEvent(ev);})();">Ver</button> <button class="btn-ghost" onclick="(function(){const ev = new Event('delPDACustom'); ev.detail='${p.id}'; window.dispatchEvent(ev);})();">Borrar</button></div></div>`).join('') || '<div class="muted small">Sin fichas</div>';
  }
  window.addEventListener('viewPDACustom', (e)=> viewPDA(e.detail));
  window.addEventListener('delPDACustom', (e)=> delPDA(e.detail));
  function searchPDA(q){
    q = (q||'').toLowerCase().trim();
    const arr = lsGet('pda', []);
    const out = arr.filter(p => ((p.text||'').toLowerCase().includes(q) || (p.title||'').toLowerCase().includes(q)));
    const res = document.getElementById('pdaResults');
    if(!res) return;
    res.innerHTML = out.map(p=>`<div class="item"><div style="flex:1"><b>${p.title||'Ficha'}</b><div class="muted small">${(p.text||'').slice(0,140)}</div></div>
      <div><button class="btn-ghost" onclick="(function(){const ev = new Event('viewPDACustom'); ev.detail='${p.id}'; window.dispatchEvent(ev);})();">Ver</button> <button class="btn-ghost" onclick="(function(){const ev = new Event('delPDACustom'); ev.detail='${p.id}'; window.dispatchEvent(ev);})();">Borrar</button></div></div>`).join('') || '<div class="muted small">No hay resultados</div>';
  }
  function createPDA(){
    if(!hasPerm('create_pda')){ modalAlert('Error','No tienes permiso para crear fichas PDA'); return; }
    const txt = document.getElementById('pdaTpl').value.trim();
    if(!txt){ modalAlert('Error','Rellena la plantilla'); return; }
    const arr = lsGet('pda', []);
    const item = {id:uid('pda'), title: (txt.split('\n')[0]||'Ficha').replace('Nombre:','').trim(), text:txt, created_at:now(), author: STATE.currentUser?STATE.currentUser.username:'Invitado'};
    arr.unshift(item); lsSet('pda', arr);
    pushLogLocal(`Ficha PDA creada: ${item.title}`);
    document.getElementById('pdaTpl').value = ''; loadPDAResults();
  }
  function viewPDA(id){
    const arr = lsGet('pda', []);
    const p = arr.find(x=>x.id===id);
    if(!p) return;
    modalAlert('Ficha PDA', `T√≠tulo: ${p.title}\n\n${p.text}\n\nCreada: ${new Date(p.created_at).toLocaleString()}\nAutor: ${p.author}`);
  }
  function delPDA(id){
    if(!confirm('Borrar ficha PDA?')) return;
    let arr = lsGet('pda', []);
    arr = arr.filter(x=>x.id!==id); lsSet('pda', arr); pushLogLocal(`Ficha PDA borrada: ${id}`); loadPDAResults();
  }

  /* ========== Calls ========== */
  function renderCalls(container){
    container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>Dispatch / Llamadas</strong><div class="muted small">Crear llamadas y asignar unidades</div></div>
      <div><button class="btn btn-small" id="closeC">Cerrar</button></div>
    </div>
    <div style="margin-top:12px;display:flex;gap:8px">
      <input id="callFrom" placeholder="Remitente (opcional)"/>
      <input id="callMsg" placeholder="Mensaje"/>
      <button id="callCreate" class="btn">Crear llamada</button>
    </div>
    <div style="margin-top:12px"><strong>Llamadas</strong><div id="callsList" class="list" style="margin-top:8px"></div></div>`;
    container.querySelector('#closeC').onclick = ()=> closeExpanded();
    container.querySelector('#callCreate').onclick = createCall;
    loadCalls();
  }
  function createCall(){
    const caller = document.getElementById('callFrom').value.trim() || 'Anonimo';
    const message = document.getElementById('callMsg').value.trim();
    if(!message){ modalAlert('Error','Introduce un mensaje'); return; }
    const calls = lsGet('calls', []);
    const c = {id:uid('c'), caller, message, status:'pending', assigned_to:null, created_at:now()};
    calls.unshift(c); lsSet('calls', calls); pushLogLocal(`Llamada creada por ${caller}`);
    document.getElementById('callMsg').value=''; document.getElementById('callFrom').value='';
    loadCalls();
  }
  function loadCalls(){
    const list = document.getElementById('callsList'); if(!list) return;
    const calls = lsGet('calls', []);
    list.innerHTML = '';
    if(!calls.length){ list.innerHTML = '<div class="muted small">No hay llamadas</div>'; return; }
    const users = lsGet('users', []);
    calls.forEach(c=>{
      const assignee = c.assigned_to ? (users.find(u=>u.id===c.assigned_to)?.display || '‚Äî') : '‚Äî';
      const el = document.createElement('div'); el.className='item';
      el.innerHTML = `<div style="flex:1"><b>${c.caller}</b><div class="muted small">${c.message}</div></div>
        <div style="text-align:right"><div class="muted tiny">${new Date(c.created_at).toLocaleString()}</div><div style="margin-top:8px" class="muted tiny">Asig: ${assignee}</div></div>`;
      const btns = document.createElement('div'); btns.style.marginLeft='12px';
      if(hasPerm('assign_call') && STATE.currentUser){
        const assign = document.createElement('button'); assign.className='btn-ghost'; assign.textContent='Asignar a m√≠';
        assign.onclick = ()=>{ assignCall(c.id); };
        btns.appendChild(assign);
      }
      if(STATE.currentUser && (STATE.currentUser.role==='admin' || (c.assigned_to && STATE.currentUser.id===c.assigned_to))){
        const del = document.createElement('button'); del.className='btn'; del.style.marginLeft='6px'; del.textContent='Borrar';
        del.onclick = ()=>{ if(confirm('Borrar llamada?')) deleteCall(c.id); };
        btns.appendChild(del);
      }
      el.appendChild(btns);
      list.appendChild(el);
    });
  }
  function assignCall(id){
    if(!STATE.currentUser){ modalAlert('Error','Inicia sesi√≥n para asignar'); return; }
    let calls = lsGet('calls', []);
    const c = calls.find(x=>x.id===id); if(!c) return;
    c.status='assigned'; c.assigned_to = STATE.currentUser.id; lsSet('calls', calls); pushLogLocal(`Llamada ${id} asignada a ${STATE.currentUser.display}`); loadCalls();
  }
  function deleteCall(id){ let calls=lsGet('calls',[]); calls = calls.filter(c=>c.id!==id); lsSet('calls', calls); pushLogLocal(`Llamada ${id} borrada`); loadCalls(); }

  /* ========== Reports ========== */
  function renderReports(container){
    container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>Informes</strong><div class="muted small">Crear y consultar informes</div></div>
      <div><button class="btn btn-small" id="closeR">Cerrar</button></div>
    </div>
    <div style="margin-top:12px">
      <div class="muted small">Plantilla (editable)</div>
      <textarea id="tplReport" style="min-height:80px"></textarea>
    </div>
    <div style="margin-top:8px" class="form-row">
      <input id="repTitle" placeholder="T√≠tulo" />
      <input id="repAuthor" placeholder="Autor (auto)" />
    </div>
    <div style="margin-top:8px"><textarea id="repDesc" placeholder="Descripci√≥n..."></textarea></div>
    <div style="margin-top:8px;display:flex;gap:8px"><button id="saveRep" class="btn">Guardar informe</button><button id="clearRep" class="btn-ghost">Limpiar</button></div>
    <div style="margin-top:12px"><strong>√öltimos informes</strong><div id="reportsList" class="list" style="margin-top:8px"></div></div>`;
    container.querySelector('#closeR').onclick = ()=> closeExpanded();
    const templates = lsGet('templates', {}); document.getElementById('tplReport').value = templates.report || '';
    document.getElementById('repAuthor').value = STATE.currentUser ? STATE.currentUser.display : 'Invitado';
    document.getElementById('saveRep').onclick = saveReport;
    document.getElementById('clearRep').onclick = ()=>{ document.getElementById('repTitle').value=''; document.getElementById('repDesc').value=''; };
    loadReports();
  }
  function saveReport(){
    if(!hasPerm('create_reports')){ modalAlert('Error','No tienes permiso para crear informes'); return; }
    const title = document.getElementById('repTitle').value.trim();
    const desc = document.getElementById('repDesc').value.trim();
    if(!title || !desc){ modalAlert('Error','T√≠tulo y descripci√≥n obligatorios'); return; }
    const reports = lsGet('reports', []);
    const r = {id:uid('rep'), title, description:desc, author: STATE.currentUser?STATE.currentUser.display:'Invitado', created_at:now()};
    reports.unshift(r); lsSet('reports', reports);
    const templates = lsGet('templates', {}); templates.report = document.getElementById('tplReport').value; lsSet('templates', templates);
    pushLogLocal(`Informe creado: ${title}`);
    loadReports();
  }
  function loadReports(){
    const list = document.getElementById('reportsList'); if(!list) return;
    const reports = lsGet('reports', []);
    list.innerHTML = '';
    if(!reports.length){ list.innerHTML = '<div class="muted small">No hay informes</div>'; return; }
    reports.forEach(r=>{
      const it = document.createElement('div'); it.className='item';
      it.innerHTML = `<div style="flex:1"><div style="font-weight:700">${r.title}</div><div class="muted small">${(r.description||'').slice(0,160)}</div></div>
        <div style="text-align:right"><div class="muted tiny">${new Date(r.created_at).toLocaleString()}</div><div style="margin-top:6px" class="muted tiny">${r.author||''}</div></div>`;
      const btns = document.createElement('div'); btns.style.marginLeft='12px';
      const view = document.createElement('button'); view.className='btn-ghost'; view.textContent='Ver';
      view.onclick = ()=> modalAlert(`Informe ‚Äî ${r.title}`, `${r.description}\n\nAutor: ${r.author}\nFecha: ${new Date(r.created_at).toLocaleString()}`);
      btns.appendChild(view);
      if(STATE.currentUser && (STATE.currentUser.role==='admin' || STATE.currentUser.role==='sergeant' || hasPerm('delete_reports'))){
        const del = document.createElement('button'); del.className='btn'; del.style.marginLeft='6px'; del.textContent='Borrar'; del.onclick = ()=>{ if(confirm('Borrar informe?')) deleteReport(r.id); };
        btns.appendChild(del);
      }
      it.appendChild(btns);
      list.appendChild(it);
    });
  }
  function deleteReport(id){ let arr=lsGet('reports',[]); arr=arr.filter(r=>r.id!==id); lsSet('reports',arr); pushLogLocal(`Informe ${id} borrado`); loadReports(); }

  /* ========== Wanted / BOLO ========== */
  function renderWanted(container){
    container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>BOLO / Wanted</strong><div class="muted small">Crear fichas buscadas</div></div>
      <div><button class="btn btn-small" id="closeW">Cerrar</button></div>
    </div>
    <div style="margin-top:12px" class="form-row">
      <input id="wName" placeholder="Nombre / Alias" />
      <input id="wBounty" placeholder="Recompensa" />
    </div>
    <div style="margin-top:8px"><textarea id="wDesc" placeholder="Descripci√≥n"></textarea></div>
    <div style="margin-top:8px;display:flex;gap:8px"><button id="saveW" class="btn">Crear ficha</button></div>
    <div style="margin-top:12px"><strong>Fichas</strong><div id="wantedList" class="list" style="margin-top:8px"></div></div>`;
    container.querySelector('#closeW').onclick = ()=> closeExpanded();
    container.querySelector('#saveW').onclick = createWanted;
    loadWanted();
  }
  function createWanted(){ if(!hasPerm('create_bolo')){ modalAlert('Error','No tienes permiso'); return; }
    const name=document.getElementById('wName').value.trim(); const desc=document.getElementById('wDesc').value.trim(); const bounty=parseInt(document.getElementById('wBounty').value||'0',10);
    if(!name){ modalAlert('Error','Nombre requerido'); return; }
    const arr=lsGet('wanted',[]); arr.unshift({id:uid('w'), name, description:desc, bounty, created_at:now()}); lsSet('wanted',arr); pushLogLocal(`Wanted creado: ${name}`); loadWanted();
  }
  function loadWanted(){ const list=document.getElementById('wantedList'); if(!list) return; const arr=lsGet('wanted',[]); list.innerHTML=''; if(!arr.length){ list.innerHTML='<div class="muted small">No hay fichas</div>'; return; } arr.forEach(w=>{ const it=document.createElement('div'); it.className='item'; it.innerHTML=`<div style="flex:1"><b>${w.name}</b><div class="muted small">${w.description}</div></div><div class="pill">${w.bounty||0}‚Ç¨</div>`; const btns=document.createElement('div'); btns.style.marginLeft='12px'; const view=document.createElement('button'); view.className='btn-ghost'; view.textContent='Ver'; view.onclick=()=>modalAlert(`Wanted ‚Äî ${w.name}`,`${w.description}\nRecompensa: ${w.bounty}‚Ç¨`); btns.appendChild(view); if(hasPerm('manage_wanted')){ const del=document.createElement('button'); del.className='btn'; del.style.marginLeft='6px'; del.textContent='Borrar'; del.onclick=()=>{ if(confirm('Borrar ficha?')){ deleteWanted(w.id); } }; btns.appendChild(del); } it.appendChild(btns); list.appendChild(it); }); }
  function deleteWanted(id){ let arr=lsGet('wanted',[]); arr=arr.filter(x=>x.id!==id); lsSet('wanted',arr); pushLogLocal(`Wanted ${id} borrado`); loadWanted(); }

  /* ========== Fines ========== */
  function renderFines(container){
    container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>Multas</strong><div class="muted small">Generar sanciones</div></div>
      <div><button class="btn btn-small" id="closeF">Cerrar</button></div>
    </div>
    <div style="margin-top:12px" class="form-row"><input id="fineOff" placeholder="Infractor"/><input id="fineAmt" placeholder="Importe"/></div>
    <div style="margin-top:8px"><textarea id="fineReason" placeholder="Motivo..."></textarea></div>
    <div style="margin-top:8px;display:flex;gap:8px"><button id="saveFine" class="btn">Emitir multa</button></div>
    <div style="margin-top:12px"><strong>Multas</strong><div id="finesList" class="list" style="margin-top:8px"></div></div>`;
    container.querySelector('#closeF').onclick = ()=> closeExpanded();
    container.querySelector('#saveFine').onclick = saveFine; loadFines();
  }
  function saveFine(){ if(!hasPerm('create_fine')){ modalAlert('Error','No tienes permiso para multar'); return; }
    const off=document.getElementById('fineOff').value.trim(); const amt=parseInt(document.getElementById('fineAmt').value||'0',10); const reason=document.getElementById('fineReason').value.trim();
    if(!off || !amt){ modalAlert('Error','Infractor e importe requeridos'); return; }
    const arr=lsGet('fines',[]); arr.unshift({id:uid('f'), offender:off, amount:amt, reason, author:STATE.currentUser?STATE.currentUser.display:'Invitado', created_at:now()}); lsSet('fines',arr); pushLogLocal(`Multa creada: ${off} ${amt}‚Ç¨`); loadFines();
  }
  function loadFines(){ const list=document.getElementById('finesList'); if(!list) return; const arr=lsGet('fines',[]); list.innerHTML=''; if(!arr.length){ list.innerHTML='<div class="muted small">No hay multas</div>'; return; } arr.forEach(f=>{ const it=document.createElement('div'); it.className='item'; it.innerHTML=`<div style="flex:1"><b>${f.offender} ‚Ä¢ ${f.amount}‚Ç¨</b><div class="muted small">${f.reason}</div></div><div class="muted tiny">${new Date(f.created_at).toLocaleString()}</div>`; const btns=document.createElement('div'); btns.style.marginLeft='12px'; if(STATE.currentUser && (STATE.currentUser.role==='admin' || STATE.currentUser.display===f.author || hasPerm('delete_reports'))){ const del=document.createElement('button'); del.className='btn'; del.textContent='Borrar'; del.onclick =()=>{ if(confirm('Borrar multa?')){ deleteFine(f.id); } }; btns.appendChild(del); } it.appendChild(btns); list.appendChild(it); }); }
  function deleteFine(id){ let arr=lsGet('fines',[]); arr=arr.filter(x=>x.id!==id); lsSet('fines',arr); pushLogLocal(`Multa ${id} borrada`); loadFines(); }

  /* ========== Service (on duty) ========== */
  function renderService(container){
    container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>Servicio</strong><div class="muted small">Ponte en servicio o sal</div></div>
      <div><button class="btn btn-small" id="closeS">Cerrar</button></div>
    </div>
    <div style="margin-top:12px;display:flex;gap:8px;align-items:center"><div class="muted small">Tu estado:</div><div id="serviceBox" class="pill">Desconocido</div><div style="margin-left:auto"><button id="toggleDuty" class="btn">Cambiar estado</button></div></div>
    <div style="margin-top:12px"><strong>Polic√≠as en servicio</strong><div id="dutyList" class="list" style="margin-top:8px"></div></div>`;
    container.querySelector('#closeS').onclick = ()=> closeExpanded();
    const box = container.querySelector('#serviceBox'); const on = lsGet('onDuty', {}); const uId = STATE.currentUser ? STATE.currentUser.id : null;
    box.textContent = (uId && on[uId]) ? 'En servicio' : 'Fuera de servicio';
    container.querySelector('#toggleDuty').onclick = ()=>{ if(!STATE.currentUser){ modalAlert('Error','Inicia sesi√≥n'); return; } const map = lsGet('onDuty', {}); map[STATE.currentUser.id] = !map[STATE.currentUser.id]; lsSet('onDuty', map); box.textContent = map[STATE.currentUser.id] ? 'En servicio' : 'Fuera de servicio'; pushLogLocal(`${STATE.currentUser.display} ${map[STATE.currentUser.id] ? 'entr√≥' : 'sali√≥'} de servicio`); updateHeader(); loadDutyList(); };
    loadDutyList();
  }
  function loadDutyList(){ const list=document.getElementById('dutyList'); if(!list) return; const on=lsGet('onDuty',{}); const users=lsGet('users', []); const active = Object.keys(on).filter(k=>on[k]).map(id=> users.find(u=>u.id===id)?.display || id); list.innerHTML = active.map(a=>`<div class="item">${a}</div>`).join('') || '<div class="muted small">Nadie en servicio</div>'; updateHeader(); }

  /* ========== ALERTS (Firestore-backed) ========== */
  async function renderAlerts(container){
    container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>Alertas</strong><div class="muted small">Crear alertas de la ciudad - Verde / Amarilla / Roja</div></div>
      <div><button class="btn btn-small" id="closeA2">Cerrar</button></div>
    </div>
    <div style="margin-top:12px" class="form-row">
      <select id="alertLevel"><option value="verde">Verde</option><option value="amarilla">Amarilla</option><option value="roja">Roja</option></select>
      <input id="alertTitle" placeholder="T√≠tulo de alerta"/>
    </div>
    <div style="margin-top:8px"><textarea id="alertMsg" placeholder="Mensaje de la alerta..."></textarea></div>
    <div style="margin-top:8px;display:flex;gap:8px"><button id="createAlertBtn" class="btn">Crear alerta</button><button id="refreshAlerts" class="btn-ghost">Refrescar</button></div>
    <div style="margin-top:12px"><strong>Alertas actuales</strong><div id="alertsList" class="list" style="margin-top:8px"></div></div>
    <div id="alertsFooter" style="margin-top:8px;text-align:right"></div>`;
    container.querySelector('#closeA2').onclick = ()=> closeExpanded();
    container.querySelector('#createAlertBtn').onclick = createAlertFirestore;
    container.querySelector('#refreshAlerts').onclick = loadAlertsFirestore;
    await loadAlertsFirestore();
  }
  async function loadAlertsFirestore(){
    const list = document.getElementById('alertsList');
    const footer = document.getElementById('alertsFooter');
    if(!list) return;
    list.innerHTML = '<div class="muted small">Cargando...</div>';
    footer.innerHTML = '';

    if(window.__FIRESTORE_READY && window.__FIRESTORE_DB){
      try{
        const db = window.__FIRESTORE_DB;
        const q = window.__FIRESTORE_helpers.query(window.__FIRESTORE_helpers.collection(db, 'alerts'), window.__FIRESTORE_helpers.orderBy('created_at','desc'));
        const snap = await window.__FIRESTORE_helpers.getDocs(q);
        const arr = [];
        snap.forEach(docSnap => {
          const d = docSnap.data();
          d._id = docSnap.id;
          arr.push(d);
        });
        if(!arr.length){ list.innerHTML = '<div class="muted small">No hay alertas</div>'; }
        else {
          list.innerHTML = '';
          arr.forEach(a=>{
            const it = document.createElement('div'); it.className='item';
            it.innerHTML = `<div style="flex:1"><div style="font-weight:700">${a.title||'(sin t√≠tulo)'} <span class="muted tiny">[${a.level||'‚Äî'}]</span></div><div class="muted small">${(a.message||'').slice(0,200)}</div></div>
              <div style="text-align:right"><div class="muted tiny">${a.created_at? new Date(a.created_at).toLocaleString() : ''}</div></div>`;
            const btns = document.createElement('div'); btns.style.marginLeft='12px';
            if(STATE.currentUser && (STATE.currentUser.role==='admin' && STATE.adminMode || a.author === (STATE.currentUser && STATE.currentUser.username))){
              const del = document.createElement('button'); del.className='btn-danger-small'; del.style.marginLeft='6px'; del.textContent='Borrar';
              del.onclick = async ()=>{ if(confirm('Borrar alerta?')){ await deleteAlertFirestore(a._id); await loadAlertsFirestore(); } };
              btns.appendChild(del);
            }
            it.appendChild(btns);
            list.appendChild(it);
          });
        }
        if(STATE.currentUser && STATE.currentUser.role==='admin' && STATE.adminMode){
          const btnAll = document.createElement('button'); btnAll.className='btn-danger-small'; btnAll.style.marginTop='8px'; btnAll.textContent='üóë Borrar todas las alertas';
          btnAll.onclick = async ()=>{ if(confirm('¬øBorrar todas las alertas de Firestore? Esta acci√≥n no se puede deshacer.')){ await deleteAllAlertsFirestore(); await loadAlertsFirestore(); } };
          footer.appendChild(btnAll);
        }
      } catch(err){
        console.error('Error loadAlertsFirestore', err);
        list.innerHTML = '<div class="muted small">Error cargando alertas (ver consola)</div>';
      }
    } else {
      const arr = lsGet('alerts', []);
      if(!arr || !arr.length) list.innerHTML = '<div class="muted small">No hay alertas</div>';
      else {
        list.innerHTML = '';
        arr.forEach(a=>{
          const it = document.createElement('div'); it.className='item';
          it.innerHTML = `<div style="flex:1"><div style="font-weight:700">${a.title}</div><div class="muted small">${a.message}</div></div>
            <div style="text-align:right"><div class="muted tiny">${a.created_at? new Date(a.created_at).toLocaleString() : ''}</div></div>`;
          list.appendChild(it);
        });
        if(STATE.currentUser && STATE.currentUser.role==='admin' && STATE.adminMode){
          const btnAll = document.createElement('button'); btnAll.className='btn-danger-small'; btnAll.style.marginTop='8px'; btnAll.textContent='üóë Borrar todas las alertas (local)';
          btnAll.onclick = ()=>{ if(confirm('Borrar todas las alertas locales?')){ lsSet('alerts', []); pushLogLocal('Borradas todas las alertas (local)'); loadAlertsFirestore(); } };
          footer.appendChild(btnAll);
        }
      }
    }
  }
  async function createAlertFirestore(){
    if(!STATE.currentUser){ modalAlert('Error','Inicia sesi√≥n para crear alertas'); return; }
    const lvl = document.getElementById('alertLevel').value;
    const title = document.getElementById('alertTitle').value.trim();
    const msg = document.getElementById('alertMsg').value.trim();
    if(!title || !msg){ modalAlert('Error','T√≠tulo y mensaje obligatorios'); return; }
    const payload = {
      title,
      message: msg,
      level: lvl,
      author: STATE.currentUser.username,
      created_at: Date.now()
    };
    if(window.__FIRESTORE_READY && window.__FIRESTORE_DB){
      try{
        await window.__FIRESTORE_helpers.addDoc(window.__FIRESTORE_helpers.collection(window.__FIRESTORE_DB,'alerts'), payload);
        await window.__FIRESTORE_helpers.addDoc(window.__FIRESTORE_helpers.collection(window.__FIRESTORE_DB,'logs'), { t: Date.now(), msg: `Alerta creada: ${title} (nivel ${lvl}) por ${STATE.currentUser.username}` });
        pushLogLocal(`Alerta creada: ${title}`);
        document.getElementById('alertTitle').value=''; document.getElementById('alertMsg').value='';
        await loadAlertsFirestore();
      } catch(err){ console.error('createAlertFirestore', err); modalAlert('Error','No se pudo crear la alerta (ver consola)'); }
    } else {
      const arr = lsGet('alerts', []); arr.unshift({...payload, id: uid('a')}); lsSet('alerts', arr); pushLogLocal(`Alerta (local) creada: ${title}`); loadAlertsFirestore();
    }
  }
  async function deleteAlertFirestore(id){
    if(!id) return;
    if(window.__FIRESTORE_READY && window.__FIRESTORE_DB){
      try{
        await window.__FIRESTORE_helpers.deleteDoc(window.__FIRESTORE_helpers.doc(window.__FIRESTORE_DB, 'alerts', id));
        await window.__FIRESTORE_helpers.addDoc(window.__FIRESTORE_helpers.collection(window.__FIRESTORE_DB,'logs'), { t: Date.now(), msg: `Alerta ${id} borrada por ${STATE.currentUser?STATE.currentUser.username:'?'} ` });
        pushLogLocal(`Alerta ${id} borrada`);
      } catch(err){ console.error('deleteAlertFirestore', err); modalAlert('Error','No se pudo borrar la alerta (ver consola)'); }
    } else {
      let arr = lsGet('alerts', []); arr = arr.filter(x=>x.id!==id); lsSet('alerts', arr); pushLogLocal(`Alerta local ${id} borrada`);
    }
  }
  async function deleteAllAlertsFirestore(){
    if(!STATE.currentUser || STATE.currentUser.role!=='admin' || !STATE.adminMode){ modalAlert('Error','Solo admin (Admin Mode) puede borrar todas las alertas'); return; }
    if(!window.__FIRESTORE_READY || !window.__FIRESTORE_DB){
      lsSet('alerts', []); pushLogLocal('Borradas todas las alertas (local fallback)'); return;
    }
    try{
      const db = window.__FIRESTORE_DB;
      const snap = await window.__FIRESTORE_helpers.getDocs(window.__FIRESTORE_helpers.collection(db,'alerts'));
      const ids = [];
      snap.forEach(s=> ids.push(s.id));
      for(const id of ids){ await window.__FIRESTORE_helpers.deleteDoc(window.__FIRESTORE_helpers.doc(db,'alerts', id)); }
      await window.__FIRESTORE_helpers.addDoc(window.__FIRESTORE_helpers.collection(db,'logs'), { t: Date.now(), msg: `ADMIN borr√≥ todas las alertas (${ids.length})` });
      pushLogLocal(`ADMIN borr√≥ todas las alertas (${ids.length})`);
      modalAlert('Hecho', `Se han borrado ${ids.length} alertas`);
    } catch(err){ console.error('deleteAllAlertsFirestore', err); modalAlert('Error','No se pudo borrar todas las alertas (ver consola)'); }
  }

  /* ========== Administration (roles & users) ========== */
  function renderAdmin(container){
    const isAdminMode = STATE.adminMode;
    container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>Administraci√≥n</strong><div class="muted small">Gestiona roles, permisos y usuarios</div></div>
      <div><button class="btn btn-small" id="closeA">Cerrar</button></div>
    </div>
    <div style="margin-top:12px">
      <div id="adminNotice" style="margin-bottom:12px"></div>
    </div>
    <div style="margin-top:12px;display:flex;gap:12px">
      <div style="flex:1">
        <h4>Usuarios</h4>
        <div id="usersAdminList" class="list"></div>
      </div>
      <div style="width:360px">
        <h4>Crear usuario</h4>
        <input id="adm_newUser" placeholder="username"><input id="adm_newDisplay" placeholder="display"><input id="adm_newPass" placeholder="password">
        <select id="adm_newRole">${Object.keys(lsGet('roles',{})).map(r=>`<option value="${r}">${r}</option>`).join('')}</select>
        <div style="display:flex;gap:8px;margin-top:8px"><button id="adm_createUser" class="btn">Crear</button><button id="adm_refresh" class="btn-ghost">Refrescar</button></div>

        <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.03)">
        <h4>Roles</h4>
        <div style="display:flex;gap:8px"><input id="adm_newRoleName" placeholder="nuevo rol"><button id="adm_createRole" class="btn">Crear rol</button></div>
        <div id="rolesAdminList" style="margin-top:12px"></div>
      </div>
    </div>`;
    container.querySelector('#closeA').onclick = ()=> closeExpanded();

    const adminNotice = container.querySelector('#adminNotice');
    if(!STATE.currentUser || STATE.currentUser.role !== 'admin'){
      adminNotice.innerHTML = `<div class="item"><div style="flex:1"><b>Acceso denegado</b><div class="muted small">Necesitas ser admin para gestionar cuentas.</div></div></div>`;
      return;
    }
    // If admin but adminMode is off, show notice and an enable button; actions will be disabled
    if(!isAdminMode){
      adminNotice.innerHTML = `<div class="item"><div style="flex:1"><b>Admin Mode OFF</b><div class="muted small">Activa Admin Mode para realizar operaciones sensibles (crear/borrar/impersonar/editar permisos).</div></div>
        <div style="display:flex;flex-direction:column;gap:6px">
          <button id="enableAdminMode" class="btn">Activar Admin Mode</button>
          <button id="explainAdminMode" class="btn-ghost">¬øQu√© es esto?</button>
        </div>
      </div>`;
      adminNotice.querySelector('#enableAdminMode').onclick = ()=> { promptEnableAdminMode(); renderAdmin(container); };
      adminNotice.querySelector('#explainAdminMode').onclick = ()=> {
        modalAlert('Admin Mode','Admin Mode requiere reingresar la contrase√±a del admin y act√∫a como protecci√≥n adicional para operaciones destructivas. Act√≠valo cuando vayas a administrar usuarios, roles o logs.');
      };
    } else {
      adminNotice.innerHTML = `<div class="item"><div style="flex:1"><b>Admin Mode ON</b><div class="muted small">Puedes realizar acciones administrativas. Cuidado con lo que borras.</div></div>
        <div><button id="disableAdminMode" class="btn-danger-small">Desactivar</button></div></div>`;
      adminNotice.querySelector('#disableAdminMode').onclick = ()=> { if(confirm('Desactivar Admin Mode?')){ STATE.adminMode=false; updateAdminUI(); renderAdmin(container); } };
    }

    container.querySelector('#adm_createUser').onclick = adminCreateUser;
    container.querySelector('#adm_refresh').onclick = ()=>renderAdmin(container);
    container.querySelector('#adm_createRole').onclick = adminCreateRole;
    loadUsersAdmin();
    loadRolesAdmin();
  }

  function loadUsersAdmin(){
    const users = lsGet('users', []); const roles = lsGet('roles', {});
    const ul = document.getElementById('usersAdminList'); ul.innerHTML = '';
    if(!users.length){ ul.innerHTML = '<div class="muted small">No hay usuarios</div>'; return; }
    users.forEach((u,i)=>{
      const canPerform = STATE.adminMode && STATE.currentUser && STATE.currentUser.role==='admin';
      const roleOptions = Object.keys(lsGet('roles',{})).map(r=>`<option value="${r}" ${u.role===r?'selected':''}>${r}</option>`).join('');
      const div = document.createElement('div'); div.className='item';
      div.innerHTML = `<div><b>${u.display} (${u.username})</b><div class="muted small">Rol: <span class="role-chip">${u.role}</span> ‚Ä¢ Badge: ${u.badge||'‚Äî'}</div></div>
        <div style="text-align:right">
          <select data-uid="${u.id}" class="adm_role_sel" ${canPerform? '': 'disabled'}>${roleOptions}</select>
          <div style="margin-top:6px"><button class="btn-ghost btn-small" data-uid="${u.id}" data-act="del" ${canPerform? '': 'disabled'}>Borrar</button> <button class="btn btn-small" data-uid="${u.id}" data-act="imp" ${canPerform? '': 'disabled'}>Impersonar</button></div>
        </div>`;
      ul.appendChild(div);
    });
    ul.querySelectorAll('.adm_role_sel').forEach(sel=>{
      sel.onchange = (e)=>{ const uid = e.target.dataset.uid; if(!STATE.adminMode){ modalAlert('Admin Mode requerido','Activa Admin Mode para cambiar roles'); renderUsersDisabledWarning(); return; } changeUserRole(uid, e.target.value); };
    });
    ul.querySelectorAll('button[data-act="del"]').forEach(b=> b.onclick = ()=>{
      const uid = b.dataset.uid;
      if(!STATE.adminMode){ modalAlert('Admin Mode requerido','Activa Admin Mode para borrar usuarios'); return; }
      if(!confirm('Borrar usuario?')) return;
      let arr = lsGet('users', []); const u = arr.find(x=>x.id===uid);
      if(u && u.username==='admin'){ modalAlert('Error','No puedes borrar admin seed'); return; }
      let on = lsGet('onDuty', {}); if(on[uid]){ delete on[uid]; lsSet('onDuty', on); }
      arr = arr.filter(x=>x.id!==uid); lsSet('users', arr); pushLogLocal(`Usuario borrado: ${uid}`); loadUsersAdmin();
    });
    ul.querySelectorAll('button[data-act="imp"]').forEach(b=> b.onclick = ()=>{
      const uid = b.dataset.uid; const u = lsGet('users',[]).find(x=>x.id===uid); if(!u) return;
      if(!STATE.adminMode){ modalAlert('Admin Mode requerido','Activa Admin Mode para impersonar'); return; }
      STATE.currentUser = {...u, impersonated: true}; lsSet('currentUser', STATE.currentUser); updateHeader(); pushLogLocal(`Impersonaci√≥n: ${u.username}`); modalAlert('Impersonar', 'Ahora eres: '+u.display); renderCards(); renderAdmin(expandedRoot.querySelector('.expanded') || document.createElement('div'));
    });
  }
  function renderUsersDisabledWarning(){
    // small visual hint to activate Admin Mode
    const usersBox = document.getElementById('usersAdminList');
    if(!usersBox) return;
    const note = document.createElement('div'); note.className='muted small'; note.textContent = 'Acciones administrativas requieren Admin Mode.';
    usersBox.prepend(note);
    setTimeout(()=>{ if(note && note.parentNode) note.remove(); }, 3500);
  }

  function changeUserRole(uid,newRole){
    if(!STATE.adminMode){ modalAlert('Admin Mode requerido','Activa Admin Mode para cambiar roles'); return; }
    let users = lsGet('users',[]); const u = users.find(x=>x.id===uid); if(!u) return; u.role=newRole; lsSet('users', users); pushLogLocal(`Rol cambiado: ${u.username} -> ${newRole}`); loadUsersAdmin();
  }
  function adminCreateUser(){
    if(!STATE.currentUser || STATE.currentUser.role !== 'admin' || !STATE.adminMode){ modalAlert('Error','Solo admin (Admin Mode) puede crear usuarios aqu√≠'); return; }
    const username=document.getElementById('adm_newUser').value.trim(); const display=document.getElementById('adm_newDisplay').value.trim()||username; const pass=document.getElementById('adm_newPass').value.trim()||'1234'; const role=document.getElementById('adm_newRole').value;
    if(!username){ modalAlert('Error','username requerido'); return; }
    let users=lsGet('users',[]); if(users.find(u=>u.username===username)){ modalAlert('Error','Usuario ya existe'); return; }
    const u={id:uid('u'), username, display, badge:'', password:pass, role}; users.unshift(u); lsSet('users',users); pushLogLocal(`Usuario admin creado: ${username}`); loadUsersAdmin();
  }
  function adminCreateRole(){
    if(!STATE.currentUser || STATE.currentUser.role !== 'admin' || !STATE.adminMode){ modalAlert('Error','Solo admin (Admin Mode) puede crear roles'); return; }
    const name=document.getElementById('adm_newRoleName').value.trim(); if(!name){ modalAlert('Error','Nombre rol requerido'); return; }
    const roles = lsGet('roles', {}); if(roles[name]){ modalAlert('Error','Rol ya existe'); return; }
    roles[name] = { name, color:'#999999', permissions:[] }; lsSet('roles', roles); pushLogLocal(`Rol creado: ${name}`); loadRolesAdmin(); loadUsersAdmin();
    document.getElementById('adm_newRoleName').value='';
  }
  function loadRolesAdmin(){
    const roles = lsGet('roles', {}); const out = document.getElementById('rolesAdminList'); out.innerHTML = '';
    for(const key in roles){
      const r = roles[key];
      const div = document.createElement('div'); div.className='item';
      div.innerHTML = `<div style="flex:1"><b>${key}</b><div class="muted small">Permisos:</div><div id="permBox_${key}" style="margin-top:6px"></div></div>
        <div style="text-align:right"><button class="btn-ghost" data-role="${key}" data-act="edit">Editar</button> <button class="btn" data-role="${key}" data-act="del">Borrar</button></div>`;
      out.appendChild(div);
      const box = div.querySelector(`#permBox_${key}`);
      box.innerHTML = (r.permissions && r.permissions.length) ? r.permissions.map(p=>`<span class="role-chip">${p}</span>`).join('') : '<span class="muted tiny">Sin permisos</span>';
    }
    out.querySelectorAll('button[data-act="edit"]').forEach(b=> b.onclick = ()=>{
      const roleKey = b.dataset.role; openRoleEditor(roleKey);
    });
    out.querySelectorAll('button[data-act="del"]').forEach(b=> b.onclick = ()=>{
      const roleKey = b.dataset.role;
      if(!STATE.adminMode){ modalAlert('Admin Mode requerido','Activa Admin Mode para borrar roles'); return; }
      if(!confirm('Borrar rol? (Los usuarios con este rol quedar√°n con rol vac√≠o)')) return;
      let roles = lsGet('roles', {}); delete roles[roleKey]; lsSet('roles', roles);
      let users = lsGet('users', []); users.forEach(u=>{ if(u.role===roleKey) u.role=''; }); lsSet('users', users);
      pushLogLocal(`Rol borrado: ${roleKey}`); loadRolesAdmin(); loadUsersAdmin();
    });
  }

  function openRoleEditor(roleKey){
    const roles = lsGet('roles', {});
    const role = roles[roleKey];
    if(!role){ modalAlert('Error','Rol no existe'); return; }
    // Require Admin Mode to edit
    if(!STATE.adminMode){ modalAlert('Admin Mode requerido','Activa Admin Mode para editar permisos de rol'); return; }
    const modal = document.createElement('div'); modal.className='overlay';
    modal.innerHTML = `<div class="modal">
      <h3>Editar rol: ${roleKey}</h3>
      <div class="muted small">Marca los permisos que tendr√° este rol</div>
      <div style="margin-top:12px" id="permChecks"></div>
      <div style="display:flex;gap:8px;margin-top:12px"><button id="saveRole" class="btn">Guardar</button><button id="cancelRole" class="btn-ghost">Cancelar</button></div>
    </div>`;
    document.body.appendChild(modal);
    const permsList = ['create_reports','delete_reports','create_pda','create_call','assign_call','create_bolo','manage_wanted','create_fine','export','all'];
    const box = modal.querySelector('#permChecks');
    box.innerHTML = permsList.map(p=>`<div style="margin-bottom:6px"><label><input type="checkbox" data-perm="${p}" ${role.permissions.includes(p)?'checked':''}/> ${p}</label></div>`).join('');
    modal.querySelector('#cancelRole').onclick = ()=> modal.remove();
    modal.querySelector('#saveRole').onclick = ()=>{
      const checked = Array.from(box.querySelectorAll('input[type=checkbox]:checked')).map(c=>c.dataset.perm);
      role.permissions = checked;
      roles[roleKey] = role; lsSet('roles', roles);
      pushLogLocal(`Rol editado: ${roleKey}`);
      modal.remove(); loadRolesAdmin(); loadUsersAdmin();
    };
  }

  /* ========== Logs (local) ========== */
  function pushLogLocal(msg){ const logs = lsGet('logs', []); logs.unshift({id:uid('log'), t:now(), msg}); lsSet('logs', logs);
    if(window.__FIRESTORE_READY && window.__FIRESTORE_DB && window.__FIRESTORE_helpers){
      try{ window.__FIRESTORE_helpers.addDoc(window.__FIRESTORE_helpers.collection(window.__FIRESTORE_DB, 'logs'), { t: Date.now(), msg }); } catch(e){ /* ignore */ }
    }
    renderLogsMini();
  }

  function renderLogs(container){
    if(!container){ expandedRoot.innerHTML=''; const panel=document.createElement('div'); panel.className='expanded'; renderLogs(panel); expandedRoot.appendChild(panel); return; }
    const logs = lsGet('logs', []);
    container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>Auditor√≠a</strong><div class="muted small">√öltimas acciones</div></div><div><button class="btn btn-small" id="closeL">Cerrar</button></div></div>
      <div style="margin-top:12px" id="logsList" class="list"></div>`;
    container.querySelector('#closeL').onclick = ()=> closeExpanded();
    const list = container.querySelector('#logsList'); list.innerHTML = '';
    if(!logs.length){ list.innerHTML = '<div class="muted small">Sin logs</div>'; return; }
    logs.slice(0,200).forEach(l=>{ const it = document.createElement('div'); it.className='item'; it.innerHTML = `<div><div style="font-weight:700">${l.msg}</div><div class="muted small">${new Date(l.t).toLocaleString()}</div></div>`; list.appendChild(it); });
  }

  /* ========== Login / Register ========== */
  document.getElementById('btnLogin').onclick = ()=> openLoginModal();
  btnExport.onclick = exportAllLocal;

  function openLoginModal(){ loginModal.style.display='flex'; document.getElementById('loginUser').focus(); }
  function closeLoginModal(){ loginModal.style.display='none'; document.getElementById('loginPass').value=''; document.getElementById('loginUser').value=''; document.getElementById('loginError').style.display='none'; }

  document.getElementById('guestBtn').onclick = ()=> { STATE.currentUser = null; lsSet('currentUser', null); updateHeader(); closeLoginModal(); pushLogLocal('Entr√≥ como invitado'); };
  document.getElementById('showReg').onclick = ()=> { const b = document.getElementById('registerBlock'); b.style.display = b.style.display==='none' ? 'block' : 'none'; };
  document.getElementById('regCancel').onclick = ()=> { document.getElementById('registerBlock').style.display='none'; };

  document.getElementById('loginBtn').onclick = ()=>{
    const u = document.getElementById('loginUser').value.trim(); const p = document.getElementById('loginPass').value.trim();
    const users = lsGet('users', []);
    const found = users.find(x=>x.username === u && x.password === p);
    if(found){ STATE.currentUser = {...found}; lsSet('currentUser', STATE.currentUser); updateHeader(); closeLoginModal(); pushLogLocal(`Sesi√≥n iniciada: ${found.username}`); modalAlert('OK','Sesi√≥n iniciada: ' + found.display); renderCards(); }
    else { document.getElementById('loginError').style.display='block'; document.getElementById('loginError').textContent='Usuario o contrase√±a incorrectos'; }
  };

  document.getElementById('regCreate').onclick = ()=>{
    const username = document.getElementById('regUser').value.trim();
    const display = document.getElementById('regName').value.trim() || username;
    const pass = document.getElementById('regPass').value.trim() || '1234';
    const role = document.getElementById('regRole').value;
    if(!username){ document.getElementById('regMsg').textContent='Usuario requerido'; return; }
    const users = lsGet('users', []);
    if(users.find(u=>u.username===username)){ document.getElementById('regMsg').textContent='Usuario ya existe'; return; }
    const u = {id:uid('u'), username, display, badge:'', password:pass, role};
    users.unshift(u); lsSet('users', users); document.getElementById('regMsg').textContent='Cuenta creada. Inicia sesi√≥n.'; pushLogLocal(`Cuenta creada: ${username}`);
    document.getElementById('regUser').value=''; document.getElementById('regName').value=''; document.getElementById('regPass').value='';
  };

  /* ========== Radio system (improved UI) ========== */
  async function renderRadio(container){
    container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>Radios</strong><div class="muted small">Chat por canales (live). Usa el canal correcto seg√∫n tu unidad.</div></div>
      <div><button class="btn btn-small" id="closeRadio">Cerrar</button></div>
    </div>
    <div style="margin-top:12px" class="radio-wrap">
      <div class="radio-left">
        <div class="radio-topbar">
          <select id="radioChannelSelect" class="radio-search"></select>
          <div class="radio-actions">
            <input id="radioNewChannel" placeholder="Nuevo canal (ej: police-1)" style="min-width:180px;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:rgba(0,0,0,0.12)"/>
            <button id="radioCreateChannel" class="btn-ghost">Crear</button>
            <button id="radioRefresh" class="btn-ghost">Refrescar</button>
          </div>
        </div>

        <div id="radioMessages" class="radio-messages" style="margin-top:12px"></div>

        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="radioMsgInput" placeholder="Escribe mensaje..." />
          <button id="radioSend" class="btn">Enviar</button>
        </div>
      </div>

      <div class="radio-right">
        <h4 style="margin:0 0 8px 0">Canales</h4>
        <input id="radioSearchChannels" class="radio-search" placeholder="Buscar canales..." style="margin-bottom:8px"/>
        <div id="radioChannelsList" class="list radio-channel-list"></div>
      </div>
    </div>`;

    container.querySelector('#closeRadio').onclick = ()=> closeExpanded();
    container.querySelector('#radioCreateChannel').onclick = createRadioChannel;
    container.querySelector('#radioSend').onclick = sendRadioMessage;
    container.querySelector('#radioRefresh').onclick = loadRadioChannels;
    document.getElementById('radioChannelSelect').onchange = (e)=> switchRadioChannel(e.target.value);
    document.getElementById('radioMsgInput').addEventListener('keydown', (e)=> { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendRadioMessage(); } });

    document.getElementById('radioSearchChannels').addEventListener('input', (e)=>{
      const q = (e.target.value||'').toLowerCase();
      const items = document.querySelectorAll('#radioChannelsList .item');
      items.forEach(it=>{
        const name = it.dataset.name || '';
        it.style.display = name.toLowerCase().includes(q) ? '' : 'none';
      });
    });

    await loadRadioChannels();
    const defaultChannels = lsGet('radio_channels', []);
    if(defaultChannels && defaultChannels.length) switchRadioChannel(defaultChannels[0].id);
  }

  async function loadRadioChannels(){
    const channelsListEl = document.getElementById('radioChannelsList');
    const selectEl = document.getElementById('radioChannelSelect');
    if(!channelsListEl || !selectEl) return;
    channelsListEl.innerHTML = '<div class="muted small">Cargando...</div>';
    selectEl.innerHTML = '';

    if(window.__FIRESTORE_READY && window.__FIRESTORE_DB && window.__FIRESTORE_helpers){
      try{
        if(STATE.radio.unsubChannels) STATE.radio.unsubChannels();
        STATE.radio.unsubChannels = window.__FIRESTORE_helpers.onSnapshot(window.__FIRESTORE_helpers.collection(window.__FIRESTORE_DB,'radio_channels'), snap => {
          const arr = [];
          snap.forEach(s => { const d = s.data(); arr.push({id: s.id, name: d.name}); });
          if(!arr.length) arr.push(...(lsGet('radio_channels',[])||[]));
          lsSet('radio_channels', arr);
          renderChannelListUI(arr);
        }, err => {
          console.error('onSnapshot radio_channels', err);
          renderChannelListUI(lsGet('radio_channels',[]));
        });
      } catch(e){ console.error('loadRadioChannels', e); renderChannelListUI(lsGet('radio_channels',[])); }
    } else {
      renderChannelListUI(lsGet('radio_channels',[]));
    }
  }

  function renderChannelListUI(arr){
    const channelsListEl = document.getElementById('radioChannelsList');
    const selectEl = document.getElementById('radioChannelSelect');
    if(!channelsListEl || !selectEl) return;
    channelsListEl.innerHTML = '';
    selectEl.innerHTML = '';
    (arr || []).forEach(ch=>{
      const id = ch.id || ch._id || ch.name;
      const name = ch.name || id;
      const it = document.createElement('div'); it.className='item'; it.dataset.name = name;
      it.innerHTML = `<div style="flex:1"><b>${name}</b><div class="muted small">${id}</div></div><div style="display:flex;gap:8px"><button class="btn-ghost" data-id="${id}">Unirse</button></div>`;
      it.querySelector('button').onclick = ()=> switchRadioChannel(id);
      channelsListEl.appendChild(it);

      const opt = document.createElement('option'); opt.value = id; opt.textContent = name; selectEl.appendChild(opt);
    });
  }

  async function createRadioChannel(){
    const val = document.getElementById('radioNewChannel').value.trim();
    if(!val) return;
    const newChan = { name: val, created_at: Date.now() };
    if(window.__FIRESTORE_READY && window.__FIRESTORE_DB && window.__FIRESTORE_helpers){
      try{
        await window.__FIRESTORE_helpers.addDoc(window.__FIRESTORE_helpers.collection(window.__FIRESTORE_DB,'radio_channels'), newChan);
        pushLogLocal(`Canal radio creado: ${val}`);
        document.getElementById('radioNewChannel').value = '';
        await loadRadioChannels();
      } catch(e){ console.error('createRadioChannel', e); modalAlert('Error','No se pudo crear canal en Firestore (ver consola)'); }
    } else {
      const arr = lsGet('radio_channels', []) || [];
      arr.unshift({id: val, name: val});
      lsSet('radio_channels', arr);
      pushLogLocal(`Canal radio (local) creado: ${val}`);
      renderChannelListUI(arr);
    }
  }

  async function switchRadioChannel(channelId){
    if(!channelId) return;
    STATE.radio.selectedChannel = channelId;
    if(STATE.radio.unsubMessages) try{ STATE.radio.unsubMessages(); }catch(e){}
    const sel = document.getElementById('radioChannelSelect'); if(sel) sel.value = channelId;
    const list = document.getElementById('radioMessages'); if(!list) return;
    list.innerHTML = '<div class="muted small">Cargando mensajes...</div>';

    if(window.__FIRESTORE_READY && window.__FIRESTORE_DB && window.__FIRESTORE_helpers){
      try{
        const db = window.__FIRESTORE_DB;
        const helpers = window.__FIRESTORE_helpers;
        if(STATE.radio.unsubMessages) STATE.radio.unsubMessages();
        STATE.radio.unsubMessages = helpers.onSnapshot(helpers.collection(db,'radio_messages'), snap => {
          const msgs = [];
          snap.forEach(s => { const d = s.data(); d._id = s.id; if((d.channel||'') === channelId) msgs.push(d); });
          msgs.sort((a,b)=> (a.created_at||0) - (b.created_at||0));
          renderRadioMessages(msgs);
        }, err => {
          console.error('radio messages snapshot', err);
          const arr = (lsGet('radio_messages',[])||[]).filter(m=>m.channel===channelId);
          renderRadioMessages(arr);
        });
        const qSnap = await helpers.getDocs(helpers.query(helpers.collection(db,'radio_messages'), helpers.orderBy('created_at','asc')));
        const msgs = [];
        qSnap.forEach(s => { const d = s.data(); d._id = s.id; if((d.channel||'')===channelId) msgs.push(d); });
        if(msgs.length) renderRadioMessages(msgs);
      } catch(e){
        console.error('switchRadioChannel', e);
        const arr = (lsGet('radio_messages',[])||[]).filter(m=>m.channel===channelId);
        renderRadioMessages(arr);
      }
    } else {
      const arr = (lsGet('radio_messages',[])||[]).filter(m=>m.channel===channelId);
      renderRadioMessages(arr);
    }
  }

  function renderRadioMessages(msgs){
    const list = document.getElementById('radioMessages');
    if(!list) return;
    list.innerHTML = '';
    if(!msgs || !msgs.length) { list.innerHTML = '<div class="muted small">Sin mensajes</div>'; return; }
    msgs.forEach(m=>{
      const me = (STATE.currentUser && (STATE.currentUser.display === m.author || STATE.currentUser.username === m.author_username));
      const it = document.createElement('div'); it.className = 'radio-msg ' + (me ? 'me' : '');
      const avatar = document.createElement('div'); avatar.className='radio-avatar'; avatar.textContent = (m.author||'G').split(' ').map(s=>s[0]||'').slice(0,2).join('').toUpperCase();
      const bubble = document.createElement('div'); bubble.className = 'radio-bubble ' + (me ? 'me' : '');
      bubble.innerHTML = `<div style="font-weight:700">${m.author||'Anon'}</div><div>${escapeHtml(m.text||'')}</div><div class="radio-meta">${new Date(m.created_at||0).toLocaleString()}</div>`;
      it.appendChild(avatar); it.appendChild(bubble);
      list.appendChild(it);
    });
    list.scrollTop = list.scrollHeight;
  }

  async function sendRadioMessage(){
    const input = document.getElementById('radioMsgInput');
    const txt = input.value.trim();
    if(!txt) return;
    const channelId = STATE.radio.selectedChannel;
    if(!channelId){ modalAlert('Error','Selecciona un canal'); return; }
    const payload = {
      channel: channelId,
      text: txt,
      author: STATE.currentUser ? STATE.currentUser.display : 'Invitado',
      author_username: STATE.currentUser ? STATE.currentUser.username : 'guest',
      created_at: Date.now()
    };
    if(window.__FIRESTORE_READY && window.__FIRESTORE_DB && window.__FIRESTORE_helpers){
      try{
        await window.__FIRESTORE_helpers.addDoc(window.__FIRESTORE_helpers.collection(window.__FIRESTORE_DB,'radio_messages'), payload);
        pushLogLocal(`Mensaje radio (${channelId}) por ${payload.author_username}`);
        input.value = '';
      } catch(e){
        console.error('sendRadioMessage', e);
        modalAlert('Error','No se pudo enviar mensaje (ver consola)');
      }
    } else {
      const arr = lsGet('radio_messages',[]) || [];
      arr.push({...payload, id:uid('rm')});
      lsSet('radio_messages', arr);
      pushLogLocal(`Mensaje radio (local) ${channelId}`);
      input.value = '';
      switchRadioChannel(channelId);
    }
  }

  function escapeHtml(str){ return (str+'').replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])); }

  /* ---------- Header & misc ---------- */
  function pushLogLocalSimple(msg){ pushLogLocal(msg); }
  function renderLogsMini(){ const onMap = lsGet('onDuty', {}); const users = lsGet('users', []); const active = Object.keys(onMap).filter(k=>onMap[k]).map(id=> users.find(u=>u.id===id)?.display || id); dutyStatus.textContent = `En servicio: ${active.length}`; userDisplay.textContent = STATE.currentUser ? `${STATE.currentUser.display} (${STATE.currentUser.role})` : 'No conectado'; updateAdminUI(); }

  function exportAllLocal(){
    const data = {
      users: lsGet('users',[]), roles: lsGet('roles',{}), templates: lsGet('templates',{}),
      reports: lsGet('reports',[]), wanted: lsGet('wanted',[]), calls: lsGet('calls',[]),
      pda: lsGet('pda',[]), fines: lsGet('fines',[]), logs: lsGet('logs',[]),
      radio_channels: lsGet('radio_channels',[]), radio_messages: lsGet('radio_messages',[])
    };
    const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'pda_export_'+Date.now()+'.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    pushLogLocal('Datos exportados (local)');
  }

  function updateHeader(){ STATE.currentUser = lsGet('currentUser', STATE.currentUser); const u = STATE.currentUser; userDisplay.textContent = u? `${u.display} (${u.role})` : 'No conectado'; const on = lsGet('onDuty', {}); const users = lsGet('users', []); const active = Object.keys(on).filter(k=>on[k]).map(id=> users.find(u=>u.id===id)?.display || id); dutyStatus.textContent = `En servicio: ${active.length}`; updateAdminUI(); }

  function closeExpanded(){ STATE.expanded=null; expandedRoot.innerHTML=''; window.scrollTo({top:0,behavior:'smooth'}); }

  /* Init */
  seedIfNeeded();
  renderCards();
  STATE.currentUser = lsGet('currentUser', STATE.currentUser);
  updateHeader();

  </script>
</body>
</html>
