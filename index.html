<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Daynight RP ‚Äî PDA / CAD</title>
<link rel="icon" href="https://cdn.discordapp.com/attachments/1421898595271180360/1425878366116122654/LOGO_WIZARD_FONDO.png.png?ex=68e93036&is=68e7deb6&hm=db97d6e7afebb0948f23e7e7e19d8159c52456483ba28a970face42f7f4455ec&" />
<style>
  :root{
    --bg:#071018; --muted:#98a8b0; --accent:#844ffc; --accent2:#6ee7b7;
    --card:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    --glass: rgba(255,255,255,0.03);
    --radius:12px; --danger:#ff6b6b;
    --green:#22c55e; --yellow:#eab308; --red:#ef4444;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:
      radial-gradient(900px 350px at 10% 10%, rgba(132,79,252,0.04), transparent),
      linear-gradient(180deg, #03121a 0%, var(--bg) 70%);
    color:#e7eef6;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;-webkit-font-smoothing:antialiased;
  }
  .wrap{max-width:1180px;margin:18px auto;padding:18px;display:grid;grid-template-rows:auto 1fr;gap:14px}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent2),var(--accent));display:flex;align-items:center;justify-content:center;font-weight:900;color:#041018;overflow:hidden}
  .logo img{width:56px;height:56px;object-fit:cover;border-radius:10px}
  h1{margin:0;font-size:18px}
  .subtitle{color:var(--muted);font-size:13px}
  .top-right{display:flex;gap:8px;align-items:center}
  .pill{background:rgba(255,255,255,0.03);padding:8px 10px;border-radius:999px;font-weight:700}
  .small{font-size:12px;color:var(--muted)}
  .btn{background:var(--accent);color:#fff;padding:8px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:800}
  .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);padding:7px 10px;border-radius:10px;cursor:pointer}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
  .card{background:var(--card);border-radius:var(--radius);padding:18px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 10px 30px rgba(2,6,10,0.6);cursor:pointer;overflow:hidden;position:relative;transition:transform .22s,box-shadow .22s;display:flex;flex-direction:column;gap:12px;min-height:120px}
  .card:hover{transform:translateY(-6px);box-shadow:0 18px 40px rgba(2,6,10,0.75)}
  .title{font-weight:900;font-size:16px}
  .desc{color:var(--muted);font-size:13px}
  .icon{width:56px;height:56px;border-radius:10px;background:rgba(255,255,255,0.02);display:flex;align-items:center;justify-content:center;font-size:22px}
  .expanded{margin-top:14px;border-radius:var(--radius);padding:18px;background:var(--card);border:1px solid rgba(255,255,255,0.03)}
  .form-row{display:flex;gap:8px}
  input,textarea,select,button{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
  textarea{min-height:110px;resize:vertical}
  .list{display:flex;flex-direction:column;gap:10px}
  .item{padding:10px;border-radius:10px;background:var(--glass);display:flex;justify-content:space-between;align-items:center}
  .muted{color:var(--muted)}
  .danger{background:linear-gradient(90deg,#ff8a80,#ff5252);color:#041018;padding:6px 8px;border-radius:8px}
  .ok{background:linear-gradient(90deg,#48c774,#34d399);color:#041018;padding:6px 8px;border-radius:8px}
  .tiny{font-size:12px}
  footer{margin-top:18px;text-align:center;color:var(--muted);font-size:13px}
  .overlay{position:fixed;inset:0;background:linear-gradient(rgba(2,6,10,0.6),rgba(2,6,10,0.8));display:flex;align-items:center;justify-content:center;z-index:9999}
  .modal{width:720px;max-width:94%;background:linear-gradient(180deg,#071729,#061421);padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
  .link-like{color:var(--accent);cursor:pointer;text-decoration:underline}
  .role-chip{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.02);margin-right:6px;margin-bottom:6px}
  .toast-wrap{position:fixed;right:18px;bottom:18px;display:flex;flex-direction:column;gap:8px;z-index:99999}
  .toast{background:rgba(0,0,0,0.7);padding:12px;border-radius:8px;color:#fff;min-width:220px;box-shadow:0 6px 18px rgba(0,0,0,0.6)}
  .alerta-pill{padding:8px 12px;border-radius:999px;font-weight:800;color:#041018}
  .alerta-verde{background:var(--green)}
  .alerta-amarilla{background:var(--yellow)}
  .alerta-roja{background:var(--red)}
  .muted-2{color:#9fb3c2}
  @media (max-width:980px){ .grid{grid-template-columns:repeat(2,1fr)} }
  @media (max-width:640px){ .grid{grid-template-columns:1fr} .form-row{flex-direction:column} .modal{width:94%} }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo"><img id="logoImg" src="https://cdn.discordapp.com/attachments/1421898595271180360/1425878366116122654/LOGO_WIZARD_FONDO.png.png?ex=68e93036&is=68e7deb6&hm=db97d6e7afebb0948f23e7e7e19d8159c52456483ba28a970face42f7f4455ec&" alt="Logo"></div>
        <div>
          <h1 id="titleApp">Daynight RP ‚Äî PDA / CAD</h1>
          <div class="subtitle">Simulador online ‚Äî Firestore sincronizado</div>
        </div>
      </div>

      <div class="top-right">
        <div class="pill small" id="userDisplay">No conectado</div>
        <div class="pill small" id="dutyStatus">En servicio: 0</div>
        <button id="btnExport" class="btn">Exportar</button>
        <button id="btnLogin" class="btn-ghost">Iniciar</button>
      </div>
    </header>

    <!-- Grid of main action cards -->
    <section class="grid fade-in" id="cardsRoot">
      <!-- Cards created by JS -->
    </section>

    <!-- Expanded panel -->
    <div id="expandedRoot"></div>

    <footer>Hecho para Daynight RP ‚Ä¢ Datos sincronizados en Firestore</footer>
  </div>

  <!-- Login modal (simple, uses users collection in Firestore) -->
  <div id="loginModal" class="overlay" style="display:none">
    <div class="modal">
      <h3>Entrar</h3>
      <div class="muted small">Introduce tu usuario y contrase√±a. Las cuentas las crea un admin desde Administraci√≥n.</div>
      <div style="margin-top:12px">
        <label class="muted small">Usuario</label>
        <input id="loginUser" placeholder="usuario (ej: perety04)"/>
        <label class="muted small" style="margin-top:8px">Contrase√±a</label>
        <input id="loginPass" type="password" placeholder="contrase√±a"/>
        <div style="display:flex;gap:8px;margin-top:12px">
          <button id="loginBtn" class="btn">Entrar</button>
          <button id="guestBtn" class="btn-ghost">Invitado</button>
          <div style="margin-left:auto" class="small muted">¬øSin cuenta? Pide a un admin que la cree.</div>
        </div>
        <div id="loginError" class="muted small" style="margin-top:8px;color:#ff9b9b;display:none"></div>
      </div>
    </div>
  </div>

  <!-- Toasts -->
  <div class="toast-wrap" id="toasts"></div>

  <!-- Audio notifications -->
  <audio id="soundAlert" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" preload="auto"></audio>
  <audio id="soundPing" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>

<script type="module">
/* ============================
   Daynight RP ‚Äî index.html
   Firestore realtime PDA/CAD
   ============================ */

/* -------- FIREBASE (Firestore) --------
   Usa tu configuraci√≥n; ya me diste estos datos.
   Si quieres sustituir por variables, cambia aqu√≠.
*/
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import {
  getFirestore, collection, doc, onSnapshot, addDoc, setDoc, updateDoc,
  deleteDoc, getDocs, query, where, orderBy, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCskczYgGtlPPBEIZiE5PuY7s_cfE_3Chg",
  authDomain: "wizard-rp.firebaseapp.com",
  projectId: "wizard-rp",
  storageBucket: "wizard-rp.firebasestorage.app",
  messagingSenderId: "479456044047",
  appId: "1:479456044047:web:65c52e2430bcb6ca586f7a",
  measurementId: "G-KX5Y56CG0R"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* --------- Helper UI / Storage --------- */
const CARDS = [
  {id:'pda', title:'PDA / Fichas', desc:'Buscar y crear fichas PDA', icon:'üöì'},
  {id:'calls', title:'Dispatch / Llamadas', desc:'Crear/Asignar llamadas', icon:'üìû'},
  {id:'reports', title:'Informes', desc:'Crear / Editar informes', icon:'üìë'},
  {id:'wanted', title:'BOLO / Wanted', desc:'Fichas buscados', icon:'üö®'},
  {id:'fines', title:'Multas', desc:'Generar sanciones', icon:'üí∏'},
  {id:'alerts', title:'Alertas ciudad', desc:'Ver/Crear alertas (verde/amarilla/roja)', icon:'‚ö†Ô∏è'},
  {id:'service', title:'Servicio', desc:'Entrar / Salir de servicio', icon:'üü¢'},
  {id:'admin', title:'Administraci√≥n', desc:'Usuarios y roles (admin)', icon:'‚öôÔ∏è'},
  {id:'logs', title:'Auditor√≠a', desc:'Historial de acciones', icon:'üìú'}
];

const cardsRoot = document.getElementById('cardsRoot');
const expandedRoot = document.getElementById('expandedRoot');
const userDisplay = document.getElementById('userDisplay');
const dutyStatus = document.getElementById('dutyStatus');
const loginModal = document.getElementById('loginModal');
const btnLogin = document.getElementById('btnLogin');
const btnExport = document.getElementById('btnExport');
const toastsWrap = document.getElementById('toasts');
const soundAlert = document.getElementById('soundAlert');
const soundPing = document.getElementById('soundPing');

let STATE = { currentUser: null, expanded: null };

/* ---------- Permission helpers ----------
   Roles are stored in collection 'roles' with docId = roleKey
   Example role doc:
   { name: 'Officer', permissions: ['create_reports','create_pda','assign_call'] }
*/
async function hasPerm(perm){
  if(!STATE.currentUser) return perm === 'create_call' ? true : false; // guests can create calls
  // load role doc
  const roleKey = STATE.currentUser.role;
  if(!roleKey) return false;
  // read role doc once (could cache)
  try{
    // onSnapshot listener used in admin; here simple get via onSnapshot not required.
    // We'll assume roles collection present and small.
    // For simplicity, get current snapshot (getDocs then find)
    const snaps = await getDocs(collection(db,'roles'));
    const roleDoc = snaps.docs.find(d=>d.id===roleKey);
    if(!roleDoc) return false;
    const r = roleDoc.data();
    if(Array.isArray(r.permissions) && r.permissions.includes('all')) return true;
    return Array.isArray(r.permissions) && r.permissions.includes(perm);
  }catch(e){
    console.error('hasPerm error', e);
    return false;
  }
}

/* ---------- Toasts / Notifications ---------- */
function pushToast(text, ttl=4500){
  const t = document.createElement('div'); t.className='toast'; t.textContent = text;
  toastsWrap.appendChild(t);
  setTimeout(()=> t.style.opacity='0.0', ttl-800);
  setTimeout(()=> t.remove(), ttl);
}
function notifyBrowser(title, body){
  if("Notification" in window && Notification.permission === "granted"){
    new Notification(title, { body });
  } else if("Notification" in window && Notification.permission !== "denied"){
    Notification.requestPermission().then(p=>{
      if(p==='granted') new Notification(title, { body });
    });
  }
}

/* ---------- Realtime counters / onDuty ---------- */
function updateDutyCountUI(){
  // read onDuty collection (boolean docs)
  onSnapshot(collection(db,'onDuty'), snap=>{
    const active = snap.docs.filter(d=>d.data().on === true);
    dutyStatus.textContent = `En servicio: ${active.length}`;
    // update header user status if current user present
    if(STATE.currentUser){
      const myDoc = active.find(d=>d.id === STATE.currentUser.id);
      const userPill = document.getElementById('userDisplay');
      userDisplay.textContent = `${STATE.currentUser.display} (${STATE.currentUser.role})`;
    } else {
      userDisplay.textContent = 'No conectado';
    }
  }, err=>console.error(err));
}

/* ---------- Render cards ---------- */
function renderCards(){
  cardsRoot.innerHTML = '';
  CARDS.forEach(c=>{
    const el = document.createElement('div'); el.className='card';
    el.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
      <div><div class="title">${c.title}</div><div class="desc">${c.desc}</div></div>
      <div class="icon">${c.icon}</div>
    </div>
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div class="muted tiny">Acci√≥n r√°pida</div>
      <div><button class="btn-ghost" data-open="${c.id}">Abrir</button></div>
    </div>`;
    el.querySelector('button[data-open]').onclick = (e)=>{ e.stopPropagation(); openCard(c.id); };
    el.onclick = ()=> openCard(c.id);
    cardsRoot.appendChild(el);
  });
}

/* ---------- Open card ---------- */
function openCard(id){
  STATE.expanded = id; expandedRoot.innerHTML = '';
  const panel = document.createElement('div'); panel.className='expanded';
  if(id==='pda') renderPDA(panel);
  else if(id==='calls') renderCalls(panel);
  else if(id==='reports') renderReports(panel);
  else if(id==='wanted') renderWanted(panel);
  else if(id==='fines') renderFines(panel);
  else if(id==='alerts') renderAlerts(panel);
  else if(id==='service') renderService(panel);
  else if(id==='admin') renderAdmin(panel);
  else if(id==='logs') renderLogs(panel);
  expandedRoot.appendChild(panel);
  window.scrollTo({ top: panel.offsetTop-20, behavior:'smooth' });
}

/* ==========================
   PDA module (simple)
   ========================== */
async function renderPDA(container){
  container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
    <div><strong>PDA / Fichas</strong><div class="muted small">Crear, buscar y ver fichas</div></div>
    <div><button class="btn btn-small" id="closeP">Cerrar</button></div>
  </div>
  <div style="margin-top:12px;display:flex;gap:8px">
    <input id="pdaQ" placeholder="Buscar texto en fichas..." />
    <button id="pdaSearch" class="btn-ghost">Buscar</button>
  </div>
  <div style="margin-top:12px" class="form-row">
    <textarea id="pdaTpl" placeholder="Plantilla / Texto de ficha"></textarea>
    <div style="width:200px"><button id="createPDA" class="btn">Crear ficha</button><button id="clearPDA" class="btn-ghost" style="margin-top:8px">Limpiar</button></div>
  </div>
  <div style="margin-top:12px"><strong>Fichas</strong><div id="pdaList" class="list" style="margin-top:8px"></div></div>`;
  container.querySelector('#closeP').onclick = ()=> closeExpanded();
  container.querySelector('#createPDA').onclick = createPDA;
  container.querySelector('#pdaSearch').onclick = ()=> searchPDA(document.getElementById('pdaQ').value);
  loadPDARealtime();
}
async function createPDA(){
  if(!(await hasPerm('create_pda'))){ pushToast('No tienes permiso para crear PDA'); return; }
  const txt = document.getElementById('pdaTpl').value.trim();
  if(!txt){ pushToast('Rellena la ficha'); return; }
  await addDoc(collection(db,'pda'), {
    text: txt, author: STATE.currentUser ? STATE.currentUser.username : 'Invitado', created_at: serverTimestamp()
  });
  pushToast('Ficha PDA creada');
  document.getElementById('pdaTpl').value='';
}
function loadPDARealtime(){
  const list = document.getElementById('pdaList');
  onSnapshot(collection(db,'pda'), snap=>{
    list.innerHTML = '';
    if(snap.empty){ list.innerHTML = '<div class="muted small">Sin fichas</div>'; return; }
    snap.docs.slice(0).forEach(d=>{
      const p = d.data();
      const it = document.createElement('div'); it.className='item';
      it.innerHTML = `<div style="flex:1"><div style="font-weight:700">${p.title||'Ficha'}</div><div class="muted small">${(p.text||'').slice(0,140)}</div></div>
        <div style="text-align:right"><div class="muted tiny">${p.author||''}</div><div style="margin-top:6px"><button class="btn-ghost" data-id="${d.id}">Ver</button> <button class="btn-ghost" data-del="${d.id}">Borrar</button></div></div>`;
      it.querySelector('button[data-id]').onclick = ()=> alert(`Ficha:\n\n${p.text}\n\nAutor: ${p.author}`);
      it.querySelector('button[data-del]').onclick = async ()=>{
        if(!STATE.currentUser){ pushToast('Inicia sesi√≥n'); return; }
        // only admin or author can delete (unless role has delete_pda)
        const allowed = (STATE.currentUser.role==='admin') || (p.author===STATE.currentUser.username);
        const canDel = allowed || (await hasPerm('delete_pda'));
        if(!canDel){ pushToast('No tienes permiso para borrar esta ficha'); return; }
        if(confirm('Borrar ficha?')){ await deleteDoc(doc(db,'pda', d.id)); pushToast('Ficha borrada'); }
      };
      list.appendChild(it);
    });
  });
}
function searchPDA(q){
  q = (q||'').toLowerCase().trim();
  // client-side filter: read once
  getDocs(collection(db,'pda')).then(snap=>{
    const out = snap.docs.filter(d=> ((d.data().text||'').toLowerCase().includes(q) || (d.data().title||'').toLowerCase().includes(q)));
    const list = document.getElementById('pdaList'); list.innerHTML = '';
    if(!out.length) { list.innerHTML = '<div class="muted small">No hay resultados</div>'; return; }
    out.forEach(d=>{
      const p = d.data();
      const it = document.createElement('div'); it.className='item';
      it.innerHTML = `<div style="flex:1"><div style="font-weight:700">${p.title||'Ficha'}</div><div class="muted small">${(p.text||'').slice(0,140)}</div></div>
        <div style="text-align:right"><div class="muted tiny">${p.author||''}</div><div style="margin-top:6px"><button class="btn-ghost">Ver</button></div></div>`;
      it.querySelector('button').onclick = ()=> alert(`Ficha:\n\n${p.text}\n\nAutor: ${p.author}`);
      list.appendChild(it);
    });
  });
}

/* ==========================
   Calls (Dispatch)
   ========================== */
function renderCalls(container){
  container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
    <div><strong>Dispatch / Llamadas</strong><div class="muted small">Crear llamadas y asignar unidades</div></div>
    <div><button class="btn btn-small" id="closeC">Cerrar</button></div>
  </div>
  <div style="margin-top:12px;display:flex;gap:8px">
    <input id="callFrom" placeholder="Remitente (opcional)"/>
    <input id="callMsg" placeholder="Mensaje"/>
    <button id="callCreate" class="btn">Crear llamada</button>
  </div>
  <div style="margin-top:12px"><strong>Llamadas</strong><div id="callsList" class="list" style="margin-top:8px"></div></div>`;
  container.querySelector('#closeC').onclick = ()=> closeExpanded();
  container.querySelector('#callCreate').onclick = createCall;
  loadCallsRealtime();
}
async function createCall(){
  const caller = document.getElementById('callFrom').value.trim() || 'Anonimo';
  const message = document.getElementById('callMsg').value.trim();
  if(!message){ pushToast('Introduce un mensaje'); return; }
  const data = { caller, message, status:'pending', assigned_to:null, created_at: serverTimestamp() };
  const res = await addDoc(collection(db,'calls'), data);
  pushToast('Llamada creada');
  soundPing.play();
  notifyBrowser('Nueva llamada', `${caller}: ${message}`);
  document.getElementById('callMsg').value=''; document.getElementById('callFrom').value='';
}
function loadCallsRealtime(){
  const list = document.getElementById('callsList');
  onSnapshot(collection(db,'calls'), snap=>{
    list.innerHTML = '';
    if(snap.empty) { list.innerHTML = '<div class="muted small">No hay llamadas</div>'; return; }
    snap.docs.forEach(d=>{
      const c = d.data();
      const it = document.createElement('div'); it.className='item';
      it.innerHTML = `<div style="flex:1"><div style="font-weight:700">${c.caller}</div><div class="muted small">${c.message}</div></div>
        <div style="text-align:right"><div class="muted tiny">${c.status||''}</div><div style="margin-top:6px"><button class="btn-ghost" data-assign="${d.id}">Asignar a m√≠</button> <button class="btn-ghost" data-del="${d.id}">Borrar</button></div></div>`;
      it.querySelector('button[data-assign]').onclick = async ()=>{
        if(!STATE.currentUser){ pushToast('Inicia sesi√≥n para asignar'); return; }
        // only assign to onDuty users: we'll allow assign to self if in onDuty
        const onDutySnap = await getDocs(collection(db,'onDuty'));
        const onUser = onDutySnap.docs.find(x=>x.id === STATE.currentUser.id && x.data().on === true);
        if(!onUser){ pushToast('Debes estar en servicio para asignar'); return; }
        await updateDoc(doc(db,'calls', d.id), { status:'assigned', assigned_to: STATE.currentUser.id, assigned_at: serverTimestamp() });
        pushToast('Llamada asignada a ti');
        soundPing.play();
        notifyBrowser('Llamada asignada', `Te han asignado una llamada: ${c.message}`);
      };
      it.querySelector('button[data-del]').onclick = async ()=>{
        // only admin or assigned user can delete
        if(!STATE.currentUser){ pushToast('Inicia sesi√≥n'); return; }
        const allowed = (STATE.currentUser.role === 'admin') || (d.data && d.data.assigned_to === STATE.currentUser.id);
        const canDelete = allowed || await hasPerm('delete_calls');
        if(!canDelete){ pushToast('No tienes permiso para borrar esta llamada'); return; }
        if(confirm('Borrar llamada?')){ await deleteDoc(doc(db,'calls', d.id)); pushToast('Llamada borrada'); }
      };
      list.appendChild(it);
    });
  });
}

/* ==========================
   Reports / Informes
   ========================== */
function renderReports(container){
  container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
    <div><strong>Informes</strong><div class="muted small">Crear y consultar informes</div></div>
    <div><button class="btn btn-small" id="closeR">Cerrar</button></div>
  </div>
  <div style="margin-top:12px">
    <div class="muted small">Plantilla (editable)</div>
    <textarea id="tplReport" style="min-height:80px"></textarea>
  </div>
  <div style="margin-top:8px" class="form-row">
    <input id="repTitle" placeholder="T√≠tulo" />
    <input id="repAuthor" placeholder="Autor (auto)" />
  </div>
  <div style="margin-top:8px"><textarea id="repDesc" placeholder="Descripci√≥n..."></textarea></div>
  <div style="margin-top:8px;display:flex;gap:8px"><button id="saveRep" class="btn">Guardar informe</button><button id="clearRep" class="btn-ghost">Limpiar</button></div>
  <div style="margin-top:12px"><strong>√öltimos informes</strong><div id="reportsList" class="list" style="margin-top:8px"></div></div>`;
  container.querySelector('#closeR').onclick = ()=> closeExpanded();
  // load template and set author
  (async ()=>{
    const tSnap = await getDocs(collection(db,'templates'));
    // templates stored as documents; fallback local
    document.getElementById('tplReport').value = "T√≠tulo: {{title}}\\nHechos: {{facts}}\\nAcciones: {{actions}}\\nOficial: {{author}}";
    document.getElementById('repAuthor').value = STATE.currentUser ? STATE.currentUser.display : 'Invitado';
  })();
  document.getElementById('saveRep').onclick = saveReport;
  document.getElementById('clearRep').onclick = ()=>{ document.getElementById('repTitle').value=''; document.getElementById('repDesc').value=''; };
  loadReportsRealtime();
}
async function saveReport(){
  if(!(await hasPerm('create_reports'))){ pushToast('No tienes permiso para crear informes'); return; }
  const title = document.getElementById('repTitle').value.trim();
  const desc = document.getElementById('repDesc').value.trim();
  if(!title || !desc){ pushToast('T√≠tulo y descripci√≥n obligatorios'); return; }
  await addDoc(collection(db,'reports'), { title, description: desc, author: STATE.currentUser ? STATE.currentUser.display : 'Invitado', created_at: serverTimestamp() });
  pushToast('Informe creado');
  soundPing.play();
}
function loadReportsRealtime(){
  const list = document.getElementById('reportsList');
  onSnapshot(collection(db,'reports'), snap=>{
    list.innerHTML = '';
    if(snap.empty){ list.innerHTML = '<div class="muted small">No hay informes</div>'; return; }
    snap.docs.forEach(d=>{
      const r = d.data();
      const it = document.createElement('div'); it.className='item';
      it.innerHTML = `<div style="flex:1"><div style="font-weight:700">${r.title}</div><div class="muted small">${(r.description||'').slice(0,160)}</div></div>
        <div style="text-align:right"><div class="muted tiny">${r.author||''}</div><div style="margin-top:6px"><button class="btn-ghost" data-view="${d.id}">Ver</button></div></div>`;
      it.querySelector('button[data-view]').onclick = ()=> alert(`Informe:\n\n${r.title}\n\n${r.description}\n\nAutor: ${r.author}`);
      list.appendChild(it);
    });
  });
}

/* ==========================
   Wanted / BOLO
   ========================== */
function renderWanted(container){
  container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
    <div><strong>BOLO / Wanted</strong><div class="muted small">Crear y gestionar fichas buscadas</div></div>
    <div><button class="btn btn-small" id="closeW">Cerrar</button></div>
  </div>
  <div style="margin-top:12px" class="form-row"><input id="wName" placeholder="Nombre / Alias"/><input id="wBounty" placeholder="Recompensa"/></div>
  <div style="margin-top:8px"><textarea id="wDesc" placeholder="Descripci√≥n"></textarea></div>
  <div style="margin-top:8px;display:flex;gap:8px"><button id="saveW" class="btn">Crear ficha</button></div>
  <div style="margin-top:12px"><strong>Fichas</strong><div id="wantedList" class="list" style="margin-top:8px"></div></div>`;
  container.querySelector('#closeW').onclick = ()=> closeExpanded();
  container.querySelector('#saveW').onclick = createWanted;
  loadWantedRealtime();
}
async function createWanted(){
  if(!(await hasPerm('create_bolo'))){ pushToast('No tienes permiso para crear BOLO'); return; }
  const name=document.getElementById('wName').value.trim();
  const desc=document.getElementById('wDesc').value.trim();
  const bounty=parseInt(document.getElementById('wBounty').value||'0',10);
  if(!name){ pushToast('Nombre requerido'); return; }
  await addDoc(collection(db,'wanted'), { name, description: desc, bounty: isNaN(bounty)?0:bounty, author: STATE.currentUser?STATE.currentUser.display:'Invitado', created_at: serverTimestamp() });
  pushToast('BOLO creado');
  soundPing.play();
  notifyBrowser('Nuevo BOLO', `${name} ‚Ä¢ ${bounty}‚Ç¨`);
  document.getElementById('wName').value=''; document.getElementById('wDesc').value=''; document.getElementById('wBounty').value='';
}
function loadWantedRealtime(){
  const list = document.getElementById('wantedList');
  onSnapshot(collection(db,'wanted'), snap=>{
    list.innerHTML = '';
    if(snap.empty){ list.innerHTML = '<div class="muted small">No hay fichas</div>'; return; }
    snap.docs.forEach(d=>{
      const w = d.data();
      const it = document.createElement('div'); it.className='item';
      it.innerHTML = `<div style="flex:1"><div style="font-weight:700">${w.name}</div><div class="muted small">${w.description}</div></div><div class="pill">${w.bounty||0}‚Ç¨</div>`;
      const btns = document.createElement('div'); btns.style.marginLeft='12px';
      const view = document.createElement('button'); view.className='btn-ghost'; view.textContent='Ver'; view.onclick = ()=> alert(`Wanted: ${w.name}\n\n${w.description}\nRecompensa: ${w.bounty}‚Ç¨`);
      btns.appendChild(view);
      const del = document.createElement('button'); del.className='btn'; del.style.marginLeft='6px'; del.textContent='Borrar';
      del.onclick = async ()=>{
        // permission check
        const can = (STATE.currentUser && STATE.currentUser.role==='admin') || await hasPerm('manage_wanted');
        if(!can){ pushToast('No tienes permiso para borrar BOLO'); return; }
        if(confirm('Borrar ficha?')){ await deleteDoc(doc(db,'wanted', d.id)); pushToast('BOLO borrado'); }
      };
      btns.appendChild(del);
      it.appendChild(btns);
      list.appendChild(it);
    });
  });
}

/* ==========================
   Multas / Fines
   ========================== */
function renderFines(container){
  container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
    <div><strong>Multas</strong><div class="muted small">Genera sanciones y multas</div></div>
    <div><button class="btn btn-small" id="closeF">Cerrar</button></div>
  </div>
  <div style="margin-top:12px" class="form-row"><input id="fineOff" placeholder="Infractor (nombre/veh√≠culo)"/><input id="fineAmt" placeholder="Importe"/></div>
  <div style="margin-top:8px"><textarea id="fineReason" placeholder="Motivo..."></textarea></div>
  <div style="margin-top:8px;display:flex;gap:8px"><button id="saveFine" class="btn">Emitir multa</button></div>
  <div style="margin-top:12px"><strong>Multas</strong><div id="finesList" class="list" style="margin-top:8px"></div></div>`;
  container.querySelector('#closeF').onclick = ()=> closeExpanded();
  container.querySelector('#saveFine').onclick = saveFine; loadFinesRealtime();
}
async function saveFine(){
  if(!(await hasPerm('create_fine'))){ pushToast('No tienes permiso para multar'); return; }
  const off=document.getElementById('fineOff').value.trim(); const amt=parseInt(document.getElementById('fineAmt').value||'0',10); const reason=document.getElementById('fineReason').value.trim();
  if(!off || !amt){ pushToast('Infractor e importe requeridos'); return; }
  await addDoc(collection(db,'fines'), { offender:off, amount:amt, reason, author: STATE.currentUser?STATE.currentUser.display:'Invitado', created_at: serverTimestamp() });
  pushToast('Multa creada');
  soundPing.play();
  notifyBrowser('Multa creada', `${off} ‚Ä¢ ${amt}‚Ç¨`);
  document.getElementById('fineOff').value=''; document.getElementById('fineAmt').value=''; document.getElementById('fineReason').value='';
}
function loadFinesRealtime(){
  const list = document.getElementById('finesList');
  onSnapshot(collection(db,'fines'), snap=>{
    list.innerHTML = '';
    if(snap.empty){ list.innerHTML = '<div class="muted small">No hay multas</div>'; return; }
    snap.docs.forEach(d=>{
      const f = d.data();
      const it = document.createElement('div'); it.className='item';
      it.innerHTML = `<div style="flex:1"><div style="font-weight:700">${f.offender} ‚Ä¢ ${f.amount}‚Ç¨</div><div class="muted small">${f.reason}</div></div><div class="muted tiny">${f.author||''}</div>`;
      const del = document.createElement('button'); del.className='btn'; del.textContent='Borrar'; del.onclick = async ()=>{
        const can = (STATE.currentUser && STATE.currentUser.role==='admin') || (f.author===STATE.currentUser?.display) || await hasPerm('delete_reports');
        if(!can){ pushToast('No tienes permiso para borrar esta multa'); return; }
        if(confirm('Borrar multa?')){ await deleteDoc(doc(db,'fines', d.id)); pushToast('Multa borrada'); }
      };
      it.appendChild(del);
      list.appendChild(it);
    });
  });
}

/* ==========================
   Alertas (ya implementado antes) ‚Äî centralizado
   ========================== */
function renderAlerts(container){
  container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
    <div><strong>Alertas ciudad</strong><div class="muted small">Crear alertas y notificarlas en tiempo real</div></div>
    <div><button class="btn btn-small" id="closeA">Cerrar</button></div>
  </div>
  <div style="margin-top:12px;display:flex;gap:8px">
    <select id="alertColor"><option value="verde">Verde</option><option value="amarilla">Amarilla</option><option value="roja">Roja</option></select>
    <input id="alertTitle" placeholder="T√≠tulo"/>
    <button id="createAlert" class="btn">Crear alerta</button>
  </div>
  <div style="margin-top:12px"><div id="alertsList" class="list"></div></div>`;
  container.querySelector('#closeA').onclick = ()=> closeExpanded();
  container.querySelector('#createAlert').onclick = createAlert;
  loadAlertsRealtime();
}
async function createAlert(){
  const color = document.getElementById('alertColor').value;
  const title = document.getElementById('alertTitle').value.trim();
  if(!title){ pushToast('T√≠tulo requerido'); return; }
  await addDoc(collection(db,'alertas'), { color, titulo: title, descripcion: '', timestamp: serverTimestamp(), author: STATE.currentUser?STATE.currentUser.display:'Sistema' });
  pushToast('Alerta creada');
  soundAlert.play();
  notifyBrowser(`Alerta ${color}`, title);
  document.getElementById('alertTitle').value = '';
}
function loadAlertsRealtime(){
  const list = document.getElementById('alertsList');
  onSnapshot(collection(db,'alertas'), snap=>{
    list.innerHTML = '';
    if(snap.empty){ list.innerHTML = '<div class="muted small">No hay alertas</div>'; return; }
    snap.docs.forEach(d=>{
      const a = d.data();
      const it = document.createElement('div'); it.className='item';
      const pillClass = a.color === 'roja' ? 'alerta-roja' : (a.color === 'amarilla' ? 'alerta-amarilla' : 'alerta-verde');
      it.innerHTML = `<div style="flex:1"><div style="font-weight:700">${a.titulo}</div><div class="muted small">${a.descripcion||''}</div></div>
        <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end"><div class="alerta-pill ${pillClass}">${a.color.toUpperCase()}</div><div><button class="btn-ghost" data-del="${d.id}">Borrar</button></div></div>`;
      it.querySelector('button[data-del]').onclick = async ()=>{
        const can = (STATE.currentUser && STATE.currentUser.role==='admin') || await hasPerm('manage_alerts');
        if(!can){ pushToast('No tienes permiso para borrar alertas'); return; }
        if(confirm('Borrar alerta?')){ await deleteDoc(doc(db,'alertas', d.id)); pushToast('Alerta borrada'); }
      };
      list.appendChild(it);
    });
  });
}

/* ==========================
   Servicio (onDuty)
   ========================== */
function renderService(container){
  container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
    <div><strong>Servicio</strong><div class="muted small">Ponte en servicio o sal</div></div>
    <div><button class="btn btn-small" id="closeS">Cerrar</button></div>
  </div>
  <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
    <div class="muted small">Tu estado:</div><div id="serviceBox" class="pill">Desconocido</div>
    <div style="margin-left:auto"><button id="toggleDuty" class="btn">Cambiar estado</button></div>
  </div>
  <div style="margin-top:12px"><strong>Polic√≠as en servicio</strong><div id="dutyList" class="list" style="margin-top:8px"></div></div>`;
  container.querySelector('#closeS').onclick = ()=> closeExpanded();
  const box = container.querySelector('#serviceBox');
  const onRef = collection(db,'onDuty');
  // update UI
  onSnapshot(onRef, snap=>{
    const usersOn = snap.docs.filter(d=>d.data().on === true).map(d=> ({id:d.id, ...d.data()}) );
    box.textContent = STATE.currentUser && usersOn.find(u=>u.id === STATE.currentUser.id) ? 'En servicio' : 'Fuera de servicio';
    const list = document.getElementById('dutyList');
    list.innerHTML = usersOn.map(u => `<div class="item">${u.display || u.username || u.id}</div>`).join('') || '<div class="muted small">Nadie en servicio</div>';
    updateHeaderDutyCount(usersOn.length);
  }, err=>console.error(err));
  container.querySelector('#toggleDuty').onclick = async ()=>{
    if(!STATE.currentUser){ pushToast('Inicia sesi√≥n'); return; }
    const myDocRef = doc(db,'onDuty', STATE.currentUser.id);
    // toggle by reading current doc (simple)
    const snaps = await getDocs(collection(db,'onDuty'));
    const found = snaps.docs.find(d=>d.id===STATE.currentUser.id);
    const newState = !(found && found.data().on === true);
    await setDoc(myDocRef, { on: newState, username: STATE.currentUser.username, display: STATE.currentUser.display, since: serverTimestamp() });
    pushToast(newState ? 'Has entrado en servicio' : 'Has salido de servicio');
    soundPing.play();
    notifyBrowser('Servicio', `${STATE.currentUser.display} ${newState? 'entr√≥' : 'sali√≥'} en servicio`);
  };
}
function updateHeaderDutyCount(n){
  dutyStatus.textContent = `En servicio: ${n}`;
}

/* ==========================
   Admin panel (roles & users)
   ========================== */
function renderAdmin(container){
  container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
    <div><strong>Administraci√≥n</strong><div class="muted small">Gestiona roles, permisos y usuarios (admin)</div></div>
    <div><button class="btn btn-small" id="closeA">Cerrar</button></div>
  </div>
  <div style="margin-top:12px;display:flex;gap:12px">
    <div style="flex:1">
      <h4>Usuarios</h4>
      <div id="usersAdminList" class="list"></div>
    </div>
    <div style="width:360px">
      <h4>Crear usuario (solo admin)</h4>
      <input id="adm_newUser" placeholder="username"><input id="adm_newDisplay" placeholder="display"><input id="adm_newPass" placeholder="password">
      <select id="adm_newRole"><option value="officer">officer</option><option value="sergeant">sergeant</option><option value="dispatcher">dispatcher</option><option value="admin">admin</option></select>
      <div style="display:flex;gap:8px;margin-top:8px"><button id="adm_createUser" class="btn">Crear</button><button id="adm_refresh" class="btn-ghost">Refrescar</button></div>
      <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.03)">
      <h4>Roles</h4>
      <div style="display:flex;gap:8px"><input id="adm_newRoleName" placeholder="nuevo rol"><button id="adm_createRole" class="btn">Crear rol</button></div>
      <div id="rolesAdminList" style="margin-top:12px"></div>
    </div>
  </div>`;
  container.querySelector('#closeA').onclick = ()=> closeExpanded();
  container.querySelector('#adm_createUser').onclick = adminCreateUser;
  container.querySelector('#adm_refresh').onclick = ()=> renderAdmin(container);
  container.querySelector('#adm_createRole').onclick = adminCreateRole;
  loadUsersAdmin();
  loadRolesAdmin();
}
async function loadUsersAdmin(){
  const ul = document.getElementById('usersAdminList'); ul.innerHTML = 'Cargando...';
  const snaps = await getDocs(collection(db,'users'));
  ul.innerHTML = '';
  snaps.docs.forEach(d=>{
    const u = d.data();
    const div = document.createElement('div'); div.className='item';
    div.innerHTML = `<div><b>${u.display || u.username} (${u.username})</b><div class="muted small">Rol: <span class="role-chip">${u.role||''}</span></div></div>
      <div style="text-align:right">
        <select data-uid="${d.id}" class="adm_role_sel">${['','officer','sergeant','dispatcher','admin'].map(r=>`<option value="${r}" ${u.role===r?'selected':''}>${r||'(ninguno)'}</option>`).join('')}</select>
        <div style="margin-top:6px"><button class="btn-ghost btn-small" data-uid="${d.id}" data-act="del">Borrar</button> <button class="btn btn-small" data-uid="${d.id}" data-act="imp">Impersonar</button></div>
      </div>`;
    ul.appendChild(div);
  });
  // attach events
  ul.querySelectorAll('.adm_role_sel').forEach(sel=>{
    sel.onchange = async (e)=>{ const uid=e.target.dataset.uid; const newRole=e.target.value; await updateDoc(doc(db,'users',uid), { role: newRole }); pushToast('Rol actualizado'); };
  });
  ul.querySelectorAll('button[data-act="del"]').forEach(b=> b.onclick = async ()=>{
    const uid = b.dataset.uid;
    if(!STATE.currentUser || STATE.currentUser.role !== 'admin'){ pushToast('Solo admin puede borrar usuarios'); return; }
    if(confirm('Borrar usuario?')){ await deleteDoc(doc(db,'users', uid)); pushToast('Usuario borrado'); }
  });
  ul.querySelectorAll('button[data-act="imp"]').forEach(b=> b.onclick = async ()=>{
    const uid = b.dataset.uid; const userDoc = await getDocs(collection(db,'users'));
    const target = userDoc.docs.find(x=>x.id===uid);
    if(!target){ pushToast('Usuario no encontrado'); return; }
    // Impersonate WITHOUT losing admin privileges: we'll store original admin in STATE._becomeAdmin
    const u = target.data();
    // store original
    STATE._original = STATE.currentUser;
    STATE.currentUser = { id: uid, username: u.username, display: u.display, role: u.role };
    pushToast(`Suplantando a ${u.display}`);
    updateHeader();
  });
}
async function adminCreateUser(){
  if(!STATE.currentUser || STATE.currentUser.role !== 'admin'){ pushToast('Solo admin puede crear usuarios aqu√≠'); return; }
  const username=document.getElementById('adm_newUser').value.trim(); const display=document.getElementById('adm_newDisplay').value.trim()||username; const pass=document.getElementById('adm_newPass').value.trim()||'1234'; const role=document.getElementById('adm_newRole').value;
  if(!username){ pushToast('username requerido'); return; }
  // create doc id as username (or uid auto)
  await addDoc(collection(db,'users'), { username, display, password: pass, role, badge:'' });
  pushToast('Usuario creado');
  document.getElementById('adm_newUser').value=''; document.getElementById('adm_newDisplay').value=''; document.getElementById('adm_newPass').value='';
  loadUsersAdmin();
}
async function adminCreateRole(){
  if(!STATE.currentUser || STATE.currentUser.role !== 'admin'){ pushToast('Solo admin puede crear roles'); return; }
  const name=document.getElementById('adm_newRoleName').value.trim(); if(!name){ pushToast('Nombre rol requerido'); return; }
  // create role doc with empty permissions
  await setDoc(doc(db,'roles',name), { name, permissions: [] });
  pushToast('Rol creado');
  document.getElementById('adm_newRoleName').value='';
  loadRolesAdmin();
}
async function loadRolesAdmin(){
  const out = document.getElementById('rolesAdminList'); out.innerHTML='Cargando...';
  const snaps = await getDocs(collection(db,'roles'));
  out.innerHTML = '';
  snaps.docs.forEach(d=>{
    const r = d.data();
    const div = document.createElement('div'); div.className='item';
    div.innerHTML = `<div style="flex:1"><b>${d.id}</b><div class="muted small">Permisos:</div><div id="permBox_${d.id}" style="margin-top:6px"></div></div>
      <div style="text-align:right"><button class="btn-ghost" data-role="${d.id}" data-act="edit">Editar</button> <button class="btn" data-role="${d.id}" data-act="del">Borrar</button></div>`;
    out.appendChild(div);
    // fill perms (simple display)
    const box = div.querySelector(`#permBox_${d.id}`);
    box.innerHTML = (r.permissions && r.permissions.length) ? r.permissions.map(p=>`<span class="role-chip">${p}</span>`).join('') : '<span class="muted tiny">Sin permisos</span>';
  });
  // attach events
  out.querySelectorAll('button[data-act="edit"]').forEach(b=> b.onclick = async ()=>{
    const roleKey = b.dataset.role; openRoleEditor(roleKey);
  });
  out.querySelectorAll('button[data-act="del"]').forEach(b=> b.onclick = async ()=>{
    const roleKey = b.dataset.role; if(!confirm('Borrar rol?')) return;
    await deleteDoc(doc(db,'roles', roleKey));
    pushToast('Rol borrado');
    loadRolesAdmin(); loadUsersAdmin();
  });
}
function openRoleEditor(roleKey){
  // fetch role
  getDocs(collection(db,'roles')).then(snaps=>{
    const roleDoc = snaps.docs.find(d=>d.id===roleKey);
    const role = roleDoc ? roleDoc.data() : { permissions: [] };
    // modal
    const modal = document.createElement('div'); modal.className='overlay';
    modal.innerHTML = `<div class="modal"><h3>Editar rol: ${roleKey}</h3><div class="muted small">Marca los permisos</div><div style="margin-top:12px" id="permChecks"></div><div style="display:flex;gap:8px;margin-top:12px"><button id="saveRole" class="btn">Guardar</button><button id="cancelRole" class="btn-ghost">Cancelar</button></div></div>`;
    document.body.appendChild(modal);
    const permsList = ['create_reports','delete_reports','create_pda','create_call','assign_call','create_bolo','manage_wanted','create_fine','export','manage_alerts','delete_pda','all'];
    const box = modal.querySelector('#permChecks');
    box.innerHTML = permsList.map(p=>`<div style="margin-bottom:6px"><label><input type="checkbox" data-perm="${p}" ${role.permissions && role.permissions.includes(p)?'checked':''}/> ${p}</label></div>`).join('');
    modal.querySelector('#cancelRole').onclick = ()=> modal.remove();
    modal.querySelector('#saveRole').onclick = async ()=>{
      const checked = Array.from(box.querySelectorAll('input[type=checkbox]:checked')).map(c=>c.dataset.perm);
      await setDoc(doc(db,'roles', roleKey), { name: roleKey, permissions: checked });
      pushToast('Rol actualizado');
      modal.remove(); loadRolesAdmin(); loadUsersAdmin();
    };
  });
}

/* ==========================
   Logs / Auditor√≠a
   ========================== */
function renderLogs(container){
  container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>Auditor√≠a</strong><div class="muted small">√öltimas acciones</div></div><div><button class="btn btn-small" id="closeL">Cerrar</button></div></div>
    <div style="margin-top:12px" id="logsList" class="list"></div>`;
  container.querySelector('#closeL').onclick = ()=> closeExpanded();
  loadLogsRealtime();
}
function pushLog(msg){
  // writes a log doc
  addDoc(collection(db,'logs'), { msg, t: serverTimestamp(), author: STATE.currentUser ? STATE.currentUser.display : 'Sistema' }).catch(e=>console.error(e));
}
function loadLogsRealtime(){
  const list = document.getElementById('logsList');
  onSnapshot(collection(db,'logs'), snap=>{
    list.innerHTML = '';
    if(snap.empty){ list.innerHTML = '<div class="muted small">Sin logs</div>'; return; }
    snap.docs.sort((a,b)=> (b.data().t?.seconds||0) - (a.data().t?.seconds||0)).slice(0,200).forEach(d=>{
      const l = d.data();
      const it = document.createElement('div'); it.className='item';
      it.innerHTML = `<div><div style="font-weight:700">${l.msg}</div><div class="muted small">${l.author||''} ‚Ä¢ ${l.t ? new Date(l.t.seconds*1000).toLocaleString() : ''}</div></div>`;
      list.appendChild(it);
    });
  });
}

/* ==========================
   Export (JSON download)
   ========================== */
async function exportAll(){
  if(!(await hasPerm('export'))){ pushToast('No tienes permiso para exportar'); return; }
  // collect main collections
  const names = ['users','roles','templates','reports','wanted','calls','pda','fines','alertas','logs','onDuty'];
  const data = {};
  for(const n of names){
    const snaps = await getDocs(collection(db,n));
    data[n] = snaps.docs.map(d=> ({ id:d.id, ...d.data() }) );
  }
  const blob = new Blob([JSON.stringify(data,null,2)], { type:'application/json' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `daynight_export_${Date.now()}.json`; a.click(); a.remove();
  pushToast('Exportado JSON');
}

/* ==========================
   Login logic ‚Äî uses users collection (simple)
   ========================== */
btnLogin.onclick = ()=> { if(STATE.currentUser) { if(confirm('Cerrar sesi√≥n?')) { STATE.currentUser=null; localStorage.removeItem('dn_currentUser'); updateHeader(); pushToast('Sesi√≥n cerrada'); } } else openLoginModal(); };
btnExport.onclick = () => exportAll();

function openLoginModal(){ loginModal.style.display='flex'; document.getElementById('loginUser').focus(); }
function closeLoginModal(){ loginModal.style.display='none'; document.getElementById('loginPass').value=''; document.getElementById('loginUser').value=''; document.getElementById('loginError').style.display='none'; }

document.getElementById('guestBtn').onclick = ()=> { STATE.currentUser = null; localStorage.removeItem('dn_currentUser'); updateHeader(); closeLoginModal(); pushToast('Sesi√≥n invitado'); };
document.getElementById('loginBtn').onclick = async ()=>{
  const u = document.getElementById('loginUser').value.trim(); const p = document.getElementById('loginPass').value.trim();
  if(!u || !p){ document.getElementById('loginError').style.display='block'; document.getElementById('loginError').textContent='Usuario y contrase√±a requeridos'; return; }
  // query users where username == u and password == p
  const snaps = await getDocs(collection(db,'users'));
  const foundDoc = snaps.docs.find(d=> d.data().username === u && d.data().password === p);
  if(foundDoc){
    const found = { id: foundDoc.id, ...foundDoc.data() };
    STATE.currentUser = found;
    localStorage.setItem('dn_currentUser', JSON.stringify(found));
    updateHeader();
    closeLoginModal();
    pushToast('Sesi√≥n iniciada: ' + found.display);
    pushLog(`Sesi√≥n iniciada: ${found.username}`);
  } else {
    document.getElementById('loginError').style.display='block'; document.getElementById('loginError').textContent='Usuario o contrase√±a incorrectos';
  }
};

/* ---------- Header & init ---------- */
function updateHeader(){
  STATE.currentUser = STATE.currentUser || JSON.parse(localStorage.getItem('dn_currentUser') || 'null');
  userDisplay.textContent = STATE.currentUser ? `${STATE.currentUser.display} (${STATE.currentUser.role})` : 'No conectado';
  // duty status updated by onDuty snapshot
  updateDutyCountUI();
}
function closeExpanded(){ STATE.expanded=null; expandedRoot.innerHTML=''; window.scrollTo({top:0,behavior:'smooth'}); }

/* ---------- Initial render ---------- */
renderCards();
updateHeader();
updateDutyCountUI();

/* ---------- Realtime listeners to show popup notifications for key events ---------- */
// Alerts (sound/desktop)
onSnapshot(collection(db,'alertas'), snap=>{
  // when change.type === 'added' show notification
  snap.docChanges().forEach(ch=>{
    if(ch.type === 'added'){
      const a = ch.doc.data();
      pushToast(`Alerta: ${a.titulo}`);
      soundAlert.play();
      notifyBrowser('Alerta', a.titulo || 'Nueva alerta');
      pushLog(`Alerta creada: ${a.titulo}`);
    } else if(ch.type === 'removed'){
      pushToast('Alerta eliminada');
      pushLog('Alerta eliminada');
    }
  });
});
// Wanted
onSnapshot(collection(db,'wanted'), snap=>{
  snap.docChanges().forEach(ch=>{
    if(ch.type === 'added'){ pushToast('Nuevo BOLO creado'); soundPing.play(); notifyBrowser('BOLO', ch.doc.data().name); pushLog(`BOLO creado: ${ch.doc.data().name}`); }
    if(ch.type === 'removed'){ pushToast('BOLO borrado'); pushLog('BOLO borrado'); }
  });
});
// Fines
onSnapshot(collection(db,'fines'), snap=>{
  snap.docChanges().forEach(ch=>{
    if(ch.type === 'added'){ pushToast('Multa creada'); soundPing.play(); notifyBrowser('Multa', `${ch.doc.data().offender} ‚Ä¢ ${ch.doc.data().amount}‚Ç¨`); pushLog('Multa creada'); }
    if(ch.type === 'removed'){ pushToast('Multa borrada'); pushLog('Multa borrada'); }
  });
});
// Calls assignment (notify assignee)
onSnapshot(collection(db,'calls'), snap=>{
  snap.docChanges().forEach(ch=>{
    if(ch.type === 'modified'){
      const data = ch.doc.data();
      if(data.assigned_to && data.assigned_at){
        // if assigned to current user, notify
        if(STATE.currentUser && data.assigned_to === STATE.currentUser.id){
          pushToast('Te han asignado una llamada');
          soundPing.play();
          notifyBrowser('Llamada asignada', data.message || 'Tienes una llamada asignada');
        }
      }
    }
  });
});

/* ---------- Ask Notification permission at start ---------- */
if("Notification" in window && Notification.permission !== "granted"){
  Notification.requestPermission();
}

/* ---------- expose openCard for direct calls (used in some event handlers) ---------- */
window.openCard = openCard;

/* ---------- end of module ---------- */

</script>
</body>
</html>