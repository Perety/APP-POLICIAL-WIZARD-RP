<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Daynight RP ‚Äî PDA Policial</title>
<style>
  :root{
    --bg:#071018; --muted:#98a8b0; --accent:#844ffc; --accent2:#6ee7b7;
    --card:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    --glass: rgba(255,255,255,0.03);
    --radius:12px;
    --danger:#ff6b6b;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:
      radial-gradient(900px 350px at 10% 10%, rgba(132,79,252,0.06), transparent),
      linear-gradient(180deg, #03121a 0%, var(--bg) 60%);
    color:#e7eef6; -webkit-font-smoothing:antialiased;
  }
  .wrap{max-width:1180px;margin:18px auto;padding:18px;display:grid;grid-template-rows:auto 1fr;gap:14px}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:72px;height:72px;border-radius:12px;background:url('https://cdn.discordapp.com/attachments/1421898595271180360/1422217488145453219/LOGO_WIZARD_FONDO.png.png') center/cover no-repeat;display:flex;align-items:center;justify-content:center;font-weight:900;color:#041018}
  h1{margin:0;font-size:18px}
  .subtitle{color:var(--muted);font-size:13px}
  .top-right{display:flex;gap:8px;align-items:center}
  .pill{background:rgba(255,255,255,0.03);padding:8px 10px;border-radius:999px;font-weight:700}
  .small{font-size:12px;color:var(--muted)}
  .btn{background:var(--accent);color:#fff;padding:8px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:800}
  .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);padding:7px 10px;border-radius:10px;cursor:pointer}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
  .card{background:var(--card);border-radius:var(--radius);padding:18px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 10px 30px rgba(2,6,10,0.6);cursor:pointer;overflow:hidden;position:relative;display:flex;flex-direction:column;gap:12px;min-height:120px;transition:transform .22s,box-shadow .22s}
  .card:hover{transform:translateY(-6px);box-shadow:0 18px 40px rgba(2,6,10,0.75)}
  .title{font-weight:900;font-size:16px}
  .desc{color:var(--muted);font-size:13px}
  .icon{width:56px;height:56px;border-radius:10px;background:rgba(255,255,255,0.02);display:flex;align-items:center;justify-content:center;font-size:22px}
  .expanded{margin-top:14px;border-radius:var(--radius);padding:18px;background:var(--card);border:1px solid rgba(255,255,255,0.03)}
  .form-row{display:flex;gap:8px}
  input,textarea,select,button{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
  textarea{min-height:110px;resize:vertical}
  .list{display:flex;flex-direction:column;gap:10px}
  .item{padding:10px;border-radius:10px;background:var(--glass);display:flex;justify-content:space-between;align-items:center}
  .muted{color:var(--muted)}
  .danger{background:linear-gradient(90deg,#ff8a80,#ff5252);color:#041018;padding:6px 8px;border-radius:8px}
  .ok{background:linear-gradient(90deg,#48c774,#34d399);color:#041018;padding:6px 8px;border-radius:8px}
  .tiny{font-size:12px}
  footer{margin-top:18px;text-align:center;color:var(--muted);font-size:13px}
  .overlay{position:fixed;inset:0;background:linear-gradient(rgba(2,6,10,0.6),rgba(2,6,10,0.8));display:flex;align-items:center;justify-content:center;z-index:9999}
  .modal{width:720px;max-width:94%;background:linear-gradient(180deg,#071729,#061421);padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
  .link-like{color:var(--accent);cursor:pointer;text-decoration:underline}
  .grid-2{display:grid;grid-template-columns:1fr 360px;gap:12px}
  .role-chip{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.02);margin-right:6px;margin-bottom:6px}
  .toast{position:fixed;right:18px;bottom:18px;background:rgba(0,0,0,0.7);padding:12px 16px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);z-index:99999;color:#fff}
  @media (max-width:980px){ .grid{grid-template-columns:repeat(2,1fr)} .grid-2{grid-template-columns:1fr} }
  @media (max-width:640px){ .grid{grid-template-columns:1fr} .form-row{flex-direction:column} .modal{width:94%} }
  .btn-small{padding:6px 8px;font-size:13px;border-radius:8px}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" title="Daynight RP"></div>
        <div>
          <h1>Daynight RP ‚Äî PDA / CAD</h1>
          <div class="subtitle">Simulador online ‚Äî comparte la URL con tu comunidad</div>
        </div>
      </div>

      <div class="top-right">
        <div class="pill small" id="userDisplay">No conectado</div>
        <div class="pill small" id="dutyStatus">En servicio: 0</div>
        <button id="btnExport" class="btn">Exportar</button>
        <button id="btnLogin" class="btn-ghost">Iniciar</button>
      </div>
    </header>

    <section class="grid" id="cardsRoot"></section>

    <div id="expandedRoot"></div>

    <footer>Hecho para Daynight RP ‚Ä¢ Datos sincronizados con Firestore/Storage</footer>
  </div>

  <!-- LOGIN / REGISTER modal (tu sistema original) -->
  <div id="loginModal" class="overlay" style="display:none">
    <div class="modal">
      <h3>Entrar / Registrarse</h3>
      <div class="muted small">Usa tu cuenta o crea una (solo admins pueden crear cuentas desde Administraci√≥n)</div>

      <div style="margin-top:12px">
        <label class="muted small">Usuario</label>
        <input id="loginUser" placeholder="usuario (ej: perety04)"/>
        <label class="muted small" style="margin-top:8px">Contrase√±a</label>
        <input id="loginPass" type="password" placeholder="contrase√±a"/>
        <div style="display:flex;gap:8px;margin-top:12px">
          <button id="loginBtn" class="btn">Entrar</button>
          <button id="guestBtn" class="btn-ghost">Invitado</button>
          <div style="margin-left:auto" class="small muted">¬øSin cuenta? <span id="showReg" class="link-like">Crear (solo admin permite subidas)</span></div>
        </div>
        <div id="loginError" class="muted small" style="margin-top:8px;color:#ff9b9b;display:none"></div>
      </div>

      <div id="registerBlock" style="display:none;margin-top:12px;border-top:1px dashed rgba(255,255,255,0.03);padding-top:12px">
        <h4 style="margin:0 0 8px 0">Crear cuenta</h4>
        <label class="muted small">Nombre visible</label>
        <input id="regName" placeholder="Ej: Ofc. P√©rez"/>
        <label class="muted small">Usuario</label>
        <input id="regUser" placeholder="usuario (ej: perety04)"/>
        <label class="muted small">Contrase√±a</label>
        <input id="regPass" type="password" placeholder="contrase√±a"/>
        <div style="display:flex;gap:8px;margin-top:8px">
          <select id="regRole">
            <option value="officer">Officer</option>
            <option value="sergeant">Sergeant</option>
            <option value="dispatcher">Dispatcher</option>
            <option value="admin">Admin</option>
          </select>
          <button id="regCreate" class="btn">Crear</button>
          <button id="regCancel" class="btn-ghost">Cancelar</button>
        </div>
        <div id="regMsg" class="muted small" style="margin-top:8px"></div>
      </div>
    </div>
  </div>

  <!-- simple file input for images (hidden) -->
  <input id="filePicker" type="file" accept="image/*" style="display:none" />

<script type="module">
/* ============================================================
   Daynight RP ‚Äî index.html (todo en uno)
   - copia y pega este archivo en public/index.html
   - pega tu firebaseConfig en el bloque marcado m√°s abajo
   - despliega con: firebase deploy --only hosting:daynightrppdapolice
   ============================================================ */

/* ----------------- Firebase modular (preparado) ----------------- */
/*
  IMPORTANTE: reemplaza los valores de firebaseConfig (apiKey, projectId, etc.)
  por los de tu proyecto desde la consola de Firebase.
*/

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getFirestore, collection, getDocs, addDoc, deleteDoc, doc, setDoc, updateDoc, onSnapshot, query, orderBy, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
import { getStorage, ref as sref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-storage.js";

const FIREBASE_CONFIG_PLACEHOLDER = {
  apiKey: "TU_API_KEY",
  authDomain: "TU_AUTH_DOMAIN",
  projectId: "TU_PROJECT_ID",
  storageBucket: "TU_STORAGE_BUCKET",
  messagingSenderId: "TU_SENDER_ID",
  appId: "TU_APP_ID",
  measurementId: "TU_MEASUREMENT_ID"
};

// ======== PEGAR AQU√ç TU firebaseConfig (reemplaza el objeto placeholder) ========
const firebaseConfig = FIREBASE_CONFIG_PLACEHOLDER;
// =============================================================================

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

/* ----------------- Helpers y almacenamiento local ----------------- */
const PREFIX = 'pda_daynight_';
function lsGet(k, fallback){ try{ const v=localStorage.getItem(PREFIX+k); return v?JSON.parse(v):fallback;}catch(e){return fallback;} }
function lsSet(k,v){ try{ localStorage.setItem(PREFIX+k, JSON.stringify(v)); }catch(e){} }
function uid(pref='id'){ return pref + '_' + Math.random().toString(36).slice(2,9); }
function now(){ return Date.now(); }
function notify(msg, timeout=3500){ const t=document.createElement('div'); t.className='toast'; t.textContent=msg; document.body.appendChild(t); setTimeout(()=> t.remove(), timeout); }

/* ----------------- App state ----------------- */
let STATE = { currentUser: lsGet('currentUser', null), expanded: null };

/* ----------------- DOM refs ----------------- */
const cardsRoot = document.getElementById('cardsRoot');
const expandedRoot = document.getElementById('expandedRoot');
const userDisplay = document.getElementById('userDisplay');
const dutyStatus = document.getElementById('dutyStatus');
const loginModal = document.getElementById('loginModal');
const btnLogin = document.getElementById('btnLogin');
const btnExport = document.getElementById('btnExport');

/* ----------------- Permissions / Roles ----------------- */
function hasPerm(perm){
  if(!STATE.currentUser) return perm === 'create_call' ? true : false; // guests can create calls
  const roles = lsGet('roles', {});
  const roleKey = STATE.currentUser.role;
  const role = roles[roleKey];
  if(!role) return false;
  if(role.permissions && role.permissions.includes('all')) return true;
  return role.permissions && role.permissions.includes(perm);
}

/* ----------------- Seed inicial (con admin seguro) ----------------- */
function seedIfNeeded(){
  if(!lsGet('inited', false)){
    const users = [
      {id:uid('u'), username:'admin', display:'Admin', badge:'ADM-001', password:'DayNightRP@2025', role:'admin'},
      {id:uid('u'), username:'dispatcher', display:'Dispatch', badge:'DISP', password:'dispatch', role:'dispatcher'},
      {id:uid('u'), username:'perety04', display:'Perety 04', badge:'PD-314', password:'peretypass', role:'officer'}
    ];
    const templates = {
      report: "T√≠tulo: {{title}}\\nHechos: {{facts}}\\nAcciones: {{actions}}\\nOficial: {{author}}",
      pda: "Nombre: {{name}}\\nAlias: {{alias}}\\nNotas: {{notes}}",
      call: "Remitente: {{caller}}\\nMensaje: {{message}}\\nUbicaci√≥n: {{location}}",
      fine: "Infractor: {{offender}}\\nImporte: {{amount}}\\nMotivo: {{reason}}"
    };
    const reports = [{id:uid('rep'), title:'Robo en tienda', description:'Robo con arma blanco. Sospechoso huy√≥.', author:'Admin', created_at:now()}];
    const wanted = [{id:uid('w'), name:'Mario Rata', description:'Robo coches', bounty:500, created_at:now()}];
    const calls = [{id:uid('c'), caller:'Civ. X', message:'Disparo', status:'pending', assigned_to:null, created_at:now()}];
    const pda = [{id:uid('p'), title:'Ficha: Juan P√©rez', text:'Nombre: Juan P√©rez\\nAlias: rata\\nDelitos: robo', created_at:now(), author:'Admin'}];
    const fines = [{id:uid('f'), offender:'Veh LSF-021', amount:200, reason:'Exceso velocidad', author:'Admin', created_at:now()}];
    const roles = {
      officer: {name:'Officer', color:'#7c3aed', permissions:['create_reports','create_pda','create_call']},
      sergeant: {name:'Sergeant', color:'#3b82f6', permissions:['create_reports','create_pda','create_call','delete_reports']},
      dispatcher: {name:'Dispatcher', color:'#f97316', permissions:['create_call','assign_call']},
      admin: {name:'Admin', color:'#10b981', permissions:['all']}
    };
    const alerts = [{id:uid('a'), title:'Robo en curso', description:'Robo en zona centro', level:'rojo', created_at:now()}];
    lsSet('users', users);
    lsSet('templates', templates);
    lsSet('reports', reports);
    lsSet('wanted', wanted);
    lsSet('calls', calls);
    lsSet('pda', pda);
    lsSet('fines', fines);
    lsSet('roles', roles);
    lsSet('alerts', alerts);
    lsSet('logs', [{id:uid('log'), t:now(), msg:'Seed inicial creada'}]);
    lsSet('onDuty', {});
    lsSet('inited', true);
  }
}

/* ----------------- UI: cards ----------------- */
const CARDS = [
  {id:'pda', title:'PDA / Fichas', desc:'Buscar y crear fichas PDA', icon:'üöì'},
  {id:'calls', title:'Dispatch / Llamadas', desc:'Crear/Asignar llamadas', icon:'üìû'},
  {id:'reports', title:'Informes', desc:'Crear / Editar informes', icon:'üìë'},
  {id:'wanted', title:'BOLO / Wanted', desc:'Fichas buscados', icon:'üö®'},
  {id:'fines', title:'Multas', desc:'Generar sanciones', icon:'üí∏'},
  {id:'service', title:'Servicio', desc:'Entrar / Salir de servicio', icon:'üü¢'},
  {id:'alerts', title:'Alertas', desc:'Alertas ciudad (verde/amarilla/roja)', icon:'‚ö†Ô∏è'},
  {id:'admin', title:'Administraci√≥n', desc:'Roles y usuarios (admin)', icon:'‚öôÔ∏è'},
  {id:'logs', title:'Auditor√≠a', desc:'Historial de acciones', icon:'üìú'}
];

function renderCards(){
  cardsRoot.innerHTML = '';
  CARDS.forEach(c=>{
    const el = document.createElement('div'); el.className='card'; el.dataset.id=c.id;
    el.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
      <div><div class="title">${c.title}</div><div class="desc">${c.desc}</div></div>
      <div class="icon">${c.icon}</div>
    </div>
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div class="muted tiny">Acci√≥n r√°pida</div>
      <div><button class="btn" data-open="${c.id}" style="background:var(--accent)">Abrir</button></div>
    </div>`;
    el.onclick = ()=>openCard(c.id);
    el.querySelector('button[data-open]').onclick = (e)=>{ e.stopPropagation(); openCard(c.id); };
    cardsRoot.appendChild(el);
  });
}

/* ----------------- Open card ----------------- */
function openCard(id){
  STATE.expanded = id;
  expandedRoot.innerHTML = '';
  const panel = document.createElement('div'); panel.className='expanded';
  if(id==='pda') renderPDA(panel);
  else if(id==='calls') renderCalls(panel);
  else if(id==='reports') renderReports(panel);
  else if(id==='wanted') renderWanted(panel);
  else if(id==='fines') renderFines(panel);
  else if(id==='service') renderService(panel);
  else if(id==='alerts') renderAlerts(panel);
  else if(id==='admin') renderAdmin(panel);
  else if(id==='logs') renderLogs(panel);
  expandedRoot.appendChild(panel);
  window.scrollTo({ top: panel.offsetTop-20, behavior:'smooth' });
}

/* ----------------- PDA ----------------- */
function renderPDA(container){
  const templates = lsGet('templates', {});
  container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
    <div><strong>PDA / Fichas</strong><div class="muted small">Buscar y crear fichas</div></div>
    <div><button class="btn btn-small" id="closeP">Cerrar</button></div>
  </div>
  <div style="margin-top:12px" class="grid-2">
    <div>
      <div class="muted small">Buscar</div>
      <input id="pdaQ" placeholder="Buscar por nombre, alias o texto..." />
      <div id="pdaResults" style="margin-top:12px"></div>
    </div>
    <div>
      <div class="muted small">Crear nueva ficha (plantilla editable)</div>
      <textarea id="pdaTpl">${templates.pda||''}</textarea>
      <div style="display:flex;gap:8px;margin-top:8px"><button id="createPDA" class="btn">Crear ficha</button><button id="clearPDA" class="btn-ghost">Limpiar</button></div>
      <div style="margin-top:10px"><small class="muted">Adjuntar imagen:</small><input id="pdaImg" type="file" accept="image/*"></div>
    </div>
  </div>`;
  container.querySelector('#closeP').onclick = ()=> closeExpanded();
  container.querySelector('#pdaQ').oninput = ()=> searchPDA(document.getElementById('pdaQ').value);
  container.querySelector('#createPDA').onclick = createPDA;
  loadPDAResults();
}
async function loadPDAResults(){
  const arr = lsGet('pda', []);
  const res = document.getElementById('pdaResults');
  if(!res) return;
  res.innerHTML = arr.map(p=>`<div class="item"><div style="flex:1"><b>${(p.title||'Ficha')}</b><div class="muted small">${(p.text||'').slice(0,140)}</div></div>
    <div><button class="btn-ghost" onclick="viewPDA('${p.id}')">Ver</button> ${canDeletePDA(p) ? `<button class="btn-ghost" onclick="delPDA('${p.id}')">Borrar</button>` : ''}</div></div>`).join('') || '<div class="muted small">Sin fichas</div>';
}
function searchPDA(q){
  q = (q||'').toLowerCase().trim();
  const arr = lsGet('pda', []);
  const out = arr.filter(p => ((p.text||'').toLowerCase().includes(q) || (p.title||'').toLowerCase().includes(q)));
  const res = document.getElementById('pdaResults');
  if(!res) return;
  res.innerHTML = out.map(p=>`<div class="item"><div style="flex:1"><b>${p.title||'Ficha'}</b><div class="muted small">${(p.text||'').slice(0,140)}</div></div>
    <div><button class="btn-ghost" onclick="viewPDA('${p.id}')">Ver</button> ${canDeletePDA(p) ? `<button class="btn-ghost" onclick="delPDA('${p.id}')">Borrar</button>` : ''}</div></div>`).join('') || '<div class="muted small">No hay resultados</div>';
}
function canDeletePDA(p){
  if(!STATE.currentUser) return false;
  if(STATE.currentUser.role==='admin') return true;
  // Only author or roles with delete permission
  return (p.author === (STATE.currentUser && STATE.currentUser.username)) || hasPerm('delete_reports');
}
async function createPDA(){
  if(!hasPerm('create_pda')){ notify('No tienes permiso para crear fichas'); return; }
  const txt = document.getElementById('pdaTpl').value.trim();
  if(!txt){ notify('Rellena la plantilla'); return; }
  const imgInput = document.getElementById('pdaImg');
  let imgURL = null;
  if(imgInput && imgInput.files && imgInput.files[0]){
    try{
      const file = imgInput.files[0];
      const path = `images/pda/${uid('img')}_${file.name}`;
      const stref = sref(storage, path);
      await uploadBytes(stref, file);
      imgURL = await getDownloadURL(stref);
    }catch(e){ console.error(e); notify('Error subiendo imagen'); }
  }
  const arr = lsGet('pda', []);
  const item = {id:uid('pda'), title: (txt.split('\n')[0]||'Ficha').replace('Nombre:','').trim(), text:txt, created_at:now(), author: STATE.currentUser?STATE.currentUser.username:'Invitado', img:imgURL};
  arr.unshift(item); lsSet('pda', arr);
  pushLog(`Ficha PDA creada: ${item.title}`);
  document.getElementById('pdaTpl').value = '';
  if(document.getElementById('pdaImg')) document.getElementById('pdaImg').value='';
  loadPDAResults();
  notify('Ficha PDA creada');
}
function viewPDA(id){
  const arr = lsGet('pda', []);
  const p = arr.find(x=>x.id===id);
  if(!p) return;
  let txt = `T√≠tulo: ${p.title}\n\n${p.text}\n\nCreada: ${new Date(p.created_at).toLocaleString()}\nAutor: ${p.author}`;
  if(p.img) txt += `\n\nImagen: ${p.img}`;
  alert(txt);
}
function delPDA(id){
  if(!confirm('Borrar ficha PDA?')) return;
  let arr = lsGet('pda', []);
  arr = arr.filter(x=>x.id!==id); lsSet('pda', arr); pushLog(`Ficha PDA borrada: ${id}`); loadPDAResults(); notify('Ficha borrada');
}

/* ----------------- Calls (Dispatch) ----------------- */
function renderCalls(container){
  container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
    <div><strong>Dispatch / Llamadas</strong><div class="muted small">Crear llamadas y asignar unidades</div></div>
    <div><button class="btn btn-small" id="closeC">Cerrar</button></div>
  </div>
  <div style="margin-top:12px;display:flex;gap:8px">
    <input id="callFrom" placeholder="Remitente (opcional)"/>
    <input id="callMsg" placeholder="Mensaje"/>
    <button id="callCreate" class="btn">Crear llamada</button>
  </div>
  <div style="margin-top:12px"><strong>Llamadas</strong><div id="callsList" class="list" style="margin-top:8px"></div></div>`;
  container.querySelector('#closeC').onclick = ()=> closeExpanded();
  container.querySelector('#callCreate').onclick = createCall;
  loadCalls();
}
function createCall(){
  const caller = document.getElementById('callFrom').value.trim() || 'Anonimo';
  const message = document.getElementById('callMsg').value.trim();
  if(!message){ notify('Introduce un mensaje'); return; }
  const calls = lsGet('calls', []);
  const c = {id:uid('c'), caller, message, status:'pending', assigned_to:null, created_at:now()};
  calls.unshift(c); lsSet('calls', calls); pushLog(`Llamada creada por ${caller}`);
  document.getElementById('callMsg').value=''; document.getElementById('callFrom').value='';
  loadCalls();
  notify('Nueva llamada creada');
}
function loadCalls(){
  const list = document.getElementById('callsList'); if(!list) return;
  const calls = lsGet('calls', []);
  list.innerHTML = '';
  if(!calls.length){ list.innerHTML = '<div class="muted small">No hay llamadas</div>'; return; }
  const users = lsGet('users', []);
  calls.forEach(c=>{
    const assignee = c.assigned_to ? (users.find(u=>u.id===c.assigned_to)?.display || '‚Äî') : '‚Äî';
    const el = document.createElement('div'); el.className='item';
    el.innerHTML = `<div style="flex:1"><b>${c.caller}</b><div class="muted small">${c.message}</div></div>
      <div style="text-align:right"><div class="muted tiny">${new Date(c.created_at).toLocaleString()}</div><div style="margin-top:8px" class="muted tiny">Asig: ${assignee}</div></div>`;
    const btns = document.createElement('div'); btns.style.marginLeft='12px';
    if(hasPerm('assign_call') && STATE.currentUser){
      const assign = document.createElement('button'); assign.className='btn-ghost'; assign.textContent='Asignar a m√≠';
      assign.onclick = ()=>{ assignCall(c.id); };
      btns.appendChild(assign);
    }
    if(STATE.currentUser && (STATE.currentUser.role==='admin' || (c.assigned_to && STATE.currentUser.id===c.assigned_to))){
      const del = document.createElement('button'); del.className='btn'; del.style.marginLeft='6px'; del.textContent='Borrar';
      del.onclick = ()=>{ if(confirm('Borrar llamada?')) deleteCall(c.id); };
      btns.appendChild(del);
    }
    el.appendChild(btns);
    list.appendChild(el);
  });
}
function assignCall(id){
  if(!STATE.currentUser){ notify('Inicia sesi√≥n para asignar'); return; }
  let calls = lsGet('calls', []);
  const c = calls.find(x=>x.id===id); if(!c) return;
  c.status='assigned'; c.assigned_to = STATE.currentUser.id; lsSet('calls', calls); pushLog(`Llamada ${id} asignada a ${STATE.currentUser.display}`); loadCalls(); notify('Llamada asignada');
}
function deleteCall(id){ let calls=lsGet('calls',[]); calls = calls.filter(c=>c.id!==id); lsSet('calls', calls); pushLog(`Llamada ${id} borrada`); loadCalls(); notify('Llamada borrada'); }

/* ----------------- Reports ----------------- */
function renderReports(container){
  container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
    <div><strong>Informes</strong><div class="muted small">Crear y consultar informes</div></div>
    <div><button class="btn btn-small" id="closeR">Cerrar</button></div>
  </div>
  <div style="margin-top:12px">
    <div class="muted small">Plantilla (editable)</div>
    <textarea id="tplReport" style="min-height:80px"></textarea>
  </div>
  <div style="margin-top:8px" class="form-row">
    <input id="repTitle" placeholder="T√≠tulo" />
    <input id="repAuthor" placeholder="Autor (auto)" />
  </div>
  <div style="margin-top:8px"><textarea id="repDesc" placeholder="Descripci√≥n..."></textarea></div>
  <div style="margin-top:8px;display:flex;gap:8px">
    <button id="saveRep" class="btn">Guardar informe</button>
    <button id="clearRep" class="btn-ghost">Limpiar</button>
    <div style="margin-left:auto"><small class="muted">Adjuntar imagen:</small><input id="repImg" type="file" accept="image/*"></div>
  </div>
  <div style="margin-top:12px"><strong>√öltimos informes</strong><div id="reportsList" class="list" style="margin-top:8px"></div></div>`;
  container.querySelector('#closeR').onclick = ()=> closeExpanded();
  const templates = lsGet('templates', {}); document.getElementById('tplReport').value = templates.report || '';
  document.getElementById('repAuthor').value = STATE.currentUser ? STATE.currentUser.display : 'Invitado';
  document.getElementById('saveRep').onclick = saveReport;
  document.getElementById('clearRep').onclick = ()=>{ document.getElementById('repTitle').value=''; document.getElementById('repDesc').value=''; };
  loadReports();
}
async function saveReport(){
  if(!hasPerm('create_reports')){ notify('No tienes permiso para crear informes'); return; }
  const title = document.getElementById('repTitle').value.trim();
  const desc = document.getElementById('repDesc').value.trim();
  if(!title || !desc){ notify('T√≠tulo y descripci√≥n obligatorios'); return; }
  let imgURL = null;
  const imgIn = document.getElementById('repImg');
  if(imgIn && imgIn.files && imgIn.files[0]){
    try{
      const file = imgIn.files[0];
      const path = `images/reports/${uid('img')}_${file.name}`;
      const stref = sref(storage, path);
      await uploadBytes(stref, file);
      imgURL = await getDownloadURL(stref);
    }catch(e){ console.error(e); notify('Error subiendo imagen'); }
  }
  const reports = lsGet('reports', []);
  const r = {id:uid('rep'), title, description:desc, author: STATE.currentUser?STATE.currentUser.display:'Invitado', created_at:now(), img:imgURL};
  reports.unshift(r); lsSet('reports', reports);
  const templates = lsGet('templates', {}); templates.report = document.getElementById('tplReport').value; lsSet('templates', templates);
  pushLog(`Informe creado: ${title}`);
  loadReports();
  notify('Informe guardado');
}
function loadReports(){
  const list = document.getElementById('reportsList'); if(!list) return;
  const reports = lsGet('reports', []);
  list.innerHTML = '';
  if(!reports.length){ list.innerHTML = '<div class="muted small">No hay informes</div>'; return; }
  reports.forEach(r=>{
    const it = document.createElement('div'); it.className='item';
    it.innerHTML = `<div style="flex:1"><div style="font-weight:700">${r.title}</div><div class="muted small">${(r.description||'').slice(0,160)}</div></div>
      <div style="text-align:right"><div class="muted tiny">${new Date(r.created_at).toLocaleString()}</div><div style="margin-top:6px" class="muted tiny">${r.author||''}</div></div>`;
    const btns = document.createElement('div'); btns.style.marginLeft='12px';
    const view = document.createElement('button'); view.className='btn-ghost'; view.textContent='Ver';
    view.onclick = ()=> { let txt = `${r.description}\n\nAutor: ${r.author}\nFecha: ${new Date(r.created_at).toLocaleString()}`; if(r.img) txt += `\nImagen: ${r.img}`; alert(txt); };
    btns.appendChild(view);
    if(STATE.currentUser && (STATE.currentUser.role==='admin' || STATE.currentUser.role==='sergeant' || hasPerm('delete_reports'))){
      const del = document.createElement('button'); del.className='btn'; del.style.marginLeft='6px'; del.textContent='Borrar'; del.onclick = ()=>{ if(confirm('Borrar informe?')) deleteReport(r.id); };
      btns.appendChild(del);
    }
    it.appendChild(btns);
    list.appendChild(it);
  });
}
function deleteReport(id){ let arr=lsGet('reports',[]); arr=arr.filter(r=>r.id!==id); lsSet('reports',arr); pushLog(`Informe ${id} borrado`); loadReports(); notify('Informe borrado'); }

/* ----------------- Wanted / BOLO ----------------- */
function renderWanted(container){
  container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
    <div><strong>BOLO / Wanted</strong><div class="muted small">Crear fichas buscadas</div></div>
    <div><button class="btn btn-small" id="closeW">Cerrar</button></div>
  </div>
  <div style="margin-top:12px" class="form-row"><input id="wName" placeholder="Nombre / Alias"/><input id="wBounty" placeholder="Recompensa"/></div>
  <div style="margin-top:8px"><textarea id="wDesc" placeholder="Descripci√≥n"></textarea></div>
  <div style="margin-top:8px;display:flex;gap:8px"><button id="saveW" class="btn">Crear ficha</button></div>
  <div style="margin-top:12px"><strong>Fichas</strong><div id="wantedList" class="list" style="margin-top:8px"></div></div>`;
  container.querySelector('#closeW').onclick = ()=> closeExpanded();
  container.querySelector('#saveW').onclick = createWanted;
  loadWanted();
}
function createWanted(){ if(!hasPerm('create_bolo')){ notify('No tienes permiso'); return; }
  const name=document.getElementById('wName').value.trim(); const desc=document.getElementById('wDesc').value.trim(); const bounty=parseInt(document.getElementById('wBounty').value||'0',10);
  if(!name){ notify('Nombre requerido'); return; }
  const arr=lsGet('wanted',[]); arr.unshift({id:uid('w'), name, description:desc, bounty, created_at:now()}); lsSet('wanted',arr); pushLog(`Wanted creado: ${name}`); loadWanted(); notify('Ficha creada');
}
function loadWanted(){ const list=document.getElementById('wantedList'); if(!list) return; const arr=lsGet('wanted',[]); list.innerHTML=''; if(!arr.length){ list.innerHTML='<div class="muted small">No hay fichas</div>'; return; } arr.forEach(w=>{ const it=document.createElement('div'); it.className='item'; it.innerHTML=`<div style="flex:1"><b>${w.name}</b><div class="muted small">${w.description}</div></div><div class="pill">${w.bounty||0}‚Ç¨</div>`; const btns=document.createElement('div'); btns.style.marginLeft='12px'; const view=document.createElement('button'); view.className='btn-ghost'; view.textContent='Ver'; view.onclick=()=>alert(`Wanted ‚Äî ${w.name}\n\n${w.description}\nRecompensa: ${w.bounty}‚Ç¨`); btns.appendChild(view); if(hasPerm('manage_wanted')){ const del=document.createElement('button'); del.className='btn'; del.style.marginLeft='6px'; del.textContent='Borrar'; del.onclick=()=>{ if(confirm('Borrar ficha?')){ deleteWanted(w.id); } }; btns.appendChild(del); } it.appendChild(btns); list.appendChild(it); }); }
function deleteWanted(id){ let arr=lsGet('wanted',[]); arr=arr.filter(x=>x.id!==id); lsSet('wanted',arr); pushLog(`Wanted ${id} borrado`); loadWanted(); notify('Wanted borrado'); }

/* ----------------- Fines (Multas) ----------------- */
function renderFines(container){
  container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
    <div><strong>Multas</strong><div class="muted small">Genera sanciones</div></div>
    <div><button class="btn btn-small" id="closeF">Cerrar</button></div>
  </div>
  <div style="margin-top:12px" class="form-row"><input id="fineOff" placeholder="Infractor"/><input id="fineAmt" placeholder="Importe"/></div>
  <div style="margin-top:8px"><textarea id="fineReason" placeholder="Motivo..."></textarea></div>
  <div style="margin-top:8px;display:flex;gap:8px"><button id="saveFine" class="btn">Emitir multa</button></div>
  <div style="margin-top:12px"><strong>Multas</strong><div id="finesList" class="list" style="margin-top:8px"></div></div>`;
  container.querySelector('#closeF').onclick = ()=> closeExpanded();
  container.querySelector('#saveFine').onclick = saveFine; loadFines();
}
function saveFine(){ if(!hasPerm('create_fine')){ notify('No tienes permiso para multar'); return; }
  const off=document.getElementById('fineOff').value.trim(); const amt=parseInt(document.getElementById('fineAmt').value||'0',10); const reason=document.getElementById('fineReason').value.trim();
  if(!off || !amt){ notify('Infractor e importe requeridos'); return; }
  const arr=lsGet('fines',[]); arr.unshift({id:uid('f'), offender:off, amount:amt, reason, author:STATE.currentUser?STATE.currentUser.display:'Invitado', created_at:now()}); lsSet('fines',arr); pushLog(`Multa creada: ${off} ${amt}‚Ç¨`); loadFines(); notify('Multa creada');
}
function loadFines(){ const list=document.getElementById('finesList'); if(!list) return; const arr=lsGet('fines',[]); list.innerHTML=''; if(!arr.length){ list.innerHTML='<div class="muted small">No hay multas</div>'; return; } arr.forEach(f=>{ const it=document.createElement('div'); it.className='item'; it.innerHTML=`<div style="flex:1"><b>${f.offender} ‚Ä¢ ${f.amount}‚Ç¨</b><div class="muted small">${f.reason}</div></div><div class="muted tiny">${new Date(f.created_at).toLocaleString()}</div>`; const btns=document.createElement('div'); btns.style.marginLeft='12px'; if(STATE.currentUser && (STATE.currentUser.role==='admin' || STATE.currentUser.display===f.author || hasPerm('delete_reports'))){ const del=document.createElement('button'); del.className='btn'; del.textContent='Borrar'; del.onclick=()=>{ if(confirm('Borrar multa?')){ deleteFine(f.id); } }; btns.appendChild(del); } it.appendChild(btns); list.appendChild(it); }); }
function deleteFine(id){ let arr=lsGet('fines',[]); arr=arr.filter(x=>x.id!==id); lsSet('fines',arr); pushLog(`Multa ${id} borrada`); loadFines(); notify('Multa borrada'); }

/* ----------------- Service (on duty with times) ----------------- */
function renderService(container){
  container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
    <div><strong>Servicio</strong><div class="muted small">Ponte en servicio o sal</div></div>
    <div><button class="btn btn-small" id="closeS">Cerrar</button></div>
  </div>
  <div style="margin-top:12px;display:flex;gap:8px;align-items:center"><div class="muted small">Tu estado:</div><div id="serviceBox" class="pill">Desconocido</div><div style="margin-left:auto"><button id="toggleDuty" class="btn">Cambiar estado</button></div></div>
  <div style="margin-top:12px"><strong>Polic√≠as en servicio</strong><div id="dutyList" class="list" style="margin-top:8px"></div></div>`;
  container.querySelector('#closeS').onclick = ()=> closeExpanded();
  const box = container.querySelector('#serviceBox'); const on = lsGet('onDuty', {}); const uId = STATE.currentUser ? STATE.currentUser.id : null;
  box.textContent = (uId && on[uId] && on[uId].active) ? 'En servicio' : 'Fuera de servicio';
  container.querySelector('#toggleDuty').onclick = ()=>{ if(!STATE.currentUser){ notify('Inicia sesi√≥n'); return; } const map = lsGet('onDuty', {}); if(!map[STATE.currentUser.id]) map[STATE.currentUser.id] = { active:false, history:[] }; map[STATE.currentUser.id].active = !map[STATE.currentUser.id].active; if(map[STATE.currentUser.id].active){ map[STATE.currentUser.id].history.push({ from: now(), to: null }); pushLog(`${STATE.currentUser.display} entr√≥ en servicio`); notify(`${STATE.currentUser.display} entr√≥ en servicio`); } else { const h = map[STATE.currentUser.id].history; if(h.length && !h[h.length-1].to) h[h.length-1].to = now(); pushLog(`${STATE.currentUser.display} sali√≥ de servicio`); notify(`${STATE.currentUser.display} sali√≥ de servicio`); } lsSet('onDuty', map); box.textContent = map[STATE.currentUser.id].active ? 'En servicio' : 'Fuera de servicio'; updateHeader(); loadDutyList(); };
  loadDutyList();
}
function loadDutyList(){ const list=document.getElementById('dutyList'); if(!list) return; const on=lsGet('onDuty',{}); const users=lsGet('users', []); const active = Object.keys(on).filter(k=>on[k] && on[k].active).map(id=> { const u = users.find(us=>us.id===id); return {display: u?u.display:id, history:on[id].history||[]}; }); list.innerHTML = active.map(a=>`<div class="item"><div><b>${a.display}</b><div class="muted small">Sesiones: ${a.history.length}</div></div></div>`).join('') || '<div class="muted small">Nadie en servicio</div>'; updateHeader(); }

/* ----------------- Alerts (con borrado) ----------------- */
function renderAlerts(container){
  container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
    <div><strong>Alertas</strong><div class="muted small">Crear y gestionar alertas ciudadanas</div></div>
    <div><button class="btn btn-small" id="closeA">Cerrar</button></div>
  </div>
  <div style="margin-top:12px" class="form-row"><input id="alertTitle" placeholder="T√≠tulo"/><select id="alertLevel"><option value="verde">Verde</option><option value="amarilla">Amarilla</option><option value="roja">Roja</option></select></div>
  <div style="margin-top:8px"><textarea id="alertDesc" placeholder="Descripci√≥n..."></textarea></div>
  <div style="margin-top:8px;display:flex;gap:8px"><button id="saveAlert" class="btn">Crear alerta</button></div>
  <div style="margin-top:12px"><strong>Alertas activas</strong><div id="alertsList" class="list" style="margin-top:8px"></div></div>`;
  container.querySelector('#closeA').onclick = ()=> closeExpanded();
  container.querySelector('#saveAlert').onclick = createAlert;
  loadAlerts();
}
function createAlert(){
  if(!STATE.currentUser){ notify('Inicia sesi√≥n para crear alertas'); return; }
  const title = document.getElementById('alertTitle').value.trim(); const desc = document.getElementById('alertDesc').value.trim(); const level = document.getElementById('alertLevel').value;
  if(!title){ notify('T√≠tulo requerido'); return; }
  const arr = lsGet('alerts', []); const a = {id:uid('a'), title, description:desc, level, created_at:now(), author:STATE.currentUser.username};
  arr.unshift(a); lsSet('alerts', arr); pushLog(`Alerta creada: ${title}`); loadAlerts(); notify('Alerta creada');
}
/* ---- Esta es la funci√≥n solicitada: loadAlerts con BORRADO (solo admins/roles con manage_alerts) ---- */
function loadAlerts(){
  const list = document.getElementById('alertsList');
  const arr = lsGet('alerts', []);
  list.innerHTML = '';
  if(!arr.length){ list.innerHTML = '<div class="muted small">Sin alertas</div>'; return; }
  arr.forEach(a=>{
    const it = document.createElement('div'); it.className='item';
    it.innerHTML = `<div style="flex:1"><div style="font-weight:700">${a.title} ‚Ä¢ <span class="muted small">${a.level}</span></div><div class="muted small">${(a.description||'')}</div></div>
      <div style="text-align:right"><div class="muted tiny">${new Date(a.created_at).toLocaleString()}</div></div>`;
    const btns = document.createElement('div'); btns.style.marginLeft='12px';
    // Solo admins o roles con permiso manage_alerts pueden borrar alertas
    if(STATE.currentUser && (STATE.currentUser.role === 'admin' || hasPerm('manage_alerts'))){
      const del = document.createElement('button'); del.className='btn'; del.textContent='Borrar';
      del.onclick = ()=> { if(confirm('¬øBorrar esta alerta?')) { let arr2 = lsGet('alerts',[]); arr2 = arr2.filter(x=>x.id!==a.id); lsSet('alerts', arr2); pushLog(`Alerta borrada: ${a.title}`); loadAlerts(); notify('Alerta borrada'); } };
      btns.appendChild(del);
    }
    it.appendChild(btns);
    list.appendChild(it);
  });
}

/* ----------------- Admin panel ----------------- */
function renderAdmin(container){
  const users = lsGet('users', []);
  const roles = lsGet('roles', {});
  container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
    <div><strong>Administraci√≥n</strong><div class="muted small">Gestiona roles, permisos y usuarios</div></div>
    <div><button class="btn btn-small" id="closeA2">Cerrar</button></div>
  </div>
  <div style="margin-top:12px;display:flex;gap:12px">
    <div style="flex:1">
      <h4>Usuarios</h4>
      <div id="usersAdminList" class="list"></div>
    </div>
    <div style="width:360px">
      <h4>Crear usuario</h4>
      <input id="adm_newUser" placeholder="username"><input id="adm_newDisplay" placeholder="display"><input id="adm_newPass" placeholder="password">
      <select id="adm_newRole">${Object.keys(roles).map(r=>`<option value="${r}">${r}</option>`).join('')}</select>
      <div style="display:flex;gap:8px;margin-top:8px"><button id="adm_createUser" class="btn">Crear</button><button id="adm_refresh" class="btn-ghost">Refrescar</button></div>

      <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.03)">
      <h4>Roles</h4>
      <div style="display:flex;gap:8px"><input id="adm_newRoleName" placeholder="nuevo rol"><button id="adm_createRole" class="btn">Crear rol</button></div>
      <div id="rolesAdminList" style="margin-top:12px"></div>
    </div>
  </div>`;
  container.querySelector('#closeA2').onclick = ()=> closeExpanded();
  container.querySelector('#adm_createUser').onclick = adminCreateUser;
  container.querySelector('#adm_refresh').onclick = ()=>renderAdmin(container);
  container.querySelector('#adm_createRole').onclick = adminCreateRole;
  loadUsersAdmin();
  loadRolesAdmin();
}
function loadUsersAdmin(){
  const users = lsGet('users', []); const roles = lsGet('roles', {});
  const ul = document.getElementById('usersAdminList'); ul.innerHTML = '';
  if(!users.length){ ul.innerHTML = '<div class="muted small">No hay usuarios</div>'; return; }
  users.forEach((u)=>{
    const div = document.createElement('div'); div.className='item';
    div.innerHTML = `<div><b>${u.display} (${u.username})</b><div class="muted small">Rol: <span class="role-chip">${u.role}</span> ‚Ä¢ Badge: ${u.badge||'‚Äî'}</div></div>
      <div style="text-align:right">
        <select data-uid="${u.id}" class="adm_role_sel">${Object.keys(lsGet('roles',{})).map(r=>`<option value="${r}" ${u.role===r?'selected':''}>${r}</option>`).join('')}</select>
        <div style="margin-top:6px"><button class="btn-ghost btn-small" data-uid="${u.id}" data-act="del">Borrar</button> <button class="btn btn-small" data-uid="${u.id}" data-act="imp">Impersonar</button></div>
      </div>`;
    ul.appendChild(div);
  });
  // attach events
  ul.querySelectorAll('.adm_role_sel').forEach(sel=>{
    sel.onchange = (e)=>{ const uid = e.target.dataset.uid; changeUserRole(uid, e.target.value); };
  });
  ul.querySelectorAll('button[data-act="del"]').forEach(b=> b.onclick = ()=>{
    const uid = b.dataset.uid;
    if(!confirm('Borrar usuario?')) return;
    let arr = lsGet('users', []); const u = arr.find(x=>x.id===uid);
    if(u && u.username==='admin'){ notify('No puedes borrar la cuenta admin seed'); return; }
    // adem√°s si estaba en servicio lo quitamos
    let on = lsGet('onDuty', {}); if(on[uid]) delete on[uid]; lsSet('onDuty', on);
    arr = arr.filter(x=>x.id!==uid); lsSet('users', arr); pushLog(`Usuario borrado: ${uid}`); loadUsersAdmin(); notify('Usuario borrado');
  });
  ul.querySelectorAll('button[data-act="imp"]').forEach(b=> b.onclick = ()=>{
    const uid = b.dataset.uid; const u = lsGet('users',[]).find(x=>x.id===uid); if(!u) return; // impersonation: mantiene permisos admin si admin impersona
    // guardamos real admin
    const real = STATE.currentUser;
    STATE.currentUser = {...u};
    lsSet('currentUser', STATE.currentUser);
    updateHeader();
    pushLog(`Impersonaci√≥n: ${u.username} (desde ${real?real.username:'? -console?'})`);
    notify('Ahora eres: ' + u.display);
  });
}
function changeUserRole(uid,newRole){
  let users=lsGet('users',[]); const u=users.find(x=>x.id===uid); if(!u) return; u.role=newRole; lsSet('users',users); pushLog(`Rol cambiado: ${u.username} -> ${newRole}`); loadUsersAdmin();
}
function adminCreateUser(){
  if(!STATE.currentUser || STATE.currentUser.role !== 'admin'){ notify('Solo admin puede crear usuarios aqu√≠'); return; }
  const username=document.getElementById('adm_newUser').value.trim(); const display=document.getElementById('adm_newDisplay').value.trim()||username; const pass=document.getElementById('adm_newPass').value.trim()||'1234'; const role=document.getElementById('adm_newRole').value;
  if(!username){ notify('username requerido'); return; }
  let users=lsGet('users',[]); if(users.find(u=>u.username===username)){ notify('Usuario ya existe'); return; }
  const u={id:uid('u'), username, display, badge:'', password:pass, role}; users.unshift(u); lsSet('users',users); pushLog(`Usuario admin creado: ${username}`); loadUsersAdmin(); notify('Usuario creado');
}
function adminCreateRole(){
  if(!STATE.currentUser || STATE.currentUser.role !== 'admin'){ notify('Solo admin puede crear roles'); return; }
  const name=document.getElementById('adm_newRoleName').value.trim(); if(!name){ notify('Nombre rol requerido'); return; }
  const roles = lsGet('roles', {}); if(roles[name]){ notify('Rol ya existe'); return; }
  roles[name] = { name, color:'#999999', permissions:[] }; lsSet('roles', roles); pushLog(`Rol creado: ${name}`); loadRolesAdmin(); loadUsersAdmin(); notify('Rol creado');
}
function loadRolesAdmin(){
  const roles = lsGet('roles', {}); const out = document.getElementById('rolesAdminList'); out.innerHTML = '';
  for(const key in roles){
    const r = roles[key];
    const div = document.createElement('div'); div.className='item';
    div.innerHTML = `<div style="flex:1"><b>${key}</b><div class="muted small">Permisos:</div><div id="permBox_${key}" style="margin-top:6px"></div></div>
      <div style="text-align:right"><button class="btn-ghost" data-role="${key}" data-act="edit">Editar</button> <button class="btn" data-role="${key}" data-act="del">Borrar</button></div>`;
    out.appendChild(div);
    const box = div.querySelector(`#permBox_${key}`);
    box.innerHTML = (r.permissions && r.permissions.length) ? r.permissions.map(p=>`<span class="role-chip">${p}</span>`).join('') : '<span class="muted tiny">Sin permisos</span>';
  }
  // attach events
  out.querySelectorAll('button[data-act="edit"]').forEach(b=> b.onclick = ()=>{
    const roleKey = b.dataset.role; openRoleEditor(roleKey);
  });
  out.querySelectorAll('button[data-act="del"]').forEach(b=> b.onclick = ()=>{
    const roleKey = b.dataset.role; if(!confirm('Borrar rol? (Los usuarios con este rol quedar√°n con rol vac√≠o)')) return;
    let roles = lsGet('roles', {}); delete roles[roleKey]; lsSet('roles', roles);
    let users = lsGet('users', []); users.forEach(u=>{ if(u.role===roleKey) u.role=''; }); lsSet('users', users);
    pushLog(`Rol borrado: ${roleKey}`); loadRolesAdmin(); loadUsersAdmin(); notify('Rol borrado');
  });
}
function openRoleEditor(roleKey){
  const roles = lsGet('roles', {});
  const role = roles[roleKey];
  if(!role){ notify('Rol no existe'); return; }
  const modal = document.createElement('div'); modal.className='overlay';
  modal.innerHTML = `<div class="modal">
    <h3>Editar rol: ${roleKey}</h3>
    <div class="muted small">Marca los permisos que tendr√° este rol</div>
    <div style="margin-top:12px" id="permChecks"></div>
    <div style="display:flex;gap:8px;margin-top:12px"><button id="saveRole" class="btn">Guardar</button><button id="cancelRole" class="btn-ghost">Cancelar</button></div>
  </div>`;
  document.body.appendChild(modal);
  const permsList = ['create_reports','delete_reports','create_pda','create_call','assign_call','create_bolo','manage_wanted','create_fine','export','manage_alerts','all'];
  const box = modal.querySelector('#permChecks');
  box.innerHTML = permsList.map(p=>`<div style="margin-bottom:6px"><label><input type="checkbox" data-perm="${p}" ${role.permissions.includes(p)?'checked':''}/> ${p}</label></div>`).join('');
  modal.querySelector('#cancelRole').onclick = ()=> modal.remove();
  modal.querySelector('#saveRole').onclick = ()=>{
    const checked = Array.from(box.querySelectorAll('input[type=checkbox]:checked')).map(c=>c.dataset.perm);
    role.permissions = checked;
    roles[roleKey] = role; lsSet('roles', roles);
    pushLog(`Rol editado: ${roleKey}`);
    modal.remove(); loadRolesAdmin(); loadUsersAdmin(); notify('Rol actualizado');
  };
}

/* ----------------- Logs & tools ----------------- */
function pushLog(msg){ const logs = lsGet('logs', []); logs.unshift({id:uid('log'), t:now(), msg}); lsSet('logs', logs); renderLogsMini(); }
function renderLogs(container){
  if(!container){ expandedRoot.innerHTML=''; const panel=document.createElement('div'); panel.className='expanded'; renderLogs(panel); expandedRoot.appendChild(panel); return; }
  const logs = lsGet('logs', []);
  container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>Auditor√≠a</strong><div class="muted small">√öltimas acciones</div></div><div><button class="btn btn-small" id="closeL">Cerrar</button></div></div>
    <div style="margin-top:12px" id="logsList" class="list"></div>`;
  container.querySelector('#closeL').onclick = ()=> closeExpanded();
  const list = container.querySelector('#logsList'); list.innerHTML = '';
  if(!logs.length){ list.innerHTML = '<div class="muted small">Sin logs</div>'; return; }
  logs.slice(0,200).forEach(l=>{ const it = document.createElement('div'); it.className='item'; it.innerHTML = `<div><div style="font-weight:700">${l.msg}</div><div class="muted small">${new Date(l.t).toLocaleString()}</div></div>`; list.appendChild(it); });
}
function renderLogsMini(){ const onMap = lsGet('onDuty', {}); const users = lsGet('users', []); const active = Object.keys(onMap).filter(k=>onMap[k] && onMap[k].active).map(id=> users.find(u=>u.id===id)?.display || id); dutyStatus.textContent = `En servicio: ${active.length}`; }

/* ----------------- Login / Register original logic (mantener tu flow) ----------------- */
document.getElementById('btnLogin').onclick = ()=> openLoginModal();
document.getElementById('btnExport').onclick = ()=> exportAll();

function openLoginModal(){ loginModal.style.display='flex'; document.getElementById('loginUser').focus(); }
function closeLoginModal(){ loginModal.style.display='none'; document.getElementById('loginPass').value=''; document.getElementById('loginUser').value=''; document.getElementById('loginError').style.display='none'; }

document.getElementById('guestBtn').onclick = ()=> { STATE.currentUser = null; lsSet('currentUser', null); updateHeader(); closeLoginModal(); pushLog('Entr√≥ como invitado'); notify('Entraste como invitado'); };
document.getElementById('showReg').onclick = ()=> { const b = document.getElementById('registerBlock'); b.style.display = b.style.display==='none' ? 'block' : 'none'; };
document.getElementById('regCancel').onclick = ()=> { document.getElementById('registerBlock').style.display='none'; };

document.getElementById('loginBtn').onclick = ()=>{
  const u = document.getElementById('loginUser').value.trim(); const p = document.getElementById('loginPass').value.trim();
  const users = lsGet('users', []);
  const found = users.find(x=>x.username === u && x.password === p);
  if(found){ STATE.currentUser = {...found}; lsSet('currentUser', STATE.currentUser); updateHeader(); closeLoginModal(); pushLog(`Sesi√≥n iniciada: ${found.username}`); notify('Sesi√≥n iniciada: ' + found.display); }
  else { document.getElementById('loginError').style.display='block'; document.getElementById('loginError').textContent='Usuario o contrase√±a incorrectos'; }
};

document.getElementById('regCreate').onclick = ()=>{
  // Creaci√≥n de cuentas desde modal: solo crear cuentas normales (no admins) - admin debe crear cuentas desde panel admin
  const username = document.getElementById('regUser').value.trim();
  const display = document.getElementById('regName').value.trim() || username;
  const pass = document.getElementById('regPass').value.trim() || '1234';
  const role = document.getElementById('regRole').value;
  if(!username){ document.getElementById('regMsg').textContent='Usuario requerido'; return; }
  const users = lsGet('users', []);
  if(users.find(u=>u.username===username)){ document.getElementById('regMsg').textContent='Usuario ya existe'; return; }
  // Para seguridad: no permitimos crear cuentas con rol 'admin' desde el modal
  const safeRole = role==='admin' ? 'officer' : role;
  const u = {id:uid('u'), username, display, badge:'', password:pass, role:safeRole};
  users.unshift(u); lsSet('users', users); document.getElementById('regMsg').textContent='Cuenta creada. Inicia sesi√≥n.'; pushLog(`Cuenta creada (self-register): ${username}`);
  document.getElementById('regUser').value=''; document.getElementById('regName').value=''; document.getElementById('regPass').value='';
  notify('Cuenta creada. Pide a un admin permisos si necesitas m√°s.');
};

/* ----------------- Auxiliar & header ----------------- */
function closeExpanded(){ STATE.expanded=null; expandedRoot.innerHTML=''; window.scrollTo({top:0,behavior:'smooth'}); }
function updateHeader(){ STATE.currentUser = lsGet('currentUser', STATE.currentUser); const u = STATE.currentUser; userDisplay.textContent = u? `${u.display} (${u.role})` : 'No conectado'; renderLogsMini(); }
btnLogin.addEventListener('click', ()=>{
  if(STATE.currentUser){ if(confirm('Cerrar sesi√≥n?')){ lsSet('currentUser', null); STATE.currentUser=null; updateHeader(); pushLog('Sesi√≥n cerrada'); notify('Sesi√≥n cerrada'); } } else openLoginModal();
});

/* ----------------- Export / Import (JSON) ----------------- */
function exportAll(){
  if(!hasPerm('export')){ notify('No tienes permiso para exportar'); return; }
  const data = {
    users: lsGet('users',[]), roles: lsGet('roles',{}), templates: lsGet('templates',{}),
    reports: lsGet('reports',[]), wanted: lsGet('wanted',[]), calls: lsGet('calls',[]),
    pda: lsGet('pda',[]), fines: lsGet('fines',[]), alerts: lsGet('alerts',[]), logs: lsGet('logs',[])
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'pda_export_'+Date.now()+'.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  pushLog('Datos exportados');
  notify('Exportado JSON');
}
function importFile(e){
  const f = e.target.files[0]; if(!f) return;
  const reader = new FileReader();
  reader.onload = (ev)=>{
    try{
      const data = JSON.parse(ev.target.result);
      if(!confirm('Importar reemplazar√° datos locales. Continuar?')) return;
      if(data.users) lsSet('users', data.users);
      if(data.roles) lsSet('roles', data.roles);
      if(data.templates) lsSet('templates', data.templates);
      if(data.reports) lsSet('reports', data.reports);
      if(data.wanted) lsSet('wanted', data.wanted);
      if(data.calls) lsSet('calls', data.calls);
      if(data.pda) lsSet('pda', data.pda);
      if(data.fines) lsSet('fines', data.fines);
      if(data.alerts) lsSet('alerts', data.alerts);
      if(data.logs) lsSet('logs', data.logs);
      pushLog('Datos importados');
      alert('Importaci√≥n completa. Recargando UI.');
      location.reload();
    } catch(err){ notify('JSON inv√°lido'); }
  };
  reader.readAsText(f);
}

/* ----------------- Logs push ----------------- */
function pushLog(msg){ const logs = lsGet('logs', []); logs.unshift({id:uid('log'), t:now(), msg}); lsSet('logs', logs); renderLogsMini(); }

/* ----------------- Init & start ----------------- */
function initUI(){
  seedIfNeeded();
  renderCards();
  STATE.currentUser = lsGet('currentUser', STATE.currentUser);
  updateHeader();
}
initUI();

</script>
</body>
</html>
