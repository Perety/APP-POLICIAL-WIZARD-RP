<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Daynight RP — PDA / CAD (Firestore-ready)</title>

<style>
  :root{
    --bg-1:#03121a; --bg-2:#071827;
    --text:#eaf6fb; --muted:#9fb3bd;
    --accent1:#7c3aed; --accent2:#06b6a4;
    --glass: rgba(255,255,255,0.02);
    --card-grad: linear-gradient(180deg, rgba(255,255,255,0.016), rgba(255,255,255,0.006));
    --radius:14px;
    --shadow: 0 18px 48px rgba(2,6,10,0.6);
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial}
  body{
    background:
      radial-gradient(800px 400px at 18% 8%, rgba(124,58,237,0.08), transparent),
      linear-gradient(180deg,var(--bg-1),var(--bg-2));
    color:var(--text); padding:28px; -webkit-font-smoothing:antialiased;
  }
  body::before{
    content:""; position:fixed; inset:0; pointer-events:none;
    background-image: linear-gradient(135deg, rgba(255,255,255,0.012) 1px, transparent 1px);
    background-size: 6px 6px; opacity:0.6; mix-blend-mode: overlay;
  }

  .wrap{max-width:1200px;margin:0 auto}
  header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:20px}
  .brand{display:flex;gap:14px;align-items:center}
  .logo{width:64px;height:64px;border-radius:12px;background:linear-gradient(135deg,var(--accent1),var(--accent2));display:grid;place-items:center;overflow:hidden;border:1px solid rgba(255,255,255,0.04);box-shadow:0 12px 40px rgba(12,10,30,0.6)}
  .brand h1{margin:0;font-size:18px}
  .subtitle{color:var(--muted);font-size:13px}

  .top-right{display:flex;gap:10px;align-items:center}
  .pill{background:var(--glass);padding:8px 12px;border-radius:999px;color:var(--muted);font-weight:700}
  .btn{background:linear-gradient(90deg,var(--accent1),var(--accent2));border:none;padding:8px 12px;border-radius:12px;color:#031018;cursor:pointer;font-weight:800;box-shadow:0 10px 28px rgba(50,10,80,0.12)}
  .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:7px 10px;border-radius:10px;color:var(--muted);cursor:pointer}
  .notif-pill{background:linear-gradient(90deg,var(--accent2),var(--accent1));padding:8px 12px;border-radius:999px;font-weight:800;color:#031018}

  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
  @media (max-width:980px){ .grid{grid-template-columns:repeat(2,1fr)} }
  @media (max-width:640px){ .grid{grid-template-columns:1fr} }

  .card{
    background:var(--card-grad); border-radius:var(--radius); padding:18px; border:1px solid rgba(255,255,255,0.04);
    box-shadow:var(--shadow); display:flex;flex-direction:column; gap:10px; position:relative; overflow:hidden; transition: transform .32s cubic-bezier(.2,.9,.2,.99), box-shadow .28s, border-color .28s;
  }
  .card .card-head{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .card .title{font-weight:900;font-size:16px}
  .card .desc{color:var(--muted);font-size:13px}
  .card:hover{transform:translateY(-8px); box-shadow:0 40px 90px rgba(0,0,0,0.7); border-color:rgba(140,80,240,0.12)}
  .card .card-actions{display:flex;gap:8px;align-items:center}
  .btn-small{padding:6px 8px;border-radius:8px;font-size:13px}

  .card::after{
    content:""; position:absolute; right:-60px; top:-30px; width:140px; height:140px; transform:rotate(25deg);
    background: linear-gradient(135deg, rgba(255,255,255,0.02), rgba(124,58,237,0.06));
    pointer-events:none; filter: blur(8px); opacity:.6;
  }

  #expandedRoot .expanded {
    margin-top:12px; border-radius:12px; padding:16px; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.04));
    border:1px solid rgba(255,255,255,0.03); box-shadow:0 30px 44px rgba(0,0,0,0.55); animation: panelIn .28s cubic-bezier(.2,.9,.2,.99) both;
  }
  @keyframes panelIn { from{opacity:0; transform:translateY(12px) scale(.995)} to{opacity:1; transform:none} }
  @keyframes panelOut { from{opacity:1} to{opacity:0; transform:translateY(8px)} }

  #toasts { position:fixed; right:18px; top:80px; z-index:99999; display:flex; flex-direction:column; gap:10px; width:340px; pointer-events:none; }
  .toast{ pointer-events:auto; display:flex; gap:10px; align-items:flex-start; padding:12px; border-radius:10px; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.06)); border:1px solid rgba(255,255,255,0.04); box-shadow:0 12px 38px rgba(2,6,10,0.6); color:var(--text); animation: toastIn .22s ease both; }
  @keyframes toastIn { from{opacity:0; transform:translateY(-8px) scale(.98)} to{opacity:1; transform:none} }
  .toast .t-left{font-weight:900;font-size:13px}
  .toast .t-body{font-size:13px;color:var(--muted)}
  .toast .t-close{margin-left:auto;background:transparent;border:none;color:var(--muted);cursor:pointer;font-weight:800}

  .muted{color:var(--muted)}
  .list{display:flex;flex-direction:column;gap:8px}
  .list .item{padding:10px;border-radius:8px;background:rgba(0,0,0,0.04);display:flex;justify-content:space-between;align-items:center}
  footer{margin-top:20px;color:var(--muted);font-size:13px;text-align:center}

  .refresh-pulse{animation: pulse .9s ease; }
  @keyframes pulse{ 0%{box-shadow:0 0 0 rgba(124,58,237,0.15)} 70%{box-shadow:0 0 30px rgba(124,58,237,0.03)} 100%{box-shadow:none} }

  @media (max-width:640px){
    header{flex-direction:column;align-items:stretch}
    #toasts{right:12px;left:12px;width:auto}
  }

  /* small helpers */
  .small{font-size:13px}
  .badge{background:rgba(255,255,255,0.03);padding:6px 8px;border-radius:999px;font-weight:700;color:var(--muted)}
</style>
</head>
<body>
  <div class="wrap" role="main">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <img src="https://i.imgur.com/7bKkhQf.png" alt="logo" style="width:100%;height:100%;object-fit:cover;border-radius:8px">
        </div>
        <div>
          <h1>Daynight RP — PDA / CAD</h1>
          <div class="subtitle">Interfaz mejorada • Notifs estilo FiveM • Firestore-ready</div>
        </div>
      </div>

      <div class="top-right">
        <div id="userDisplay" class="pill">No conectado</div>
        <div id="dutyStatus" class="pill">En servicio: 0</div>
        <div id="notifWrap" style="display:inline-flex;align-items:center">
          <div id="notifPill" class="notif-pill" style="display:none">Alertas 0</div>
        </div>
        <button id="btnRefreshAll" class="btn-ghost">Refrescar todo</button>
        <button id="btnExport" class="btn">Exportar</button>
        <button id="btnLogin" class="btn-ghost">Entrar</button>
      </div>
    </header>

    <section class="grid" id="cardsRoot" aria-label="Paneles principales"></section>

    <div id="expandedRoot" aria-live="polite"></div>

    <footer>Hecho para Daynight RP • UI lista para Firestore • Diseño modernizado</footer>
  </div>

  <div id="toasts" aria-live="polite" aria-atomic="true"></div>

<script>
/*
  Este fichero asume que Firebase ya está inicializado en otra parte de tu proyecto.
  Detecta ambos estilos:
    - API modular (getFirestore, collection, getDocs, addDoc, doc, updateDoc, deleteDoc)
    - API compat (firebase.firestore())
  Si no detecta Firestore, usa datos locales para demo.
*/

/* ======================== UTIL: Firestore adapter ======================== */
const FireDB = (function(){
  // Detect modular API
  const hasModular = typeof getFirestore === 'function' && typeof collection === 'function';
  // Detect compat API
  const hasCompat = typeof firebase !== 'undefined' && firebase.firestore;
  let dbMod = null;
  if(hasModular){
    try{ dbMod = getFirestore(); }catch(e){ dbMod = null; }
  }
  const api = {
    available: hasModular || hasCompat,
    hasModular,
    hasCompat,
    dbMod,
    COL(name){
      // return collection reference (modular) or path string (compat)
      if(this.hasModular && this.dbMod) return collection(this.dbMod, name);
      if(this.hasCompat) return firebase.firestore().collection(name);
      return null;
    },
    async getAll(name){
      try{
        if(this.hasModular && this.dbMod){
          const snap = await getDocs(collection(this.dbMod, name));
          const out = []; snap.forEach(d=> out.push({ id:d.id, ...d.data() }));
          return out;
        } else if(this.hasCompat){
          const snap = await firebase.firestore().collection(name).get();
          const out = []; snap.forEach(d=> out.push({ id:d.id, ...d.data() }));
          return out;
        }
      }catch(e){ console.warn('FireDB.getAll error', e); }
      return null;
    },
    async add(name, data){
      try{
        if(this.hasModular && this.dbMod){
          const res = await addDoc(collection(this.dbMod, name), data);
          return { id: res.id, ...data };
        } else if(this.hasCompat){
          const ref = await firebase.firestore().collection(name).add(data);
          return { id: ref.id, ...data };
        }
      }catch(e){ console.warn('FireDB.add error', e); }
      return null;
    },
    async del(name, id){
      try{
        if(this.hasModular && this.dbMod){
          await deleteDoc(doc(this.dbMod, name, id));
          return true;
        } else if(this.hasCompat){
          await firebase.firestore().collection(name).doc(id).delete();
          return true;
        }
      }catch(e){ console.warn('FireDB.del error', e); }
      return false;
    },
    async update(name, id, patch){
      try{
        if(this.hasModular && this.dbMod){
          await updateDoc(doc(this.dbMod, name, id), patch);
          return true;
        } else if(this.hasCompat){
          await firebase.firestore().collection(name).doc(id).update(patch);
          return true;
        }
      }catch(e){ console.warn('FireDB.update error', e); }
      return false;
    }
  };
  return api;
})();

/* ======================== ESTADO LOCAL ======================== */
const STATE = {
  currentUser: { display: 'Visitante', role: 'user' },
  notifications: [],
  onDutyCount: 0,
  wanted: [], // BOLOs
  fines: [],
  alerts: []
};

/* Puedes cambiar estos nombres si tus colecciones se llaman distinto */
const COLLECTIONS = {
  wanted: 'wanted',
  fines: 'fines',
  users: 'users',
  alerts: 'alerts'
};

/* ======================== CARDS ======================== */
const CARDS = [
  { id:'dispatch', title:'Despacho', desc:'Ver llamadas activas', icon:'🚨' },
  { id:'wanted', title:'BOLO / Wanted', desc:'Listados y prioridades', icon:'🔎' },
  { id:'fines', title:'Multas', desc:'Gestionar multas y pagos', icon:'💸' },
  { id:'reports', title:'Incidentes', desc:'Reportes públicos', icon:'📋' },
  { id:'alerts', title:'Alertas', desc:'Alertas de ciudad', icon:'🔔' },
  { id:'radio', title:'Radios', desc:'Canales y mensajes', icon:'📡' },
  { id:'admin', title:'Administración', desc:'Roles y usuarios', icon:'⚙️' },
];

const cardsRoot = document.getElementById('cardsRoot');
const expandedRoot = document.getElementById('expandedRoot');
const userDisplay = document.getElementById('userDisplay');
const dutyStatus = document.getElementById('dutyStatus');
const notifPill = document.getElementById('notifPill');
const toastWrap = document.getElementById('toasts');

/* ====== Renders ====== */
function renderCards(){
  cardsRoot.innerHTML='';
  CARDS.forEach(c=>{
    const el = document.createElement('div');
    el.className='card';
    el.dataset.id=c.id;
    el.innerHTML = `
      <div class="card-head">
        <div>
          <div class="title">${c.title}</div>
          <div class="desc">${c.desc}</div>
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end">
          <div style="font-size:26px">${c.icon}</div>
          <div class="card-actions" style="margin-top:8px">
            <button class="btn-ghost btn-small open-btn" data-open="${c.id}">Abrir</button>
            <button class="btn-ghost btn-small refresh-btn" data-refresh="${c.id}">Refrescar</button>
          </div>
        </div>
      </div>
    `;
    el.querySelector('.open-btn').addEventListener('click', (e)=>{ e.stopPropagation(); openCard(c.id, el); });
    el.querySelector('.refresh-btn').addEventListener('click', (e)=>{ e.stopPropagation(); refreshPanel(c.id, el); });
    el.addEventListener('click', ()=> openCard(c.id, el));
    cardsRoot.appendChild(el);
  });
}

/* ====== Expanded panel handling ====== */
function clearExpanded(){
  if(!expandedRoot.firstElementChild) return;
  const node = expandedRoot.firstElementChild;
  node.style.animation = 'panelOut .18s ease forwards';
  setTimeout(()=> expandedRoot.innerHTML='', 190);
}

function openCard(id, hostEl){
  document.querySelectorAll('.card').forEach(c=>c.classList.remove('active'));
  if(hostEl) hostEl.classList.add('active');

  expandedRoot.innerHTML = ''; 
  const panel = document.createElement('div');
  panel.className = 'expanded';
  panel.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>${id.toUpperCase()}</strong> <div class="muted small">Panel dinámico</div></div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn btn-small refresh-panel" data-id="${id}">Refrescar</button>
        <button class="btn-ghost close-panel">Cerrar</button>
      </div>
    </div>
    <div id="panelBody_${id}" style="margin-top:12px"></div>
  `;
  expandedRoot.appendChild(panel);

  panel.querySelector('.close-panel').addEventListener('click', ()=> clearExpanded());
  panel.querySelector('.refresh-panel').addEventListener('click', ()=> refreshPanel(id, hostEl));

  switch(id){
    case 'wanted': renderWantedPanel(panel.querySelector(`#panelBody_${id}`)); break;
    case 'fines': renderFinesPanel(panel.querySelector(`#panelBody_${id}`)); break;
    case 'alerts': renderAlertsPanel(panel.querySelector(`#panelBody_${id}`)); break;
    default:
      panel.querySelector(`#panelBody_${id}`).innerHTML = `<div class="muted small">Contenido no implementado (demo)</div>`;
  }
}

/* ====== Refresh logic ====== */
async function refreshPanel(id, hostEl){
  if(hostEl){
    hostEl.classList.add('refresh-pulse');
    setTimeout(()=> hostEl.classList.remove('refresh-pulse'), 900);
  }
  switch(id){
    case 'wanted': await loadWanted(); break;
    case 'fines': await loadFines(); break;
    case 'alerts': await loadAlerts(); break;
    default: await Promise.resolve(); break;
  }
  updateHeader();
  notify('info', 'Refrescado', `Panel ${id} actualizado`, 1600);
}

document.getElementById('btnRefreshAll').addEventListener('click', async ()=>{
  document.querySelectorAll('.card').forEach(c=>c.classList.add('refresh-pulse'));
  setTimeout(()=> document.querySelectorAll('.card').forEach(c=>c.classList.remove('refresh-pulse')), 900);
  await Promise.all([loadWanted(), loadFines(), loadAlerts()]);
  updateHeader();
  notify('info','Refrescado','Todos los paneles actualizados', 1800);
});

/* ====== Notifications (FiveM-like toasts) ====== */
let TOAST_ID = 0;
function notify(type='info', title='', text='', ttl=4000){
  const id = ++TOAST_ID;
  const el = document.createElement('div');
  el.className='toast';
  el.dataset.id = id;
  const emoji = type==='danger'?'⚠️': type==='success'?'✅': type==='warn'?'🚨':'ℹ️';
  el.innerHTML = `<div style="font-weight:900">${emoji} ${title}</div>
                  <div class="t-body" style="margin-left:8px">${text}</div>
                  <button class="t-close" aria-label="cerrar">×</button>`;
  toastWrap.prepend(el);
  updateNotifCount(1);
  el.querySelector('.t-close').addEventListener('click', ()=> removeToast(id));
  if(ttl && ttl>0) setTimeout(()=> removeToast(id), ttl);
  return id;
}
function removeToast(id){
  const t = toastWrap.querySelector(`.toast[data-id="${id}"]`);
  if(!t) return;
  t.style.opacity = '0'; t.style.transform = 'translateY(-8px)';
  setTimeout(()=> { t.remove(); updateNotifCount(-1); }, 200);
}
function updateNotifCount(delta=0){
  if(delta>0) STATE.notifications.push(1);
  else if(delta<0) STATE.notifications.pop();
  const n = STATE.notifications.length;
  if(n>0){ notifPill.style.display='inline-block'; notifPill.textContent = `Alertas ${n}`; }
  else notifPill.style.display='none';
}

/* ====== BOLO / Wanted ====== */
async function loadWantedFromDB(){
  if(!FireDB.available) return null;
  return await FireDB.getAll(COLLECTIONS.wanted);
}
async function loadWanted(){
  const dbdata = await loadWantedFromDB();
  if(dbdata) STATE.wanted = dbdata;
  else {
    if(STATE.wanted.length===0){
      STATE.wanted = [
        { id:'bolo1', name:'Juan Pérez', reason:'Robo agravado', priority:'Alta', notes:'Armado' },
        { id:'bolo2', name:'María Ruiz', reason:'Estafa', priority:'Media', notes:'Moverse en aeropuerto' },
      ];
    }
  }
  renderWantedCards();
}
function renderWantedCards(){
  // small preview card on grid (if not expanded)
  let card = document.querySelector('.card[data-id="wanted"] .card-footer');
  // ensure a small preview area exists
  const host = document.querySelector('.card[data-id="wanted"]');
  if(host){
    // add a brief summary if not present
    if(!host.querySelector('.card-footer')){
      const ft = document.createElement('div'); ft.className='card-footer muted small';
      ft.style.marginTop='8px'; ft.textContent = `${STATE.wanted.length} BOLO(s) activos`;
      host.appendChild(ft);
    } else {
      host.querySelector('.card-footer').textContent = `${STATE.wanted.length} BOLO(s) activos`;
    }
  }

  const area = document.getElementById('panelBody_wanted');
  if(!area) return;
  area.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>BOLO / Wanted</strong><div class="muted small">Gestiona BOLOs y avisos</div></div>
      <div style="display:flex;gap:8px">
        <button id="addBoloBtn" class="btn btn-small">Nuevo BOLO</button>
        <button id="refreshWantedBtn" class="btn-ghost btn-small">Refrescar</button>
      </div>
    </div>
    <div id="wantedList" style="margin-top:12px" class="list"></div>
  `;
  const list = area.querySelector('#wantedList');
  if(STATE.wanted.length===0) list.innerHTML = '<div class="muted small">Sin BOLOs activos</div>';
  else {
    list.innerHTML = '';
    STATE.wanted.forEach(w=>{
      const it = document.createElement('div'); it.className='item';
      it.innerHTML = `<div><b>${escapeHtml(w.name||'N/A')}</b><div class="muted small">${escapeHtml(w.reason||'')} • ${escapeHtml(w.priority||'')}</div></div>
                      <div style="display:flex;gap:8px">
                        <button class="btn-ghost btn-small view-bolo" data-id="${w.id}">Ver</button>
                        <button class="btn btn-small del-bolo" data-id="${w.id}">Borrar</button>
                      </div>`;
      list.appendChild(it);
    });

    list.querySelectorAll('.del-bolo').forEach(b=>{
      b.addEventListener('click', async ()=>{
        const id = b.dataset.id;
        // delete in Firestore if available
        if(FireDB.available){
          const ok = await FireDB.del(COLLECTIONS.wanted, id);
          if(!ok){ notify('danger','Error','No se pudo eliminar en Firestore',2000); return; }
        }
        STATE.wanted = STATE.wanted.filter(x=> x.id !== id);
        renderWantedCards();
        notify('success','BOLO eliminado', `Se eliminó ${id}`, 1600);
      });
    });
    list.querySelectorAll('.view-bolo').forEach(b=>{
      b.addEventListener('click', ()=> {
        const id = b.dataset.id;
        const w = STATE.wanted.find(x=>x.id===id);
        if(!w) return;
        const modal = document.createElement('div'); modal.className='overlay';
        modal.style.position='fixed'; modal.style.inset=0; modal.style.display='grid'; modal.style.placeItems='center';
        modal.innerHTML = `<div style="background:var(--card-grad);padding:18px;border-radius:12px;min-width:320px">
            <h3>${escapeHtml(w.name)}</h3>
            <p><b>Motivo:</b> ${escapeHtml(w.reason)}</p>
            <p><b>Prioridad:</b> ${escapeHtml(w.priority)}</p>
            <p class="muted small">${escapeHtml(w.notes || '')}</p>
            <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
              <button class="btn-ghost" id="closeModal">Cerrar</button>
            </div>
          </div>`;
        document.body.appendChild(modal);
        modal.querySelector('#closeModal').addEventListener('click', ()=> modal.remove());
      });
    });
  }

  // add new bolo
  if(area){
    area.querySelector('#addBoloBtn').addEventListener('click', async ()=>{
      const name = prompt('Nombre del sujeto:') || 'Sujeto anónimo';
      const reason = prompt('Motivo:') || 'No especificado';
      const priority = prompt('Prioridad (Alta/Media/Baja):') || 'Media';
      const notes = prompt('Notas adicionales:') || '';
      const data = { name, reason, priority, notes, createdAt: new Date().toISOString() };
      if(FireDB.available){
        const created = await FireDB.add(COLLECTIONS.wanted, data);
        if(created) {
          STATE.wanted.unshift(created);
          notify('success','BOLO creado','Guardado en Firestore',1600);
        } else {
          // fallback local id
          data.id = `bolo${Date.now().toString().slice(-5)}`;
          STATE.wanted.unshift(data);
          notify('warn','BOLO creado','Guardado localmente (Firestore falló)',2000);
        }
      } else {
        data.id = `bolo${Date.now().toString().slice(-5)}`;
        STATE.wanted.unshift(data);
        notify('success','BOLO creado','Guardado localmente',1600);
      }
      renderWantedCards();
    });

    area.querySelector('#refreshWantedBtn').addEventListener('click', ()=> { loadWanted(); notify('info','Wanted','Lista recargada',1200); });
  }
}

/* ====== Multas (Fines) ====== */
async function loadFinesFromDB(){
  if(!FireDB.available) return null;
  return await FireDB.getAll(COLLECTIONS.fines);
}
async function loadFines(){
  const dbdata = await loadFinesFromDB();
  if(dbdata) STATE.fines = dbdata;
  else {
    if(STATE.fines.length===0){
      STATE.fines = [
        { id:'fine1', owner:'Carlos Díaz', amount:250, reason:'Exceso de velocidad', paid:false },
      ];
    }
  }
  renderFinesPanel();
}

function renderFinesPanel(container){
  let area = container || document.getElementById('panelBody_fines');
  if(!area){
    const modal = document.createElement('div');
    modal.style.position='fixed'; modal.style.right='20px'; modal.style.bottom='20px'; modal.style.width='420px'; modal.style.zIndex=99999;
    modal.innerHTML = `<div class="card"><div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>Multas</strong><div class="muted small">Resumen</div></div>
      <div><button class="btn-ghost close-small">Cerrar</button></div>
    </div><div id="finesMiniList" style="margin-top:12px"></div></div>`;
    document.body.appendChild(modal);
    modal.querySelector('.close-small').addEventListener('click', ()=> modal.remove());
    area = modal.querySelector('#finesMiniList');
  }

  if(!area) return;
  area.innerHTML = `<div style="display:flex;justify-content:space-between">
    <div><strong>Multas</strong></div>
    <div style="display:flex;gap:8px">
      <button id="newFineBtn" class="btn btn-small">Nueva multa</button>
      <button id="refreshFinesBtn" class="btn-ghost btn-small">Refrescar</button>
    </div>
  </div>
  <div style="margin-top:12px" id="fineList" class="list"></div>`;

  const list = area.querySelector('#fineList');
  if(STATE.fines.length===0) list.innerHTML = '<div class="muted small">Sin multas</div>';
  else{
    list.innerHTML = '';
    STATE.fines.forEach(f=>{
      const it = document.createElement('div'); it.className='item';
      it.innerHTML = `<div><b>${escapeHtml(f.owner || 'N/A')}</b><div class="muted small">${escapeHtml(f.reason || '')} • ${escapeHtml(String(f.amount || 0))}€</div></div>
                      <div style="display:flex;gap:8px">
                        <button class="btn-ghost btn-small pay-fine" data-id="${f.id}">${f.paid?'Reembolsar':'Pagar'}</button>
                        <button class="btn btn-small del-fine" data-id="${f.id}">Eliminar</button>
                      </div>`;
      list.appendChild(it);
    });

    list.querySelectorAll('.pay-fine').forEach(b=>{
      b.addEventListener('click', async ()=>{
        const id = b.dataset.id;
        const f = STATE.fines.find(x=>x.id===id);
        if(!f) return;
        f.paid = !f.paid;
        if(FireDB.available){
          const ok = await FireDB.update(COLLECTIONS.fines, id, { paid: f.paid });
          if(!ok) notify('danger','Error','No se pudo actualizar en Firestore',1800);
        }
        renderFinesPanel(area);
        notify('success','Multa actualizada', `${f.owner} • ${f.paid? 'Pagada':'Pendiente'}`, 1500);
      });
    });

    list.querySelectorAll('.del-fine').forEach(b=>{
      b.addEventListener('click', async ()=>{
        const id = b.dataset.id;
        if(FireDB.available){
          const ok = await FireDB.del(COLLECTIONS.fines, id);
          if(!ok){ notify('danger','Error','No se pudo eliminar en Firestore',1800); return; }
        }
        STATE.fines = STATE.fines.filter(x=>x.id!==id);
        renderFinesPanel(area);
        notify('info','Multa eliminada', `ID ${id}`, 1200);
      });
    });
  }

  area.querySelector('#newFineBtn').addEventListener('click', async ()=>{
    const owner = prompt('Titular de la multa:') || 'Desconocido';
    const amount = parseFloat(prompt('Importe (€):') || '0') || 0;
    const reason = prompt('Motivo:') || '—';
    const data = { owner, amount, reason, paid:false, createdAt: new Date().toISOString() };
    if(FireDB.available){
      const created = await FireDB.add(COLLECTIONS.fines, data);
      if(created){ STATE.fines.unshift(created); notify('success','Multa creada','Guardada en Firestore',1500); }
      else { data.id = `fine${Date.now().toString().slice(-5)}`; STATE.fines.unshift(data); notify('warn','Multa creada','Guardada localmente',1600); }
    } else {
      data.id = `fine${Date.now().toString().slice(-5)}`; STATE.fines.unshift(data); notify('success','Multa creada','Guardada localmente',1500);
    }
    renderFinesPanel(area);
  });

  area.querySelector('#refreshFinesBtn').addEventListener('click', ()=> { loadFines(); notify('info','Multas','Lista recargada',1200); });
}

/* ====== Alerts ====== */
async function loadAlerts(){
  if(FireDB.available){
    const db = await FireDB.getAll(COLLECTIONS.alerts);
    if(db) STATE.alerts = db;
  }
  // no further processing for demo
}

function renderAlertsPanel(container){
  const area = container || document.getElementById('panelBody_alerts');
  if(!area) return;
  area.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>Alertas</strong><div class="muted small">Enviar una alerta a la ciudad</div></div>
      <div style="display:flex;gap:8px">
        <button id="sendAlertBtn" class="btn btn-small">Enviar</button>
        <button id="refreshAlertsBtn" class="btn-ghost btn-small">Refrescar</button>
      </div>
    </div>
    <div style="margin-top:12px">
      <input id="alertTitle" placeholder="Título" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04)"/>
      <textarea id="alertMsg" placeholder="Mensaje..." style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);margin-top:8px"></textarea>
    </div>
    <div style="margin-top:8px" id="alertsList" class="list"></div>
  `;
  const list = area.querySelector('#alertsList');
  if((STATE.alerts || []).length===0) list.innerHTML = '<div class="muted small">Sin alertas enviadas</div>';
  else {
    list.innerHTML = '';
    STATE.alerts.forEach((a)=>{
      const it = document.createElement('div'); it.className='item';
      it.innerHTML = `<div><b>${escapeHtml(a.title||'')}</b><div class="muted small">${escapeHtml(a.msg||'')}</div></div><div>${escapeHtml(a.ts||'')}</div>`;
      list.appendChild(it);
    });
  }
  area.querySelector('#sendAlertBtn').addEventListener('click', async ()=>{
    const t = area.querySelector('#alertTitle').value || 'Alerta';
    const m = area.querySelector('#alertMsg').value || '';
    const a = { title:t, msg:m, ts: new Date().toLocaleString() };
    if(FireDB.available){
      const created = await FireDB.add(COLLECTIONS.alerts, a);
      if(created) { STATE.alerts.unshift(created); notify('warn', t, m, 4000); }
      else { STATE.alerts.unshift(a); notify('warn', t, m, 4000); }
    } else {
      STATE.alerts.unshift(a);
      notify('warn', t, m, 4000);
    }
    renderAlertsPanel(area);
  });
  area.querySelector('#refreshAlertsBtn').addEventListener('click', ()=> { loadAlerts(); notify('info','Alertas recargadas','',1200); });
}

/* ====== Header & Helpers ====== */
async function updateHeader(){
  userDisplay.textContent = STATE.currentUser ? `${STATE.currentUser.display} (${STATE.currentUser.role})` : 'No conectado';
  // compute onDuty from users collection if available
  try{
    if(FireDB.available){
      const users = await FireDB.getAll(COLLECTIONS.users);
      STATE.onDutyCount = (users || []).filter(u=>u.onDuty).length;
    }
  }catch(e){ console.warn(e); }
  dutyStatus.textContent = `En servicio: ${STATE.onDutyCount || 0}`;
}

/* ====== Init ====== */
(async function init(){
  renderCards();

  // small visual: put counts in cards after render
  setTimeout(()=> {
    const wantedCard = document.querySelector('.card[data-id="wanted"] .card-head');
    if(wantedCard && !document.querySelector('.card[data-id="wanted"] .card-footer')){
      const ft = document.createElement('div'); ft.className='card-footer muted small'; ft.style.marginTop='8px';
      ft.textContent = 'Cargando...'; document.querySelector('.card[data-id="wanted"]').appendChild(ft);
    }
  }, 600);

  await loadWanted();
  await loadFines();
  await loadAlerts();
  await updateHeader();

  document.getElementById('btnExport').addEventListener('click', async ()=>{
    const data = { wanted: STATE.wanted, fines: STATE.fines, alerts: STATE.alerts };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type:'application/json' });
    const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'daynight_export_' + Date.now() + '.json'; document.body.appendChild(a); a.click(); a.remove();
    notify('success','Exportado','JSON descargado',1500);
  });

  // sample notifications
  setTimeout(()=> notify('info','Bienvenido','Interfaz lista',2200), 600);
  if(!FireDB.available) setTimeout(()=> notify('warn','Firestore no detectado','Funcionamiento en modo local/demo',2400), 900);

  // expose for debugging
  window.__APP = { STATE, refreshPanel, openCard, notify, loadWanted, loadFines, FireDB };
})();

/* ESC to close expanded */
document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') clearExpanded(); });

/* simple escape html helper for text nodes */
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'})[m]; }); }
</script>
</body>
</html>
