<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Daynight RP — Sistema Policial</title>
  <style>
    :root {
      --bg-1: #0a0f1a;
      --bg-2: #0c1628;
      --muted: #a0b8c6;
      --text: #eaf4fc;
      --accent: #4f46e5;
      --accent-2: #06b6d4;
      --danger: #ef4444;
      --glass: rgba(255,255,255,0.03);
      --card-grad: linear-gradient(180deg, rgba(255,255,255,0.014), rgba(255,255,255,0.006));
      --radius: 12px;
      --shadow: 0 14px 40px rgba(2,6,10,0.6);
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    }
    html, body {
      height: 100%;
      margin: 0;
      background:
        radial-gradient(800px 300px at 12% 8%, rgba(79,70,229,0.06), transparent),
        linear-gradient(180deg,var(--bg-2) 0%, var(--bg-1) 60%);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
    }
    a { color: var(--accent) }

    .bg {
      position: fixed;
      inset: 0;
      z-index: 0;
      pointer-events: none;
      overflow: hidden;
    }
    .nebula {
      position: absolute;
      width: 60vmax;
      height: 60vmax;
      left: -10vmin;
      top: -8vmin;
      background:
        radial-gradient(circle at 30% 30%, rgba(79,70,229,0.24), transparent 30%),
        radial-gradient(circle at 70% 70%, rgba(6,182,164,0.12), transparent 25%);
      filter: blur(56px) saturate(120%);
      transform: translateZ(0);
      animation: float 12s ease-in-out infinite;
      opacity: 0.95;
    }
    .nebula.r {
      right: -10vmin;
      left: auto;
      top: 6vmin;
      background:
        radial-gradient(circle at 70% 20%, rgba(255,80,120,0.20), transparent 30%),
        radial-gradient(circle at 30% 80%, rgba(110,231,183,0.12), transparent 25%);
      animation-duration: 10s;
      animation-direction: reverse;
    }
    .gridOverlay {
      position: absolute;
      inset: 0;
      background-image:
        linear-gradient(transparent 96%, rgba(255,255,255,0.01) 96%),
        linear-gradient(90deg, transparent 96%, rgba(255,255,255,0.01) 96%);
      background-size: 320px 320px;
      opacity: 0.03;
    }
    .stripes {
      position: absolute;
      inset: 0;
      opacity: 0.12;
      filter: blur(18px) saturate(120%);
      background:
        linear-gradient(90deg, rgba(79,70,229,0.06) 0 20%, transparent 20% 50%),
        linear-gradient(90deg, rgba(255,40,80,0.05) 50% 70%, transparent 70% 100%);
      mix-blend-mode: overlay;
      animation: stripesShift 6s linear infinite;
    }
    @keyframes float {
      0% { transform: translateY(-8px) }
      50% { transform: translateY(8px) }
      100% { transform: translateY(-8px) }
    }
    @keyframes stripesShift {
      0% { background-position: 0 0, 100% 0 }
      50% { background-position: 50% 0, 50% 0 }
      100% { background-position: 0 0, 100% 0 }
    }
  </style>
</head>
<body>
  <div class="bg" aria-hidden="true">
    <div class="nebula"></div>
    <div class="nebula r"></div>
    <div class="gridOverlay"></div>
    <div class="stripes"></div>
  </div>
  <div class="wrap" role="main">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <img src="https://cdn.discordapp.com/attachments/1421898595271180360/1425878366116122654/LOGO_WIZARD_FONDO.png.png" alt="logo" style="width:100%;height:100%;object-fit:cover;border-radius:8px">
        </div>
        <div>
          <h1>Daynight RP — Sistema Policial</h1>
          <div class="subtitle">Interfaz mejorada • Firestore sincronizado</div>
        </div>
      </div>
      <div class="top-right">
        <div id="userDisplay" class="pill">No conectado</div>
        <div id="dutyStatus" class="pill">En servicio: 0</div>
        <div id="notifWrap" style="display:inline-flex;align-items:center">
          <div id="notifPill" class="notif-pill" style="display:none">Alertas 0</div>
        </div>
        <button id="btnExport" class="btn">Exportar</button>
        <button id="btnLogin" class="btn-ghost">Entrar</button>
        <div id="adminModeWrap" style="display:none">
          <span id="adminModePill" class="admin-mode-pill">Admin: OFF</span>
        </div>
      </div>
    </header>

    <section class="grid" id="cardsRoot" aria-label="Paneles principales"></section>
    <div id="expandedRoot" aria-live="polite"></div>
    <footer>Hecho para Daynight RP • UI actualizada • Firestore-only</footer>
  </div>

  <!-- Modal de login -->
  <div id="loginModal" class="overlay" style="display:none" aria-hidden="true">
    <div class="modal fade-in" role="dialog" aria-modal="true">
      <h3>Entrar / Registrarse</h3>
      <div class="muted small">Demo con Firestore. En producción: Firebase Auth + reglas.</div>
      <div style="margin-top:12px">
        <label class="muted small" for="loginUser">Usuario</label>
        <input id="loginUser" placeholder="usuario"/>
        <label class="muted small" for="loginPass" style="margin-top:8px">Contraseña</label>
        <input id="loginPass" type="password" placeholder="contraseña"/>
        <div style="display:flex;gap:8px;margin-top:12px">
          <button id="loginBtnModal" class="btn">Entrar</button>
          <button id="guestBtn" class="btn-ghost">Invitado</button>
          <div style="margin-left:auto" class="small muted">¿Sin cuenta? <span id="showReg" style="cursor:pointer;color:var(--accent)">Crear</span></div>
        </div>
        <div id="loginError" class="muted small" style="margin-top:8px;color:var(--danger);display:none"></div>
      </div>
      <div id="registerBlock" style="display:none;margin-top:12px;border-top:1px dashed rgba(255,255,255,0.03);padding-top:12px">
        <h4 style="margin:0 0 8px 0">Crear cuenta</h4>
        <label class="muted small">Nombre visible</label>
        <input id="regName" placeholder="Ej: Ofc. Pérez"/>
        <label class="muted small">Usuario</label>
        <input id="regUser" placeholder="usuario"/>
        <label class="muted small">Contraseña</label>
        <input id="regPass" type="password" placeholder="contraseña"/>
        <div style="display:flex;gap:8px;margin-top:8px">
          <select id="regRole">
            <option value="officer">Oficial</option>
            <option value="sergeant">Sargento</option>
            <option value="dispatcher">Despachador</option>
            <option value="admin">Administrador</option>
          </select>
          <button id="regCreate" class="btn">Crear</button>
          <button id="regCancel" class="btn-ghost">Cancelar</button>
        </div>
        <div id="regMsg" class="muted small" style="margin-top:8px"></div>
      </div>
    </div>
  </div>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import {
    getFirestore, collection, getDocs, addDoc, query, where
  } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCskczYgGtlPPBEIZiE5PuY7s_cfE_3Chg",
    authDomain: "wizard-rp.firebaseapp.com",
    projectId: "wizard-rp",
    storageBucket: "wizard-rp.firebasestorage.app",
    messagingSenderId: "479456044047",
    appId: "1:479456044047:web:65c52e2430bcb6ca586f7a",
    measurementId: "G-KX5Y56CG0R"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const COL = name => collection(db, name);

  const STATE = {
    currentUser: null
  };

  const $ = (sel, root = document) => root.querySelector(sel);

  // Login
  $('#btnLogin').addEventListener('click', () => {
    $('#loginModal').style.display = 'flex';
    $('#loginError').style.display = 'none';
  });

  $('#loginBtnModal').addEventListener('click', async () => {
    const username = $('#loginUser').value.trim();
    const password = $('#loginPass').value.trim();
    if (!username || !password) {
      $('#loginError').textContent = 'Rellena usuario y contraseña';
      $('#loginError').style.display = 'block';
      return;
    }

    try {
      const snap = await getDocs(query(COL('users'), where('username', '==', username), where('password', '==', password)));
      if (snap.empty) {
        $('#loginError').textContent = 'Usuario o contraseña incorrectos';
        $('#loginError').style.display = 'block';
        return;
      }

      let userData;
      snap.forEach(doc => userData = { id: doc.id, ...doc.data() });
      STATE.currentUser = userData;

      $('#loginModal').style.display = 'none';
      $('#userDisplay').textContent = userData.display || userData.username;
      $('#userDisplay').classList.add('pill');
      renderCards();
    } catch (e) {
      console.error('Error en login', e);
      $('#loginError').textContent = 'Error al conectar con Firestore';
      $('#loginError').style.display = 'block';
    }
  });

  $('#guestBtn').addEventListener('click', () => {
    STATE.currentUser = { username: 'Invitado', display: 'Invitado', role: 'guest' };
    $('#loginModal').style.display = 'none';
    $('#userDisplay').textContent = 'Invitado';
    renderCards();
  });

  $('#showReg').addEventListener('click', () => {
    $('#registerBlock').style.display = 'block';
  });

  $('#regCancel').addEventListener('click', () => {
    $('#registerBlock').style.display = 'none';
  });

  $('#regCreate').addEventListener('click', async () => {
    const name = $('#regName').value.trim();
    const username = $('#regUser').value.trim();
    const password = $('#regPass').value.trim();
    const role = $('#regRole').value;

    if (!name || !username || !password || !role) {
      $('#regMsg').textContent = 'Completa todos los campos';
      return;
    }

    try {
      const existing = await getDocs(query(COL('users'), where('username', '==', username)));
      if (!existing.empty) {
        $('#regMsg').textContent = 'Ese usuario ya existe';
        return;
      }

      await addDoc(COL('users'), {
        display: name,
        username,
        password,
        role,
        badge: 'SIN-ASIGNAR',
        onDuty: false
      });

      $('#regMsg').textContent = 'Cuenta creada correctamente';
      $('#registerBlock').style.display = 'none';
    } catch (e) {
      console.error('Error en registro', e);
      $('#regMsg').textContent = 'Error al crear cuenta';
    }
  });

  // Paneles
  const CARDS = [
    { id: 'pda', title: 'Fichas PDA', desc: 'Buscar y crear fichas', icon: '👤🔒' },
    { id: 'wanted', title: 'Buscados / BOLO', desc: 'Personas buscadas', icon: '🚔' },
    { id: 'fines', title: 'Multas', desc: 'Generar sanciones', icon: '💰' },
    { id: 'alerts', title: 'Alertas', desc: 'Crear y gestionar alertas', icon: '📢' }
  ];

  function renderCards() {
    const cardsRoot = $('#cardsRoot');
    cardsRoot.innerHTML = '';
    CARDS.forEach(c => {
      const el = document.createElement('div');
      el.className = 'card';
      el.innerHTML = `
        <div class="card-head">
          <div>
            <div class="title">${c.title}</div>
            <div class="desc">${c.desc}</div>
          </div>
          <div style="font-size:26px">${c.icon}</div>
        </div>
      `;
      el.addEventListener('click', () => {
        alert(`Panel "${c.title}" abierto (demo).`);
      });
      cardsRoot.appendChild(el);
    });
  }

  renderCards();
</script>
</body>
</html>
